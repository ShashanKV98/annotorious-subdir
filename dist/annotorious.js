(function(B,N){typeof exports=="object"&&typeof module<"u"?N(exports):typeof define=="function"&&define.amd?define(["exports"],N):(B=typeof globalThis<"u"?globalThis:B||self,N(B.Annotorious={}))})(this,function(B){"use strict";var Di=Object.defineProperty;var Ri=(B,N,he)=>N in B?Di(B,N,{enumerable:!0,configurable:!0,writable:!0,value:he}):B[N]=he;var yt=(B,N,he)=>(Ri(B,typeof N!="symbol"?N+"":N,he),he);function N(){}function he(e,t){for(const n in t)e[n]=t[n];return e}function _t(e){return e()}function wt(){return Object.create(null)}function ie(e){e.forEach(_t)}function F(e){return typeof e=="function"}function Z(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function Bn(e){return Object.keys(e).length===0}function bt(e,...t){if(e==null){for(const o of t)o(void 0);return N}const n=e.subscribe(...t);return n.unsubscribe?()=>n.unsubscribe():n}function Et(e,t,n){e.$$.on_destroy.push(bt(t,n))}function Yn(e,t,n,o){if(e){const i=At(e,t,n,o);return e[0](i)}}function At(e,t,n,o){return e[1]&&o?he(n.ctx.slice(),e[1](o(t))):n.ctx}function Dn(e,t,n,o){if(e[2]&&o){const i=e[2](o(n));if(t.dirty===void 0)return i;if(typeof i=="object"){const s=[],r=Math.max(t.dirty.length,i.length);for(let a=0;a<r;a+=1)s[a]=t.dirty[a]|i[a];return s}return t.dirty|i}return t.dirty}function Rn(e,t,n,o,i,s){if(i){const r=At(t,n,o,s);e.p(r,i)}}function Xn(e){if(e.ctx.length>32){const t=[],n=e.ctx.length/32;for(let o=0;o<n;o++)t[o]=-1;return t}return-1}function ue(e,t){e.appendChild(t)}function I(e,t,n){e.insertBefore(t,n||null)}function v(e){e.parentNode&&e.parentNode.removeChild(e)}function xe(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function X(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Tt(e){return document.createTextNode(e)}function x(){return Tt(" ")}function se(){return Tt("")}function z(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)}function c(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function Cn(e){return Array.from(e.childNodes)}function St(e,t,n){e.classList.toggle(t,!!n)}function Un(e,t,{bubbles:n=!1,cancelable:o=!1}={}){return new CustomEvent(e,{detail:t,bubbles:n,cancelable:o})}let Ie;function ke(e){Ie=e}function Mt(){if(!Ie)throw new Error("Function called outside component initialization");return Ie}function we(e){Mt().$$.on_mount.push(e)}function me(){const e=Mt();return(t,n,{cancelable:o=!1}={})=>{const i=e.$$.callbacks[t];if(i){const s=Un(t,n,{cancelable:o});return i.slice().forEach(r=>{r.call(e,s)}),!s.defaultPrevented}return!0}}function re(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach(o=>o.call(this,t))}const be=[],Pe=[];let Ee=[];const Lt=[],Nn=Promise.resolve();let $e=!1;function Vn(){$e||($e=!0,Nn.then(Ot))}function et(e){Ee.push(e)}const tt=new Set;let Ae=0;function Ot(){if(Ae!==0)return;const e=Ie;do{try{for(;Ae<be.length;){const t=be[Ae];Ae++,ke(t),Gn(t.$$)}}catch(t){throw be.length=0,Ae=0,t}for(ke(null),be.length=0,Ae=0;Pe.length;)Pe.pop()();for(let t=0;t<Ee.length;t+=1){const n=Ee[t];tt.has(n)||(tt.add(n),n())}Ee.length=0}while(be.length);for(;Lt.length;)Lt.pop()();$e=!1,tt.clear(),ke(e)}function Gn(e){if(e.fragment!==null){e.update(),ie(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(et)}}function Hn(e){const t=[],n=[];Ee.forEach(o=>e.indexOf(o)===-1?t.push(o):n.push(o)),n.forEach(o=>o()),Ee=t}const Ue=new Set;let ge;function le(){ge={r:0,c:[],p:ge}}function ae(){ge.r||ie(ge.c),ge=ge.p}function V(e,t){e&&e.i&&(Ue.delete(e),e.i(t))}function H(e,t,n,o){if(e&&e.o){if(Ue.has(e))return;Ue.add(e),ge.c.push(()=>{Ue.delete(e),o&&(n&&e.d(1),o())}),e.o(t)}else o&&o()}function Te(e){return(e==null?void 0:e.length)!==void 0?e:Array.from(e)}function de(e){e&&e.c()}function ce(e,t,n){const{fragment:o,after_update:i}=e.$$;o&&o.m(t,n),et(()=>{const s=e.$$.on_mount.map(_t).filter(F);e.$$.on_destroy?e.$$.on_destroy.push(...s):ie(s),e.$$.on_mount=[]}),i.forEach(et)}function fe(e,t){const n=e.$$;n.fragment!==null&&(Hn(n.after_update),ie(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function Fn(e,t){e.$$.dirty[0]===-1&&(be.push(e),Vn(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function ee(e,t,n,o,i,s,r=null,a=[-1]){const l=Ie;ke(e);const u=e.$$={fragment:null,ctx:[],props:s,update:N,not_equal:i,bound:wt(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(l?l.$$.context:[])),callbacks:wt(),dirty:a,skip_bound:!1,root:t.target||l.$$.root};r&&r(u.root);let m=!1;if(u.ctx=n?n(e,t.props||{},(f,h,...d)=>{const g=d.length?d[0]:h;return u.ctx&&i(u.ctx[f],u.ctx[f]=g)&&(!u.skip_bound&&u.bound[f]&&u.bound[f](g),m&&Fn(e,f)),h}):[],u.update(),m=!0,ie(u.before_update),u.fragment=o?o(u.ctx):!1,t.target){if(t.hydrate){const f=Cn(t.target);u.fragment&&u.fragment.l(f),f.forEach(v)}else u.fragment&&u.fragment.c();t.intro&&V(e.$$.fragment),ce(e,t.target,t.anchor),Ot()}ke(l)}class te{constructor(){yt(this,"$$");yt(this,"$$set")}$destroy(){fe(this,1),this.$destroy=N}$on(t,n){if(!F(n))return N;const o=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return o.push(n),()=>{const i=o.indexOf(n);i!==-1&&o.splice(i,1)}}$set(t){this.$$set&&!Bn(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}const zn="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(zn);var K=(e=>(e.ELLIPSE="ELLIPSE",e.POLYGON="POLYGON",e.RECTANGLE="RECTANGLE",e.FREEHAND="FREEHAND",e))(K||{});const nt={},Ne=(e,t)=>nt[e]=t,Ve=e=>nt[e.type].area(e),vt=(e,t,n)=>nt[e.type].intersects(e,t,n),Be=e=>{let t=1/0,n=1/0,o=-1/0,i=-1/0;return e.forEach(([s,r])=>{t=Math.min(t,s),n=Math.min(n,r),o=Math.max(o,s),i=Math.max(i,r)}),{minX:t,minY:n,maxX:o,maxY:i}},jn={area:e=>Math.PI*e.geometry.rx*e.geometry.ry,intersects:(e,t,n)=>{const{cx:o,cy:i,rx:s,ry:r}=e.geometry,a=0,l=Math.cos(a),u=Math.sin(a),m=t-o,f=n-i,h=l*m+u*f,d=u*m-l*f;return h*h/(s*s)+d*d/(r*r)<=1}};Ne(K.ELLIPSE,jn);const Kn={area:e=>{const{points:t}=e.geometry;let n=0,o=t.length-1;for(let i=0;i<t.length;i++)n+=(t[o][0]+t[i][0])*(t[o][1]-t[i][1]),o=i;return Math.abs(.5*n)},intersects:(e,t,n)=>{const{points:o}=e.geometry;let i=!1;for(let s=0,r=o.length-1;s<o.length;r=s++){const a=o[s][0],l=o[s][1],u=o[r][0],m=o[r][1];l>n!=m>n&&t<(u-a)*(n-l)/(m-l)+a&&(i=!i)}return i}};Ne(K.POLYGON,Kn);const It={area:e=>e.geometry.w*e.geometry.h,intersects:(e,t,n)=>t>=e.geometry.x&&t<=e.geometry.x+e.geometry.w&&n>=e.geometry.y&&n<=e.geometry.y+e.geometry.h};Ne(K.RECTANGLE,It);const kt=(e,t=!1)=>{const n=typeof e=="string"?e:e.value,o=/^(xywh)=(pixel|percent)?:?(.+?),(.+?),(.+?),(.+)*/g,i=[...n.matchAll(o)][0],[s,r,a,l,u,m,f]=i;if(r!=="xywh")throw new Error("Unsupported MediaFragment: "+n);if(a&&a!=="pixel")throw new Error(`Unsupported MediaFragment unit: ${a}`);const[h,d,g,b]=[l,u,m,f].map(parseFloat);return{type:K.RECTANGLE,geometry:{x:h,y:d,w:g,h:b,bounds:{minX:h,minY:t?d-b:d,maxX:h+g,maxY:t?d:d+b}}}},Pt=e=>{const{x:t,y:n,w:o,h:i}=e;return{type:"FragmentSelector",conformsTo:"http://www.w3.org/TR/media-frags/",value:`xywh=pixel:${t},${n},${o},${i}`}},Bt="http://www.w3.org/2000/svg",Yt=e=>{const t=o=>{Array.from(o.attributes).forEach(i=>{i.name.startsWith("on")&&o.removeAttribute(i.name)})},n=e.getElementsByTagName("script");return Array.from(n).reverse().forEach(o=>o.parentNode.removeChild(o)),Array.from(e.querySelectorAll("*")).forEach(t),e},Wn=e=>{const o=new XMLSerializer().serializeToString(e.documentElement).replace("<svg>",`<svg xmlns="${Bt}">`);return new DOMParser().parseFromString(o,"image/svg+xml").documentElement},qn=e=>{const n=new DOMParser().parseFromString(e,"image/svg+xml"),o=n.lookupPrefix(Bt),i=n.lookupNamespaceURI(null);return o||i?Yt(n).firstChild:Yt(Wn(n)).firstChild},Jn=e=>{const[t,n,o]=e.match(/(<polygon points=["|'])([^("|')]*)/)||[];if(!o)return;const i=o.split(" ").map(s=>s.split(",").map(parseFloat));return{type:K.POLYGON,geometry:{points:i,bounds:Be(i)}}},Zn=e=>{const t=qn(e),n=parseFloat(t.getAttribute("cx")),o=parseFloat(t.getAttribute("cy")),i=parseFloat(t.getAttribute("rx")),s=parseFloat(t.getAttribute("ry")),r={minX:n-i,minY:o-s,maxX:n+i,maxY:o+s};return{type:K.ELLIPSE,geometry:{cx:n,cy:o,rx:i,ry:s,bounds:r}}},Dt=e=>{const t=typeof e=="string"?e:e.value;if(t.includes("<polygon points="))return Jn(t);if(t.includes("<ellipse "))return Zn(t)},Rt=e=>{let t;if(e.type===K.POLYGON){const n=e.geometry,{points:o}=n;t=`<svg><polygon points="${o.map(i=>i.join(",")).join(" ")}" /></svg>`}else if(e.type===K.ELLIPSE){const n=e.geometry;t=`<svg><ellipse cx="${n.cx}" cy="${n.cy}" rx="${n.rx}" ry="${n.ry}" /></svg>`}if(t)return{type:"SvgSelector",value:t};throw`Unsupported shape type: ${e.type}`};let Ge;const Qn=new Uint8Array(16);function xn(){if(!Ge&&(Ge=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Ge))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ge(Qn)}const Q=[];for(let e=0;e<256;++e)Q.push((e+256).toString(16).slice(1));function $n(e,t=0){return Q[e[t+0]]+Q[e[t+1]]+Q[e[t+2]]+Q[e[t+3]]+"-"+Q[e[t+4]]+Q[e[t+5]]+"-"+Q[e[t+6]]+Q[e[t+7]]+"-"+Q[e[t+8]]+Q[e[t+9]]+"-"+Q[e[t+10]]+Q[e[t+11]]+Q[e[t+12]]+Q[e[t+13]]+Q[e[t+14]]+Q[e[t+15]]}const Xt={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Ct(e,t,n){if(Xt.randomUUID&&!t&&!e)return Xt.randomUUID();e=e||{};const o=e.random||(e.rng||xn)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,t){n=n||0;for(let i=0;i<16;++i)t[n+i]=o[i];return t}return $n(o)}var Ut=Object.prototype.hasOwnProperty;function pe(e,t){var n,o;if(e===t)return!0;if(e&&t&&(n=e.constructor)===t.constructor){if(n===Date)return e.getTime()===t.getTime();if(n===RegExp)return e.toString()===t.toString();if(n===Array){if((o=e.length)===t.length)for(;o--&&pe(e[o],t[o]););return o===-1}if(!n||typeof e=="object"){o=0;for(n in e)if(Ut.call(e,n)&&++o&&!Ut.call(t,n)||!(n in t)||!pe(e[n],t[n]))return!1;return Object.keys(t).length===o}}return e!==e&&t!==t}function ot(){}function eo(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}const Se=[];function it(e,t=ot){let n;const o=new Set;function i(a){if(eo(e,a)&&(e=a,n)){const l=!Se.length;for(const u of o)u[1](),Se.push(u,e);if(l){for(let u=0;u<Se.length;u+=2)Se[u][0](Se[u+1]);Se.length=0}}}function s(a){i(a(e))}function r(a,l=ot){const u=[a,l];return o.add(u),o.size===1&&(n=t(i)||ot),a(e),()=>{o.delete(u),o.size===0&&n&&(n(),n=null)}}return{set:i,update:s,subscribe:r}}const to=e=>{const{subscribe:t,set:n}=it(null);let o=null;return t(i=>o=i),e.observe(({changes:i})=>{if(o){i.deleted.some(r=>r.id===o)&&n(null);const s=i.updated.find(({oldValue:r})=>r.id===o);s&&n(s.newValue.id)}}),{get current(){return o},subscribe:t,set:n}};var Nt=(e=>(e.EDIT="EDIT",e.SELECT="SELECT",e.NONE="NONE",e))(Nt||{});const st={selected:[]},no=(e,t="EDIT")=>{const{subscribe:n,set:o}=it(st);let i=st;n(f=>i=f);const s=()=>o(st),r=()=>{var f;return((f=i.selected)==null?void 0:f.length)===0},a=f=>{if(i.selected.length===0)return!1;const h=typeof f=="string"?f:f.id;return i.selected.some(d=>d.id===h)},l=(f,h)=>{const d=e.getAnnotation(f);if(d){const g=oo(d,t);o(g==="EDIT"?{selected:[{id:f,editable:!0}],pointerEvent:h}:g==="SELECT"?{selected:[{id:f}],pointerEvent:h}:{selected:[],pointerEvent:h})}else console.warn("Invalid selection: "+f)},u=(f,h=!0)=>{const d=Array.isArray(f)?f:[f],g=d.map(b=>e.getAnnotation(b)).filter(b=>b);o({selected:g.map(({id:b})=>({id:b,editable:h}))}),g.length!==d.length&&console.warn("Invalid selection",f)},m=f=>{if(i.selected.length===0)return!1;const{selected:h}=i;h.filter(({id:d})=>f.includes(d)).length>0&&o({selected:h.filter(({id:d})=>!f.includes(d))})};return e.observe(({changes:f})=>m(f.deleted.map(h=>h.id))),{clear:s,clickSelect:l,get selected(){return i?[...i.selected]:null},get pointerEvent(){return i?i.pointerEvent:null},isEmpty:r,isSelected:a,setSelected:u,subscribe:n}},oo=(e,t)=>typeof t=="function"?t(e)||"EDIT":t||"EDIT",io=[];for(let e=0;e<256;++e)io.push((e+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const so=(e,t)=>{const n=new Set(e.bodies.map(o=>o.id));return t.bodies.filter(o=>!n.has(o.id))},ro=(e,t)=>{const n=new Set(t.bodies.map(o=>o.id));return e.bodies.filter(o=>!n.has(o.id))},lo=(e,t)=>t.bodies.map(n=>{const o=e.bodies.find(i=>i.id===n.id);return{newBody:n,oldBody:o&&!pe(o,n)?o:void 0}}).filter(({oldBody:n})=>n),ao=(e,t)=>!pe(e.target,t.target),Vt=(e,t)=>{const n=so(e,t),o=ro(e,t),i=lo(e,t);return{oldValue:e,newValue:t,bodiesCreated:n.length>0?n:void 0,bodiesDeleted:o.length>0?o:void 0,bodiesUpdated:i.length>0?i:void 0,targetUpdated:ao(e,t)?{oldTarget:e.target,newTarget:t.target}:void 0}};var W=(e=>(e.LOCAL="LOCAL",e.REMOTE="REMOTE",e))(W||{});const co=(e,t)=>{var n,o;const{changes:i,origin:s}=t;if(!(!e.options.origin||e.options.origin===s))return!1;if(e.options.ignore){const{ignore:r}=e.options,a=l=>(l==null?void 0:l.length)>0;if(!(a(i.created)||a(i.deleted))){const l=(n=i.updated)==null?void 0:n.some(m=>a(m.bodiesCreated)||a(m.bodiesDeleted)||a(m.bodiesUpdated)),u=(o=i.updated)==null?void 0:o.some(m=>m.targetUpdated);if(r==="BODY_ONLY"&&l&&!u||r==="TARGET_ONLY"&&u&&!l)return!1}}if(e.options.annotations){const r=new Set([...i.created.map(a=>a.id),...i.deleted.map(a=>a.id),...i.updated.map(({oldValue:a})=>a.id)]);return!!(Array.isArray(e.options.annotations)?e.options.annotations:[e.options.annotations]).find(a=>r.has(a))}else return!0},fo=(e,t)=>{const n=new Set((e.created||[]).map(f=>f.id)),o=new Set((e.updated||[]).map(({newValue:f})=>f.id)),i=new Set((t.created||[]).map(f=>f.id)),s=new Set((t.deleted||[]).map(f=>f.id)),r=new Set((t.updated||[]).map(({oldValue:f})=>f.id)),a=new Set((t.updated||[]).filter(({oldValue:f})=>n.has(f.id)||o.has(f.id)).map(({oldValue:f})=>f.id)),l=[...(e.created||[]).filter(f=>!s.has(f.id)).map(f=>r.has(f.id)?t.updated.find(({oldValue:h})=>h.id===f.id).newValue:f),...t.created||[]],u=[...(e.deleted||[]).filter(f=>!i.has(f.id)),...(t.deleted||[]).filter(f=>!n.has(f.id))],m=[...(e.updated||[]).filter(({newValue:f})=>!s.has(f.id)).map(f=>{const{oldValue:h,newValue:d}=f;if(r.has(d.id)){const g=t.updated.find(b=>b.oldValue.id===d.id).newValue;return Vt(h,g)}else return f}),...(t.updated||[]).filter(({oldValue:f})=>!a.has(f.id))];return{created:l,deleted:u,updated:m}},uo=e=>e.id!==void 0,ho=()=>{const e=new Map,t=new Map,n=[],o=(y,p={})=>n.push({onChange:y,options:p}),i=y=>{const p=n.findIndex(E=>E.onChange==y);p>-1&&n.splice(p,1)},s=(y,p)=>{const E={origin:y,changes:{created:p.created||[],updated:p.updated||[],deleted:p.deleted||[]},state:[...e.values()]};n.forEach(L=>{co(L,E)&&L.onChange(E)})},r=(y,p=W.LOCAL)=>{if(e.get(y.id))throw Error(`Cannot add annotation ${y.id} - exists already`);e.set(y.id,y),y.bodies.forEach(E=>t.set(E.id,y.id)),s(p,{created:[y]})},a=(y,p)=>{const E=typeof y=="string"?p:y,L=typeof y=="string"?y:y.id,P=e.get(L);if(P){const C=Vt(P,E);return L===E.id?e.set(L,E):(e.delete(L),e.set(E.id,E)),P.bodies.forEach(G=>t.delete(G.id)),E.bodies.forEach(G=>t.set(G.id,E.id)),C}else console.warn(`Cannot update annotation ${L} - does not exist`)},l=(y,p=W.LOCAL,E=W.LOCAL)=>{const L=uo(p)?E:p,P=a(y,p);P&&s(L,{updated:[P]})},u=(y,p=W.LOCAL)=>{const E=y.reduce((L,P)=>{const C=a(P);return C?[...L,C]:L},[]);E.length>0&&s(p,{updated:E})},m=(y,p=W.LOCAL)=>{const E=e.get(y.annotation);if(E){const L={...E,bodies:[...E.bodies,y]};e.set(E.id,L),t.set(y.id,L.id),s(p,{updated:[{oldValue:E,newValue:L,bodiesCreated:[y]}]})}else console.warn(`Attempt to add body to missing annotation: ${y.annotation}`)},f=()=>[...e.values()],h=(y=W.LOCAL)=>{const p=[...e.values()];e.clear(),t.clear(),s(y,{deleted:p})},d=(y,p=!0,E=W.LOCAL)=>{if(p){const L=[...e.values()];e.clear(),t.clear(),y.forEach(P=>{e.set(P.id,P),P.bodies.forEach(C=>t.set(C.id,P.id))}),s(E,{created:y,deleted:L})}else{const L=y.reduce((P,C)=>{const G=e.get(C.id);return G?[...P,G]:P},[]);if(L.length>0)throw Error(`Bulk insert would overwrite the following annotations: ${L.map(P=>P.id).join(", ")}`);y.forEach(P=>{e.set(P.id,P),P.bodies.forEach(C=>t.set(C.id,P.id))}),s(E,{created:y})}},g=y=>{const p=typeof y=="string"?y:y.id,E=e.get(p);if(E)return e.delete(p),E.bodies.forEach(L=>t.delete(L.id)),E;console.warn(`Attempt to delete missing annotation: ${p}`)},b=(y,p=W.LOCAL)=>{const E=g(y);E&&s(p,{deleted:[E]})},T=(y,p=W.LOCAL)=>{const E=y.reduce((L,P)=>{const C=g(P);return C?[...L,C]:L},[]);E.length>0&&s(p,{deleted:E})},w=(y,p=W.LOCAL)=>{const E=e.get(y.annotation);if(E){const L=E.bodies.find(P=>P.id===y.id);if(L){t.delete(L.id);const P={...E,bodies:E.bodies.filter(C=>C.id!==y.id)};e.set(E.id,P),s(p,{updated:[{oldValue:E,newValue:P,bodiesDeleted:[L]}]})}else console.warn(`Attempt to delete missing body ${y.id} from annotation ${y.annotation}`)}else console.warn(`Attempt to delete body from missing annotation ${y.annotation}`)},_=y=>{const p=e.get(y);return p?{...p}:void 0},A=y=>{const p=t.get(y);if(p){const E=_(p).bodies.find(L=>L.id===y);if(E)return E;console.error(`Store integrity error: body ${y} in index, but not in annotation`)}else console.warn(`Attempt to retrieve missing body: ${y}`)},S=(y,p)=>{if(y.annotation!==p.annotation)throw"Annotation integrity violation: annotation ID must be the same when updating bodies";const E=e.get(y.annotation);if(E){const L=E.bodies.find(C=>C.id===y.id),P={...E,bodies:E.bodies.map(C=>C.id===L.id?p:C)};return e.set(E.id,P),L.id!==p.id&&(t.delete(L.id),t.set(p.id,P.id)),{oldValue:E,newValue:P,bodiesUpdated:[{oldBody:L,newBody:p}]}}else console.warn(`Attempt to add body to missing annotation ${y.annotation}`)},O=(y,p,E=W.LOCAL)=>{const L=S(y,p);s(E,{updated:[L]})},D=(y,p=W.LOCAL)=>{const E=y.map(L=>S({id:L.id,annotation:L.annotation},L));s(p,{updated:E})},U=y=>{const p=e.get(y.annotation);if(p){const E={...p,target:{...p.target,...y}};return e.set(p.id,E),{oldValue:p,newValue:E,targetUpdated:{oldTarget:p.target,newTarget:y}}}else console.warn(`Attempt to update target on missing annotation: ${y.annotation}`)};return{addAnnotation:r,addBody:m,all:f,bulkAddAnnotation:d,bulkDeleteAnnotation:T,bulkUpdateAnnotation:u,bulkUpdateBodies:D,bulkUpdateTargets:(y,p=W.LOCAL)=>{const E=y.map(U).filter(L=>L);E.length>0&&s(p,{updated:E})},clear:h,deleteAnnotation:b,deleteBody:w,getAnnotation:_,getBody:A,observe:o,unobserve:i,updateAnnotation:l,updateBody:O,updateTarget:(y,p=W.LOCAL)=>{const E=U(y);E&&s(p,{updated:[E]})}}},mo=e=>({...e,subscribe:t=>{const n=o=>t(o.state);return e.observe(n),t(e.all()),()=>e.unobserve(n)}});let go=()=>({emit(e,...t){let n=this.events[e]||[];for(let o=0,i=n.length;o<i;o++)n[o](...t)},events:{},on(e,t){var n;return(n=this.events[e])!=null&&n.push(t)||(this.events[e]=[t]),()=>{var o;this.events[e]=(o=this.events[e])==null?void 0:o.filter(i=>t!==i)}}});const po=250,yo=e=>{const t=go(),n=[];let o=-1,i=!1,s=0;const r=d=>{if(!i){const{changes:g}=d,b=performance.now();if(b-s>po)n.splice(o+1),n.push(g),o=n.length-1;else{const T=n.length-1;n[T]=fo(n[T],g)}s=b}i=!1};e.observe(r,{origin:W.LOCAL});const a=d=>(d==null?void 0:d.length)>0&&e.bulkDeleteAnnotation(d),l=d=>(d==null?void 0:d.length)>0&&e.bulkAddAnnotation(d,!1),u=d=>(d==null?void 0:d.length)>0&&e.bulkUpdateAnnotation(d.map(({oldValue:g})=>g)),m=d=>(d==null?void 0:d.length)>0&&e.bulkUpdateAnnotation(d.map(({newValue:g})=>g)),f=d=>(d==null?void 0:d.length)>0&&e.bulkAddAnnotation(d,!1),h=d=>(d==null?void 0:d.length)>0&&e.bulkDeleteAnnotation(d);return{canRedo:()=>n.length-1>o,canUndo:()=>o>-1,destroy:()=>e.unobserve(r),on:(d,g)=>t.on(d,g),redo:()=>{if(n.length-1>o){i=!0;const{created:d,updated:g,deleted:b}=n[o+1];l(d),m(g),h(b),t.emit("redo",n[o+1]),o+=1}},undo:()=>{if(o>-1){i=!0;const{created:d,updated:g,deleted:b}=n[o];a(d),u(g),f(b),t.emit("undo",n[o]),o-=1}}}},_o=()=>{const{subscribe:e,set:t}=it([]);return{subscribe:e,set:t}},wo=(e,t,n,o)=>{const{store:i,selection:s,hover:r,viewport:a}=e,l=new Map;let u=[],m,f;const h=(w,_)=>{l.has(w)?l.get(w).push(_):l.set(w,[_])},d=(w,_)=>{const A=l.get(w);A&&A.indexOf(_)>0&&A.splice(A.indexOf(_),1)},g=(w,_,A)=>{l.has(w)&&setTimeout(()=>{l.get(w).forEach(S=>{if(n){const O=Array.isArray(_)?_.map(U=>n.serialize(U)):n.serialize(_),D=A?A instanceof PointerEvent?A:n.serialize(A):void 0;S(O,D)}else S(_,A)})},1)},b=()=>{const{selected:w}=s,_=w.map(({id:A})=>i.getAnnotation(A));_.forEach(A=>{const S=u.find(O=>O.id===A.id);(!S||!pe(S,A))&&g("updateAnnotation",A,S)}),u=u.map(A=>_.find(({id:O})=>O===A.id)||A)};s.subscribe(({selected:w})=>{if(!(u.length===0&&w.length===0)){if(u.length===0&&w.length>0)u=w.map(({id:_})=>i.getAnnotation(_));else if(u.length>0&&w.length===0)u.forEach(_=>{const A=i.getAnnotation(_.id);A&&!pe(A,_)&&g("updateAnnotation",A,_)}),u=[];else{const _=new Set(u.map(S=>S.id)),A=new Set(w.map(({id:S})=>S));u.filter(S=>!A.has(S.id)).forEach(S=>{const O=i.getAnnotation(S.id);O&&!pe(O,S)&&g("updateAnnotation",O,S)}),u=[...u.filter(S=>A.has(S.id)),...w.filter(({id:S})=>!_.has(S)).map(({id:S})=>i.getAnnotation(S))]}g("selectionChanged",u)}}),r.subscribe(w=>{!m&&w?g("mouseEnterAnnotation",i.getAnnotation(w)):m&&!w?g("mouseLeaveAnnotation",i.getAnnotation(m)):m&&w&&(g("mouseLeaveAnnotation",i.getAnnotation(m)),g("mouseEnterAnnotation",i.getAnnotation(w))),m=w}),a==null||a.subscribe(w=>g("viewportIntersect",w.map(i.getAnnotation))),i.observe(w=>{o&&(f&&clearTimeout(f),f=setTimeout(b,1e3));const{created:_,deleted:A}=w.changes;_.forEach(S=>g("createAnnotation",S)),A.forEach(S=>g("deleteAnnotation",S)),w.changes.updated.filter(S=>[...S.bodiesCreated||[],...S.bodiesDeleted||[],...S.bodiesUpdated||[]].length>0).forEach(({oldValue:S,newValue:O})=>{const D=u.find(U=>U.id===S.id)||S;u=u.map(U=>U.id===S.id?O:U),g("updateAnnotation",O,D)})},{origin:W.LOCAL}),i.observe(w=>{if(u){const _=new Set(u.map(S=>S.id)),A=w.changes.updated.filter(({newValue:S})=>_.has(S.id)).map(({newValue:S})=>S);A.length>0&&(u=u.map(S=>A.find(D=>D.id===S.id)||S))}},{origin:W.REMOTE});const T=w=>_=>{const{created:A,deleted:S,updated:O}=_;A.forEach(D=>g("createAnnotation",D)),S.forEach(D=>g("deleteAnnotation",D)),w?O.forEach(D=>g("updateAnnotation",D.oldValue,D.newValue)):O.forEach(D=>g("updateAnnotation",D.newValue,D.oldValue))};return t.on("undo",T(!0)),t.on("redo",T(!1)),{on:h,off:d,emit:g}},bo=e=>t=>t.reduce((n,o)=>{const{parsed:i,error:s}=e.parse(o);return s?{parsed:n.parsed,failed:[...n.failed,o]}:{parsed:[...n.parsed,i],failed:n.failed}},{parsed:[],failed:[]}),Eo=(e,t,n)=>{const{store:o,selection:i}=e,s=T=>{if(n){const{parsed:w,error:_}=n.parse(T);w?o.addAnnotation(w,W.REMOTE):console.error(_)}else o.addAnnotation(T,W.REMOTE)},r=()=>i.clear(),a=()=>o.clear(),l=T=>{const w=o.getAnnotation(T);return n&&w?n.serialize(w):w},u=()=>n?o.all().map(n.serialize):o.all(),m=()=>{var T;const w=(((T=i.selected)==null?void 0:T.map(_=>_.id))||[]).map(_=>o.getAnnotation(_));return n?w.map(n.serialize):w},f=T=>fetch(T).then(w=>w.json()).then(w=>(d(w),w)),h=T=>{if(typeof T=="string"){const w=o.getAnnotation(T);return o.deleteAnnotation(T),n?n.serialize(w):w}else{const w=n?n.parse(T).parsed:T;return o.deleteAnnotation(w),T}},d=T=>{if(n){const{parsed:w,failed:_}=bo(n)(T);_.length>0&&console.warn(`Discarded ${_.length} invalid annotations`,_),o.bulkAddAnnotation(w,!0,W.REMOTE)}else o.bulkAddAnnotation(T,!0,W.REMOTE)},g=T=>{T?i.setSelected(T):i.clear()},b=T=>{if(n){const w=n.parse(T).parsed,_=n.serialize(o.getAnnotation(w.id));return o.updateAnnotation(w),_}else{const w=o.getAnnotation(T.id);return o.updateAnnotation(T),w}};return{addAnnotation:s,cancelSelected:r,canRedo:t.canRedo,canUndo:t.canUndo,clearAnnotations:a,getAnnotationById:l,getAnnotations:u,getSelected:m,loadAnnotations:f,redo:t.redo,removeAnnotation:h,setAnnotations:d,setSelected:g,undo:t.undo,updateAnnotation:b}};let Ao=e=>crypto.getRandomValues(new Uint8Array(e)),To=(e,t,n)=>{let o=(2<<Math.log(e.length-1)/Math.LN2)-1,i=-~(1.6*o*t/e.length);return(s=t)=>{let r="";for(;;){let a=n(i),l=i;for(;l--;)if(r+=e[a[l]&o]||"",r.length===s)return r}}},So=(e,t=21)=>To(e,t,Ao),Mo=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((t,n)=>(n&=63,n<36?t+=n.toString(36):n<62?t+=(n-26).toString(36).toUpperCase():n>62?t+="-":t+="_",t),"");const Lo=()=>({isGuest:!0,id:So("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",20)()}),Oo=e=>{const t=JSON.stringify(e);let n=0;for(let o=0,i=t.length;o<i;o++){let s=t.charCodeAt(o);n=(n<<5)-n+s,n|=0}return`${n}`},Gt=e=>e?typeof e=="object"?{...e}:e:void 0,vo=(e,t)=>(Array.isArray(e)?e:[e]).map(n=>{const{id:o,type:i,purpose:s,value:r,created:a,creator:l,...u}=n;return{id:o||`temp-${Oo(n)}`,annotation:t,type:i,purpose:s,value:r,created:a?new Date(a):void 0,creator:Gt(l),...u}}),Io=e=>e.map(t=>{var n;const o={...t};return delete o.annotation,(n=o.id)!=null&&n.startsWith("temp-")&&delete o.id,o});Mo();const ko=(e,t=!1)=>({parse:i=>Ht(i,t),serialize:i=>Ft(i,e)}),Ht=(e,t=!1)=>{const n=e.id||Ct(),{creator:o,created:i,updatedBy:s,updated:r,body:a,...l}=e,u=vo(a,n),m=Array.isArray(e.target)?e.target[0]:e.target,f=Array.isArray(m.selector)?m.selector[0]:m.selector,h=f.type==="FragmentSelector"?kt(f,t):f.type==="SvgSelector"?Dt(f):void 0;return h?{parsed:{...l,id:n,bodies:u,target:{created:i?new Date(i):void 0,creator:Gt(o),...l.target,annotation:n,selector:h}}}:{error:Error(`Unknown selector type: ${f.type}`)}},Ft=(e,t)=>{const{selector:n,creator:o,created:i,updated:s,updatedBy:r,...a}=e.target,l=n.type==K.RECTANGLE?Pt(n.geometry):Rt(n);return{...e,"@context":"http://www.w3.org/ns/anno.jsonld",id:e.id,type:"Annotation",body:Io(e.bodies),creator:o,created:i==null?void 0:i.toISOString(),target:{...a,source:t,selector:l}}};function zt(e,t,n){const o=e.slice();return o[11]=t[n],o[13]=n,o}function jt(e){let t,n,o,i,s;return{c(){t=X("rect"),c(t,"class","a9s-corner-handle"),c(t,"x",n=e[11][0]-e[3]/2),c(t,"y",o=e[11][1]-e[3]/2),c(t,"height",e[3]),c(t,"width",e[3])},m(r,a){I(r,t,a),i||(s=z(t,"pointerdown",function(){F(e[10](M(e[13])))&&e[10](M(e[13])).apply(this,arguments)}),i=!0)},p(r,a){e=r,a&24&&n!==(n=e[11][0]-e[3]/2)&&c(t,"x",n),a&24&&o!==(o=e[11][1]-e[3]/2)&&c(t,"y",o),a&8&&c(t,"height",e[3]),a&8&&c(t,"width",e[3])},d(r){r&&v(t),i=!1,s()}}}function Po(e){let t,n,o,i,s,r,a,l,u,m,f=Te(e[4].points),h=[];for(let d=0;d<f.length;d+=1)h[d]=jt(zt(e,f,d));return{c(){t=X("polygon"),i=x(),s=X("polygon"),a=x();for(let d=0;d<h.length;d+=1)h[d].c();l=se(),c(t,"class","a9s-outer"),c(t,"style",n=e[1]?"display:none;":void 0),c(t,"points",o=e[4].points.map(Kt).join(" ")),c(s,"class","a9s-inner a9s-shape-handle"),c(s,"style",e[1]),c(s,"points",r=e[4].points.map(Wt).join(" "))},m(d,g){I(d,t,g),I(d,i,g),I(d,s,g),I(d,a,g);for(let b=0;b<h.length;b+=1)h[b]&&h[b].m(d,g);I(d,l,g),u||(m=[z(t,"pointerdown",function(){F(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)}),z(s,"pointerdown",function(){F(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)})],u=!0)},p(d,g){if(e=d,g&2&&n!==(n=e[1]?"display:none;":void 0)&&c(t,"style",n),g&16&&o!==(o=e[4].points.map(Kt).join(" "))&&c(t,"points",o),g&2&&c(s,"style",e[1]),g&16&&r!==(r=e[4].points.map(Wt).join(" "))&&c(s,"points",r),g&1048){f=Te(e[4].points);let b;for(b=0;b<f.length;b+=1){const T=zt(e,f,b);h[b]?h[b].p(T,g):(h[b]=jt(T),h[b].c(),h[b].m(l.parentNode,l))}for(;b<h.length;b+=1)h[b].d(1);h.length=f.length}},d(d){d&&(v(t),v(i),v(s),v(a),v(l)),xe(h,d),u=!1,ie(m)}}}function Bo(e){let t,n;return t=new He({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[Po,({grab:o})=>({10:o}),({grab:o})=>o?1024:0]},$$scope:{ctx:e}}}),t.$on("change",e[7]),t.$on("grab",e[8]),t.$on("release",e[9]),{c(){de(t.$$.fragment)},m(o,i){ce(t,o,i),n=!0},p(o,[i]){const s={};i&1&&(s.shape=o[0]),i&4&&(s.transform=o[2]),i&17434&&(s.$$scope={dirty:i,ctx:o}),t.$set(s)},i(o){n||(V(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){fe(t,o)}}}const Kt=e=>e.join(","),Wt=e=>e.join(",");function Yo(e,t,n){let o,i,{shape:s}=t,{computedStyle:r=void 0}=t,{transform:a}=t,{viewportScale:l=1}=t;const u=(d,g,b)=>{let T;g===M.SHAPE?T=d.geometry.points.map(([_,A])=>[_+b[0],A+b[1]]):T=d.geometry.points.map(([_,A],S)=>g===M(S)?[_+b[0],A+b[1]]:[_,A]);const w=Be(T);return{...d,geometry:{points:T,bounds:w}}};function m(d){re.call(this,e,d)}function f(d){re.call(this,e,d)}function h(d){re.call(this,e,d)}return e.$$set=d=>{"shape"in d&&n(0,s=d.shape),"computedStyle"in d&&n(1,r=d.computedStyle),"transform"in d&&n(2,a=d.transform),"viewportScale"in d&&n(6,l=d.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=s.geometry),e.$$.dirty&64&&n(3,i=10/l)},[s,r,a,i,o,u,l,m,f,h]}class qt extends te{constructor(t){super(),ee(this,t,Yo,Bo,Z,{shape:0,computedStyle:1,transform:2,viewportScale:6})}}function Do(e){let t,n,o,i,s,r,a,l,u,m,f,h,d,g,b,T,w,_,A,S,O,D,U,y,p,E,L,P,C,G,R,ve,Ce,Y,$,q,ye,J,_e,We,mt,ne,qe,Je,gt,oe,Ze,Qe,pt,Pn;return{c(){t=X("rect"),a=x(),l=X("rect"),d=x(),g=X("rect"),_=x(),A=X("rect"),U=x(),y=X("rect"),P=x(),C=X("rect"),Ce=x(),Y=X("rect"),ye=x(),J=X("rect"),mt=x(),ne=X("rect"),gt=x(),oe=X("rect"),c(t,"class","a9s-outer"),c(t,"style",n=e[1]?"display:none;":void 0),c(t,"x",o=e[4].x),c(t,"y",i=e[4].y),c(t,"width",s=e[4].w),c(t,"height",r=e[4].h),c(l,"class","a9s-inner a9s-shape-handle"),c(l,"style",e[1]),c(l,"x",u=e[4].x),c(l,"y",m=e[4].y),c(l,"width",f=e[4].w),c(l,"height",h=e[4].h),c(g,"class","a9s-edge-handle a9s-edge-handle-top"),c(g,"x",b=e[4].x),c(g,"y",T=e[4].y),c(g,"height",1),c(g,"width",w=e[4].w),c(A,"class","a9s-edge-handle a9s-edge-handle-right"),c(A,"x",S=e[4].x+e[4].w),c(A,"y",O=e[4].y),c(A,"height",D=e[4].h),c(A,"width",1),c(y,"class","a9s-edge-handle a9s-edge-handle-bottom"),c(y,"x",p=e[4].x),c(y,"y",E=e[4].y+e[4].h),c(y,"height",1),c(y,"width",L=e[4].w),c(C,"class","a9s-edge-handle a9s-edge-handle-left"),c(C,"x",G=e[4].x),c(C,"y",R=e[4].y),c(C,"height",ve=e[4].h),c(C,"width",1),c(Y,"class","a9s-corner-handle a9s-corner-handle-topleft"),c(Y,"x",$=e[4].x-e[3]/2),c(Y,"y",q=e[4].y-e[3]/2),c(Y,"height",e[3]),c(Y,"width",e[3]),c(J,"class","a9s-corner-handle a9s-corner-handle-topright"),c(J,"x",_e=e[4].x+e[4].w-e[3]/2),c(J,"y",We=e[4].y-e[3]/2),c(J,"height",e[3]),c(J,"width",e[3]),c(ne,"class","a9s-corner-handle a9s-corner-handle-bottomright"),c(ne,"x",qe=e[4].x+e[4].w-e[3]/2),c(ne,"y",Je=e[4].y+e[4].h-e[3]/2),c(ne,"height",e[3]),c(ne,"width",e[3]),c(oe,"class","a9s-corner-handle a9s-corner-handle-bottomleft"),c(oe,"x",Ze=e[4].x-e[3]/2),c(oe,"y",Qe=e[4].y+e[4].h-e[3]/2),c(oe,"height",e[3]),c(oe,"width",e[3])},m(j,k){I(j,t,k),I(j,a,k),I(j,l,k),I(j,d,k),I(j,g,k),I(j,_,k),I(j,A,k),I(j,U,k),I(j,y,k),I(j,P,k),I(j,C,k),I(j,Ce,k),I(j,Y,k),I(j,ye,k),I(j,J,k),I(j,mt,k),I(j,ne,k),I(j,gt,k),I(j,oe,k),pt||(Pn=[z(t,"pointerdown",function(){F(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)}),z(l,"pointerdown",function(){F(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)}),z(g,"pointerdown",function(){F(e[10](M.TOP))&&e[10](M.TOP).apply(this,arguments)}),z(A,"pointerdown",function(){F(e[10](M.RIGHT))&&e[10](M.RIGHT).apply(this,arguments)}),z(y,"pointerdown",function(){F(e[10](M.BOTTOM))&&e[10](M.BOTTOM).apply(this,arguments)}),z(C,"pointerdown",function(){F(e[10](M.LEFT))&&e[10](M.LEFT).apply(this,arguments)}),z(Y,"pointerdown",function(){F(e[10](M.TOP_LEFT))&&e[10](M.TOP_LEFT).apply(this,arguments)}),z(J,"pointerdown",function(){F(e[10](M.TOP_RIGHT))&&e[10](M.TOP_RIGHT).apply(this,arguments)}),z(ne,"pointerdown",function(){F(e[10](M.BOTTOM_RIGHT))&&e[10](M.BOTTOM_RIGHT).apply(this,arguments)}),z(oe,"pointerdown",function(){F(e[10](M.BOTTOM_LEFT))&&e[10](M.BOTTOM_LEFT).apply(this,arguments)})],pt=!0)},p(j,k){e=j,k&2&&n!==(n=e[1]?"display:none;":void 0)&&c(t,"style",n),k&16&&o!==(o=e[4].x)&&c(t,"x",o),k&16&&i!==(i=e[4].y)&&c(t,"y",i),k&16&&s!==(s=e[4].w)&&c(t,"width",s),k&16&&r!==(r=e[4].h)&&c(t,"height",r),k&2&&c(l,"style",e[1]),k&16&&u!==(u=e[4].x)&&c(l,"x",u),k&16&&m!==(m=e[4].y)&&c(l,"y",m),k&16&&f!==(f=e[4].w)&&c(l,"width",f),k&16&&h!==(h=e[4].h)&&c(l,"height",h),k&16&&b!==(b=e[4].x)&&c(g,"x",b),k&16&&T!==(T=e[4].y)&&c(g,"y",T),k&16&&w!==(w=e[4].w)&&c(g,"width",w),k&16&&S!==(S=e[4].x+e[4].w)&&c(A,"x",S),k&16&&O!==(O=e[4].y)&&c(A,"y",O),k&16&&D!==(D=e[4].h)&&c(A,"height",D),k&16&&p!==(p=e[4].x)&&c(y,"x",p),k&16&&E!==(E=e[4].y+e[4].h)&&c(y,"y",E),k&16&&L!==(L=e[4].w)&&c(y,"width",L),k&16&&G!==(G=e[4].x)&&c(C,"x",G),k&16&&R!==(R=e[4].y)&&c(C,"y",R),k&16&&ve!==(ve=e[4].h)&&c(C,"height",ve),k&24&&$!==($=e[4].x-e[3]/2)&&c(Y,"x",$),k&24&&q!==(q=e[4].y-e[3]/2)&&c(Y,"y",q),k&8&&c(Y,"height",e[3]),k&8&&c(Y,"width",e[3]),k&24&&_e!==(_e=e[4].x+e[4].w-e[3]/2)&&c(J,"x",_e),k&24&&We!==(We=e[4].y-e[3]/2)&&c(J,"y",We),k&8&&c(J,"height",e[3]),k&8&&c(J,"width",e[3]),k&24&&qe!==(qe=e[4].x+e[4].w-e[3]/2)&&c(ne,"x",qe),k&24&&Je!==(Je=e[4].y+e[4].h-e[3]/2)&&c(ne,"y",Je),k&8&&c(ne,"height",e[3]),k&8&&c(ne,"width",e[3]),k&24&&Ze!==(Ze=e[4].x-e[3]/2)&&c(oe,"x",Ze),k&24&&Qe!==(Qe=e[4].y+e[4].h-e[3]/2)&&c(oe,"y",Qe),k&8&&c(oe,"height",e[3]),k&8&&c(oe,"width",e[3])},d(j){j&&(v(t),v(a),v(l),v(d),v(g),v(_),v(A),v(U),v(y),v(P),v(C),v(Ce),v(Y),v(ye),v(J),v(mt),v(ne),v(gt),v(oe)),pt=!1,ie(Pn)}}}function Ro(e){let t,n;return t=new He({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[Do,({grab:o})=>({10:o}),({grab:o})=>o?1024:0]},$$scope:{ctx:e}}}),t.$on("grab",e[7]),t.$on("change",e[8]),t.$on("release",e[9]),{c(){de(t.$$.fragment)},m(o,i){ce(t,o,i),n=!0},p(o,[i]){const s={};i&1&&(s.shape=o[0]),i&4&&(s.transform=o[2]),i&3098&&(s.$$scope={dirty:i,ctx:o}),t.$set(s)},i(o){n||(V(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){fe(t,o)}}}function Xo(e,t,n){let o,i,{shape:s}=t,{computedStyle:r=void 0}=t,{transform:a}=t,{viewportScale:l=1}=t;const u=(d,g,b)=>{const T=d.geometry.bounds;let[w,_]=[T.minX,T.minY],[A,S]=[T.maxX,T.maxY];const[O,D]=b;if(g===M.SHAPE)w+=O,A+=O,_+=D,S+=D;else{switch(g){case M.TOP:case M.TOP_LEFT:case M.TOP_RIGHT:{_+=D;break}case M.BOTTOM:case M.BOTTOM_LEFT:case M.BOTTOM_RIGHT:{S+=D;break}}switch(g){case M.LEFT:case M.TOP_LEFT:case M.BOTTOM_LEFT:{w+=O;break}case M.RIGHT:case M.TOP_RIGHT:case M.BOTTOM_RIGHT:{A+=O;break}}}const U=Math.min(w,A),y=Math.min(_,S),p=Math.abs(A-w),E=Math.abs(S-_);return{...d,geometry:{x:U,y,w:p,h:E,bounds:{minX:U,minY:y,maxX:U+p,maxY:y+E}}}};function m(d){re.call(this,e,d)}function f(d){re.call(this,e,d)}function h(d){re.call(this,e,d)}return e.$$set=d=>{"shape"in d&&n(0,s=d.shape),"computedStyle"in d&&n(1,r=d.computedStyle),"transform"in d&&n(2,a=d.transform),"viewportScale"in d&&n(6,l=d.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=s.geometry),e.$$.dirty&64&&n(3,i=10/l)},[s,r,a,i,o,u,l,m,f,h]}class Jt extends te{constructor(t){super(),ee(this,t,Xo,Ro,Z,{shape:0,computedStyle:1,transform:2,viewportScale:6})}}function Co(e){let t,n,o,i,s,r,a,l,u,m,f,h,d,g,b,T,w,_,A,S,O,D,U,y,p,E,L,P,C;return{c(){t=X("ellipse"),r=x(),a=X("ellipse"),h=x(),d=X("rect"),T=x(),w=X("rect"),S=x(),O=X("rect"),y=x(),p=X("rect"),c(t,"class","a9s-outer"),c(t,"cx",n=e[3].cx),c(t,"cy",o=e[3].cy),c(t,"rx",i=e[3].rx),c(t,"ry",s=e[3].ry),c(a,"class","a9s-inner a9s-shape-handle"),c(a,"cx",l=e[3].cx),c(a,"cy",u=e[3].cy),c(a,"rx",m=e[3].rx),c(a,"ry",f=e[3].ry),c(d,"class","a9s-corner-handle a9s-corner-top"),c(d,"x",g=e[3].cx-e[2]/2),c(d,"y",b=e[3].cy-e[2]/2-e[3].ry),c(d,"height",e[2]),c(d,"width",e[2]),c(w,"class","a9s-corner-handle a9s-corner-handle-right"),c(w,"x",_=e[3].cx+e[3].rx-e[2]/2),c(w,"y",A=e[3].cy-e[2]/2),c(w,"height",e[2]),c(w,"width",e[2]),c(O,"class","a9s-corner-handle a9s-corner-handle-bottom"),c(O,"x",D=e[3].cx-e[2]/2),c(O,"y",U=e[3].cy+e[3].ry-e[2]/2),c(O,"height",e[2]),c(O,"width",e[2]),c(p,"class","a9s-corner-handle a9s-corner-handle-left"),c(p,"x",E=e[3].cx-e[3].rx-e[2]/2),c(p,"y",L=e[3].cy-e[2]/2),c(p,"height",e[2]),c(p,"width",e[2])},m(G,R){I(G,t,R),I(G,r,R),I(G,a,R),I(G,h,R),I(G,d,R),I(G,T,R),I(G,w,R),I(G,S,R),I(G,O,R),I(G,y,R),I(G,p,R),P||(C=[z(t,"pointerdown",function(){F(e[9](M.SHAPE))&&e[9](M.SHAPE).apply(this,arguments)}),z(a,"pointerdown",function(){F(e[9](M.SHAPE))&&e[9](M.SHAPE).apply(this,arguments)}),z(d,"pointerdown",function(){F(e[9](M.TOP))&&e[9](M.TOP).apply(this,arguments)}),z(w,"pointerdown",function(){F(e[9](M.RIGHT))&&e[9](M.RIGHT).apply(this,arguments)}),z(O,"pointerdown",function(){F(e[9](M.BOTTOM))&&e[9](M.BOTTOM).apply(this,arguments)}),z(p,"pointerdown",function(){F(e[9](M.LEFT))&&e[9](M.LEFT).apply(this,arguments)})],P=!0)},p(G,R){e=G,R&8&&n!==(n=e[3].cx)&&c(t,"cx",n),R&8&&o!==(o=e[3].cy)&&c(t,"cy",o),R&8&&i!==(i=e[3].rx)&&c(t,"rx",i),R&8&&s!==(s=e[3].ry)&&c(t,"ry",s),R&8&&l!==(l=e[3].cx)&&c(a,"cx",l),R&8&&u!==(u=e[3].cy)&&c(a,"cy",u),R&8&&m!==(m=e[3].rx)&&c(a,"rx",m),R&8&&f!==(f=e[3].ry)&&c(a,"ry",f),R&12&&g!==(g=e[3].cx-e[2]/2)&&c(d,"x",g),R&12&&b!==(b=e[3].cy-e[2]/2-e[3].ry)&&c(d,"y",b),R&4&&c(d,"height",e[2]),R&4&&c(d,"width",e[2]),R&12&&_!==(_=e[3].cx+e[3].rx-e[2]/2)&&c(w,"x",_),R&12&&A!==(A=e[3].cy-e[2]/2)&&c(w,"y",A),R&4&&c(w,"height",e[2]),R&4&&c(w,"width",e[2]),R&12&&D!==(D=e[3].cx-e[2]/2)&&c(O,"x",D),R&12&&U!==(U=e[3].cy+e[3].ry-e[2]/2)&&c(O,"y",U),R&4&&c(O,"height",e[2]),R&4&&c(O,"width",e[2]),R&12&&E!==(E=e[3].cx-e[3].rx-e[2]/2)&&c(p,"x",E),R&12&&L!==(L=e[3].cy-e[2]/2)&&c(p,"y",L),R&4&&c(p,"height",e[2]),R&4&&c(p,"width",e[2])},d(G){G&&(v(t),v(r),v(a),v(h),v(d),v(T),v(w),v(S),v(O),v(y),v(p)),P=!1,ie(C)}}}function Uo(e){let t,n;return t=new He({props:{shape:e[0],transform:e[1],editor:e[4],$$slots:{default:[Co,({grab:o})=>({9:o}),({grab:o})=>o?512:0]},$$scope:{ctx:e}}}),t.$on("grab",e[6]),t.$on("change",e[7]),t.$on("release",e[8]),{c(){de(t.$$.fragment)},m(o,i){ce(t,o,i),n=!0},p(o,[i]){const s={};i&1&&(s.shape=o[0]),i&2&&(s.transform=o[1]),i&1548&&(s.$$scope={dirty:i,ctx:o}),t.$set(s)},i(o){n||(V(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){fe(t,o)}}}function No(e,t,n){let o,i,{shape:s}=t,{transform:r}=t,{viewportScale:a=1}=t;const l=(h,d,g)=>{const b=h.geometry.bounds;let[T,w]=[b.minX,b.minY],[_,A]=[b.maxX,b.maxY];const[S,O]=g;if(d===M.SHAPE)T+=S,_+=S,w+=O,A+=O;else switch(d){case M.TOP:{w+=O;break}case M.BOTTOM:{A+=O;break}case M.LEFT:{T+=S;break}case M.RIGHT:{_+=S;break}}const D=Math.min(T,_),U=Math.min(w,A),y=Math.abs(_-T),p=Math.abs(A-w),E=(T+_)/2,L=(w+A)/2,P=y/2,C=p/2;return{...h,geometry:{...h.geometry,cx:E,cy:L,rx:P,ry:C,bounds:{minX:D,minY:U,maxX:D+y,maxY:U+p}}}};function u(h){re.call(this,e,h)}function m(h){re.call(this,e,h)}function f(h){re.call(this,e,h)}return e.$$set=h=>{"shape"in h&&n(0,s=h.shape),"transform"in h&&n(1,r=h.transform),"viewportScale"in h&&n(5,a=h.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(3,o=s.geometry),e.$$.dirty&32&&n(2,i=10/a)},[s,r,i,o,l,a,u,m,f]}class Zt extends te{constructor(t){super(),ee(this,t,No,Uo,Z,{shape:0,transform:1,viewportScale:5})}}const Qt=new Map([[K.RECTANGLE,Jt],[K.POLYGON,qt],[K.ELLIPSE,Zt]]),rt=e=>Qt.get(e.type),xt=(e,t)=>Qt.set(e,t),M=e=>`HANDLE-${e}`;M.SHAPE="SHAPE",M.TOP="TOP",M.RIGHT="RIGHT",M.BOTTOM="BOTTOM",M.LEFT="LEFT",M.TOP_LEFT="TOP_LEFT",M.TOP_RIGHT="TOP_RIGHT",M.BOTTOM_RIGHT="BOTTOM_RIGHT",M.BOTTOM_LEFT="BOTTOM_LEFT";const Vo=e=>({}),$t=e=>({grab:e[0]});function Go(e){let t,n,o,i;const s=e[7].default,r=Yn(s,e,e[6],$t);return{c(){t=X("g"),r&&r.c(),c(t,"class","a9s-annotation selected")},m(a,l){I(a,t,l),r&&r.m(t,null),n=!0,o||(i=[z(t,"pointerup",e[2]),z(t,"pointermove",e[1])],o=!0)},p(a,[l]){r&&r.p&&(!n||l&64)&&Rn(r,s,a,a[6],n?Dn(s,a[6],l,Vo):Xn(a[6]),$t)},i(a){n||(V(r,a),n=!0)},o(a){H(r,a),n=!1},d(a){a&&v(t),r&&r.d(a),o=!1,ie(i)}}}function Ho(e,t,n){let{$$slots:o={},$$scope:i}=t;const s=me();let{shape:r}=t,{editor:a}=t,{transform:l}=t,u=null,m,f=null;const h=b=>T=>{u=b,m=l.elementToImage(T.offsetX,T.offsetY),f=r,T.target.setPointerCapture(T.pointerId),s("grab")},d=b=>{if(u){const[T,w]=l.elementToImage(b.offsetX,b.offsetY),_=[T-m[0],w-m[1]];n(3,r=a(f,u,_)),s("change",r)}},g=b=>{b.target.releasePointerCapture(b.pointerId),u=null,f=r,s("release")};return e.$$set=b=>{"shape"in b&&n(3,r=b.shape),"editor"in b&&n(4,a=b.editor),"transform"in b&&n(5,l=b.transform),"$$scope"in b&&n(6,i=b.$$scope)},[h,d,g,r,a,l,i,o]}class He extends te{constructor(t){super(),ee(this,t,Ho,Go,Z,{shape:3,editor:4,transform:5})}}const Fe=(e,t)=>{const n=typeof t=="function"?t(e):t;if(n){const{fill:o,fillOpacity:i}=n;let s="";return o&&(s+=`fill:${o};stroke:${o};`),s+=`fill-opacity:${i||"0.25"};`,s}};function Fo(e,t,n){let o;const i=me();let{annotation:s}=t,{editor:r}=t,{style:a=void 0}=t,{target:l}=t,{transform:u}=t,{viewportScale:m}=t,f;return we(()=>(n(6,f=new r({target:l,props:{shape:s.target.selector,computedStyle:o,transform:u,viewportScale:m}})),f.$on("change",h=>{f.$$set({shape:h.detail}),i("change",h.detail)}),f.$on("grab",h=>i("grab",h.detail)),f.$on("release",h=>i("release",h.detail)),()=>{f.$destroy()})),e.$$set=h=>{"annotation"in h&&n(0,s=h.annotation),"editor"in h&&n(1,r=h.editor),"style"in h&&n(2,a=h.style),"target"in h&&n(3,l=h.target),"transform"in h&&n(4,u=h.transform),"viewportScale"in h&&n(5,m=h.viewportScale)},e.$$.update=()=>{e.$$.dirty&5&&(o=Fe(s,a)),e.$$.dirty&65&&s&&(f==null||f.$set({shape:s.target.selector})),e.$$.dirty&80&&f&&f.$set({transform:u}),e.$$.dirty&96&&f&&f.$set({viewportScale:m})},[s,r,a,l,u,m,f]}class en extends te{constructor(t){super(),ee(this,t,Fo,null,Z,{annotation:0,editor:1,style:2,target:3,transform:4,viewportScale:5})}}function zo(e,t,n){const o=me();let{drawingMode:i}=t,{target:s}=t,{tool:r}=t,{transform:a}=t,{viewportScale:l}=t,u;return we(()=>{const m=s.closest("svg"),f=[],h=(d,g,b)=>{m.addEventListener(d,g,b),f.push(()=>m.removeEventListener(d,g,b))};return n(5,u=new r({target:s,props:{addEventListener:h,drawingMode:i,transform:a,viewportScale:l}})),u.$on("create",d=>o("create",d.detail)),()=>{f.forEach(d=>d()),u.$destroy()}}),e.$$set=m=>{"drawingMode"in m&&n(0,i=m.drawingMode),"target"in m&&n(1,s=m.target),"tool"in m&&n(2,r=m.tool),"transform"in m&&n(3,a=m.transform),"viewportScale"in m&&n(4,l=m.viewportScale)},e.$$.update=()=>{e.$$.dirty&40&&u&&u.$set({transform:a}),e.$$.dirty&48&&u&&u.$set({viewportScale:l})},[i,s,r,a,l,u]}class tn extends te{constructor(t){super(),ee(this,t,zo,null,Z,{drawingMode:0,target:1,tool:2,transform:3,viewportScale:4})}}function nn(e){let t,n;return{c(){t=X("rect"),n=X("rect"),c(t,"class","a9s-outer"),c(t,"x",e[1]),c(t,"y",e[2]),c(t,"width",e[3]),c(t,"height",e[4]),c(n,"class","a9s-inner"),c(n,"x",e[1]),c(n,"y",e[2]),c(n,"width",e[3]),c(n,"height",e[4])},m(o,i){I(o,t,i),I(o,n,i)},p(o,i){i&2&&c(t,"x",o[1]),i&4&&c(t,"y",o[2]),i&8&&c(t,"width",o[3]),i&16&&c(t,"height",o[4]),i&2&&c(n,"x",o[1]),i&4&&c(n,"y",o[2]),i&8&&c(n,"width",o[3]),i&16&&c(n,"height",o[4])},d(o){o&&(v(t),v(n))}}}function jo(e){let t,n=e[0]&&nn(e);return{c(){t=X("g"),n&&n.c(),c(t,"class","a9s-annotation a9s-rubberband")},m(o,i){I(o,t,i),n&&n.m(t,null)},p(o,[i]){o[0]?n?n.p(o,i):(n=nn(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:N,o:N,d(o){o&&v(t),n&&n.d()}}}function Ko(e,t,n){const o=me();let{addEventListener:i}=t,{drawingMode:s}=t,{transform:r}=t,a,l,u,m,f,h,d;const g=_=>{a=performance.now(),s==="drag"&&(n(0,l=r.elementToImage(_.offsetX,_.offsetY)),u=l,n(1,m=l[0]),n(2,f=l[1]),n(3,h=1),n(4,d=1))},b=_=>{l&&(u=r.elementToImage(_.offsetX,_.offsetY),n(1,m=Math.min(u[0],l[0])),n(2,f=Math.min(u[1],l[1])),n(3,h=Math.abs(u[0]-l[0])),n(4,d=Math.abs(u[1]-l[1])))},T=_=>{const A=performance.now()-a;if(s==="click"){if(A>300)return;_.stopPropagation(),l?w():(n(0,l=r.elementToImage(_.offsetX,_.offsetY)),u=l,n(1,m=l[0]),n(2,f=l[1]),n(3,h=1),n(4,d=1))}else l&&(A>300||h*d>100?(_.stopPropagation(),w()):(n(0,l=null),u=null))},w=()=>{if(h*d>15){const _={type:K.RECTANGLE,geometry:{bounds:{minX:m,minY:f,maxX:m+h,maxY:f+d},x:m,y:f,w:h,h:d}};o("create",_)}n(0,l=null),u=null};return we(()=>{i("pointerdown",g),i("pointermove",b),i("pointerup",T,!0)}),e.$$set=_=>{"addEventListener"in _&&n(5,i=_.addEventListener),"drawingMode"in _&&n(6,s=_.drawingMode),"transform"in _&&n(7,r=_.transform)},[l,m,f,h,d,i,s,r]}class on extends te{constructor(t){super(),ee(this,t,Ko,jo,Z,{addEventListener:5,drawingMode:6,transform:7})}}const ze=(e,t)=>{const n=Math.abs(t[0]-e[0]),o=Math.abs(t[1]-e[1]);return Math.sqrt(Math.pow(n,2)+Math.pow(o,2))},Me=[];function Wo(e,t=N){let n;const o=new Set;function i(a){if(Z(e,a)&&(e=a,n)){const l=!Me.length;for(const u of o)u[1](),Me.push(u,e);if(l){for(let u=0;u<Me.length;u+=2)Me[u][0](Me[u+1]);Me.length=0}}}function s(a){i(a(e))}function r(a,l=N){const u=[a,l];return o.add(u),o.size===1&&(n=t(i,s)||N),a(e),()=>{o.delete(u),o.size===0&&n&&(n(),n=null)}}return{set:i,update:s,subscribe:r}}const qo=(e,t)=>{const{naturalWidth:n,naturalHeight:o}=e;if(!n&&!o){const{width:i,height:s}=e;t.setAttribute("viewBox",`0 0 ${i} ${s}`),e.addEventListener("load",r=>{const a=r.target;t.setAttribute("viewBox",`0 0 ${a.naturalWidth} ${a.naturalHeight}`)})}else t.setAttribute("viewBox",`0 0 ${n} ${o}`)},sn=(e,t)=>{qo(e,t);const{subscribe:n,set:o}=Wo(1);let i;return window.ResizeObserver&&(i=new ResizeObserver(()=>{const r=t.getBoundingClientRect(),{width:a,height:l}=t.viewBox.baseVal,u=Math.max(r.width/a,r.height/l);o(u)}),i.observe(t.parentElement)),{destroy:()=>{i&&i.disconnect()},subscribe:n}},Jo="ontouchstart"in window||navigator.maxTouchPoints>0;function lt(e){const t=e.slice(),n=(t[2]?t[0]:[...t[0],t[1]]).map(o=>o.join(",")).join(" ");return t[15]=n,t}function rn(e){let t,n,o,i,s,r=e[2]&&ln(e);return{c(){t=X("polygon"),o=X("polygon"),r&&r.c(),s=se(),c(t,"class","a9s-outer"),c(t,"points",n=e[15]),c(o,"class","a9s-inner"),c(o,"points",i=e[15])},m(a,l){I(a,t,l),I(a,o,l),r&&r.m(a,l),I(a,s,l)},p(a,l){l&7&&n!==(n=a[15])&&c(t,"points",n),l&7&&i!==(i=a[15])&&c(o,"points",i),a[2]?r?r.p(a,l):(r=ln(a),r.c(),r.m(s.parentNode,s)):r&&(r.d(1),r=null)},d(a){a&&(v(t),v(o),v(s)),r&&r.d(a)}}}function ln(e){let t,n,o;return{c(){t=X("rect"),c(t,"class","a9s-corner-handle"),c(t,"x",n=e[0][0][0]-e[3]/2),c(t,"y",o=e[0][0][1]-e[3]/2),c(t,"height",e[3]),c(t,"width",e[3])},m(i,s){I(i,t,s)},p(i,s){s&9&&n!==(n=i[0][0][0]-i[3]/2)&&c(t,"x",n),s&9&&o!==(o=i[0][0][1]-i[3]/2)&&c(t,"y",o),s&8&&c(t,"height",i[3]),s&8&&c(t,"width",i[3])},d(i){i&&v(t)}}}function Zo(e){let t,n=e[1]&&rn(lt(e));return{c(){t=X("g"),n&&n.c(),c(t,"class","a9s-annotation a9s-rubberband")},m(o,i){I(o,t,i),n&&n.m(t,null)},p(o,[i]){o[1]?n?n.p(lt(o),i):(n=rn(lt(o)),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:N,o:N,d(o){o&&v(t),n&&n.d()}}}const Qo=20;function xo(e,t,n){let o;const i=me();let{addEventListener:s}=t,{drawingMode:r}=t,{transform:a}=t,{viewportScale:l=1}=t,u,m=[],f=null,h=!1;const d=_=>{const{timeStamp:A,offsetX:S,offsetY:O}=_;if(u={timeStamp:A,offsetX:S,offsetY:O},r==="drag"&&m.length===0){const D=a.elementToImage(_.offsetX,_.offsetY);m.push(D),n(1,f=D)}},g=_=>{if(m.length>0&&(n(1,f=a.elementToImage(_.offsetX,_.offsetY)),m.length>2)){const A=ze(f,m[0])*l;n(2,h=A<Qo)}},b=_=>{if(r==="click"){const A=_.timeStamp-u.timeStamp,S=ze([u.offsetX,u.offsetY],[_.offsetX,_.offsetY]);if(A>300||S>15)return;if(h)w();else if(m.length===0){const O=a.elementToImage(_.offsetX,_.offsetY);m.push(O),n(1,f=O)}else m.push(f)}else{if(m.length===1&&ze(m[0],f)<=4){n(0,m=[]),n(1,f=null);return}_.stopImmediatePropagation(),h?w():m.push(f)}},T=()=>{const _=[...m,f],A={type:K.POLYGON,geometry:{bounds:Be(_),points:_}};Ve(A)>4&&(n(0,m=[]),n(1,f=null),i("create",A))},w=()=>{const _={type:K.POLYGON,geometry:{bounds:Be(m),points:[...m]}};n(0,m=[]),n(1,f=null),i("create",_)};return we(()=>{s("pointerdown",d,!0),s("pointermove",g),s("pointerup",b,!0),s("dblclick",T,!0)}),e.$$set=_=>{"addEventListener"in _&&n(4,s=_.addEventListener),"drawingMode"in _&&n(5,r=_.drawingMode),"transform"in _&&n(6,a=_.transform),"viewportScale"in _&&n(7,l=_.viewportScale)},e.$$.update=()=>{e.$$.dirty&128&&n(3,o=10/l)},[m,f,h,o,s,r,a,l]}class $o extends te{constructor(t){super(),ee(this,t,xo,Zo,Z,{addEventListener:4,drawingMode:5,transform:6,viewportScale:7})}}function an(e){let t,n,o,i,s,r,a,l,u,m;return{c(){t=X("ellipse"),r=X("ellipse"),c(t,"class","a9s-outer"),c(t,"cx",n=e[2]+e[4]/2),c(t,"cy",o=e[3]+e[5]/2),c(t,"rx",i=e[4]/2),c(t,"ry",s=e[5]/2),c(r,"class","a9s-inner"),c(r,"cx",a=e[2]+e[4]/2),c(r,"cy",l=e[3]+e[5]/2),c(r,"rx",u=e[4]/2),c(r,"ry",m=e[5]/2)},m(f,h){I(f,t,h),I(f,r,h)},p(f,h){h&20&&n!==(n=f[2]+f[4]/2)&&c(t,"cx",n),h&40&&o!==(o=f[3]+f[5]/2)&&c(t,"cy",o),h&16&&i!==(i=f[4]/2)&&c(t,"rx",i),h&32&&s!==(s=f[5]/2)&&c(t,"ry",s),h&20&&a!==(a=f[2]+f[4]/2)&&c(r,"cx",a),h&40&&l!==(l=f[3]+f[5]/2)&&c(r,"cy",l),h&16&&u!==(u=f[4]/2)&&c(r,"rx",u),h&32&&m!==(m=f[5]/2)&&c(r,"ry",m)},d(f){f&&(v(t),v(r))}}}function ei(e){let t,n=e[1]&&an(e);return{c(){t=X("g"),n&&n.c(),c(t,"class","a9s-annotation a9s-rubberband")},m(o,i){I(o,t,i),n&&n.m(t,null),e[9](t)},p(o,[i]){o[1]?n?n.p(o,i):(n=an(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:N,o:N,d(o){o&&v(t),n&&n.d(),e[9](null)}}}function ti(e,t,n){const o=me();let{addEventListener:i}=t,{drawingMode:s}=t,{transform:r}=t,a,l,u,m,f,h,d,g=!1,b=!1,T,w;const _=p=>{T=performance.now(),s==="drag"&&(n(1,l=r.elementToImage(p.offsetX,p.offsetY)),u=l,n(2,m=l[0]),n(3,f=l[1]),n(4,h=1),n(5,d=1))},A=p=>{const E=p||w;if(l)if(u=r.elementToImage(E.offsetX,E.offsetY),b){const L=2*Math.abs(u[0]-l[0]),P=2*Math.abs(u[1]-l[1]);n(4,h=g?Math.max(L,P):L),n(5,d=g?h:P),n(2,m=Math.min(u[0],l[0]-h/2)),n(3,f=Math.min(u[1],l[1]-d/2))}else{const L=Math.abs(u[0]-l[0]),P=Math.abs(u[1]-l[1]);n(4,h=g?Math.max(L,P):L),n(5,d=g?h:P),n(2,m=Math.min(u[0],l[0])),n(3,f=Math.min(u[1],l[1]))}p&&(w=p)},S=p=>{s==="click"&&p.stopImmediatePropagation();const E=performance.now()-T;if(s==="click"){if(E>300)return;p.stopPropagation(),l?O():(n(1,l=r.elementToImage(p.offsetX,p.offsetY)),u=l,n(2,m=l[0]),n(3,f=l[1]),n(4,h=1),n(5,d=1))}else l&&(E>300||h*d>100?(p.stopPropagation(),O()):(n(1,l=null),u=null,w=void 0))},O=()=>{if(h*d>15){const p={type:K.ELLIPSE,geometry:{bounds:{minX:m,minY:f,maxX:m+h,maxY:f+d},cx:m+h/2,cy:f+d/2,rx:h/2,ry:d/2}};o("create",p)}n(1,l=null),u=null,w=void 0},D=p=>{p.key==="Shift"&&(g=!0,A()),p.key==="Control"&&(b=!0,A())},U=p=>{p.key==="Shift"&&(g=!1,A()),p.key==="Control"&&(b=!1,A())};we(()=>(document.addEventListener("keyup",U),document.addEventListener("keydown",D),i("pointerdown",_),i("pointermove",A),i("pointerup",S),()=>{document.removeEventListener("keyup",U),document.removeEventListener("keydown",D)}));function y(p){Pe[p?"unshift":"push"](()=>{a=p,n(0,a)})}return e.$$set=p=>{"addEventListener"in p&&n(6,i=p.addEventListener),"drawingMode"in p&&n(7,s=p.drawingMode),"transform"in p&&n(8,r=p.transform)},[a,l,m,f,h,d,i,s,r,y]}class ni extends te{constructor(t){super(),ee(this,t,ti,ei,Z,{addEventListener:6,drawingMode:7,transform:8})}}const at=new Map([["rectangle",{tool:on}],["polygon",{tool:$o}],["ellipse",{tool:ni}]]),Ye=()=>[...at.keys()],ct=e=>at.get(e),cn=(e,t,n)=>at.set(e,{tool:t,opts:n});function oi(e){let t,n,o,i,s;return{c(){t=X("g"),n=X("ellipse"),i=X("ellipse"),c(n,"class","a9s-outer"),c(n,"style",o=e[1]?"display:none;":void 0),c(n,"cx",e[2]),c(n,"cy",e[3]),c(n,"rx",e[4]),c(n,"ry",e[5]),c(i,"class","a9s-inner"),c(i,"style",e[1]),c(i,"cx",e[2]),c(i,"cy",e[3]),c(i,"rx",e[4]),c(i,"ry",e[5]),c(t,"data-id",s=e[0].id)},m(r,a){I(r,t,a),ue(t,n),ue(t,i)},p(r,[a]){a&2&&o!==(o=r[1]?"display:none;":void 0)&&c(n,"style",o),a&2&&c(i,"style",r[1]),a&1&&s!==(s=r[0].id)&&c(t,"data-id",s)},i:N,o:N,d(r){r&&v(t)}}}function ii(e,t,n){let o,{annotation:i}=t,{geom:s}=t,{style:r=void 0}=t;const{cx:a,cy:l,rx:u,ry:m}=s;return e.$$set=f=>{"annotation"in f&&n(0,i=f.annotation),"geom"in f&&n(6,s=f.geom),"style"in f&&n(7,r=f.style)},e.$$.update=()=>{e.$$.dirty&129&&n(1,o=Fe(i,r))},[i,o,a,l,u,m,s,r]}class si extends te{constructor(t){super(),ee(this,t,ii,oi,Z,{annotation:0,geom:6,style:7})}}function ri(e){let t,n,o,i,s;return{c(){t=X("g"),n=X("polygon"),i=X("polygon"),c(n,"class","a9s-outer"),c(n,"style",o=e[1]?"display:none;":void 0),c(n,"points",e[2].map(li).join(" ")),c(i,"class","a9s-inner"),c(i,"style",e[1]),c(i,"points",e[2].map(ai).join(" ")),c(t,"data-id",s=e[0].id)},m(r,a){I(r,t,a),ue(t,n),ue(t,i)},p(r,[a]){a&2&&o!==(o=r[1]?"display:none;":void 0)&&c(n,"style",o),a&2&&c(i,"style",r[1]),a&1&&s!==(s=r[0].id)&&c(t,"data-id",s)},i:N,o:N,d(r){r&&v(t)}}}const li=e=>e.join(","),ai=e=>e.join(",");function ci(e,t,n){let o,{annotation:i}=t,{geom:s}=t,{style:r=void 0}=t;const{points:a}=s;return e.$$set=l=>{"annotation"in l&&n(0,i=l.annotation),"geom"in l&&n(3,s=l.geom),"style"in l&&n(4,r=l.style)},e.$$.update=()=>{e.$$.dirty&17&&n(1,o=Fe(i,r))},[i,o,a,s,r]}class fi extends te{constructor(t){super(),ee(this,t,ci,ri,Z,{annotation:0,geom:3,style:4})}}function ui(e){let t,n,o,i,s;return{c(){t=X("g"),n=X("rect"),i=X("rect"),c(n,"class","a9s-outer"),c(n,"style",o=e[5]?"display:none;":void 0),c(n,"x",e[4]),c(n,"y",e[3]),c(n,"width",e[2]),c(n,"height",e[1]),c(i,"class","a9s-inner"),c(i,"style",e[5]),c(i,"x",e[4]),c(i,"y",e[3]),c(i,"width",e[2]),c(i,"height",e[1]),c(t,"data-id",s=e[0].id)},m(r,a){I(r,t,a),ue(t,n),ue(t,i)},p(r,[a]){a&32&&o!==(o=r[5]?"display:none;":void 0)&&c(n,"style",o),a&16&&c(n,"x",r[4]),a&8&&c(n,"y",r[3]),a&4&&c(n,"width",r[2]),a&2&&c(n,"height",r[1]),a&32&&c(i,"style",r[5]),a&16&&c(i,"x",r[4]),a&8&&c(i,"y",r[3]),a&4&&c(i,"width",r[2]),a&2&&c(i,"height",r[1]),a&1&&s!==(s=r[0].id)&&c(t,"data-id",s)},i:N,o:N,d(r){r&&v(t)}}}function di(e,t,n){let o,i,s,r,a,{annotation:l}=t,{geom:u}=t,{style:m=void 0}=t;return e.$$set=f=>{"annotation"in f&&n(0,l=f.annotation),"geom"in f&&n(6,u=f.geom),"style"in f&&n(7,m=f.style)},e.$$.update=()=>{e.$$.dirty&129&&n(5,o=Fe(l,m)),e.$$.dirty&64&&n(4,{x:i,y:s,w:r,h:a}=u,i,(n(3,s),n(6,u)),(n(2,r),n(6,u)),(n(1,a),n(6,u)))},[l,a,r,s,i,o,u,m]}class hi extends te{constructor(t){super(),ee(this,t,di,ui,Z,{annotation:0,geom:6,style:7})}}const mi={elementToImage:(e,t)=>[e,t]},fn=e=>({elementToImage:(t,n)=>{const o=e.getBoundingClientRect(),i=e.createSVGPoint();i.x=t+o.x,i.y=n+o.y;const{x:s,y:r}=i.matrixTransform(e.getScreenCTM().inverse());return[s,r]}}),gi=250,un=(e,t)=>{const n=me();let o;return{onPointerDown:()=>o=performance.now(),onPointerUp:r=>{if(performance.now()-o<gi){const{x:l,y:u}=pi(r,e),m=t.getAt(l,u);m?n("click",{originalEvent:r,annotation:m}):n("click",{originalEvent:r})}}}},pi=(e,t)=>{const n=t.createSVGPoint(),o=t.getBoundingClientRect(),i=e.clientX-o.x,s=e.clientY-o.y,{left:r,top:a}=t.getBoundingClientRect();return n.x=i+r,n.y=s+a,n.matrixTransform(t.getScreenCTM().inverse())};function dn(e,t,n){const o=e.slice();return o[29]=t[n],o}function hn(e,t,n){const o=e.slice();return o[32]=t[n],o}function ft(e){const t=e.slice(),n=t[32].target.selector;return t[35]=n,t}function mn(e){let t=e[32].id,n,o,i=gn(e);return{c(){i.c(),n=se()},m(s,r){i.m(s,r),I(s,n,r),o=!0},p(s,r){r[0]&8192&&Z(t,t=s[32].id)?(le(),H(i,1,1,N),ae(),i=gn(s),i.c(),V(i,1),i.m(n.parentNode,n)):i.p(s,r)},i(s){o||(V(i),o=!0)},o(s){H(i),o=!1},d(s){s&&v(n),i.d(s)}}}function yi(e){let t,n;return t=new fi({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){de(t.$$.fragment)},m(o,i){ce(t,o,i),n=!0},p(o,i){const s={};i[0]&8192&&(s.annotation=o[32]),i[0]&8192&&(s.geom=o[35].geometry),i[0]&2&&(s.style=o[1]),t.$set(s)},i(o){n||(V(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){fe(t,o)}}}function _i(e){let t,n;return t=new hi({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){de(t.$$.fragment)},m(o,i){ce(t,o,i),n=!0},p(o,i){const s={};i[0]&8192&&(s.annotation=o[32]),i[0]&8192&&(s.geom=o[35].geometry),i[0]&2&&(s.style=o[1]),t.$set(s)},i(o){n||(V(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){fe(t,o)}}}function wi(e){let t,n;return t=new si({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){de(t.$$.fragment)},m(o,i){ce(t,o,i),n=!0},p(o,i){const s={};i[0]&8192&&(s.annotation=o[32]),i[0]&8192&&(s.geom=o[35].geometry),i[0]&2&&(s.style=o[1]),t.$set(s)},i(o){n||(V(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){fe(t,o)}}}function gn(e){let t,n,o,i;const s=[wi,_i,yi],r=[];function a(l,u){return l[35].type===K.ELLIPSE?0:l[35].type===K.RECTANGLE?1:l[35].type===K.POLYGON?2:-1}return~(t=a(e))&&(n=r[t]=s[t](e)),{c(){n&&n.c(),o=se()},m(l,u){~t&&r[t].m(l,u),I(l,o,u),i=!0},p(l,u){let m=t;t=a(l),t===m?~t&&r[t].p(l,u):(n&&(le(),H(r[m],1,1,()=>{r[m]=null}),ae()),~t?(n=r[t],n?n.p(l,u):(n=r[t]=s[t](l),n.c()),V(n,1),n.m(o.parentNode,o)):n=null)},i(l){i||(V(n),i=!0)},o(l){H(n),i=!1},d(l){l&&v(o),~t&&r[t].d(l)}}}function pn(e){let t=!e[7](e[32]),n,o,i=t&&mn(ft(e));return{c(){i&&i.c(),n=se()},m(s,r){i&&i.m(s,r),I(s,n,r),o=!0},p(s,r){r[0]&8320&&(t=!s[7](s[32])),t?i?(i.p(ft(s),r),r[0]&8320&&V(i,1)):(i=mn(ft(s)),i.c(),V(i,1),i.m(n.parentNode,n)):i&&(le(),H(i,1,1,()=>{i=null}),ae())},i(s){o||(V(i),o=!0)},o(s){H(i),o=!1},d(s){s&&v(n),i&&i.d(s)}}}function yn(e){let t,n,o,i;const s=[Ei,bi],r=[];function a(l,u){return l[6]?0:l[12]&&l[0]?1:-1}return~(t=a(e))&&(n=r[t]=s[t](e)),{c(){n&&n.c(),o=se()},m(l,u){~t&&r[t].m(l,u),I(l,o,u),i=!0},p(l,u){let m=t;t=a(l),t===m?~t&&r[t].p(l,u):(n&&(le(),H(r[m],1,1,()=>{r[m]=null}),ae()),~t?(n=r[t],n?n.p(l,u):(n=r[t]=s[t](l),n.c()),V(n,1),n.m(o.parentNode,o)):n=null)},i(l){i||(V(n),i=!0)},o(l){H(n),i=!1},d(l){l&&v(o),~t&&r[t].d(l)}}}function bi(e){let t=e[2],n,o,i=_n(e);return{c(){i.c(),n=se()},m(s,r){i.m(s,r),I(s,n,r),o=!0},p(s,r){r[0]&4&&Z(t,t=s[2])?(le(),H(i,1,1,N),ae(),i=_n(s),i.c(),V(i,1),i.m(n.parentNode,n)):i.p(s,r)},i(s){o||(V(i),o=!0)},o(s){H(i),o=!1},d(s){s&&v(n),i.d(s)}}}function Ei(e){let t,n,o=Te(e[6]),i=[];for(let r=0;r<o.length;r+=1)i[r]=bn(dn(e,o,r));const s=r=>H(i[r],1,1,()=>{i[r]=null});return{c(){for(let r=0;r<i.length;r+=1)i[r].c();t=se()},m(r,a){for(let l=0;l<i.length;l+=1)i[l]&&i[l].m(r,a);I(r,t,a),n=!0},p(r,a){if(a[0]&279634){o=Te(r[6]);let l;for(l=0;l<o.length;l+=1){const u=dn(r,o,l);i[l]?(i[l].p(u,a),V(i[l],1)):(i[l]=bn(u),i[l].c(),V(i[l],1),i[l].m(t.parentNode,t))}for(le(),l=o.length;l<i.length;l+=1)s(l);ae()}},i(r){if(!n){for(let a=0;a<o.length;a+=1)V(i[a]);n=!0}},o(r){i=i.filter(Boolean);for(let a=0;a<i.length;a+=1)H(i[a]);n=!1},d(r){r&&v(t),xe(i,r)}}}function _n(e){let t,n;return t=new tn({props:{target:e[4],tool:e[12],drawingMode:e[11],transform:e[10],viewportScale:e[14]}}),t.$on("create",e[17]),{c(){de(t.$$.fragment)},m(o,i){ce(t,o,i),n=!0},p(o,i){const s={};i[0]&16&&(s.target=o[4]),i[0]&4096&&(s.tool=o[12]),i[0]&2048&&(s.drawingMode=o[11]),i[0]&1024&&(s.transform=o[10]),i[0]&16384&&(s.viewportScale=o[14]),t.$set(s)},i(o){n||(V(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){fe(t,o)}}}function wn(e){let t,n;return t=new en({props:{target:e[4],editor:rt(e[29].target.selector),annotation:e[29],style:e[1],transform:e[10],viewportScale:e[14]}}),t.$on("change",function(){F(e[18](e[29]))&&e[18](e[29]).apply(this,arguments)}),{c(){de(t.$$.fragment)},m(o,i){ce(t,o,i),n=!0},p(o,i){e=o;const s={};i[0]&16&&(s.target=e[4]),i[0]&64&&(s.editor=rt(e[29].target.selector)),i[0]&64&&(s.annotation=e[29]),i[0]&2&&(s.style=e[1]),i[0]&1024&&(s.transform=e[10]),i[0]&16384&&(s.viewportScale=e[14]),t.$set(s)},i(o){n||(V(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){fe(t,o)}}}function bn(e){let t=e[29].id,n,o,i=wn(e);return{c(){i.c(),n=se()},m(s,r){i.m(s,r),I(s,n,r),o=!0},p(s,r){r[0]&64&&Z(t,t=s[29].id)?(le(),H(i,1,1,N),ae(),i=wn(s),i.c(),V(i,1),i.m(n.parentNode,n)):i.p(s,r)},i(s){o||(V(i),o=!0)},o(s){H(i),o=!1},d(s){s&&v(n),i.d(s)}}}function Ai(e){let t,n,o,i,s,r,a=Te(e[13]),l=[];for(let f=0;f<a.length;f+=1)l[f]=pn(hn(e,a,f));const u=f=>H(l[f],1,1,()=>{l[f]=null});let m=e[4]&&yn(e);return{c(){t=X("svg"),n=X("g");for(let f=0;f<l.length;f+=1)l[f].c();o=X("g"),m&&m.c(),c(o,"class","drawing"),c(t,"class","a9s-annotationlayer"),St(t,"drawing",e[12])},m(f,h){I(f,t,h),ue(t,n);for(let d=0;d<l.length;d+=1)l[d]&&l[d].m(n,null);ue(t,o),m&&m.m(o,null),e[25](o),e[26](t),i=!0,s||(r=[z(t,"pointerup",function(){F(e[8])&&e[8].apply(this,arguments)}),z(t,"pointerdown",function(){F(e[9])&&e[9].apply(this,arguments)})],s=!0)},p(f,h){if(e=f,h[0]&8322){a=Te(e[13]);let d;for(d=0;d<a.length;d+=1){const g=hn(e,a,d);l[d]?(l[d].p(g,h),V(l[d],1)):(l[d]=pn(g),l[d].c(),V(l[d],1),l[d].m(n,null))}for(le(),d=a.length;d<l.length;d+=1)u(d);ae()}e[4]?m?(m.p(e,h),h[0]&16&&V(m,1)):(m=yn(e),m.c(),V(m,1),m.m(o,null)):m&&(le(),H(m,1,1,()=>{m=null}),ae()),(!i||h[0]&4096)&&St(t,"drawing",e[12])},i(f){if(!i){for(let h=0;h<a.length;h+=1)V(l[h]);V(m),i=!0}},o(f){l=l.filter(Boolean);for(let h=0;h<l.length;h+=1)H(l[h]);H(m),i=!1},d(f){f&&v(t),xe(l,f),m&&m.d(),e[25](null),e[26](null),s=!1,ie(r)}}}function Ti(e,t,n){let o,i,s,r,a,l,u,m,f,h,d=N,g=()=>(d(),d=bt(y,Y=>n(14,h=Y)),y);e.$$.on_destroy.push(()=>d());let{drawingEnabled:b}=t,{image:T}=t,{preferredDrawingMode:w}=t,{state:_}=t,{style:A=void 0}=t,{toolName:S=Ye().length>0?Ye()[0]:void 0}=t,{user:O}=t,D,U,y;we(()=>g(n(5,y=sn(T,U))));const{selection:p,store:E}=_;Et(e,p,Y=>n(24,m=Y)),Et(e,E,Y=>n(13,f=Y));let L=null,P=null;const C=Y=>{E.unobserve(L);const $=Y.filter(({editable:q})=>q).map(({id:q})=>q);$.length>0?(n(6,P=$.map(q=>E.getAnnotation(q))),L=q=>{const{updated:ye}=q.changes;n(6,P=ye.map(J=>J.newValue))},E.observe(L,{annotations:$})):n(6,P=null)},G=Y=>{const $=Ct(),q={id:$,bodies:[],target:{annotation:$,selector:Y.detail,creator:O,created:new Date}};E.addAnnotation(q),p.setSelected(q.id)},R=Y=>$=>{var _e;const{target:q}=Y,ye=10*60*1e3,J=((_e=q.creator)==null?void 0:_e.id)!==O.id||!q.created||new Date().getTime()-q.created.getTime()>ye;E.updateTarget({...q,selector:$.detail,created:J?q.created:new Date,updated:J?new Date:null,updatedBy:J?O:null})};function ve(Y){Pe[Y?"unshift":"push"](()=>{D=Y,n(4,D)})}function Ce(Y){Pe[Y?"unshift":"push"](()=>{U=Y,n(3,U)})}return e.$$set=Y=>{"drawingEnabled"in Y&&n(0,b=Y.drawingEnabled),"image"in Y&&n(19,T=Y.image),"preferredDrawingMode"in Y&&n(20,w=Y.preferredDrawingMode),"state"in Y&&n(21,_=Y.state),"style"in Y&&n(1,A=Y.style),"toolName"in Y&&n(2,S=Y.toolName),"user"in Y&&n(22,O=Y.user)},e.$$.update=()=>{e.$$.dirty[0]&4&&n(12,{tool:o,opts:i}=ct(S),o,(n(23,i),n(2,S))),e.$$.dirty[0]&9437184&&n(11,s=(i==null?void 0:i.drawingMode)||w),e.$$.dirty[0]&8&&n(10,r=fn(U)),e.$$.dirty[0]&8&&n(9,{onPointerDown:a,onPointerUp:l}=un(U,E),a,(n(8,l),n(3,U))),e.$$.dirty[0]&16777216&&n(7,u=Y=>m.selected.find($=>$.id===Y.id&&$.editable)),e.$$.dirty[0]&16777216&&C(m.selected)},[b,A,S,U,D,y,P,u,l,a,r,s,o,f,h,p,E,G,R,T,w,_,O,i,m,ve,Ce]}class En extends te{constructor(t){super(),ee(this,t,Ti,Ai,Z,{drawingEnabled:0,image:19,preferredDrawingMode:20,state:21,style:1,toolName:2,user:22},null,[-1,-1])}}function Si(e,t,n,o,i){An(e,t,n||0,o||e.length-1,i||Mi)}function An(e,t,n,o,i){for(;o>n;){if(o-n>600){var s=o-n+1,r=t-n+1,a=Math.log(s),l=.5*Math.exp(2*a/3),u=.5*Math.sqrt(a*l*(s-l)/s)*(r-s/2<0?-1:1),m=Math.max(n,Math.floor(t-r*l/s+u)),f=Math.min(o,Math.floor(t+(s-r)*l/s+u));An(e,t,m,f,i)}var h=e[t],d=n,g=o;for(De(e,n,t),i(e[o],h)>0&&De(e,n,o);d<g;){for(De(e,d,g),d++,g--;i(e[d],h)<0;)d++;for(;i(e[g],h)>0;)g--}i(e[n],h)===0?De(e,n,g):(g++,De(e,g,o)),g<=t&&(n=g+1),t<=g&&(o=g-1)}}function De(e,t,n){var o=e[t];e[t]=e[n],e[n]=o}function Mi(e,t){return e<t?-1:e>t?1:0}class Li{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let n=this.data;const o=[];if(!Ke(t,n))return o;const i=this.toBBox,s=[];for(;n;){for(let r=0;r<n.children.length;r++){const a=n.children[r],l=n.leaf?i(a):a;Ke(t,l)&&(n.leaf?o.push(a):dt(t,l)?this._all(a,o):s.push(a))}n=s.pop()}return o}collides(t){let n=this.data;if(!Ke(t,n))return!1;const o=[];for(;n;){for(let i=0;i<n.children.length;i++){const s=n.children[i],r=n.leaf?this.toBBox(s):s;if(Ke(t,r)){if(n.leaf||dt(t,r))return!0;o.push(s)}}n=o.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let o=0;o<t.length;o++)this.insert(t[o]);return this}let n=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=n;else if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const o=this.data;this.data=n,n=o}this._insert(n,this.data.height-n.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=Oe([]),this}remove(t,n){if(!t)return this;let o=this.data;const i=this.toBBox(t),s=[],r=[];let a,l,u;for(;o||s.length;){if(o||(o=s.pop(),l=s[s.length-1],a=r.pop(),u=!0),o.leaf){const m=Oi(t,o.children,n);if(m!==-1)return o.children.splice(m,1),s.push(o),this._condense(s),this}!u&&!o.leaf&&dt(o,i)?(s.push(o),r.push(a),a=0,l=o,o=o.children[0]):l?(a++,o=l.children[a],u=!1):o=null}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,n){const o=[];for(;t;)t.leaf?n.push(...t.children):o.push(...t.children),t=o.pop();return n}_build(t,n,o,i){const s=o-n+1;let r=this._maxEntries,a;if(s<=r)return a=Oe(t.slice(n,o+1)),Le(a,this.toBBox),a;i||(i=Math.ceil(Math.log(s)/Math.log(r)),r=Math.ceil(s/Math.pow(r,i-1))),a=Oe([]),a.leaf=!1,a.height=i;const l=Math.ceil(s/r),u=l*Math.ceil(Math.sqrt(r));Tn(t,n,o,u,this.compareMinX);for(let m=n;m<=o;m+=u){const f=Math.min(m+u-1,o);Tn(t,m,f,l,this.compareMinY);for(let h=m;h<=f;h+=l){const d=Math.min(h+l-1,f);a.children.push(this._build(t,h,d,i-1))}}return Le(a,this.toBBox),a}_chooseSubtree(t,n,o,i){for(;i.push(n),!(n.leaf||i.length-1===o);){let s=1/0,r=1/0,a;for(let l=0;l<n.children.length;l++){const u=n.children[l],m=ut(u),f=ki(t,u)-m;f<r?(r=f,s=m<s?m:s,a=u):f===r&&m<s&&(s=m,a=u)}n=a||n.children[0]}return n}_insert(t,n,o){const i=o?t:this.toBBox(t),s=[],r=this._chooseSubtree(i,this.data,n,s);for(r.children.push(t),Xe(r,i);n>=0&&s[n].children.length>this._maxEntries;)this._split(s,n),n--;this._adjustParentBBoxes(i,s,n)}_split(t,n){const o=t[n],i=o.children.length,s=this._minEntries;this._chooseSplitAxis(o,s,i);const r=this._chooseSplitIndex(o,s,i),a=Oe(o.children.splice(r,o.children.length-r));a.height=o.height,a.leaf=o.leaf,Le(o,this.toBBox),Le(a,this.toBBox),n?t[n-1].children.push(a):this._splitRoot(o,a)}_splitRoot(t,n){this.data=Oe([t,n]),this.data.height=t.height+1,this.data.leaf=!1,Le(this.data,this.toBBox)}_chooseSplitIndex(t,n,o){let i,s=1/0,r=1/0;for(let a=n;a<=o-n;a++){const l=Re(t,0,a,this.toBBox),u=Re(t,a,o,this.toBBox),m=Pi(l,u),f=ut(l)+ut(u);m<s?(s=m,i=a,r=f<r?f:r):m===s&&f<r&&(r=f,i=a)}return i||o-n}_chooseSplitAxis(t,n,o){const i=t.leaf?this.compareMinX:vi,s=t.leaf?this.compareMinY:Ii,r=this._allDistMargin(t,n,o,i),a=this._allDistMargin(t,n,o,s);r<a&&t.children.sort(i)}_allDistMargin(t,n,o,i){t.children.sort(i);const s=this.toBBox,r=Re(t,0,n,s),a=Re(t,o-n,o,s);let l=je(r)+je(a);for(let u=n;u<o-n;u++){const m=t.children[u];Xe(r,t.leaf?s(m):m),l+=je(r)}for(let u=o-n-1;u>=n;u--){const m=t.children[u];Xe(a,t.leaf?s(m):m),l+=je(a)}return l}_adjustParentBBoxes(t,n,o){for(let i=o;i>=0;i--)Xe(n[i],t)}_condense(t){for(let n=t.length-1,o;n>=0;n--)t[n].children.length===0?n>0?(o=t[n-1].children,o.splice(o.indexOf(t[n]),1)):this.clear():Le(t[n],this.toBBox)}}function Oi(e,t,n){if(!n)return t.indexOf(e);for(let o=0;o<t.length;o++)if(n(e,t[o]))return o;return-1}function Le(e,t){Re(e,0,e.children.length,t,e)}function Re(e,t,n,o,i){i||(i=Oe(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let s=t;s<n;s++){const r=e.children[s];Xe(i,e.leaf?o(r):r)}return i}function Xe(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function vi(e,t){return e.minX-t.minX}function Ii(e,t){return e.minY-t.minY}function ut(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function je(e){return e.maxX-e.minX+(e.maxY-e.minY)}function ki(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function Pi(e,t){const n=Math.max(e.minX,t.minX),o=Math.max(e.minY,t.minY),i=Math.min(e.maxX,t.maxX),s=Math.min(e.maxY,t.maxY);return Math.max(0,i-n)*Math.max(0,s-o)}function dt(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function Ke(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function Oe(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Tn(e,t,n,o,i){const s=[t,n];for(;s.length;){if(n=s.pop(),t=s.pop(),n-t<=o)continue;const r=t+Math.ceil((n-t)/o/2)*o;Si(e,r,t,n,i),s.push(t,r,r,n)}}const Bi=()=>{const e=new Li,t=new Map,n=()=>[...t.values()],o=()=>{e.clear(),t.clear()},i=f=>{const{minX:h,minY:d,maxX:g,maxY:b}=f.selector.geometry.bounds,T={minX:h,minY:d,maxX:g,maxY:b,target:f};e.insert(T),t.set(f.annotation,T)},s=f=>{const h=t.get(f.annotation);e.remove(h),t.delete(f.annotation)};return{all:n,clear:o,getAt:(f,h)=>{const g=e.search({minX:f,minY:h,maxX:f,maxY:h}).map(b=>b.target).filter(b=>b.selector.type===K.RECTANGLE||vt(b.selector,f,h));if(g.length>0)return g.sort((b,T)=>Ve(b.selector)-Ve(T.selector)),g[0]},getIntersecting:(f,h,d,g)=>e.search({minX:f,minY:h,maxX:f+d,maxY:h+g}).map(b=>b.target),insert:i,remove:s,set:(f,h=!0)=>{h&&o();const d=f.map(g=>{const{minX:b,minY:T,maxX:w,maxY:_}=g.selector.geometry.bounds;return{minX:b,minY:T,maxX:w,maxY:_,target:g}});d.forEach(g=>t.set(g.target.annotation,g)),e.load(d)},size:()=>e.all().length,update:(f,h)=>{s(f),i(h)}}},Sn=e=>{const t=ho(),n=Bi(),o=no(t,e.pointerSelectAction),i=to(t),s=_o();return t.observe(({changes:l})=>{n.set(l.created.map(u=>u.target),!1),l.deleted.forEach(u=>n.remove(u.target)),l.updated.forEach(({oldValue:u,newValue:m})=>n.update(u.target,m.target))}),{store:{...t,getAt:(l,u)=>{const m=n.getAt(l,u);return m?t.getAnnotation(m.annotation):void 0},getIntersecting:(l,u,m,f)=>n.getIntersecting(l,u,m,f).map(h=>t.getAnnotation(h.annotation))},selection:o,hover:i,viewport:s}},Mn=e=>{const t=Sn(e);return{...t,store:mo(t.store)}},Ln=e=>{let t,n;if(e.nodeName==="CANVAS")t=e,n=t.getContext("2d",{willReadFrequently:!0});else{const i=e;t=document.createElement("canvas"),t.width=i.width,t.height=i.height,n=t.getContext("2d",{willReadFrequently:!0}),n.drawImage(i,0,0,i.width,i.height)}let o=0;for(let i=1;i<10;i++)for(let s=1;s<10;s++){const r=Math.round(s*t.width/10),a=Math.round(i*t.height/10),l=n.getImageData(r,a,1,1).data,u=(.299*l[0]+.587*l[1]+.114*l[2])/255;o+=u}return o/81},On=e=>{const t=Ln(e),n=t>.6?"dark":"light";return console.log(`[Annotorious] Image brightness: ${t.toFixed(1)}. Setting ${n} theme.`),n},ht=(e,t,n)=>t.setAttribute("data-theme",n==="auto"?On(e):n),vn=(e,t)=>({...e,drawingEnabled:e.drawingEnabled===void 0?t.drawingEnabled:e.drawingEnabled,drawingMode:e.drawingMode||t.drawingMode,pointerSelectAction:e.pointerSelectAction||t.pointerSelectAction,theme:e.theme||t.theme}),In=navigator.userAgent.indexOf("Mac OS X")!==-1,kn=(e,t)=>{const n=t||document,o=r=>{r.key==="Z"&&r.ctrlKey?e.undo():r.key==="Y"&&r.ctrlKey&&e.redo()},i=r=>{r.key==="z"&&r.metaKey&&(r.shiftKey?e.redo():e.undo())},s=()=>{In?n.removeEventListener("keydown",i):n.removeEventListener("keydown",o)};return In?n.addEventListener("keydown",i):n.addEventListener("keydown",o),{destroy:s}},Yi=(e,t={})=>{if(!e)throw"Missing argument: image";const n=typeof e=="string"?document.getElementById(e):e,o=vn(t,{drawingEnabled:!0,drawingMode:"drag",pointerSelectAction:Nt.EDIT,theme:"light"}),i=Mn(o),{selection:s,store:r}=i,a=yo(r),l=wo(i,a,o.adapter,o.autoSave),u=document.createElement("DIV");u.style.position="relative",u.style.display="inline-block",n.style.display="block",n.parentNode.insertBefore(u,n),u.appendChild(n);const m=kn(a);let f=Lo();ht(n,u,o.theme);const h=new En({target:u,props:{drawingEnabled:o.drawingEnabled,image:n,toolName:void 0,preferredDrawingMode:o.drawingMode,state:i,style:o.style,user:f}});h.$on("click",y=>{const{originalEvent:p,annotation:E}=y.detail;E?s.clickSelect(E.id,p):s.isEmpty()||s.clear()});const d=Eo(i,a,o.adapter),g=()=>{h.$destroy(),u.parentNode.insertBefore(n,u),u.parentNode.removeChild(u),m.destroy(),a.destroy()},b=()=>f,T=(y,p,E)=>cn(y,p,E),w=(y,p)=>xt(y,p),_=y=>{console.log(Ye());const p=ct(y);if(console.log(p),!p)throw`No such tool named ${y}`;h.$set({toolName:y})},A=y=>h.$set({drawingEnabled:y}),S=y=>{console.warn("Filter not implemented yet")},O=y=>h.$set({style:y}),D=y=>ht(n,u,y),U=y=>{f=y,h.$set({user:y})};return{...d,destroy:g,getUser:b,listDrawingTools:Ye,on:l.on,off:l.off,registerDrawingTool:T,registerShapeEditor:w,setDrawingEnabled:A,setDrawingTool:_,setFilter:S,setStyle:O,setTheme:D,setUser:U,state:i}};B.Editor=He,B.EditorMount=en,B.EllipseEditor=Zt,B.Handle=M,B.IdentityTransform=mi,B.PolygonEditor=qt,B.RectangleEditor=Jt,B.RectangleUtil=It,B.RubberbandRectangle=on,B.SVGAnnotationLayer=En,B.ShapeType=K,B.ToolMount=tn,B.W3CImageFormat=ko,B.addEventListeners=un,B.boundsFromPoints=Be,B.computeArea=Ve,B.createImageAnnotator=Yi,B.createImageAnnotatorState=Sn,B.createSVGTransform=fn,B.createSvelteImageAnnotatorState=Mn,B.detectTheme=On,B.distance=ze,B.enableResponsive=sn,B.fillDefaults=vn,B.getEditor=rt,B.getTool=ct,B.initKeyboardCommands=kn,B.intersects=vt,B.isTouch=Jo,B.listDrawingTools=Ye,B.parseFragmentSelector=kt,B.parseSVGSelector=Dt,B.parseW3CImageAnnotation=Ht,B.registerEditor=xt,B.registerShapeUtil=Ne,B.registerTool=cn,B.sampleBrightness=Ln,B.serializeFragmentSelector=Pt,B.serializeSVGSelector=Rt,B.serializeW3CImageAnnotation=Ft,B.setTheme=ht,Object.defineProperty(B,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=annotorious.js.map
