(function(Y,F){typeof exports=="object"&&typeof module<"u"?F(exports):typeof define=="function"&&define.amd?define(["exports"],F):(Y=typeof globalThis<"u"?globalThis:Y||self,F(Y.Annotorious={}))})(this,function(Y){"use strict";function F(){}function Yn(e,t){for(const n in t)e[n]=t[n];return e}function _t(e){return e()}function wt(){return Object.create(null)}function le(e){e.forEach(_t)}function j(e){return typeof e=="function"}function Z(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function Rn(e){return Object.keys(e).length===0}function bt(e,...t){if(e==null)return F;const n=e.subscribe(...t);return n.unsubscribe?()=>n.unsubscribe():n}function Et(e,t,n){e.$$.on_destroy.push(bt(t,n))}function Xn(e,t,n,o){if(e){const i=At(e,t,n,o);return e[0](i)}}function At(e,t,n,o){return e[1]&&o?Yn(n.ctx.slice(),e[1](o(t))):n.ctx}function Cn(e,t,n,o){if(e[2]&&o){const i=e[2](o(n));if(t.dirty===void 0)return i;if(typeof i=="object"){const r=[],s=Math.max(t.dirty.length,i.length);for(let a=0;a<s;a+=1)r[a]=t.dirty[a]|i[a];return r}return t.dirty|i}return t.dirty}function Un(e,t,n,o,i,r){if(i){const s=At(t,n,o,r);e.p(s,i)}}function Nn(e){if(e.ctx.length>32){const t=[],n=e.ctx.length/32;for(let o=0;o<n;o++)t[o]=-1;return t}return-1}function ce(e,t){e.appendChild(t)}function k(e,t,n){e.insertBefore(t,n||null)}function v(e){e.parentNode&&e.parentNode.removeChild(e)}function Qe(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function R(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function St(e){return document.createTextNode(e)}function x(){return St(" ")}function fe(){return St("")}function K(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)}function c(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function Vn(e){return Array.from(e.childNodes)}function Tt(e,t,n){e.classList[n?"add":"remove"](t)}function Gn(e,t,{bubbles:n=!1,cancelable:o=!1}={}){const i=document.createEvent("CustomEvent");return i.initCustomEvent(e,n,o,t),i}let ke;function Ie(e){ke=e}function Mt(){if(!ke)throw new Error("Function called outside component initialization");return ke}function ge(e){Mt().$$.on_mount.push(e)}function he(){const e=Mt();return(t,n,{cancelable:o=!1}={})=>{const i=e.$$.callbacks[t];if(i){const r=Gn(t,n,{cancelable:o});return i.slice().forEach(s=>{s.call(e,r)}),!r.defaultPrevented}return!0}}function ie(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach(o=>o.call(this,t))}const Ee=[],Pe=[];let Ae=[];const Lt=[],Fn=Promise.resolve();let xe=!1;function Hn(){xe||(xe=!0,Fn.then(Ot))}function $e(e){Ae.push(e)}const et=new Set;let Se=0;function Ot(){if(Se!==0)return;const e=ke;do{try{for(;Se<Ee.length;){const t=Ee[Se];Se++,Ie(t),zn(t.$$)}}catch(t){throw Ee.length=0,Se=0,t}for(Ie(null),Ee.length=0,Se=0;Pe.length;)Pe.pop()();for(let t=0;t<Ae.length;t+=1){const n=Ae[t];et.has(n)||(et.add(n),n())}Ae.length=0}while(Ee.length);for(;Lt.length;)Lt.pop()();xe=!1,et.clear(),Ie(e)}function zn(e){if(e.fragment!==null){e.update(),le(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach($e)}}function jn(e){const t=[],n=[];Ae.forEach(o=>e.indexOf(o)===-1?t.push(o):n.push(o)),n.forEach(o=>o()),Ae=t}const Ne=new Set;let pe;function ue(){pe={r:0,c:[],p:pe}}function de(){pe.r||le(pe.c),pe=pe.p}function G(e,t){e&&e.i&&(Ne.delete(e),e.i(t))}function H(e,t,n,o){if(e&&e.o){if(Ne.has(e))return;Ne.add(e),pe.c.push(()=>{Ne.delete(e),o&&(n&&e.d(1),o())}),e.o(t)}else o&&o()}function ae(e){e&&e.c()}function re(e,t,n,o){const{fragment:i,after_update:r}=e.$$;i&&i.m(t,n),o||$e(()=>{const s=e.$$.on_mount.map(_t).filter(j);e.$$.on_destroy?e.$$.on_destroy.push(...s):le(s),e.$$.on_mount=[]}),r.forEach($e)}function se(e,t){const n=e.$$;n.fragment!==null&&(jn(n.after_update),le(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function Kn(e,t){e.$$.dirty[0]===-1&&(Ee.push(e),Hn(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function $(e,t,n,o,i,r,s,a=[-1]){const l=ke;Ie(e);const u=e.$$={fragment:null,ctx:[],props:r,update:F,not_equal:i,bound:wt(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(l?l.$$.context:[])),callbacks:wt(),dirty:a,skip_bound:!1,root:t.target||l.$$.root};s&&s(u.root);let h=!1;if(u.ctx=n?n(e,t.props||{},(f,m,...d)=>{const g=d.length?d[0]:m;return u.ctx&&i(u.ctx[f],u.ctx[f]=g)&&(!u.skip_bound&&u.bound[f]&&u.bound[f](g),h&&Kn(e,f)),m}):[],u.update(),h=!0,le(u.before_update),u.fragment=o?o(u.ctx):!1,t.target){if(t.hydrate){const f=Vn(t.target);u.fragment&&u.fragment.l(f),f.forEach(v)}else u.fragment&&u.fragment.c();t.intro&&G(e.$$.fragment),re(e,t.target,t.anchor,t.customElement),Ot()}Ie(l)}class ee{$destroy(){se(this,1),this.$destroy=F}$on(t,n){if(!j(n))return F;const o=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return o.push(n),()=>{const i=o.indexOf(n);i!==-1&&o.splice(i,1)}}$set(t){this.$$set&&!Rn(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}var z=(e=>(e.ELLIPSE="ELLIPSE",e.POLYGON="POLYGON",e.RECTANGLE="RECTANGLE",e.FREEHAND="FREEHAND",e))(z||{});const tt={},De=(e,t)=>tt[e]=t,Ve=e=>tt[e.type].area(e),vt=(e,t,n)=>tt[e.type].intersects(e,t,n),me=e=>{let t=1/0,n=1/0,o=-1/0,i=-1/0;return e.forEach(([r,s])=>{t=Math.min(t,r),n=Math.min(n,s),o=Math.max(o,r),i=Math.max(i,s)}),{minX:t,minY:n,maxX:o,maxY:i}},Wn={area:e=>Math.PI*e.geometry.rx*e.geometry.ry,intersects:(e,t,n)=>{const{cx:o,cy:i,rx:r,ry:s}=e.geometry,a=0,l=Math.cos(a),u=Math.sin(a),h=t-o,f=n-i,m=l*h+u*f,d=u*h-l*f;return m*m/(r*r)+d*d/(s*s)<=1}};De(z.ELLIPSE,Wn);const qn={area:e=>{const{points:t}=e.geometry;let n=0,o=t.length-1;for(let i=0;i<t.length;i++)n+=(t[o][0]+t[i][0])*(t[o][1]-t[i][1]),o=i;return Math.abs(.5*n)},intersects:(e,t,n)=>{const{points:o}=e.geometry;let i=!1;for(let r=0,s=o.length-1;r<o.length;s=r++){const a=o[r][0],l=o[r][1],u=o[s][0],h=o[s][1];l>n!=h>n&&t<(u-a)*(n-l)/(h-l)+a&&(i=!i)}return i}};De(z.POLYGON,qn);const kt={area:e=>e.geometry.w*e.geometry.h,intersects:(e,t,n)=>t>=e.geometry.x&&t<=e.geometry.x+e.geometry.w&&n>=e.geometry.y&&n<=e.geometry.y+e.geometry.h};De(z.RECTANGLE,kt);const Zn={area:e=>{const{points:t}=e.geometry;let n=0,o=t.length-1;for(let i=0;i<t.length;i++)n+=(t[o][0]+t[i][0])*(t[o][1]-t[i][1]),o=i;return Math.abs(.5*n)},intersects:(e,t,n)=>{const{points:o}=e.geometry;let i=!1;for(let r=0,s=o.length-1;r<o.length;s=r++){const a=o[r][0],l=o[r][1],u=o[s][0],h=o[s][1];l>n!=h>n&&t<(u-a)*(n-l)/(h-l)+a&&(i=!i)}return i}};De(z.FREEHAND,Zn);const It=(e,t=!1)=>{const n=typeof e=="string"?e:e.value,o=/^(xywh)=(pixel|percent)?:?(.+?),(.+?),(.+?),(.+)*/g,i=[...n.matchAll(o)][0],[r,s,a,l,u,h,f]=i;if(s!=="xywh")throw new Error("Unsupported MediaFragment: "+n);if(a&&a!=="pixel")throw new Error(`Unsupported MediaFragment unit: ${a}`);const[m,d,g,E]=[l,u,h,f].map(parseFloat);return{type:z.RECTANGLE,geometry:{x:m,y:d,w:g,h:E,bounds:{minX:m,minY:t?d-E:d,maxX:m+g,maxY:t?d:d+E}}}},Pt=e=>{const{x:t,y:n,w:o,h:i}=e;return{type:"FragmentSelector",conformsTo:"http://www.w3.org/TR/media-frags/",value:`xywh=pixel:${t},${n},${o},${i}`}},Dt="http://www.w3.org/2000/svg",Bt=e=>{const t=o=>{Array.from(o.attributes).forEach(i=>{i.name.startsWith("on")&&o.removeAttribute(i.name)})},n=e.getElementsByTagName("script");return Array.from(n).reverse().forEach(o=>o.parentNode.removeChild(o)),Array.from(e.querySelectorAll("*")).forEach(t),e},Jn=e=>{const o=new XMLSerializer().serializeToString(e.documentElement).replace("<svg>",`<svg xmlns="${Dt}">`);return new DOMParser().parseFromString(o,"image/svg+xml").documentElement};function Qn(e,t){var n=e[0]-t[0],o=e[1]-t[1];return n*n+o*o}function xn(e,t,n){var o=t[0],i=t[1],r=n[0]-o,s=n[1]-i;if(r!==0||s!==0){var a=((e[0]-o)*r+(e[1]-i)*s)/(r*r+s*s);a>1?(o=n[0],i=n[1]):a>0&&(o+=r*a,i+=s*a)}return r=e[0]-o,s=e[1]-i,r*r+s*s}function $n(e,t){for(var n=e[0],o=[n],i,r=1,s=e.length;r<s;r++)i=e[r],Qn(i,n)>t&&(o.push(i),n=i);return n!==i&&o.push(i),o}function nt(e,t,n,o,i){for(var r=o,s,a=t+1;a<n;a++){var l=xn(e[a],e[t],e[n]);l>r&&(s=a,r=l)}r>o&&(s-t>1&&nt(e,t,s,o,i),i.push(e[s]),n-s>1&&nt(e,s,n,o,i))}function eo(e,t){var n=e.length-1,o=[e[0]];return nt(e,0,n,t,o),o.push(e[n]),o}function to(e,t,n){if(e.length<=2)return e;var o=t!==void 0?t*t:1;return e=n?e:$n(e,o),e=eo(e,o),e}const ot={size:4,thinning:.3,smoothing:.5,streamline:.5,easing:e=>e,start:{taper:0,easing:e=>e,cap:!0},end:{taper:0,easing:e=>e,cap:!0}};function no(e){if(!e.length)return"";const t=e.reduce((n,[o,i],r,s)=>{const[a,l]=s[(r+1)%s.length];return n.push(o,i,(o+a)/2,(i+l)/2),n},["M",...e[0],"Q"]);return t.push("Z"),t.join(" ")}function Be(e,t,n=!1){return no(n?to(e,1):e)}const oo=e=>{const n=new DOMParser().parseFromString(e,"image/svg+xml"),o=n.lookupPrefix(Dt),i=n.lookupNamespaceURI(null);return o||i?Bt(n).firstChild:Bt(Jn(n)).firstChild},io=e=>{const[t,n,o]=e.match(/(<path d=["|'])([^("|')]*)/)||[];if(!o)return;const i=/([MQZT])([^MQZT]*)/g,s=Array.from(o.matchAll(i)).map(a=>(a[1],a[2].trim().split(/\s+/).map(parseFloat)));return{type:z.FREEHAND,geometry:{points:s,bounds:me(s)}}},ro=e=>{const[t,n,o]=e.match(/(<polygon points=["|'])([^("|')]*)/)||[];if(!o)return;const i=o.split(" ").map(r=>r.split(",").map(parseFloat));return{type:z.POLYGON,geometry:{points:i,bounds:me(i)}}},so=e=>{const t=oo(e),n=parseFloat(t.getAttribute("cx")),o=parseFloat(t.getAttribute("cy")),i=parseFloat(t.getAttribute("rx")),r=parseFloat(t.getAttribute("ry")),s={minX:n-i,minY:o-r,maxX:n+i,maxY:o+r};return{type:z.ELLIPSE,geometry:{cx:n,cy:o,rx:i,ry:r,bounds:s}}},Yt=e=>{const t=typeof e=="string"?e:e.value;if(t.includes("<polygon points="))return ro(t);if(t.includes("<path d="))return io(t);if(t.includes("<ellipse "))return so(t)},Rt=e=>{let t;if(e.type===z.POLYGON){const n=e.geometry,{points:o}=n;t=`<svg><polygon points="${o.map(i=>i.join(",")).join(" ")}" /></svg>`}else if(e.type===z.FREEHAND){const n=e.geometry;t=`<svg><path d="${Be(n.points)}"/></svg>`}else if(e.type===z.ELLIPSE){const n=e.geometry;t=`<svg><ellipse cx="${n.cx}" cy="${n.cy}" rx="${n.rx}" ry="${n.ry}" /></svg>`}if(t)return{type:"SvgSelector",value:t};throw`Unsupported shape type: ${e.type}`};let Ge;const lo=new Uint8Array(16);function ao(){if(!Ge&&(Ge=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Ge))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ge(lo)}const Q=[];for(let e=0;e<256;++e)Q.push((e+256).toString(16).slice(1));function co(e,t=0){return Q[e[t+0]]+Q[e[t+1]]+Q[e[t+2]]+Q[e[t+3]]+"-"+Q[e[t+4]]+Q[e[t+5]]+"-"+Q[e[t+6]]+Q[e[t+7]]+"-"+Q[e[t+8]]+Q[e[t+9]]+"-"+Q[e[t+10]]+Q[e[t+11]]+Q[e[t+12]]+Q[e[t+13]]+Q[e[t+14]]+Q[e[t+15]]}const Xt={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Ct(e,t,n){if(Xt.randomUUID&&!t&&!e)return Xt.randomUUID();e=e||{};const o=e.random||(e.rng||ao)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,t){n=n||0;for(let i=0;i<16;++i)t[n+i]=o[i];return t}return co(o)}var Ut=Object.prototype.hasOwnProperty;function ye(e,t){var n,o;if(e===t)return!0;if(e&&t&&(n=e.constructor)===t.constructor){if(n===Date)return e.getTime()===t.getTime();if(n===RegExp)return e.toString()===t.toString();if(n===Array){if((o=e.length)===t.length)for(;o--&&ye(e[o],t[o]););return o===-1}if(!n||typeof e=="object"){o=0;for(n in e)if(Ut.call(e,n)&&++o&&!Ut.call(t,n)||!(n in t)||!ye(e[n],t[n]))return!1;return Object.keys(t).length===o}}return e!==e&&t!==t}function it(){}function fo(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}const Te=[];function rt(e,t=it){let n;const o=new Set;function i(a){if(fo(e,a)&&(e=a,n)){const l=!Te.length;for(const u of o)u[1](),Te.push(u,e);if(l){for(let u=0;u<Te.length;u+=2)Te[u][0](Te[u+1]);Te.length=0}}}function r(a){i(a(e))}function s(a,l=it){const u=[a,l];return o.add(u),o.size===1&&(n=t(i)||it),a(e),()=>{o.delete(u),o.size===0&&n&&(n(),n=null)}}return{set:i,update:r,subscribe:s}}const uo=e=>{const{subscribe:t,set:n}=rt(null);let o=null;return t(i=>o=i),e.observe(({changes:i})=>{if(o){i.deleted.some(s=>s.id===o)&&n(null);const r=i.updated.find(({oldValue:s})=>s.id===o);r&&n(r.newValue.id)}}),{get current(){return o},subscribe:t,set:n}};var Nt=(e=>(e.EDIT="EDIT",e.SELECT="SELECT",e.NONE="NONE",e))(Nt||{});const st={selected:[]},ho=(e,t="EDIT")=>{const{subscribe:n,set:o}=rt(st);let i=st;n(f=>i=f);const r=()=>o(st),s=()=>{var f;return((f=i.selected)==null?void 0:f.length)===0},a=f=>{if(i.selected.length===0)return!1;const m=typeof f=="string"?f:f.id;return i.selected.some(d=>d.id===m)},l=(f,m)=>{const d=e.getAnnotation(f);if(d){const g=mo(d,t);o(g==="EDIT"?{selected:[{id:f,editable:!0}],pointerEvent:m}:g==="SELECT"?{selected:[{id:f}],pointerEvent:m}:{selected:[],pointerEvent:m})}else console.warn("Invalid selection: "+f)},u=(f,m=!0)=>{const d=Array.isArray(f)?f:[f],g=d.map(E=>e.getAnnotation(E)).filter(E=>E);o({selected:g.map(({id:E})=>({id:E,editable:m}))}),g.length!==d.length&&console.warn("Invalid selection",f)},h=f=>{if(i.selected.length===0)return!1;const{selected:m}=i;m.filter(({id:d})=>f.includes(d)).length>0&&o({selected:m.filter(({id:d})=>!f.includes(d))})};return e.observe(({changes:f})=>h(f.deleted.map(m=>m.id))),{clear:r,clickSelect:l,get selected(){return i?[...i.selected]:null},get pointerEvent(){return i?i.pointerEvent:null},isEmpty:s,isSelected:a,setSelected:u,subscribe:n}},mo=(e,t)=>typeof t=="function"?t(e)||"EDIT":t||"EDIT",go=[];for(let e=0;e<256;++e)go.push((e+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const po=(e,t)=>{const n=new Set(e.bodies.map(o=>o.id));return t.bodies.filter(o=>!n.has(o.id))},yo=(e,t)=>{const n=new Set(t.bodies.map(o=>o.id));return e.bodies.filter(o=>!n.has(o.id))},_o=(e,t)=>t.bodies.map(n=>{const o=e.bodies.find(i=>i.id===n.id);return{newBody:n,oldBody:o&&!ye(o,n)?o:void 0}}).filter(({oldBody:n})=>n),wo=(e,t)=>!ye(e.target,t.target),Vt=(e,t)=>{const n=po(e,t),o=yo(e,t),i=_o(e,t);return{oldValue:e,newValue:t,bodiesCreated:n.length>0?n:void 0,bodiesDeleted:o.length>0?o:void 0,bodiesUpdated:i.length>0?i:void 0,targetUpdated:wo(e,t)?{oldTarget:e.target,newTarget:t.target}:void 0}};var W=(e=>(e.LOCAL="LOCAL",e.REMOTE="REMOTE",e))(W||{});const bo=(e,t)=>{var n,o;const{changes:i,origin:r}=t;if(!(!e.options.origin||e.options.origin===r))return!1;if(e.options.ignore){const{ignore:s}=e.options,a=l=>(l==null?void 0:l.length)>0;if(!(a(i.created)||a(i.deleted))){const l=(n=i.updated)==null?void 0:n.some(h=>a(h.bodiesCreated)||a(h.bodiesDeleted)||a(h.bodiesUpdated)),u=(o=i.updated)==null?void 0:o.some(h=>h.targetUpdated);if(s==="BODY_ONLY"&&l&&!u||s==="TARGET_ONLY"&&u&&!l)return!1}}if(e.options.annotations){const s=new Set([...i.created.map(a=>a.id),...i.deleted.map(a=>a.id),...i.updated.map(({oldValue:a})=>a.id)]);return!!(Array.isArray(e.options.annotations)?e.options.annotations:[e.options.annotations]).find(a=>s.has(a))}else return!0},Eo=(e,t)=>{const n=new Set((e.created||[]).map(f=>f.id)),o=new Set((e.updated||[]).map(({newValue:f})=>f.id)),i=new Set((t.created||[]).map(f=>f.id)),r=new Set((t.deleted||[]).map(f=>f.id)),s=new Set((t.updated||[]).map(({oldValue:f})=>f.id)),a=new Set((t.updated||[]).filter(({oldValue:f})=>n.has(f.id)||o.has(f.id)).map(({oldValue:f})=>f.id)),l=[...(e.created||[]).filter(f=>!r.has(f.id)).map(f=>s.has(f.id)?t.updated.find(({oldValue:m})=>m.id===f.id).newValue:f),...t.created||[]],u=[...(e.deleted||[]).filter(f=>!i.has(f.id)),...(t.deleted||[]).filter(f=>!n.has(f.id))],h=[...(e.updated||[]).filter(({newValue:f})=>!r.has(f.id)).map(f=>{const{oldValue:m,newValue:d}=f;if(s.has(d.id)){const g=t.updated.find(E=>E.oldValue.id===d.id).newValue;return Vt(m,g)}else return f}),...(t.updated||[]).filter(({oldValue:f})=>!a.has(f.id))];return{created:l,deleted:u,updated:h}},Ao=e=>e.id!==void 0,So=()=>{const e=new Map,t=new Map,n=[],o=(y,_={})=>n.push({onChange:y,options:_}),i=y=>{const _=n.findIndex(S=>S.onChange==y);_>-1&&n.splice(_,1)},r=(y,_)=>{const S={origin:y,changes:{created:_.created||[],updated:_.updated||[],deleted:_.deleted||[]},state:[...e.values()]};n.forEach(O=>{bo(O,S)&&O.onChange(S)})},s=(y,_=W.LOCAL)=>{if(e.get(y.id))throw Error(`Cannot add annotation ${y.id} - exists already`);e.set(y.id,y),y.bodies.forEach(S=>t.set(S.id,y.id)),r(_,{created:[y]})},a=(y,_)=>{const S=typeof y=="string"?_:y,O=typeof y=="string"?y:y.id,P=e.get(O);if(P){const N=Vt(P,S);return O===S.id?e.set(O,S):(e.delete(O),e.set(S.id,S)),P.bodies.forEach(V=>t.delete(V.id)),S.bodies.forEach(V=>t.set(V.id,S.id)),N}else console.warn(`Cannot update annotation ${O} - does not exist`)},l=(y,_=W.LOCAL,S=W.LOCAL)=>{const O=Ao(_)?S:_,P=a(y,_);P&&r(O,{updated:[P]})},u=(y,_=W.LOCAL)=>{const S=y.reduce((O,P)=>{const N=a(P);return N?[...O,N]:O},[]);S.length>0&&r(_,{updated:S})},h=(y,_=W.LOCAL)=>{const S=e.get(y.annotation);if(S){const O={...S,bodies:[...S.bodies,y]};e.set(S.id,O),t.set(y.id,O.id),r(_,{updated:[{oldValue:S,newValue:O,bodiesCreated:[y]}]})}else console.warn(`Attempt to add body to missing annotation: ${y.annotation}`)},f=()=>[...e.values()],m=(y=W.LOCAL)=>{const _=[...e.values()];e.clear(),t.clear(),r(y,{deleted:_})},d=(y,_=!0,S=W.LOCAL)=>{if(_){const O=[...e.values()];e.clear(),t.clear(),y.forEach(P=>{e.set(P.id,P),P.bodies.forEach(N=>t.set(N.id,P.id))}),r(S,{created:y,deleted:O})}else{const O=y.reduce((P,N)=>{const V=e.get(N.id);return V?[...P,V]:P},[]);if(O.length>0)throw Error(`Bulk insert would overwrite the following annotations: ${O.map(P=>P.id).join(", ")}`);y.forEach(P=>{e.set(P.id,P),P.bodies.forEach(N=>t.set(N.id,P.id))}),r(S,{created:y})}},g=y=>{const _=typeof y=="string"?y:y.id,S=e.get(_);if(S)return e.delete(_),S.bodies.forEach(O=>t.delete(O.id)),S;console.warn(`Attempt to delete missing annotation: ${_}`)},E=(y,_=W.LOCAL)=>{const S=g(y);S&&r(_,{deleted:[S]})},A=(y,_=W.LOCAL)=>{const S=y.reduce((O,P)=>{const N=g(P);return N?[...O,N]:O},[]);S.length>0&&r(_,{deleted:S})},b=(y,_=W.LOCAL)=>{const S=e.get(y.annotation);if(S){const O=S.bodies.find(P=>P.id===y.id);if(O){t.delete(O.id);const P={...S,bodies:S.bodies.filter(N=>N.id!==y.id)};e.set(S.id,P),r(_,{updated:[{oldValue:S,newValue:P,bodiesDeleted:[O]}]})}else console.warn(`Attempt to delete missing body ${y.id} from annotation ${y.annotation}`)}else console.warn(`Attempt to delete body from missing annotation ${y.annotation}`)},p=y=>{const _=e.get(y);return _?{..._}:void 0},w=y=>{const _=t.get(y);if(_){const S=p(_).bodies.find(O=>O.id===y);if(S)return S;console.error(`Store integrity error: body ${y} in index, but not in annotation`)}else console.warn(`Attempt to retrieve missing body: ${y}`)},T=(y,_)=>{if(y.annotation!==_.annotation)throw"Annotation integrity violation: annotation ID must be the same when updating bodies";const S=e.get(y.annotation);if(S){const O=S.bodies.find(N=>N.id===y.id),P={...S,bodies:S.bodies.map(N=>N.id===O.id?_:N)};return e.set(S.id,P),O.id!==_.id&&(t.delete(O.id),t.set(_.id,P.id)),{oldValue:S,newValue:P,bodiesUpdated:[{oldBody:O,newBody:_}]}}else console.warn(`Attempt to add body to missing annotation ${y.annotation}`)},L=(y,_,S=W.LOCAL)=>{const O=T(y,_);r(S,{updated:[O]})},D=(y,_=W.LOCAL)=>{const S=y.map(O=>T({id:O.id,annotation:O.annotation},O));r(_,{updated:S})},U=y=>{const _=e.get(y.annotation);if(_){const S={..._,target:{..._.target,...y}};return e.set(_.id,S),{oldValue:_,newValue:S,targetUpdated:{oldTarget:_.target,newTarget:y}}}else console.warn(`Attempt to update target on missing annotation: ${y.annotation}`)};return{addAnnotation:s,addBody:h,all:f,bulkAddAnnotation:d,bulkDeleteAnnotation:A,bulkUpdateAnnotation:u,bulkUpdateBodies:D,bulkUpdateTargets:(y,_=W.LOCAL)=>{const S=y.map(U).filter(O=>O);S.length>0&&r(_,{updated:S})},clear:m,deleteAnnotation:E,deleteBody:b,getAnnotation:p,getBody:w,observe:o,unobserve:i,updateAnnotation:l,updateBody:L,updateTarget:(y,_=W.LOCAL)=>{const S=U(y);S&&r(_,{updated:[S]})}}},To=e=>({...e,subscribe:t=>{const n=o=>t(o.state);return e.observe(n),t(e.all()),()=>e.unobserve(n)}});let Mo=()=>({emit(e,...t){let n=this.events[e]||[];for(let o=0,i=n.length;o<i;o++)n[o](...t)},events:{},on(e,t){var n;return(n=this.events[e])!=null&&n.push(t)||(this.events[e]=[t]),()=>{var o;this.events[e]=(o=this.events[e])==null?void 0:o.filter(i=>t!==i)}}});const Lo=250,Oo=e=>{const t=Mo(),n=[];let o=-1,i=!1,r=0;const s=d=>{if(!i){const{changes:g}=d,E=performance.now();if(E-r>Lo)n.splice(o+1),n.push(g),o=n.length-1;else{const A=n.length-1;n[A]=Eo(n[A],g)}r=E}i=!1};e.observe(s,{origin:W.LOCAL});const a=d=>(d==null?void 0:d.length)>0&&e.bulkDeleteAnnotation(d),l=d=>(d==null?void 0:d.length)>0&&e.bulkAddAnnotation(d,!1),u=d=>(d==null?void 0:d.length)>0&&e.bulkUpdateAnnotation(d.map(({oldValue:g})=>g)),h=d=>(d==null?void 0:d.length)>0&&e.bulkUpdateAnnotation(d.map(({newValue:g})=>g)),f=d=>(d==null?void 0:d.length)>0&&e.bulkAddAnnotation(d,!1),m=d=>(d==null?void 0:d.length)>0&&e.bulkDeleteAnnotation(d);return{canRedo:()=>n.length-1>o,canUndo:()=>o>-1,destroy:()=>e.unobserve(s),on:(d,g)=>t.on(d,g),redo:()=>{if(n.length-1>o){i=!0;const{created:d,updated:g,deleted:E}=n[o+1];l(d),h(g),m(E),t.emit("redo",n[o+1]),o+=1}},undo:()=>{if(o>-1){i=!0;const{created:d,updated:g,deleted:E}=n[o];a(d),u(g),f(E),t.emit("undo",n[o]),o-=1}}}},vo=()=>{const{subscribe:e,set:t}=rt([]);return{subscribe:e,set:t}},ko=(e,t,n,o)=>{const{store:i,selection:r,hover:s,viewport:a}=e,l=new Map;let u=[],h,f;const m=(b,p)=>{l.has(b)?l.get(b).push(p):l.set(b,[p])},d=(b,p)=>{const w=l.get(b);w&&w.indexOf(p)>0&&w.splice(w.indexOf(p),1)},g=(b,p,w)=>{l.has(b)&&setTimeout(()=>{l.get(b).forEach(T=>{if(n){const L=Array.isArray(p)?p.map(U=>n.serialize(U)):n.serialize(p),D=w?w instanceof PointerEvent?w:n.serialize(w):void 0;T(L,D)}else T(p,w)})},1)},E=()=>{const{selected:b}=r,p=b.map(({id:w})=>i.getAnnotation(w));p.forEach(w=>{const T=u.find(L=>L.id===w.id);(!T||!ye(T,w))&&g("updateAnnotation",w,T)}),u=u.map(w=>p.find(({id:L})=>L===w.id)||w)};r.subscribe(({selected:b})=>{if(!(u.length===0&&b.length===0)){if(u.length===0&&b.length>0)u=b.map(({id:p})=>i.getAnnotation(p));else if(u.length>0&&b.length===0)u.forEach(p=>{const w=i.getAnnotation(p.id);w&&!ye(w,p)&&g("updateAnnotation",w,p)}),u=[];else{const p=new Set(u.map(T=>T.id)),w=new Set(b.map(({id:T})=>T));u.filter(T=>!w.has(T.id)).forEach(T=>{const L=i.getAnnotation(T.id);L&&!ye(L,T)&&g("updateAnnotation",L,T)}),u=[...u.filter(T=>w.has(T.id)),...b.filter(({id:T})=>!p.has(T)).map(({id:T})=>i.getAnnotation(T))]}g("selectionChanged",u)}}),s.subscribe(b=>{!h&&b?g("mouseEnterAnnotation",i.getAnnotation(b)):h&&!b?g("mouseLeaveAnnotation",i.getAnnotation(h)):h&&b&&(g("mouseLeaveAnnotation",i.getAnnotation(h)),g("mouseEnterAnnotation",i.getAnnotation(b))),h=b}),a==null||a.subscribe(b=>g("viewportIntersect",b.map(i.getAnnotation))),i.observe(b=>{o&&(f&&clearTimeout(f),f=setTimeout(E,1e3));const{created:p,deleted:w}=b.changes;p.forEach(T=>g("createAnnotation",T)),w.forEach(T=>g("deleteAnnotation",T)),b.changes.updated.filter(T=>[...T.bodiesCreated||[],...T.bodiesDeleted||[],...T.bodiesUpdated||[]].length>0).forEach(({oldValue:T,newValue:L})=>{const D=u.find(U=>U.id===T.id)||T;u=u.map(U=>U.id===T.id?L:U),g("updateAnnotation",L,D)})},{origin:W.LOCAL}),i.observe(b=>{if(u){const p=new Set(u.map(T=>T.id)),w=b.changes.updated.filter(({newValue:T})=>p.has(T.id)).map(({newValue:T})=>T);w.length>0&&(u=u.map(T=>w.find(D=>D.id===T.id)||T))}},{origin:W.REMOTE});const A=b=>p=>{const{created:w,deleted:T,updated:L}=p;w.forEach(D=>g("createAnnotation",D)),T.forEach(D=>g("deleteAnnotation",D)),b?L.forEach(D=>g("updateAnnotation",D.oldValue,D.newValue)):L.forEach(D=>g("updateAnnotation",D.newValue,D.oldValue))};return t.on("undo",A(!0)),t.on("redo",A(!1)),{on:m,off:d,emit:g}},Io=e=>t=>t.reduce((n,o)=>{const{parsed:i,error:r}=e.parse(o);return r?{parsed:n.parsed,failed:[...n.failed,o]}:{parsed:[...n.parsed,i],failed:n.failed}},{parsed:[],failed:[]}),Po=(e,t,n)=>{const{store:o,selection:i}=e,r=A=>{if(n){const{parsed:b,error:p}=n.parse(A);b?o.addAnnotation(b,W.REMOTE):console.error(p)}else o.addAnnotation(A,W.REMOTE)},s=()=>i.clear(),a=()=>o.clear(),l=A=>{const b=o.getAnnotation(A);return n&&b?n.serialize(b):b},u=()=>n?o.all().map(n.serialize):o.all(),h=()=>{var A;const b=(((A=i.selected)==null?void 0:A.map(p=>p.id))||[]).map(p=>o.getAnnotation(p));return n?b.map(n.serialize):b},f=A=>fetch(A).then(b=>b.json()).then(b=>(d(b),b)),m=A=>{if(typeof A=="string"){const b=o.getAnnotation(A);return o.deleteAnnotation(A),n?n.serialize(b):b}else{const b=n?n.parse(A).parsed:A;return o.deleteAnnotation(b),A}},d=A=>{if(n){const{parsed:b,failed:p}=Io(n)(A);p.length>0&&console.warn(`Discarded ${p.length} invalid annotations`,p),o.bulkAddAnnotation(b,!0,W.REMOTE)}else o.bulkAddAnnotation(A,!0,W.REMOTE)},g=A=>{A?i.setSelected(A):i.clear()},E=A=>{if(n){const b=n.parse(A).parsed,p=n.serialize(o.getAnnotation(b.id));return o.updateAnnotation(b),p}else{const b=o.getAnnotation(A.id);return o.updateAnnotation(A),b}};return{addAnnotation:r,cancelSelected:s,canRedo:t.canRedo,canUndo:t.canUndo,clearAnnotations:a,getAnnotationById:l,getAnnotations:u,getSelected:h,loadAnnotations:f,redo:t.redo,removeAnnotation:m,setAnnotations:d,setSelected:g,undo:t.undo,updateAnnotation:E}};let Do=e=>crypto.getRandomValues(new Uint8Array(e)),Bo=(e,t,n)=>{let o=(2<<Math.log(e.length-1)/Math.LN2)-1,i=-~(1.6*o*t/e.length);return(r=t)=>{let s="";for(;;){let a=n(i),l=i;for(;l--;)if(s+=e[a[l]&o]||"",s.length===r)return s}}},Yo=(e,t=21)=>Bo(e,t,Do),Ro=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((t,n)=>(n&=63,n<36?t+=n.toString(36):n<62?t+=(n-26).toString(36).toUpperCase():n>62?t+="-":t+="_",t),"");const Xo=()=>({isGuest:!0,id:Yo("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",20)()}),Co=e=>{const t=JSON.stringify(e);let n=0;for(let o=0,i=t.length;o<i;o++){let r=t.charCodeAt(o);n=(n<<5)-n+r,n|=0}return`${n}`},Gt=e=>e?typeof e=="object"?{...e}:e:void 0,Uo=(e,t)=>(Array.isArray(e)?e:[e]).map(n=>{const{id:o,type:i,purpose:r,value:s,created:a,creator:l,...u}=n;return{id:o||`temp-${Co(n)}`,annotation:t,type:i,purpose:r,value:s,created:a?new Date(a):void 0,creator:Gt(l),...u}}),No=e=>e.map(t=>{var n;const o={...t};return delete o.annotation,(n=o.id)!=null&&n.startsWith("temp-")&&delete o.id,o});Ro();const Vo=(e,t=!1)=>({parse:i=>Ft(i,t),serialize:i=>Ht(i,e)}),Ft=(e,t=!1)=>{const n=e.id||Ct(),{creator:o,created:i,updatedBy:r,updated:s,body:a,...l}=e,u=Uo(a,n),h=Array.isArray(e.target)?e.target[0]:e.target,f=Array.isArray(h.selector)?h.selector[0]:h.selector,m=f.type==="FragmentSelector"?It(f,t):f.type==="SvgSelector"?Yt(f):void 0;return m?{parsed:{...l,id:n,bodies:u,target:{created:i?new Date(i):void 0,creator:Gt(o),...l.target,annotation:n,selector:m}}}:{error:Error(`Unknown selector type: ${f.type}`)}},Ht=(e,t)=>{const{selector:n,creator:o,created:i,updated:r,updatedBy:s,...a}=e.target,l=n.type==z.RECTANGLE?Pt(n.geometry):Rt(n);return{...e,"@context":"http://www.w3.org/ns/anno.jsonld",id:e.id,type:"Annotation",body:No(e.bodies),creator:o,created:i==null?void 0:i.toISOString(),target:{...a,source:t,selector:l}}};function zt(e,t,n){const o=e.slice();return o[11]=t[n],o[13]=n,o}function jt(e){let t,n,o,i,r;return{c(){t=R("rect"),c(t,"class","a9s-corner-handle"),c(t,"x",n=e[11][0]-e[3]/2),c(t,"y",o=e[11][1]-e[3]/2),c(t,"height",e[3]),c(t,"width",e[3])},m(s,a){k(s,t,a),i||(r=K(t,"pointerdown",function(){j(e[10](M(e[13])))&&e[10](M(e[13])).apply(this,arguments)}),i=!0)},p(s,a){e=s,a&24&&n!==(n=e[11][0]-e[3]/2)&&c(t,"x",n),a&24&&o!==(o=e[11][1]-e[3]/2)&&c(t,"y",o),a&8&&c(t,"height",e[3]),a&8&&c(t,"width",e[3])},d(s){s&&v(t),i=!1,r()}}}function Go(e){let t,n,o,i,r,s,a,l,u,h,f=e[4].points,m=[];for(let d=0;d<f.length;d+=1)m[d]=jt(zt(e,f,d));return{c(){t=R("polygon"),i=x(),r=R("polygon"),a=x();for(let d=0;d<m.length;d+=1)m[d].c();l=fe(),c(t,"class","a9s-outer"),c(t,"style",n=e[1]?"display:none;":void 0),c(t,"points",o=e[4].points.map(Kt).join(" ")),c(r,"class","a9s-inner a9s-shape-handle"),c(r,"style",e[1]),c(r,"points",s=e[4].points.map(Wt).join(" "))},m(d,g){k(d,t,g),k(d,i,g),k(d,r,g),k(d,a,g);for(let E=0;E<m.length;E+=1)m[E]&&m[E].m(d,g);k(d,l,g),u||(h=[K(t,"pointerdown",function(){j(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)}),K(r,"pointerdown",function(){j(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)})],u=!0)},p(d,g){if(e=d,g&2&&n!==(n=e[1]?"display:none;":void 0)&&c(t,"style",n),g&16&&o!==(o=e[4].points.map(Kt).join(" "))&&c(t,"points",o),g&2&&c(r,"style",e[1]),g&16&&s!==(s=e[4].points.map(Wt).join(" "))&&c(r,"points",s),g&1048){f=e[4].points;let E;for(E=0;E<f.length;E+=1){const A=zt(e,f,E);m[E]?m[E].p(A,g):(m[E]=jt(A),m[E].c(),m[E].m(l.parentNode,l))}for(;E<m.length;E+=1)m[E].d(1);m.length=f.length}},d(d){d&&v(t),d&&v(i),d&&v(r),d&&v(a),Qe(m,d),d&&v(l),u=!1,le(h)}}}function Fo(e){let t,n;return t=new Ye({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[Go,({grab:o})=>({10:o}),({grab:o})=>o?1024:0]},$$scope:{ctx:e}}}),t.$on("change",e[7]),t.$on("grab",e[8]),t.$on("release",e[9]),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&4&&(r.transform=o[2]),i&17434&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}const Kt=e=>e.join(","),Wt=e=>e.join(",");function Ho(e,t,n){let o,i,{shape:r}=t,{computedStyle:s=void 0}=t,{transform:a}=t,{viewportScale:l=1}=t;const u=(d,g,E)=>{let A;g===M.SHAPE?A=d.geometry.points.map(([p,w])=>[p+E[0],w+E[1]]):A=d.geometry.points.map(([p,w],T)=>g===M(T)?[p+E[0],w+E[1]]:[p,w]);const b=me(A);return{...d,geometry:{points:A,bounds:b}}};function h(d){ie.call(this,e,d)}function f(d){ie.call(this,e,d)}function m(d){ie.call(this,e,d)}return e.$$set=d=>{"shape"in d&&n(0,r=d.shape),"computedStyle"in d&&n(1,s=d.computedStyle),"transform"in d&&n(2,a=d.transform),"viewportScale"in d&&n(6,l=d.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=r.geometry),e.$$.dirty&64&&n(3,i=10/l)},[r,s,a,i,o,u,l,h,f,m]}class qt extends ee{constructor(t){super(),$(this,t,Ho,Fo,Z,{shape:0,computedStyle:1,transform:2,viewportScale:6})}}function zo(e){let t,n,o,i,r,s,a,l,u,h,f,m,d,g,E,A,b,p,w,T,L,D,U,y,_,S,O,P,N,V,X,ve,Ue,B,te,q,we,J,be,Ke,gt,ne,We,qe,pt,oe,Ze,Je,yt,Bn;return{c(){t=R("rect"),a=x(),l=R("rect"),d=x(),g=R("rect"),p=x(),w=R("rect"),U=x(),y=R("rect"),P=x(),N=R("rect"),Ue=x(),B=R("rect"),we=x(),J=R("rect"),gt=x(),ne=R("rect"),pt=x(),oe=R("rect"),c(t,"class","a9s-outer"),c(t,"style",n=e[1]?"display:none;":void 0),c(t,"x",o=e[4].x),c(t,"y",i=e[4].y),c(t,"width",r=e[4].w),c(t,"height",s=e[4].h),c(l,"class","a9s-inner a9s-shape-handle"),c(l,"style",e[1]),c(l,"x",u=e[4].x),c(l,"y",h=e[4].y),c(l,"width",f=e[4].w),c(l,"height",m=e[4].h),c(g,"class","a9s-edge-handle a9s-edge-handle-top"),c(g,"x",E=e[4].x),c(g,"y",A=e[4].y),c(g,"height",1),c(g,"width",b=e[4].w),c(w,"class","a9s-edge-handle a9s-edge-handle-right"),c(w,"x",T=e[4].x+e[4].w),c(w,"y",L=e[4].y),c(w,"height",D=e[4].h),c(w,"width",1),c(y,"class","a9s-edge-handle a9s-edge-handle-bottom"),c(y,"x",_=e[4].x),c(y,"y",S=e[4].y+e[4].h),c(y,"height",1),c(y,"width",O=e[4].w),c(N,"class","a9s-edge-handle a9s-edge-handle-left"),c(N,"x",V=e[4].x),c(N,"y",X=e[4].y),c(N,"height",ve=e[4].h),c(N,"width",1),c(B,"class","a9s-corner-handle a9s-corner-handle-topleft"),c(B,"x",te=e[4].x-e[3]/2),c(B,"y",q=e[4].y-e[3]/2),c(B,"height",e[3]),c(B,"width",e[3]),c(J,"class","a9s-corner-handle a9s-corner-handle-topright"),c(J,"x",be=e[4].x+e[4].w-e[3]/2),c(J,"y",Ke=e[4].y-e[3]/2),c(J,"height",e[3]),c(J,"width",e[3]),c(ne,"class","a9s-corner-handle a9s-corner-handle-bottomright"),c(ne,"x",We=e[4].x+e[4].w-e[3]/2),c(ne,"y",qe=e[4].y+e[4].h-e[3]/2),c(ne,"height",e[3]),c(ne,"width",e[3]),c(oe,"class","a9s-corner-handle a9s-corner-handle-bottomleft"),c(oe,"x",Ze=e[4].x-e[3]/2),c(oe,"y",Je=e[4].y+e[4].h-e[3]/2),c(oe,"height",e[3]),c(oe,"width",e[3])},m(C,I){k(C,t,I),k(C,a,I),k(C,l,I),k(C,d,I),k(C,g,I),k(C,p,I),k(C,w,I),k(C,U,I),k(C,y,I),k(C,P,I),k(C,N,I),k(C,Ue,I),k(C,B,I),k(C,we,I),k(C,J,I),k(C,gt,I),k(C,ne,I),k(C,pt,I),k(C,oe,I),yt||(Bn=[K(t,"pointerdown",function(){j(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)}),K(l,"pointerdown",function(){j(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)}),K(g,"pointerdown",function(){j(e[10](M.TOP))&&e[10](M.TOP).apply(this,arguments)}),K(w,"pointerdown",function(){j(e[10](M.RIGHT))&&e[10](M.RIGHT).apply(this,arguments)}),K(y,"pointerdown",function(){j(e[10](M.BOTTOM))&&e[10](M.BOTTOM).apply(this,arguments)}),K(N,"pointerdown",function(){j(e[10](M.LEFT))&&e[10](M.LEFT).apply(this,arguments)}),K(B,"pointerdown",function(){j(e[10](M.TOP_LEFT))&&e[10](M.TOP_LEFT).apply(this,arguments)}),K(J,"pointerdown",function(){j(e[10](M.TOP_RIGHT))&&e[10](M.TOP_RIGHT).apply(this,arguments)}),K(ne,"pointerdown",function(){j(e[10](M.BOTTOM_RIGHT))&&e[10](M.BOTTOM_RIGHT).apply(this,arguments)}),K(oe,"pointerdown",function(){j(e[10](M.BOTTOM_LEFT))&&e[10](M.BOTTOM_LEFT).apply(this,arguments)})],yt=!0)},p(C,I){e=C,I&2&&n!==(n=e[1]?"display:none;":void 0)&&c(t,"style",n),I&16&&o!==(o=e[4].x)&&c(t,"x",o),I&16&&i!==(i=e[4].y)&&c(t,"y",i),I&16&&r!==(r=e[4].w)&&c(t,"width",r),I&16&&s!==(s=e[4].h)&&c(t,"height",s),I&2&&c(l,"style",e[1]),I&16&&u!==(u=e[4].x)&&c(l,"x",u),I&16&&h!==(h=e[4].y)&&c(l,"y",h),I&16&&f!==(f=e[4].w)&&c(l,"width",f),I&16&&m!==(m=e[4].h)&&c(l,"height",m),I&16&&E!==(E=e[4].x)&&c(g,"x",E),I&16&&A!==(A=e[4].y)&&c(g,"y",A),I&16&&b!==(b=e[4].w)&&c(g,"width",b),I&16&&T!==(T=e[4].x+e[4].w)&&c(w,"x",T),I&16&&L!==(L=e[4].y)&&c(w,"y",L),I&16&&D!==(D=e[4].h)&&c(w,"height",D),I&16&&_!==(_=e[4].x)&&c(y,"x",_),I&16&&S!==(S=e[4].y+e[4].h)&&c(y,"y",S),I&16&&O!==(O=e[4].w)&&c(y,"width",O),I&16&&V!==(V=e[4].x)&&c(N,"x",V),I&16&&X!==(X=e[4].y)&&c(N,"y",X),I&16&&ve!==(ve=e[4].h)&&c(N,"height",ve),I&24&&te!==(te=e[4].x-e[3]/2)&&c(B,"x",te),I&24&&q!==(q=e[4].y-e[3]/2)&&c(B,"y",q),I&8&&c(B,"height",e[3]),I&8&&c(B,"width",e[3]),I&24&&be!==(be=e[4].x+e[4].w-e[3]/2)&&c(J,"x",be),I&24&&Ke!==(Ke=e[4].y-e[3]/2)&&c(J,"y",Ke),I&8&&c(J,"height",e[3]),I&8&&c(J,"width",e[3]),I&24&&We!==(We=e[4].x+e[4].w-e[3]/2)&&c(ne,"x",We),I&24&&qe!==(qe=e[4].y+e[4].h-e[3]/2)&&c(ne,"y",qe),I&8&&c(ne,"height",e[3]),I&8&&c(ne,"width",e[3]),I&24&&Ze!==(Ze=e[4].x-e[3]/2)&&c(oe,"x",Ze),I&24&&Je!==(Je=e[4].y+e[4].h-e[3]/2)&&c(oe,"y",Je),I&8&&c(oe,"height",e[3]),I&8&&c(oe,"width",e[3])},d(C){C&&v(t),C&&v(a),C&&v(l),C&&v(d),C&&v(g),C&&v(p),C&&v(w),C&&v(U),C&&v(y),C&&v(P),C&&v(N),C&&v(Ue),C&&v(B),C&&v(we),C&&v(J),C&&v(gt),C&&v(ne),C&&v(pt),C&&v(oe),yt=!1,le(Bn)}}}function jo(e){let t,n;return t=new Ye({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[zo,({grab:o})=>({10:o}),({grab:o})=>o?1024:0]},$$scope:{ctx:e}}}),t.$on("grab",e[7]),t.$on("change",e[8]),t.$on("release",e[9]),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&4&&(r.transform=o[2]),i&3098&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function Ko(e,t,n){let o,i,{shape:r}=t,{computedStyle:s=void 0}=t,{transform:a}=t,{viewportScale:l=1}=t;const u=(d,g,E)=>{const A=d.geometry.bounds;let[b,p]=[A.minX,A.minY],[w,T]=[A.maxX,A.maxY];const[L,D]=E;if(g===M.SHAPE)b+=L,w+=L,p+=D,T+=D;else{switch(g){case M.TOP:case M.TOP_LEFT:case M.TOP_RIGHT:{p+=D;break}case M.BOTTOM:case M.BOTTOM_LEFT:case M.BOTTOM_RIGHT:{T+=D;break}}switch(g){case M.LEFT:case M.TOP_LEFT:case M.BOTTOM_LEFT:{b+=L;break}case M.RIGHT:case M.TOP_RIGHT:case M.BOTTOM_RIGHT:{w+=L;break}}}const U=Math.min(b,w),y=Math.min(p,T),_=Math.abs(w-b),S=Math.abs(T-p);return{...d,geometry:{x:U,y,w:_,h:S,bounds:{minX:U,minY:y,maxX:U+_,maxY:y+S}}}};function h(d){ie.call(this,e,d)}function f(d){ie.call(this,e,d)}function m(d){ie.call(this,e,d)}return e.$$set=d=>{"shape"in d&&n(0,r=d.shape),"computedStyle"in d&&n(1,s=d.computedStyle),"transform"in d&&n(2,a=d.transform),"viewportScale"in d&&n(6,l=d.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=r.geometry),e.$$.dirty&64&&n(3,i=10/l)},[r,s,a,i,o,u,l,h,f,m]}class Zt extends ee{constructor(t){super(),$(this,t,Ko,jo,Z,{shape:0,computedStyle:1,transform:2,viewportScale:6})}}function Wo(e){let t,n,o,i,r,s,a,l,u,h,f,m,d,g,E,A,b,p,w,T,L,D,U,y,_,S,O,P,N;return{c(){t=R("ellipse"),s=x(),a=R("ellipse"),m=x(),d=R("rect"),A=x(),b=R("rect"),T=x(),L=R("rect"),y=x(),_=R("rect"),c(t,"class","a9s-outer"),c(t,"cx",n=e[3].cx),c(t,"cy",o=e[3].cy),c(t,"rx",i=e[3].rx),c(t,"ry",r=e[3].ry),c(a,"class","a9s-inner a9s-shape-handle"),c(a,"cx",l=e[3].cx),c(a,"cy",u=e[3].cy),c(a,"rx",h=e[3].rx),c(a,"ry",f=e[3].ry),c(d,"class","a9s-corner-handle a9s-corner-top"),c(d,"x",g=e[3].cx-e[2]/2),c(d,"y",E=e[3].cy-e[2]/2-e[3].ry),c(d,"height",e[2]),c(d,"width",e[2]),c(b,"class","a9s-corner-handle a9s-corner-handle-right"),c(b,"x",p=e[3].cx+e[3].rx-e[2]/2),c(b,"y",w=e[3].cy-e[2]/2),c(b,"height",e[2]),c(b,"width",e[2]),c(L,"class","a9s-corner-handle a9s-corner-handle-bottom"),c(L,"x",D=e[3].cx-e[2]/2),c(L,"y",U=e[3].cy+e[3].ry-e[2]/2),c(L,"height",e[2]),c(L,"width",e[2]),c(_,"class","a9s-corner-handle a9s-corner-handle-left"),c(_,"x",S=e[3].cx-e[3].rx-e[2]/2),c(_,"y",O=e[3].cy-e[2]/2),c(_,"height",e[2]),c(_,"width",e[2])},m(V,X){k(V,t,X),k(V,s,X),k(V,a,X),k(V,m,X),k(V,d,X),k(V,A,X),k(V,b,X),k(V,T,X),k(V,L,X),k(V,y,X),k(V,_,X),P||(N=[K(t,"pointerdown",function(){j(e[9](M.SHAPE))&&e[9](M.SHAPE).apply(this,arguments)}),K(a,"pointerdown",function(){j(e[9](M.SHAPE))&&e[9](M.SHAPE).apply(this,arguments)}),K(d,"pointerdown",function(){j(e[9](M.TOP))&&e[9](M.TOP).apply(this,arguments)}),K(b,"pointerdown",function(){j(e[9](M.RIGHT))&&e[9](M.RIGHT).apply(this,arguments)}),K(L,"pointerdown",function(){j(e[9](M.BOTTOM))&&e[9](M.BOTTOM).apply(this,arguments)}),K(_,"pointerdown",function(){j(e[9](M.LEFT))&&e[9](M.LEFT).apply(this,arguments)})],P=!0)},p(V,X){e=V,X&8&&n!==(n=e[3].cx)&&c(t,"cx",n),X&8&&o!==(o=e[3].cy)&&c(t,"cy",o),X&8&&i!==(i=e[3].rx)&&c(t,"rx",i),X&8&&r!==(r=e[3].ry)&&c(t,"ry",r),X&8&&l!==(l=e[3].cx)&&c(a,"cx",l),X&8&&u!==(u=e[3].cy)&&c(a,"cy",u),X&8&&h!==(h=e[3].rx)&&c(a,"rx",h),X&8&&f!==(f=e[3].ry)&&c(a,"ry",f),X&12&&g!==(g=e[3].cx-e[2]/2)&&c(d,"x",g),X&12&&E!==(E=e[3].cy-e[2]/2-e[3].ry)&&c(d,"y",E),X&4&&c(d,"height",e[2]),X&4&&c(d,"width",e[2]),X&12&&p!==(p=e[3].cx+e[3].rx-e[2]/2)&&c(b,"x",p),X&12&&w!==(w=e[3].cy-e[2]/2)&&c(b,"y",w),X&4&&c(b,"height",e[2]),X&4&&c(b,"width",e[2]),X&12&&D!==(D=e[3].cx-e[2]/2)&&c(L,"x",D),X&12&&U!==(U=e[3].cy+e[3].ry-e[2]/2)&&c(L,"y",U),X&4&&c(L,"height",e[2]),X&4&&c(L,"width",e[2]),X&12&&S!==(S=e[3].cx-e[3].rx-e[2]/2)&&c(_,"x",S),X&12&&O!==(O=e[3].cy-e[2]/2)&&c(_,"y",O),X&4&&c(_,"height",e[2]),X&4&&c(_,"width",e[2])},d(V){V&&v(t),V&&v(s),V&&v(a),V&&v(m),V&&v(d),V&&v(A),V&&v(b),V&&v(T),V&&v(L),V&&v(y),V&&v(_),P=!1,le(N)}}}function qo(e){let t,n;return t=new Ye({props:{shape:e[0],transform:e[1],editor:e[4],$$slots:{default:[Wo,({grab:o})=>({9:o}),({grab:o})=>o?512:0]},$$scope:{ctx:e}}}),t.$on("grab",e[6]),t.$on("change",e[7]),t.$on("release",e[8]),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&2&&(r.transform=o[1]),i&1548&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function Zo(e,t,n){let o,i,{shape:r}=t,{transform:s}=t,{viewportScale:a=1}=t;const l=(m,d,g)=>{const E=m.geometry.bounds;let[A,b]=[E.minX,E.minY],[p,w]=[E.maxX,E.maxY];const[T,L]=g;if(d===M.SHAPE)A+=T,p+=T,b+=L,w+=L;else switch(d){case M.TOP:{b+=L;break}case M.BOTTOM:{w+=L;break}case M.LEFT:{A+=T;break}case M.RIGHT:{p+=T;break}}const D=Math.min(A,p),U=Math.min(b,w),y=Math.abs(p-A),_=Math.abs(w-b),S=(A+p)/2,O=(b+w)/2,P=y/2,N=_/2;return{...m,geometry:{...m.geometry,cx:S,cy:O,rx:P,ry:N,bounds:{minX:D,minY:U,maxX:D+y,maxY:U+_}}}};function u(m){ie.call(this,e,m)}function h(m){ie.call(this,e,m)}function f(m){ie.call(this,e,m)}return e.$$set=m=>{"shape"in m&&n(0,r=m.shape),"transform"in m&&n(1,s=m.transform),"viewportScale"in m&&n(5,a=m.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(3,o=r.geometry),e.$$.dirty&32&&n(2,i=10/a)},[r,s,i,o,l,a,u,h,f]}class Jt extends ee{constructor(t){super(),$(this,t,Zo,qo,Z,{shape:0,transform:1,viewportScale:5})}}const _e=(e,t,n)=>{const o=typeof t=="function"?t(e):t;if(o){const{fill:i,fillOpacity:r}=o;let s="",a;return i&&(s+=`fill:${i};stroke:${i};`),n&&(a=n.fillOpacity),s+=`fill-opacity:${a||r||"0.25"};`,s}};function Jo(e){let t,n,o;return{c(){t=R("path"),c(t,"class","a9s-shape-handle"),c(t,"style",e[3]),c(t,"d",e[2])},m(i,r){k(i,t,r),n||(o=K(t,"pointerdown",function(){j(e[14](M.SHAPE))&&e[14](M.SHAPE).apply(this,arguments)}),n=!0)},p(i,r){e=i,r&8&&c(t,"style",e[3]),r&4&&c(t,"d",e[2])},d(i){i&&v(t),n=!1,o()}}}function Qo(e){let t,n;return t=new Ye({props:{shape:e[0],transform:e[1],editor:e[4],$$slots:{default:[Jo,({grab:o})=>({14:o}),({grab:o})=>o?16384:0]},$$scope:{ctx:e}}}),t.$on("change",e[9]),t.$on("grab",e[10]),t.$on("release",e[11]),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&2&&(r.transform=o[1]),i&49164&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function xo(e,t,n){let o,i,r,{shape:s}=t,{annotation:a}=t,{transform:l}=t,{viewportScale:u=1}=t,{style:h=void 0}=t,f={fillOpacity:1};const m=(A,b,p)=>{let w;b===M.SHAPE&&(w=A.geometry.points.map(([L,D,U])=>[L+p[0],D+p[1],U]));const T=me(w.map(L=>[L[0],L[1]]));return{...A,geometry:{points:w,bounds:T}}};function d(A){ie.call(this,e,A)}function g(A){ie.call(this,e,A)}function E(A){ie.call(this,e,A)}return e.$$set=A=>{"shape"in A&&n(0,s=A.shape),"annotation"in A&&n(5,a=A.annotation),"transform"in A&&n(1,l=A.transform),"viewportScale"in A&&n(6,u=A.viewportScale),"style"in A&&n(7,h=A.style)},e.$$.update=()=>{e.$$.dirty&1&&n(8,o=s.geometry),e.$$.dirty&64,e.$$.dirty&160&&n(3,i=_e(a,h,f)),e.$$.dirty&256&&n(2,r=Be(o.points,ot,!0))},[s,l,r,i,m,a,u,h,o,d,g,E]}class Qt extends ee{constructor(t){super(),$(this,t,xo,Qo,Z,{shape:0,annotation:5,transform:1,viewportScale:6,style:7})}}const xt=new Map([[z.RECTANGLE,Zt],[z.POLYGON,qt],[z.ELLIPSE,Jt],[z.FREEHAND,Qt]]),lt=e=>xt.get(e.type),$t=(e,t)=>xt.set(e,t),M=e=>`HANDLE-${e}`;M.SHAPE="SHAPE",M.TOP="TOP",M.RIGHT="RIGHT",M.BOTTOM="BOTTOM",M.LEFT="LEFT",M.TOP_LEFT="TOP_LEFT",M.TOP_RIGHT="TOP_RIGHT",M.BOTTOM_RIGHT="BOTTOM_RIGHT",M.BOTTOM_LEFT="BOTTOM_LEFT";const $o=e=>({}),en=e=>({grab:e[0]});function ei(e){let t,n,o,i;const r=e[7].default,s=Xn(r,e,e[6],en);return{c(){t=R("g"),s&&s.c(),c(t,"class","a9s-annotation selected")},m(a,l){k(a,t,l),s&&s.m(t,null),n=!0,o||(i=[K(t,"pointerup",e[2]),K(t,"pointermove",e[1])],o=!0)},p(a,[l]){s&&s.p&&(!n||l&64)&&Un(s,r,a,a[6],n?Cn(r,a[6],l,$o):Nn(a[6]),en)},i(a){n||(G(s,a),n=!0)},o(a){H(s,a),n=!1},d(a){a&&v(t),s&&s.d(a),o=!1,le(i)}}}function ti(e,t,n){let{$$slots:o={},$$scope:i}=t;const r=he();let{shape:s}=t,{editor:a}=t,{transform:l}=t,u=null,h,f=null;const m=E=>A=>{u=E,h=l.elementToImage(A.offsetX,A.offsetY),f=s,A.target.setPointerCapture(A.pointerId),r("grab")},d=E=>{if(u){const[A,b]=l.elementToImage(E.offsetX,E.offsetY),p=[A-h[0],b-h[1]];n(3,s=a(f,u,p)),r("change",s)}},g=E=>{E.target.releasePointerCapture(E.pointerId),u=null,f=s,r("release")};return e.$$set=E=>{"shape"in E&&n(3,s=E.shape),"editor"in E&&n(4,a=E.editor),"transform"in E&&n(5,l=E.transform),"$$scope"in E&&n(6,i=E.$$scope)},[m,d,g,s,a,l,i,o]}class Ye extends ee{constructor(t){super(),$(this,t,ti,ei,Z,{shape:3,editor:4,transform:5})}}function ni(e,t,n){let o;const i=he();let{annotation:r}=t,{editor:s}=t,{style:a=void 0}=t,{target:l}=t,{transform:u}=t,{viewportScale:h}=t,f;return ge(()=>(n(6,f=new s({target:l,props:{shape:r.target.selector,computedStyle:o,transform:u,viewportScale:h}})),f.$on("change",m=>{f.$$set({shape:m.detail}),i("change",m.detail)}),f.$on("grab",m=>i("grab",m.detail)),f.$on("release",m=>i("release",m.detail)),()=>{f.$destroy()})),e.$$set=m=>{"annotation"in m&&n(0,r=m.annotation),"editor"in m&&n(1,s=m.editor),"style"in m&&n(2,a=m.style),"target"in m&&n(3,l=m.target),"transform"in m&&n(4,u=m.transform),"viewportScale"in m&&n(5,h=m.viewportScale)},e.$$.update=()=>{e.$$.dirty&5&&(o=_e(r,a)),e.$$.dirty&65&&r&&(f==null||f.$set({shape:r.target.selector})),e.$$.dirty&80&&f&&f.$set({transform:u}),e.$$.dirty&96&&f&&f.$set({viewportScale:h})},[r,s,a,l,u,h,f]}class tn extends ee{constructor(t){super(),$(this,t,ni,null,Z,{annotation:0,editor:1,style:2,target:3,transform:4,viewportScale:5})}}function oi(e,t,n){const o=he();let{drawingMode:i}=t,{target:r}=t,{tool:s}=t,{transform:a}=t,{viewportScale:l}=t,u;return ge(()=>{const h=r.closest("svg"),f=[],m=(d,g,E)=>{h.addEventListener(d,g,E),f.push(()=>h.removeEventListener(d,g,E))};return n(5,u=new s({target:r,props:{addEventListener:m,drawingMode:i,transform:a,viewportScale:l}})),u.$on("create",d=>o("create",d.detail)),()=>{f.forEach(d=>d()),u.$destroy()}}),e.$$set=h=>{"drawingMode"in h&&n(0,i=h.drawingMode),"target"in h&&n(1,r=h.target),"tool"in h&&n(2,s=h.tool),"transform"in h&&n(3,a=h.transform),"viewportScale"in h&&n(4,l=h.viewportScale)},e.$$.update=()=>{e.$$.dirty&40&&u&&u.$set({transform:a}),e.$$.dirty&48&&u&&u.$set({viewportScale:l})},[i,r,s,a,l,u]}class nn extends ee{constructor(t){super(),$(this,t,oi,null,Z,{drawingMode:0,target:1,tool:2,transform:3,viewportScale:4})}}function on(e){let t,n;return{c(){t=R("rect"),n=R("rect"),c(t,"class","a9s-outer"),c(t,"x",e[1]),c(t,"y",e[2]),c(t,"width",e[3]),c(t,"height",e[4]),c(n,"class","a9s-inner"),c(n,"x",e[1]),c(n,"y",e[2]),c(n,"width",e[3]),c(n,"height",e[4])},m(o,i){k(o,t,i),k(o,n,i)},p(o,i){i&2&&c(t,"x",o[1]),i&4&&c(t,"y",o[2]),i&8&&c(t,"width",o[3]),i&16&&c(t,"height",o[4]),i&2&&c(n,"x",o[1]),i&4&&c(n,"y",o[2]),i&8&&c(n,"width",o[3]),i&16&&c(n,"height",o[4])},d(o){o&&v(t),o&&v(n)}}}function ii(e){let t,n=e[0]&&on(e);return{c(){t=R("g"),n&&n.c(),c(t,"class","a9s-annotation a9s-rubberband")},m(o,i){k(o,t,i),n&&n.m(t,null)},p(o,[i]){o[0]?n?n.p(o,i):(n=on(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:F,o:F,d(o){o&&v(t),n&&n.d()}}}function ri(e,t,n){const o=he();let{addEventListener:i}=t,{drawingMode:r}=t,{transform:s}=t,a,l,u,h,f,m,d;const g=p=>{a=performance.now(),r==="drag"&&(n(0,l=s.elementToImage(p.offsetX,p.offsetY)),u=l,n(1,h=l[0]),n(2,f=l[1]),n(3,m=1),n(4,d=1))},E=p=>{l&&(u=s.elementToImage(p.offsetX,p.offsetY),n(1,h=Math.min(u[0],l[0])),n(2,f=Math.min(u[1],l[1])),n(3,m=Math.abs(u[0]-l[0])),n(4,d=Math.abs(u[1]-l[1])))},A=p=>{const w=performance.now()-a;if(r==="click"){if(w>300)return;p.stopPropagation(),l?b():(n(0,l=s.elementToImage(p.offsetX,p.offsetY)),u=l,n(1,h=l[0]),n(2,f=l[1]),n(3,m=1),n(4,d=1))}else l&&(w>300||m*d>100?(p.stopPropagation(),b()):(n(0,l=null),u=null))},b=()=>{if(m*d>15){const p={type:z.RECTANGLE,geometry:{bounds:{minX:h,minY:f,maxX:h+m,maxY:f+d},x:h,y:f,w:m,h:d}};o("create",p)}n(0,l=null),u=null};return ge(()=>{i("pointerdown",g),i("pointermove",E),i("pointerup",A,!0)}),e.$$set=p=>{"addEventListener"in p&&n(5,i=p.addEventListener),"drawingMode"in p&&n(6,r=p.drawingMode),"transform"in p&&n(7,s=p.transform)},[l,h,f,m,d,i,r,s]}class rn extends ee{constructor(t){super(),$(this,t,ri,ii,Z,{addEventListener:5,drawingMode:6,transform:7})}}const Fe=(e,t)=>{const n=Math.abs(t[0]-e[0]),o=Math.abs(t[1]-e[1]);return Math.sqrt(Math.pow(n,2)+Math.pow(o,2))},Me=[];function si(e,t=F){let n;const o=new Set;function i(a){if(Z(e,a)&&(e=a,n)){const l=!Me.length;for(const u of o)u[1](),Me.push(u,e);if(l){for(let u=0;u<Me.length;u+=2)Me[u][0](Me[u+1]);Me.length=0}}}function r(a){i(a(e))}function s(a,l=F){const u=[a,l];return o.add(u),o.size===1&&(n=t(i)||F),a(e),()=>{o.delete(u),o.size===0&&n&&(n(),n=null)}}return{set:i,update:r,subscribe:s}}const li=(e,t)=>{const{naturalWidth:n,naturalHeight:o}=e;if(!n&&!o){const{width:i,height:r}=e;t.setAttribute("viewBox",`0 0 ${i} ${r}`),e.addEventListener("load",s=>{const a=s.target;t.setAttribute("viewBox",`0 0 ${a.naturalWidth} ${a.naturalHeight}`)})}else t.setAttribute("viewBox",`0 0 ${n} ${o}`)},sn=(e,t)=>{li(e,t);const{subscribe:n,set:o}=si(1);let i;return window.ResizeObserver&&(i=new ResizeObserver(()=>{const s=t.getBoundingClientRect(),{width:a,height:l}=t.viewBox.baseVal,u=Math.max(s.width/a,s.height/l);o(u)}),i.observe(t.parentElement)),{destroy:()=>{i&&i.disconnect()},subscribe:n}},ai="ontouchstart"in window||navigator.maxTouchPoints>0;function at(e){const t=e.slice(),n=(t[2]?t[0]:[...t[0],t[1]]).map(o=>o.join(",")).join(" ");return t[15]=n,t}function ln(e){let t,n,o,i,r,s=e[2]&&an(e);return{c(){t=R("polygon"),o=R("polygon"),s&&s.c(),r=fe(),c(t,"class","a9s-outer"),c(t,"points",n=e[15]),c(o,"class","a9s-inner"),c(o,"points",i=e[15])},m(a,l){k(a,t,l),k(a,o,l),s&&s.m(a,l),k(a,r,l)},p(a,l){l&7&&n!==(n=a[15])&&c(t,"points",n),l&7&&i!==(i=a[15])&&c(o,"points",i),a[2]?s?s.p(a,l):(s=an(a),s.c(),s.m(r.parentNode,r)):s&&(s.d(1),s=null)},d(a){a&&v(t),a&&v(o),s&&s.d(a),a&&v(r)}}}function an(e){let t,n,o;return{c(){t=R("rect"),c(t,"class","a9s-corner-handle"),c(t,"x",n=e[0][0][0]-e[3]/2),c(t,"y",o=e[0][0][1]-e[3]/2),c(t,"height",e[3]),c(t,"width",e[3])},m(i,r){k(i,t,r)},p(i,r){r&9&&n!==(n=i[0][0][0]-i[3]/2)&&c(t,"x",n),r&9&&o!==(o=i[0][0][1]-i[3]/2)&&c(t,"y",o),r&8&&c(t,"height",i[3]),r&8&&c(t,"width",i[3])},d(i){i&&v(t)}}}function ci(e){let t,n=e[1]&&ln(at(e));return{c(){t=R("g"),n&&n.c(),c(t,"class","a9s-annotation a9s-rubberband")},m(o,i){k(o,t,i),n&&n.m(t,null)},p(o,[i]){o[1]?n?n.p(at(o),i):(n=ln(at(o)),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:F,o:F,d(o){o&&v(t),n&&n.d()}}}const fi=20;function ui(e,t,n){let o;const i=he();let{addEventListener:r}=t,{drawingMode:s}=t,{transform:a}=t,{viewportScale:l=1}=t,u,h=[],f=null,m=!1;const d=p=>{const{timeStamp:w,offsetX:T,offsetY:L}=p;if(u={timeStamp:w,offsetX:T,offsetY:L},s==="drag"&&h.length===0){const D=a.elementToImage(p.offsetX,p.offsetY);h.push(D),n(1,f=D)}},g=p=>{if(h.length>0&&(n(1,f=a.elementToImage(p.offsetX,p.offsetY)),h.length>2)){const w=Fe(f,h[0])*l;n(2,m=w<fi)}},E=p=>{if(s==="click"){const w=p.timeStamp-u.timeStamp,T=Fe([u.offsetX,u.offsetY],[p.offsetX,p.offsetY]);if(w>300||T>15)return;if(m)b();else if(h.length===0){const L=a.elementToImage(p.offsetX,p.offsetY);h.push(L),n(1,f=L)}else h.push(f)}else{if(h.length===1&&Fe(h[0],f)<=4){n(0,h=[]),n(1,f=null);return}p.stopImmediatePropagation(),m?b():h.push(f)}},A=()=>{const p=[...h,f],w={type:z.POLYGON,geometry:{bounds:me(p),points:p}};Ve(w)>4&&(n(0,h=[]),n(1,f=null),i("create",w))},b=()=>{const p={type:z.POLYGON,geometry:{bounds:me(h),points:[...h]}};n(0,h=[]),n(1,f=null),i("create",p)};return ge(()=>{r("pointerdown",d,!0),r("pointermove",g),r("pointerup",E,!0),r("dblclick",A,!0)}),e.$$set=p=>{"addEventListener"in p&&n(4,r=p.addEventListener),"drawingMode"in p&&n(5,s=p.drawingMode),"transform"in p&&n(6,a=p.transform),"viewportScale"in p&&n(7,l=p.viewportScale)},e.$$.update=()=>{e.$$.dirty&128&&n(3,o=10/l)},[h,f,m,o,r,s,a,l]}class di extends ee{constructor(t){super(),$(this,t,ui,ci,Z,{addEventListener:4,drawingMode:5,transform:6,viewportScale:7})}}function cn(e){let t,n,o,i,r,s,a,l,u,h;return{c(){t=R("ellipse"),s=R("ellipse"),c(t,"class","a9s-outer"),c(t,"cx",n=e[2]+e[4]/2),c(t,"cy",o=e[3]+e[5]/2),c(t,"rx",i=e[4]/2),c(t,"ry",r=e[5]/2),c(s,"class","a9s-inner"),c(s,"cx",a=e[2]+e[4]/2),c(s,"cy",l=e[3]+e[5]/2),c(s,"rx",u=e[4]/2),c(s,"ry",h=e[5]/2)},m(f,m){k(f,t,m),k(f,s,m)},p(f,m){m&20&&n!==(n=f[2]+f[4]/2)&&c(t,"cx",n),m&40&&o!==(o=f[3]+f[5]/2)&&c(t,"cy",o),m&16&&i!==(i=f[4]/2)&&c(t,"rx",i),m&32&&r!==(r=f[5]/2)&&c(t,"ry",r),m&20&&a!==(a=f[2]+f[4]/2)&&c(s,"cx",a),m&40&&l!==(l=f[3]+f[5]/2)&&c(s,"cy",l),m&16&&u!==(u=f[4]/2)&&c(s,"rx",u),m&32&&h!==(h=f[5]/2)&&c(s,"ry",h)},d(f){f&&v(t),f&&v(s)}}}function hi(e){let t,n=e[1]&&cn(e);return{c(){t=R("g"),n&&n.c(),c(t,"class","a9s-annotation a9s-rubberband")},m(o,i){k(o,t,i),n&&n.m(t,null),e[9](t)},p(o,[i]){o[1]?n?n.p(o,i):(n=cn(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:F,o:F,d(o){o&&v(t),n&&n.d(),e[9](null)}}}function mi(e,t,n){const o=he();let{addEventListener:i}=t,{drawingMode:r}=t,{transform:s}=t,a,l,u,h,f,m,d,g=!1,E=!1,A,b;const p=_=>{A=performance.now(),r==="drag"&&(n(1,l=s.elementToImage(_.offsetX,_.offsetY)),u=l,n(2,h=l[0]),n(3,f=l[1]),n(4,m=1),n(5,d=1))},w=_=>{const S=_||b;if(l)if(u=s.elementToImage(S.offsetX,S.offsetY),E){const O=2*Math.abs(u[0]-l[0]),P=2*Math.abs(u[1]-l[1]);n(4,m=g?Math.max(O,P):O),n(5,d=g?m:P),n(2,h=Math.min(u[0],l[0]-m/2)),n(3,f=Math.min(u[1],l[1]-d/2))}else{const O=Math.abs(u[0]-l[0]),P=Math.abs(u[1]-l[1]);n(4,m=g?Math.max(O,P):O),n(5,d=g?m:P),n(2,h=Math.min(u[0],l[0])),n(3,f=Math.min(u[1],l[1]))}_&&(b=_)},T=_=>{r==="click"&&_.stopImmediatePropagation();const S=performance.now()-A;if(r==="click"){if(S>300)return;_.stopPropagation(),l?L():(n(1,l=s.elementToImage(_.offsetX,_.offsetY)),u=l,n(2,h=l[0]),n(3,f=l[1]),n(4,m=1),n(5,d=1))}else l&&(S>300||m*d>100?(_.stopPropagation(),L()):(n(1,l=null),u=null,b=void 0))},L=()=>{if(m*d>15){const _={type:z.ELLIPSE,geometry:{bounds:{minX:h,minY:f,maxX:h+m,maxY:f+d},cx:h+m/2,cy:f+d/2,rx:m/2,ry:d/2}};o("create",_)}n(1,l=null),u=null,b=void 0},D=_=>{_.key==="Shift"&&(g=!0,w()),_.key==="Control"&&(E=!0,w())},U=_=>{_.key==="Shift"&&(g=!1,w()),_.key==="Control"&&(E=!1,w())};ge(()=>(document.addEventListener("keyup",U),document.addEventListener("keydown",D),i("pointerdown",p),i("pointermove",w),i("pointerup",T),()=>{document.removeEventListener("keyup",U),document.removeEventListener("keydown",D)}));function y(_){Pe[_?"unshift":"push"](()=>{a=_,n(0,a)})}return e.$$set=_=>{"addEventListener"in _&&n(6,i=_.addEventListener),"drawingMode"in _&&n(7,r=_.drawingMode),"transform"in _&&n(8,s=_.transform)},[a,l,h,f,m,d,i,r,s,y]}class gi extends ee{constructor(t){super(),$(this,t,mi,hi,Z,{addEventListener:6,drawingMode:7,transform:8})}}function fn(e){let t;return{c(){t=R("path"),c(t,"style",e[2]),c(t,"d",e[0])},m(n,o){k(n,t,o)},p(n,o){o&4&&c(t,"style",n[2]),o&1&&c(t,"d",n[0])},d(n){n&&v(t)}}}function pi(e){let t,n=e[1]&&fn(e);return{c(){t=R("g"),n&&n.c(),c(t,"class","a9s-annotation a9s-rubberband")},m(o,i){k(o,t,i),n&&n.m(t,null)},p(o,[i]){o[1]?n?n.p(o,i):(n=fn(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:F,o:F,d(o){o&&v(t),n&&n.d()}}}function yi(e,t,n){let o;const i=he();let{addEventListener:r}=t,{drawingMode:s}=t,{annotation:a}=t,{transform:l}=t,{viewportScale:u=1}=t,{style:h=void 0}=t,f={fillOpacity:1},m=[],d="",g=!1;const E=w=>{if(s==="drag"&&m.length===0){n(1,g=!0);const T=l.elementToImage(w.offsetX,w.offsetY);m.push([...T,w.pressure]),n(0,d=Be(m))}},A=w=>{if(g){const T=l.elementToImage(w.offsetX,w.offsetY);m.push([...T,w.pressure]),n(0,d=Be(m,ot,!0))}},b=w=>{g&&p()},p=()=>{const w={type:z.FREEHAND,geometry:{bounds:me(m.map(T=>[T[0],T[1]])),points:m}};n(1,g=!1),m=[],i("create",w)};return ge(()=>{r("pointerdown",E,!0),r("pointermove",A),r("pointerup",b,!0)}),e.$$set=w=>{"addEventListener"in w&&n(3,r=w.addEventListener),"drawingMode"in w&&n(4,s=w.drawingMode),"annotation"in w&&n(5,a=w.annotation),"transform"in w&&n(6,l=w.transform),"viewportScale"in w&&n(7,u=w.viewportScale),"style"in w&&n(8,h=w.style)},e.$$.update=()=>{e.$$.dirty&128,e.$$.dirty&288&&n(2,o=_e(a,h,f))},[d,g,o,r,s,a,l,u,h]}class _i extends ee{constructor(t){super(),$(this,t,yi,pi,Z,{addEventListener:3,drawingMode:4,annotation:5,transform:6,viewportScale:7,style:8})}}const ct=new Map([["rectangle",{tool:rn}],["polygon",{tool:di}],["ellipse",{tool:gi}],["freehand",{tool:_i}]]),He=()=>[...ct.keys()],ft=e=>ct.get(e),un=(e,t,n)=>ct.set(e,{tool:t,opts:n});function wi(e){let t,n,o,i,r;return{c(){t=R("g"),n=R("ellipse"),i=R("ellipse"),c(n,"class","a9s-outer"),c(n,"style",o=e[1]?"display:none;":void 0),c(n,"cx",e[2]),c(n,"cy",e[3]),c(n,"rx",e[4]),c(n,"ry",e[5]),c(i,"class","a9s-inner"),c(i,"style",e[1]),c(i,"cx",e[2]),c(i,"cy",e[3]),c(i,"rx",e[4]),c(i,"ry",e[5]),c(t,"data-id",r=e[0].id)},m(s,a){k(s,t,a),ce(t,n),ce(t,i)},p(s,[a]){a&2&&o!==(o=s[1]?"display:none;":void 0)&&c(n,"style",o),a&2&&c(i,"style",s[1]),a&1&&r!==(r=s[0].id)&&c(t,"data-id",r)},i:F,o:F,d(s){s&&v(t)}}}function bi(e,t,n){let o,{annotation:i}=t,{geom:r}=t,{style:s=void 0}=t;const{cx:a,cy:l,rx:u,ry:h}=r;return e.$$set=f=>{"annotation"in f&&n(0,i=f.annotation),"geom"in f&&n(6,r=f.geom),"style"in f&&n(7,s=f.style)},e.$$.update=()=>{e.$$.dirty&129&&n(1,o=_e(i,s))},[i,o,a,l,u,h,r,s]}class Ei extends ee{constructor(t){super(),$(this,t,bi,wi,Z,{annotation:0,geom:6,style:7})}}function Ai(e){let t,n,o,i,r;return{c(){t=R("g"),n=R("polygon"),i=R("polygon"),c(n,"class","a9s-outer"),c(n,"style",o=e[1]?"display:none;":void 0),c(n,"points",e[2].map(Si).join(" ")),c(i,"class","a9s-inner"),c(i,"style",e[1]),c(i,"points",e[2].map(Ti).join(" ")),c(t,"data-id",r=e[0].id)},m(s,a){k(s,t,a),ce(t,n),ce(t,i)},p(s,[a]){a&2&&o!==(o=s[1]?"display:none;":void 0)&&c(n,"style",o),a&2&&c(i,"style",s[1]),a&1&&r!==(r=s[0].id)&&c(t,"data-id",r)},i:F,o:F,d(s){s&&v(t)}}}const Si=e=>e.join(","),Ti=e=>e.join(",");function Mi(e,t,n){let o,{annotation:i}=t,{geom:r}=t,{style:s=void 0}=t;const{points:a}=r;return e.$$set=l=>{"annotation"in l&&n(0,i=l.annotation),"geom"in l&&n(3,r=l.geom),"style"in l&&n(4,s=l.style)},e.$$.update=()=>{e.$$.dirty&17&&n(1,o=_e(i,s))},[i,o,a,r,s]}class Li extends ee{constructor(t){super(),$(this,t,Mi,Ai,Z,{annotation:0,geom:3,style:4})}}function Oi(e){let t,n,o,i,r;return{c(){t=R("g"),n=R("rect"),i=R("rect"),c(n,"class","a9s-outer"),c(n,"style",o=e[5]?"display:none;":void 0),c(n,"x",e[4]),c(n,"y",e[3]),c(n,"width",e[2]),c(n,"height",e[1]),c(i,"class","a9s-inner"),c(i,"style",e[5]),c(i,"x",e[4]),c(i,"y",e[3]),c(i,"width",e[2]),c(i,"height",e[1]),c(t,"data-id",r=e[0].id)},m(s,a){k(s,t,a),ce(t,n),ce(t,i)},p(s,[a]){a&32&&o!==(o=s[5]?"display:none;":void 0)&&c(n,"style",o),a&16&&c(n,"x",s[4]),a&8&&c(n,"y",s[3]),a&4&&c(n,"width",s[2]),a&2&&c(n,"height",s[1]),a&32&&c(i,"style",s[5]),a&16&&c(i,"x",s[4]),a&8&&c(i,"y",s[3]),a&4&&c(i,"width",s[2]),a&2&&c(i,"height",s[1]),a&1&&r!==(r=s[0].id)&&c(t,"data-id",r)},i:F,o:F,d(s){s&&v(t)}}}function vi(e,t,n){let o,i,r,s,a,{annotation:l}=t,{geom:u}=t,{style:h=void 0}=t;return e.$$set=f=>{"annotation"in f&&n(0,l=f.annotation),"geom"in f&&n(6,u=f.geom),"style"in f&&n(7,h=f.style)},e.$$.update=()=>{e.$$.dirty&129&&n(5,o=_e(l,h)),e.$$.dirty&64&&n(4,{x:i,y:r,w:s,h:a}=u,i,(n(3,r),n(6,u)),(n(2,s),n(6,u)),(n(1,a),n(6,u)))},[l,a,s,r,i,o,u,h]}class ki extends ee{constructor(t){super(),$(this,t,vi,Oi,Z,{annotation:0,geom:6,style:7})}}function Ii(e){let t,n,o;return{c(){t=R("g"),n=R("path"),c(n,"style",e[2]),c(n,"d",e[1]),c(t,"data-id",o=e[0].id)},m(i,r){k(i,t,r),ce(t,n)},p(i,[r]){r&4&&c(n,"style",i[2]),r&2&&c(n,"d",i[1]),r&1&&o!==(o=i[0].id)&&c(t,"data-id",o)},i:F,o:F,d(i){i&&v(t)}}}function Pi(e,t,n){let o,i,{annotation:r}=t,{geom:s}=t,{style:a=void 0}=t,l={fillOpacity:1};const{points:u}=s;return e.$$set=h=>{"annotation"in h&&n(0,r=h.annotation),"geom"in h&&n(3,s=h.geom),"style"in h&&n(4,a=h.style)},e.$$.update=()=>{e.$$.dirty&17&&n(2,o=_e(r,a,l))},n(1,i=Be(u,ot,!0)),[r,i,o,s,a]}class Di extends ee{constructor(t){super(),$(this,t,Pi,Ii,Z,{annotation:0,geom:3,style:4})}}const Bi={elementToImage:(e,t)=>[e,t]},dn=e=>({elementToImage:(t,n)=>{const o=e.getBoundingClientRect(),i=e.createSVGPoint();i.x=t+o.x,i.y=n+o.y;const{x:r,y:s}=i.matrixTransform(e.getScreenCTM().inverse());return[r,s]}}),Yi=250,hn=(e,t)=>{const n=he();let o;return{onPointerDown:()=>o=performance.now(),onPointerUp:s=>{if(performance.now()-o<Yi){const{x:l,y:u}=Ri(s,e),h=t.getAt(l,u);h?n("click",{originalEvent:s,annotation:h}):n("click",{originalEvent:s})}}}},Ri=(e,t)=>{const n=t.createSVGPoint(),o=t.getBoundingClientRect(),i=e.clientX-o.x,r=e.clientY-o.y,{left:s,top:a}=t.getBoundingClientRect();return n.x=i+s,n.y=r+a,n.matrixTransform(t.getScreenCTM().inverse())};function mn(e,t,n){const o=e.slice();return o[29]=t[n],o}function gn(e,t,n){const o=e.slice();return o[32]=t[n],o}function ut(e){const t=e.slice(),n=t[32].target.selector;return t[35]=n,t}function pn(e){let t=e[32].id,n,o,i=yn(e);return{c(){i.c(),n=fe()},m(r,s){i.m(r,s),k(r,n,s),o=!0},p(r,s){s[0]&8192&&Z(t,t=r[32].id)?(ue(),H(i,1,1,F),de(),i=yn(r),i.c(),G(i,1),i.m(n.parentNode,n)):i.p(r,s)},i(r){o||(G(i),o=!0)},o(r){H(i),o=!1},d(r){r&&v(n),i.d(r)}}}function Xi(e){let t,n;return t=new Di({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function Ci(e){let t,n;return t=new Li({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function Ui(e){let t,n;return t=new ki({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function Ni(e){let t,n;return t=new Ei({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function yn(e){let t,n,o,i;const r=[Ni,Ui,Ci,Xi],s=[];function a(l,u){return l[35].type===z.ELLIPSE?0:l[35].type===z.RECTANGLE?1:l[35].type===z.POLYGON?2:l[35].type===z.FREEHAND?3:-1}return~(t=a(e))&&(n=s[t]=r[t](e)),{c(){n&&n.c(),o=fe()},m(l,u){~t&&s[t].m(l,u),k(l,o,u),i=!0},p(l,u){let h=t;t=a(l),t===h?~t&&s[t].p(l,u):(n&&(ue(),H(s[h],1,1,()=>{s[h]=null}),de()),~t?(n=s[t],n?n.p(l,u):(n=s[t]=r[t](l),n.c()),G(n,1),n.m(o.parentNode,o)):n=null)},i(l){i||(G(n),i=!0)},o(l){H(n),i=!1},d(l){~t&&s[t].d(l),l&&v(o)}}}function _n(e){let t=!e[7](e[32]),n,o,i=t&&pn(ut(e));return{c(){i&&i.c(),n=fe()},m(r,s){i&&i.m(r,s),k(r,n,s),o=!0},p(r,s){s[0]&8320&&(t=!r[7](r[32])),t?i?(i.p(ut(r),s),s[0]&8320&&G(i,1)):(i=pn(ut(r)),i.c(),G(i,1),i.m(n.parentNode,n)):i&&(ue(),H(i,1,1,()=>{i=null}),de())},i(r){o||(G(i),o=!0)},o(r){H(i),o=!1},d(r){i&&i.d(r),r&&v(n)}}}function wn(e){let t,n,o,i;const r=[Gi,Vi],s=[];function a(l,u){return l[6]?0:l[12]&&l[0]?1:-1}return~(t=a(e))&&(n=s[t]=r[t](e)),{c(){n&&n.c(),o=fe()},m(l,u){~t&&s[t].m(l,u),k(l,o,u),i=!0},p(l,u){let h=t;t=a(l),t===h?~t&&s[t].p(l,u):(n&&(ue(),H(s[h],1,1,()=>{s[h]=null}),de()),~t?(n=s[t],n?n.p(l,u):(n=s[t]=r[t](l),n.c()),G(n,1),n.m(o.parentNode,o)):n=null)},i(l){i||(G(n),i=!0)},o(l){H(n),i=!1},d(l){~t&&s[t].d(l),l&&v(o)}}}function Vi(e){let t=e[2],n,o,i=bn(e);return{c(){i.c(),n=fe()},m(r,s){i.m(r,s),k(r,n,s),o=!0},p(r,s){s[0]&4&&Z(t,t=r[2])?(ue(),H(i,1,1,F),de(),i=bn(r),i.c(),G(i,1),i.m(n.parentNode,n)):i.p(r,s)},i(r){o||(G(i),o=!0)},o(r){H(i),o=!1},d(r){r&&v(n),i.d(r)}}}function Gi(e){let t,n,o=e[6],i=[];for(let s=0;s<o.length;s+=1)i[s]=An(mn(e,o,s));const r=s=>H(i[s],1,1,()=>{i[s]=null});return{c(){for(let s=0;s<i.length;s+=1)i[s].c();t=fe()},m(s,a){for(let l=0;l<i.length;l+=1)i[l]&&i[l].m(s,a);k(s,t,a),n=!0},p(s,a){if(a[0]&279634){o=s[6];let l;for(l=0;l<o.length;l+=1){const u=mn(s,o,l);i[l]?(i[l].p(u,a),G(i[l],1)):(i[l]=An(u),i[l].c(),G(i[l],1),i[l].m(t.parentNode,t))}for(ue(),l=o.length;l<i.length;l+=1)r(l);de()}},i(s){if(!n){for(let a=0;a<o.length;a+=1)G(i[a]);n=!0}},o(s){i=i.filter(Boolean);for(let a=0;a<i.length;a+=1)H(i[a]);n=!1},d(s){Qe(i,s),s&&v(t)}}}function bn(e){let t,n;return t=new nn({props:{target:e[4],tool:e[12],drawingMode:e[11],transform:e[10],viewportScale:e[14]}}),t.$on("create",e[17]),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,i){const r={};i[0]&16&&(r.target=o[4]),i[0]&4096&&(r.tool=o[12]),i[0]&2048&&(r.drawingMode=o[11]),i[0]&1024&&(r.transform=o[10]),i[0]&16384&&(r.viewportScale=o[14]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function En(e){let t,n;return t=new tn({props:{target:e[4],editor:lt(e[29].target.selector),annotation:e[29],style:e[1],transform:e[10],viewportScale:e[14]}}),t.$on("change",function(){j(e[18](e[29]))&&e[18](e[29]).apply(this,arguments)}),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,i){e=o;const r={};i[0]&16&&(r.target=e[4]),i[0]&64&&(r.editor=lt(e[29].target.selector)),i[0]&64&&(r.annotation=e[29]),i[0]&2&&(r.style=e[1]),i[0]&1024&&(r.transform=e[10]),i[0]&16384&&(r.viewportScale=e[14]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){H(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function An(e){let t=e[29].id,n,o,i=En(e);return{c(){i.c(),n=fe()},m(r,s){i.m(r,s),k(r,n,s),o=!0},p(r,s){s[0]&64&&Z(t,t=r[29].id)?(ue(),H(i,1,1,F),de(),i=En(r),i.c(),G(i,1),i.m(n.parentNode,n)):i.p(r,s)},i(r){o||(G(i),o=!0)},o(r){H(i),o=!1},d(r){r&&v(n),i.d(r)}}}function Fi(e){let t,n,o,i,r,s,a=e[13],l=[];for(let f=0;f<a.length;f+=1)l[f]=_n(gn(e,a,f));const u=f=>H(l[f],1,1,()=>{l[f]=null});let h=e[4]&&wn(e);return{c(){t=R("svg"),n=R("g");for(let f=0;f<l.length;f+=1)l[f].c();o=R("g"),h&&h.c(),c(o,"class","drawing"),c(t,"class","a9s-annotationlayer"),Tt(t,"drawing",e[12])},m(f,m){k(f,t,m),ce(t,n);for(let d=0;d<l.length;d+=1)l[d]&&l[d].m(n,null);ce(t,o),h&&h.m(o,null),e[25](o),e[26](t),i=!0,r||(s=[K(t,"pointerup",function(){j(e[8])&&e[8].apply(this,arguments)}),K(t,"pointerdown",function(){j(e[9])&&e[9].apply(this,arguments)})],r=!0)},p(f,m){if(e=f,m[0]&8322){a=e[13];let d;for(d=0;d<a.length;d+=1){const g=gn(e,a,d);l[d]?(l[d].p(g,m),G(l[d],1)):(l[d]=_n(g),l[d].c(),G(l[d],1),l[d].m(n,null))}for(ue(),d=a.length;d<l.length;d+=1)u(d);de()}e[4]?h?(h.p(e,m),m[0]&16&&G(h,1)):(h=wn(e),h.c(),G(h,1),h.m(o,null)):h&&(ue(),H(h,1,1,()=>{h=null}),de()),(!i||m[0]&4096)&&Tt(t,"drawing",e[12])},i(f){if(!i){for(let m=0;m<a.length;m+=1)G(l[m]);G(h),i=!0}},o(f){l=l.filter(Boolean);for(let m=0;m<l.length;m+=1)H(l[m]);H(h),i=!1},d(f){f&&v(t),Qe(l,f),h&&h.d(),e[25](null),e[26](null),r=!1,le(s)}}}function Hi(e,t,n){let o,i,r,s,a,l,u,h,f,m,d=F,g=()=>(d(),d=bt(y,B=>n(14,m=B)),y);e.$$.on_destroy.push(()=>d());let{drawingEnabled:E}=t,{image:A}=t,{preferredDrawingMode:b}=t,{state:p}=t,{style:w=void 0}=t,{toolName:T=He().length>0?He()[0]:void 0}=t,{user:L}=t,D,U,y;ge(()=>g(n(5,y=sn(A,U))));const{selection:_,store:S}=p;Et(e,_,B=>n(24,h=B)),Et(e,S,B=>n(13,f=B));let O=null,P=null;const N=B=>{S.unobserve(O);const te=B.filter(({editable:q})=>q).map(({id:q})=>q);te.length>0?(n(6,P=te.map(q=>S.getAnnotation(q))),O=q=>{const{updated:we}=q.changes;n(6,P=we.map(J=>J.newValue))},S.observe(O,{annotations:te})):n(6,P=null)},V=B=>{const te=Ct(),q={id:te,bodies:[],target:{annotation:te,selector:B.detail,creator:L,created:new Date}};S.addAnnotation(q),_.setSelected(q.id)},X=B=>te=>{var be;const{target:q}=B,we=10*60*1e3,J=((be=q.creator)==null?void 0:be.id)!==L.id||!q.created||new Date().getTime()-q.created.getTime()>we;S.updateTarget({...q,selector:te.detail,created:J?q.created:new Date,updated:J?new Date:null,updatedBy:J?L:null})};function ve(B){Pe[B?"unshift":"push"](()=>{D=B,n(4,D)})}function Ue(B){Pe[B?"unshift":"push"](()=>{U=B,n(3,U)})}return e.$$set=B=>{"drawingEnabled"in B&&n(0,E=B.drawingEnabled),"image"in B&&n(19,A=B.image),"preferredDrawingMode"in B&&n(20,b=B.preferredDrawingMode),"state"in B&&n(21,p=B.state),"style"in B&&n(1,w=B.style),"toolName"in B&&n(2,T=B.toolName),"user"in B&&n(22,L=B.user)},e.$$.update=()=>{e.$$.dirty[0]&4&&n(12,{tool:o,opts:i}=ft(T),o,(n(23,i),n(2,T))),e.$$.dirty[0]&9437184&&n(11,r=(i==null?void 0:i.drawingMode)||b),e.$$.dirty[0]&8&&n(10,s=dn(U)),e.$$.dirty[0]&8&&n(9,{onPointerDown:a,onPointerUp:l}=hn(U,S),a,(n(8,l),n(3,U))),e.$$.dirty[0]&16777216&&n(7,u=B=>h.selected.find(te=>te.id===B.id&&te.editable)),e.$$.dirty[0]&16777216&&N(h.selected)},[E,w,T,U,D,y,P,u,l,a,s,r,o,f,m,_,S,V,X,A,b,p,L,i,h,ve,Ue]}class Sn extends ee{constructor(t){super(),$(this,t,Hi,Fi,Z,{drawingEnabled:0,image:19,preferredDrawingMode:20,state:21,style:1,toolName:2,user:22},null,[-1,-1])}}function zi(e,t,n,o,i){Tn(e,t,n||0,o||e.length-1,i||ji)}function Tn(e,t,n,o,i){for(;o>n;){if(o-n>600){var r=o-n+1,s=t-n+1,a=Math.log(r),l=.5*Math.exp(2*a/3),u=.5*Math.sqrt(a*l*(r-l)/r)*(s-r/2<0?-1:1),h=Math.max(n,Math.floor(t-s*l/r+u)),f=Math.min(o,Math.floor(t+(r-s)*l/r+u));Tn(e,t,h,f,i)}var m=e[t],d=n,g=o;for(Re(e,n,t),i(e[o],m)>0&&Re(e,n,o);d<g;){for(Re(e,d,g),d++,g--;i(e[d],m)<0;)d++;for(;i(e[g],m)>0;)g--}i(e[n],m)===0?Re(e,n,g):(g++,Re(e,g,o)),g<=t&&(n=g+1),t<=g&&(o=g-1)}}function Re(e,t,n){var o=e[t];e[t]=e[n],e[n]=o}function ji(e,t){return e<t?-1:e>t?1:0}class Ki{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let n=this.data;const o=[];if(!je(t,n))return o;const i=this.toBBox,r=[];for(;n;){for(let s=0;s<n.children.length;s++){const a=n.children[s],l=n.leaf?i(a):a;je(t,l)&&(n.leaf?o.push(a):ht(t,l)?this._all(a,o):r.push(a))}n=r.pop()}return o}collides(t){let n=this.data;if(!je(t,n))return!1;const o=[];for(;n;){for(let i=0;i<n.children.length;i++){const r=n.children[i],s=n.leaf?this.toBBox(r):r;if(je(t,s)){if(n.leaf||ht(t,s))return!0;o.push(r)}}n=o.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let o=0;o<t.length;o++)this.insert(t[o]);return this}let n=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=n;else if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const o=this.data;this.data=n,n=o}this._insert(n,this.data.height-n.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=Oe([]),this}remove(t,n){if(!t)return this;let o=this.data;const i=this.toBBox(t),r=[],s=[];let a,l,u;for(;o||r.length;){if(o||(o=r.pop(),l=r[r.length-1],a=s.pop(),u=!0),o.leaf){const h=Wi(t,o.children,n);if(h!==-1)return o.children.splice(h,1),r.push(o),this._condense(r),this}!u&&!o.leaf&&ht(o,i)?(r.push(o),s.push(a),a=0,l=o,o=o.children[0]):l?(a++,o=l.children[a],u=!1):o=null}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,n){const o=[];for(;t;)t.leaf?n.push(...t.children):o.push(...t.children),t=o.pop();return n}_build(t,n,o,i){const r=o-n+1;let s=this._maxEntries,a;if(r<=s)return a=Oe(t.slice(n,o+1)),Le(a,this.toBBox),a;i||(i=Math.ceil(Math.log(r)/Math.log(s)),s=Math.ceil(r/Math.pow(s,i-1))),a=Oe([]),a.leaf=!1,a.height=i;const l=Math.ceil(r/s),u=l*Math.ceil(Math.sqrt(s));Mn(t,n,o,u,this.compareMinX);for(let h=n;h<=o;h+=u){const f=Math.min(h+u-1,o);Mn(t,h,f,l,this.compareMinY);for(let m=h;m<=f;m+=l){const d=Math.min(m+l-1,f);a.children.push(this._build(t,m,d,i-1))}}return Le(a,this.toBBox),a}_chooseSubtree(t,n,o,i){for(;i.push(n),!(n.leaf||i.length-1===o);){let r=1/0,s=1/0,a;for(let l=0;l<n.children.length;l++){const u=n.children[l],h=dt(u),f=Ji(t,u)-h;f<s?(s=f,r=h<r?h:r,a=u):f===s&&h<r&&(r=h,a=u)}n=a||n.children[0]}return n}_insert(t,n,o){const i=o?t:this.toBBox(t),r=[],s=this._chooseSubtree(i,this.data,n,r);for(s.children.push(t),Ce(s,i);n>=0&&r[n].children.length>this._maxEntries;)this._split(r,n),n--;this._adjustParentBBoxes(i,r,n)}_split(t,n){const o=t[n],i=o.children.length,r=this._minEntries;this._chooseSplitAxis(o,r,i);const s=this._chooseSplitIndex(o,r,i),a=Oe(o.children.splice(s,o.children.length-s));a.height=o.height,a.leaf=o.leaf,Le(o,this.toBBox),Le(a,this.toBBox),n?t[n-1].children.push(a):this._splitRoot(o,a)}_splitRoot(t,n){this.data=Oe([t,n]),this.data.height=t.height+1,this.data.leaf=!1,Le(this.data,this.toBBox)}_chooseSplitIndex(t,n,o){let i,r=1/0,s=1/0;for(let a=n;a<=o-n;a++){const l=Xe(t,0,a,this.toBBox),u=Xe(t,a,o,this.toBBox),h=Qi(l,u),f=dt(l)+dt(u);h<r?(r=h,i=a,s=f<s?f:s):h===r&&f<s&&(s=f,i=a)}return i||o-n}_chooseSplitAxis(t,n,o){const i=t.leaf?this.compareMinX:qi,r=t.leaf?this.compareMinY:Zi,s=this._allDistMargin(t,n,o,i),a=this._allDistMargin(t,n,o,r);s<a&&t.children.sort(i)}_allDistMargin(t,n,o,i){t.children.sort(i);const r=this.toBBox,s=Xe(t,0,n,r),a=Xe(t,o-n,o,r);let l=ze(s)+ze(a);for(let u=n;u<o-n;u++){const h=t.children[u];Ce(s,t.leaf?r(h):h),l+=ze(s)}for(let u=o-n-1;u>=n;u--){const h=t.children[u];Ce(a,t.leaf?r(h):h),l+=ze(a)}return l}_adjustParentBBoxes(t,n,o){for(let i=o;i>=0;i--)Ce(n[i],t)}_condense(t){for(let n=t.length-1,o;n>=0;n--)t[n].children.length===0?n>0?(o=t[n-1].children,o.splice(o.indexOf(t[n]),1)):this.clear():Le(t[n],this.toBBox)}}function Wi(e,t,n){if(!n)return t.indexOf(e);for(let o=0;o<t.length;o++)if(n(e,t[o]))return o;return-1}function Le(e,t){Xe(e,0,e.children.length,t,e)}function Xe(e,t,n,o,i){i||(i=Oe(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let r=t;r<n;r++){const s=e.children[r];Ce(i,e.leaf?o(s):s)}return i}function Ce(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function qi(e,t){return e.minX-t.minX}function Zi(e,t){return e.minY-t.minY}function dt(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function ze(e){return e.maxX-e.minX+(e.maxY-e.minY)}function Ji(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function Qi(e,t){const n=Math.max(e.minX,t.minX),o=Math.max(e.minY,t.minY),i=Math.min(e.maxX,t.maxX),r=Math.min(e.maxY,t.maxY);return Math.max(0,i-n)*Math.max(0,r-o)}function ht(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function je(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function Oe(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Mn(e,t,n,o,i){const r=[t,n];for(;r.length;){if(n=r.pop(),t=r.pop(),n-t<=o)continue;const s=t+Math.ceil((n-t)/o/2)*o;zi(e,s,t,n,i),r.push(t,s,s,n)}}const xi=()=>{const e=new Ki,t=new Map,n=()=>[...t.values()],o=()=>{e.clear(),t.clear()},i=f=>{const{minX:m,minY:d,maxX:g,maxY:E}=f.selector.geometry.bounds,A={minX:m,minY:d,maxX:g,maxY:E,target:f};e.insert(A),t.set(f.annotation,A)},r=f=>{const m=t.get(f.annotation);e.remove(m),t.delete(f.annotation)};return{all:n,clear:o,getAt:(f,m)=>{const g=e.search({minX:f,minY:m,maxX:f,maxY:m}).map(E=>E.target).filter(E=>E.selector.type===z.RECTANGLE||vt(E.selector,f,m));if(g.length>0)return g.sort((E,A)=>Ve(E.selector)-Ve(A.selector)),g[0]},getIntersecting:(f,m,d,g)=>e.search({minX:f,minY:m,maxX:f+d,maxY:m+g}).map(E=>E.target),insert:i,remove:r,set:(f,m=!0)=>{m&&o();const d=f.map(g=>{const{minX:E,minY:A,maxX:b,maxY:p}=g.selector.geometry.bounds;return{minX:E,minY:A,maxX:b,maxY:p,target:g}});d.forEach(g=>t.set(g.target.annotation,g)),e.load(d)},size:()=>e.all().length,update:(f,m)=>{r(f),i(m)}}},Ln=e=>{const t=So(),n=xi(),o=ho(t,e.pointerSelectAction),i=uo(t),r=vo();return t.observe(({changes:l})=>{n.set(l.created.map(u=>u.target),!1),l.deleted.forEach(u=>n.remove(u.target)),l.updated.forEach(({oldValue:u,newValue:h})=>n.update(u.target,h.target))}),{store:{...t,getAt:(l,u)=>{const h=n.getAt(l,u);return h?t.getAnnotation(h.annotation):void 0},getIntersecting:(l,u,h,f)=>n.getIntersecting(l,u,h,f).map(m=>t.getAnnotation(m.annotation))},selection:o,hover:i,viewport:r}},On=e=>{const t=Ln(e);return{...t,store:To(t.store)}},vn=e=>{let t,n;if(e.nodeName==="CANVAS")t=e,n=t.getContext("2d",{willReadFrequently:!0});else{const i=e;t=document.createElement("canvas"),t.width=i.width,t.height=i.height,n=t.getContext("2d",{willReadFrequently:!0}),n.drawImage(i,0,0,i.width,i.height)}let o=0;for(let i=1;i<10;i++)for(let r=1;r<10;r++){const s=Math.round(r*t.width/10),a=Math.round(i*t.height/10),l=n.getImageData(s,a,1,1).data,u=(.299*l[0]+.587*l[1]+.114*l[2])/255;o+=u}return o/81},kn=e=>{const t=vn(e),n=t>.6?"dark":"light";return console.log(`[Annotorious] Image brightness: ${t.toFixed(1)}. Setting ${n} theme.`),n},mt=(e,t,n)=>t.setAttribute("data-theme",n==="auto"?kn(e):n),In=(e,t)=>({...e,drawingEnabled:e.drawingEnabled===void 0?t.drawingEnabled:e.drawingEnabled,drawingMode:e.drawingMode||t.drawingMode,pointerSelectAction:e.pointerSelectAction||t.pointerSelectAction,theme:e.theme||t.theme}),Pn=navigator.userAgent.indexOf("Mac OS X")!==-1,Dn=(e,t)=>{const n=t||document,o=s=>{s.key==="Z"&&s.ctrlKey?e.undo():s.key==="Y"&&s.ctrlKey&&e.redo()},i=s=>{s.key==="z"&&s.metaKey&&(s.shiftKey?e.redo():e.undo())},r=()=>{Pn?n.removeEventListener("keydown",i):n.removeEventListener("keydown",o)};return Pn?n.addEventListener("keydown",i):n.addEventListener("keydown",o),{destroy:r}},tr="",nr="",or="",$i=(e,t={})=>{if(!e)throw"Missing argument: image";const n=typeof e=="string"?document.getElementById(e):e,o=In(t,{drawingEnabled:!0,drawingMode:"drag",pointerSelectAction:Nt.EDIT,theme:"light"}),i=On(o),{selection:r,store:s}=i,a=Oo(s),l=ko(i,a,o.adapter,o.autoSave),u=document.createElement("DIV");u.style.position="relative",u.style.display="inline-block",n.style.display="block",n.parentNode.insertBefore(u,n),u.appendChild(n);const h=Dn(a);let f=Xo();mt(n,u,o.theme);const m=new Sn({target:u,props:{drawingEnabled:o.drawingEnabled,image:n,preferredDrawingMode:o.drawingMode,state:i,style:o.style,user:f}});m.$on("click",y=>{const{originalEvent:_,annotation:S}=y.detail;S?r.clickSelect(S.id,_):r.isEmpty()||r.clear()});const d=Po(i,a,o.adapter),g=()=>{m.$destroy(),u.parentNode.insertBefore(n,u),u.parentNode.removeChild(u),h.destroy(),a.destroy()},E=()=>f,A=(y,_,S)=>un(y,_,S),b=(y,_)=>$t(y,_),p=y=>{if(!ft(y))throw`No drawing tool named ${y}`;m.$set({toolName:y})},w=y=>m.$set({drawingEnabled:y}),T=y=>{console.warn("Filter not implemented yet")},L=y=>m.$set({style:y}),D=y=>mt(n,u,y),U=y=>{f=y,m.$set({user:y})};return{...d,destroy:g,getUser:E,listDrawingTools:He,on:l.on,off:l.off,registerDrawingTool:A,registerShapeEditor:b,setDrawingEnabled:w,setDrawingTool:p,setFilter:T,setStyle:L,setTheme:D,setUser:U,state:i}};Y.Editor=Ye,Y.EditorMount=tn,Y.EllipseEditor=Jt,Y.FreehandEditor=Qt,Y.Handle=M,Y.IdentityTransform=Bi,Y.PolygonEditor=qt,Y.RectangleEditor=Zt,Y.RectangleUtil=kt,Y.RubberbandRectangle=rn,Y.SVGAnnotationLayer=Sn,Y.ShapeType=z,Y.ToolMount=nn,Y.W3CImageFormat=Vo,Y.addEventListeners=hn,Y.boundsFromPoints=me,Y.computeArea=Ve,Y.createImageAnnotator=$i,Y.createImageAnnotatorState=Ln,Y.createSVGTransform=dn,Y.createSvelteImageAnnotatorState=On,Y.detectTheme=kn,Y.distance=Fe,Y.enableResponsive=sn,Y.fillDefaults=In,Y.getEditor=lt,Y.getTool=ft,Y.initKeyboardCommands=Dn,Y.intersects=vt,Y.isTouch=ai,Y.listDrawingTools=He,Y.parseFragmentSelector=It,Y.parseSVGSelector=Yt,Y.parseW3CImageAnnotation=Ft,Y.registerEditor=$t,Y.registerShapeUtil=De,Y.registerTool=un,Y.sampleBrightness=vn,Y.serializeFragmentSelector=Pt,Y.serializeSVGSelector=Rt,Y.serializeW3CImageAnnotation=Ht,Y.setTheme=mt,Object.defineProperty(Y,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=annotorious.js.map
