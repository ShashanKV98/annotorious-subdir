(function(R,j){typeof exports=="object"&&typeof module<"u"?j(exports):typeof define=="function"&&define.amd?define(["exports"],j):(R=typeof globalThis<"u"?globalThis:R||self,j(R.Annotorious={}))})(this,function(R){"use strict";function j(){}function no(e,t){for(const n in t)e[n]=t[n];return e}function Ot(e){return e()}function Pt(){return Object.create(null)}function he(e){e.forEach(Ot)}function K(e){return typeof e=="function"}function J(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function oo(e){return Object.keys(e).length===0}function Dt(e,...t){if(e==null)return j;const n=e.subscribe(...t);return n.unsubscribe?()=>n.unsubscribe():n}function Bt(e,t,n){e.$$.on_destroy.push(Dt(t,n))}function io(e,t,n,o){if(e){const i=Yt(e,t,n,o);return e[0](i)}}function Yt(e,t,n,o){return e[1]&&o?no(n.ctx.slice(),e[1](o(t))):n.ctx}function ro(e,t,n,o){if(e[2]&&o){const i=e[2](o(n));if(t.dirty===void 0)return i;if(typeof i=="object"){const r=[],s=Math.max(t.dirty.length,i.length);for(let a=0;a<s;a+=1)r[a]=t.dirty[a]|i[a];return r}return t.dirty|i}return t.dirty}function so(e,t,n,o,i,r){if(i){const s=Yt(t,n,o,r);e.p(s,i)}}function lo(e){if(e.ctx.length>32){const t=[],n=e.ctx.length/32;for(let o=0;o<n;o++)t[o]=-1;return t}return-1}function re(e,t){e.appendChild(t)}function I(e,t,n){e.insertBefore(t,n||null)}function v(e){e.parentNode&&e.parentNode.removeChild(e)}function ut(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function P(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Rt(e){return document.createTextNode(e)}function x(){return Rt(" ")}function _e(){return Rt("")}function Z(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)}function f(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function ao(e){return Array.from(e.childNodes)}function Xt(e,t,n){e.classList[n?"add":"remove"](t)}function fo(e,t,{bubbles:n=!1,cancelable:o=!1}={}){const i=document.createEvent("CustomEvent");return i.initCustomEvent(e,n,o,t),i}let Ve;function ze(e){Ve=e}function Nt(){if(!Ve)throw new Error("Function called outside component initialization");return Ve}function Se(e){Nt().$$.on_mount.push(e)}function we(){const e=Nt();return(t,n,{cancelable:o=!1}={})=>{const i=e.$$.callbacks[t];if(i){const r=fo(t,n,{cancelable:o});return i.slice().forEach(s=>{s.call(e,r)}),!r.defaultPrevented}return!0}}function oe(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach(o=>o.call(this,t))}const De=[],je=[];let Be=[];const Ct=[],co=Promise.resolve();let dt=!1;function uo(){dt||(dt=!0,co.then(Ut))}function ht(e){Be.push(e)}const mt=new Set;let Ye=0;function Ut(){if(Ye!==0)return;const e=Ve;do{try{for(;Ye<De.length;){const t=De[Ye];Ye++,ze(t),ho(t.$$)}}catch(t){throw De.length=0,Ye=0,t}for(ze(null),De.length=0,Ye=0;je.length;)je.pop()();for(let t=0;t<Be.length;t+=1){const n=Be[t];mt.has(n)||(mt.add(n),n())}Be.length=0}while(De.length);for(;Ct.length;)Ct.pop()();dt=!1,mt.clear(),ze(e)}function ho(e){if(e.fragment!==null){e.update(),he(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(ht)}}function mo(e){const t=[],n=[];Be.forEach(o=>e.indexOf(o)===-1?t.push(o):n.push(o)),n.forEach(o=>o()),Be=t}const tt=new Set;let ve;function be(){ve={r:0,c:[],p:ve}}function Ee(){ve.r||he(ve.c),ve=ve.p}function z(e,t){e&&e.i&&(tt.delete(e),e.i(t))}function W(e,t,n,o){if(e&&e.o){if(tt.has(e))return;tt.add(e),ve.c.push(()=>{tt.delete(e),o&&(n&&e.d(1),o())}),e.o(t)}else o&&o()}function ce(e){e&&e.c()}function le(e,t,n,o){const{fragment:i,after_update:r}=e.$$;i&&i.m(t,n),o||ht(()=>{const s=e.$$.on_mount.map(Ot).filter(K);e.$$.on_destroy?e.$$.on_destroy.push(...s):he(s),e.$$.on_mount=[]}),r.forEach(ht)}function ae(e,t){const n=e.$$;n.fragment!==null&&(mo(n.after_update),he(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function go(e,t){e.$$.dirty[0]===-1&&(De.push(e),uo(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function $(e,t,n,o,i,r,s,a=[-1]){const l=Ve;ze(e);const u=e.$$={fragment:null,ctx:[],props:r,update:j,not_equal:i,bound:Pt(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(l?l.$$.context:[])),callbacks:Pt(),dirty:a,skip_bound:!1,root:t.target||l.$$.root};s&&s(u.root);let h=!1;if(u.ctx=n?n(e,t.props||{},(c,m,...d)=>{const g=d.length?d[0]:m;return u.ctx&&i(u.ctx[c],u.ctx[c]=g)&&(!u.skip_bound&&u.bound[c]&&u.bound[c](g),h&&go(e,c)),m}):[],u.update(),h=!0,he(u.before_update),u.fragment=o?o(u.ctx):!1,t.target){if(t.hydrate){const c=ao(t.target);u.fragment&&u.fragment.l(c),c.forEach(v)}else u.fragment&&u.fragment.c();t.intro&&z(e.$$.fragment),le(e,t.target,t.anchor,t.customElement),Ut()}ze(l)}class ee{$destroy(){ae(this,1),this.$destroy=j}$on(t,n){if(!K(n))return j;const o=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return o.push(n),()=>{const i=o.indexOf(n);i!==-1&&o.splice(i,1)}}$set(t){this.$$set&&!oo(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}var q=(e=>(e.ELLIPSE="ELLIPSE",e.POLYGON="POLYGON",e.RECTANGLE="RECTANGLE",e.FREEHAND="FREEHAND",e.LINE="LINE",e))(q||{});const gt={},Re=(e,t)=>gt[e]=t,nt=e=>gt[e.type].area(e),Ft=(e,t,n)=>gt[e.type].intersects(e,t,n),Ae=e=>{let t=1/0,n=1/0,o=-1/0,i=-1/0;return e.forEach(([r,s])=>{t=Math.min(t,r),n=Math.min(n,s),o=Math.max(o,r),i=Math.max(i,s)}),{minX:t,minY:n,maxX:o,maxY:i}},po={area:e=>Math.PI*e.geometry.rx*e.geometry.ry,intersects:(e,t,n)=>{const{cx:o,cy:i,rx:r,ry:s}=e.geometry,a=0,l=Math.cos(a),u=Math.sin(a),h=t-o,c=n-i,m=l*h+u*c,d=u*h-l*c;return m*m/(r*r)+d*d/(s*s)<=1}};Re(q.ELLIPSE,po);const yo={area:e=>{const{points:t}=e.geometry;let n=0,o=t.length-1;for(let i=0;i<t.length;i++)n+=(t[o][0]+t[i][0])*(t[o][1]-t[i][1]),o=i;return Math.abs(.5*n)},intersects:(e,t,n)=>{const{points:o}=e.geometry;let i=!1;for(let r=0,s=o.length-1;r<o.length;s=r++){const a=o[r][0],l=o[r][1],u=o[s][0],h=o[s][1];l>n!=h>n&&t<(u-a)*(n-l)/(h-l)+a&&(i=!i)}return i}};Re(q.POLYGON,yo);const Gt={area:e=>e.geometry.w*e.geometry.h,intersects:(e,t,n)=>t>=e.geometry.x&&t<=e.geometry.x+e.geometry.w&&n>=e.geometry.y&&n<=e.geometry.y+e.geometry.h};Re(q.RECTANGLE,Gt);const _o={area:e=>{const{points:t}=e.geometry;let n=0,o=t.length-1;for(let i=0;i<t.length;i++)n+=(t[o][0]+t[i][0])*(t[o][1]-t[i][1]),o=i;return Math.abs(.5*n)},intersects:(e,t,n)=>{const{points:o}=e.geometry;let i=!1;for(let r=0,s=o.length-1;r<o.length;s=r++){const a=o[r][0],l=o[r][1],u=o[s][0],h=o[s][1];l>n!=h>n&&t<(u-a)*(n-l)/(h-l)+a&&(i=!i)}return i}};Re(q.FREEHAND,_o);const Ht={area:e=>0,intersects:(e,t,n)=>{const o=e.geometry.x1,i=e.geometry.x2,r=e.geometry.y1,s=e.geometry.y2;var a=Math.sqrt(Math.pow(t-o,2)+Math.pow(n-r,2)),l=Math.sqrt(Math.pow(t-i,2)+Math.pow(n-s,2)),u=Math.sqrt(Math.pow(i-o,2)+Math.pow(s-r,2)),h=a+l;return Math.abs(h-u)<=.1}};Re(q.LINE,Ht);const Vt=(e,t=!1)=>{const n=typeof e=="string"?e:e.value,o=/^(xywh)=(pixel|percent)?:?(.+?),(.+?),(.+?),(.+)*/g,i=[...n.matchAll(o)][0],[r,s,a,l,u,h,c]=i;if(s!=="xywh")throw new Error("Unsupported MediaFragment: "+n);if(a&&a!=="pixel")throw new Error(`Unsupported MediaFragment unit: ${a}`);const[m,d,g,S]=[l,u,h,c].map(parseFloat);return{type:q.RECTANGLE,geometry:{x:m,y:d,w:g,h:S,bounds:{minX:m,minY:t?d-S:d,maxX:m+g,maxY:t?d:d+S}}}},zt=e=>{const{x:t,y:n,w:o,h:i}=e;return{type:"FragmentSelector",conformsTo:"http://www.w3.org/TR/media-frags/",value:`xywh=pixel:${t},${n},${o},${i}`}},jt="http://www.w3.org/2000/svg",qt=e=>{const t=o=>{Array.from(o.attributes).forEach(i=>{i.name.startsWith("on")&&o.removeAttribute(i.name)})},n=e.getElementsByTagName("script");return Array.from(n).reverse().forEach(o=>o.parentNode.removeChild(o)),Array.from(e.querySelectorAll("*")).forEach(t),e},wo=e=>{const o=new XMLSerializer().serializeToString(e.documentElement).replace("<svg>",`<svg xmlns="${jt}">`);return new DOMParser().parseFromString(o,"image/svg+xml").documentElement};function Wt(e,t,n,o=i=>i){return e*o(.5-t*(.5-n))}function bo(e){return[-e[0],-e[1]]}function me(e,t){return[e[0]+t[0],e[1]+t[1]]}function ue(e,t){return[e[0]-t[0],e[1]-t[1]]}function ge(e,t){return[e[0]*t,e[1]*t]}function Eo(e,t){return[e[0]/t,e[1]/t]}function qe(e){return[e[1],-e[0]]}function Kt(e,t){return e[0]*t[0]+e[1]*t[1]}function So(e,t){return e[0]===t[0]&&e[1]===t[1]}function Ao(e){return Math.hypot(e[0],e[1])}function Mo(e){return e[0]*e[0]+e[1]*e[1]}function Zt(e,t){return Mo(ue(e,t))}function Jt(e){return Eo(e,Ao(e))}function To(e,t){return Math.hypot(e[1]-t[1],e[0]-t[0])}function We(e,t,n){let o=Math.sin(n),i=Math.cos(n),r=e[0]-t[0],s=e[1]-t[1],a=r*i-s*o,l=r*o+s*i;return[a+t[0],l+t[1]]}function pt(e,t,n){return me(e,ge(ue(t,e),n))}function Qt(e,t,n){return me(e,ge(t,n))}var{min:Xe,PI:Lo}=Math,xt=.275,Ke=Lo+1e-4;function ko(e,t={}){let{size:n=16,smoothing:o=.5,thinning:i=.5,simulatePressure:r=!0,easing:s=V=>V,start:a={},end:l={},last:u=!1}=t,{cap:h=!0,easing:c=V=>V*(2-V)}=a,{cap:m=!0,easing:d=V=>--V*V*V+1}=l;if(e.length===0||n<=0)return[];let g=e[e.length-1].runningLength,S=a.taper===!1?0:a.taper===!0?Math.max(n,g):a.taper,A=l.taper===!1?0:l.taper===!0?Math.max(n,g):l.taper,w=Math.pow(n*o,2),p=[],_=[],M=e.slice(0,10).reduce((V,O)=>{let G=O.pressure;if(r){let F=Xe(1,O.distance/n),de=Xe(1,1-F);G=Xe(1,V+(de-V)*(F*xt))}return(V+G)/2},e[0].pressure),T=Wt(n,i,e[e.length-1].pressure,s),B,N=e[0].vector,b=e[0].point,y=b,E=b,k=y,D=!1;for(let V=0;V<e.length;V++){let{pressure:O}=e[V],{point:G,vector:F,distance:de,runningLength:ie}=e[V];if(V<e.length-1&&g-ie<3)continue;if(i){if(r){let fe=Xe(1,de/n),Le=Xe(1,1-fe);O=Xe(1,M+(Le-M)*(fe*xt))}T=Wt(n,i,O,s)}else T=n/2;B===void 0&&(B=T);let ne=ie<S?c(ie/S):1,He=g-ie<A?d((g-ie)/A):1;T=Math.max(.01,T*Math.min(ne,He));let Oe=(V<e.length-1?e[V+1]:e[V]).vector,Te=V<e.length-1?Kt(F,Oe):1,et=Kt(F,N)<0&&!D,se=Te!==null&&Te<0;if(et||se){let fe=ge(qe(N),T);for(let Le=1/13,ke=0;ke<=1;ke+=Le)E=We(ue(G,fe),G,Ke*ke),p.push(E),k=We(me(G,fe),G,Ke*-ke),_.push(k);b=E,y=k,se&&(D=!0);continue}if(D=!1,V===e.length-1){let fe=ge(qe(F),T);p.push(ue(G,fe)),_.push(me(G,fe));continue}let Pe=ge(qe(pt(Oe,F,Te)),T);E=ue(G,Pe),(V<=1||Zt(b,E)>w)&&(p.push(E),b=E),k=me(G,Pe),(V<=1||Zt(y,k)>w)&&(_.push(k),y=k),M=O,N=F}let X=e[0].point.slice(0,2),C=e.length>1?e[e.length-1].point.slice(0,2):me(e[0].point,[1,1]),U=[],pe=[];if(e.length===1){if(!(S||A)||u){let V=Qt(X,Jt(qe(ue(X,C))),-(B||T)),O=[];for(let G=1/13,F=G;F<=1;F+=G)O.push(We(V,X,Ke*2*F));return O}}else{if(!(S||A&&e.length===1))if(h)for(let O=1/13,G=O;G<=1;G+=O){let F=We(_[0],X,Ke*G);U.push(F)}else{let O=ue(p[0],_[0]),G=ge(O,.5),F=ge(O,.51);U.push(ue(X,G),ue(X,F),me(X,F),me(X,G))}let V=qe(bo(e[e.length-1].vector));if(A||S&&e.length===1)pe.push(C);else if(m){let O=Qt(C,V,T);for(let G=1/29,F=G;F<1;F+=G)pe.push(We(O,C,Ke*3*F))}else pe.push(me(C,ge(V,T)),me(C,ge(V,T*.99)),ue(C,ge(V,T*.99)),ue(C,ge(V,T)))}return p.concat(pe,_.reverse(),U)}function vo(e,t={}){var n;let{streamline:o=.5,size:i=16,last:r=!1}=t;if(e.length===0)return[];let s=.15+(1-o)*.85,a=Array.isArray(e[0])?e:e.map(({x:d,y:g,pressure:S=.5})=>[d,g,S]);if(a.length===2){let d=a[1];a=a.slice(0,-1);for(let g=1;g<5;g++)a.push(pt(a[0],d,g/4))}a.length===1&&(a=[...a,[...me(a[0],[1,1]),...a[0].slice(2)]]);let l=[{point:[a[0][0],a[0][1]],pressure:a[0][2]>=0?a[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],u=!1,h=0,c=l[0],m=a.length-1;for(let d=1;d<a.length;d++){let g=r&&d===m?a[d].slice(0,2):pt(c.point,a[d],s);if(So(c.point,g))continue;let S=To(g,c.point);if(h+=S,d<m&&!u){if(h<i)continue;u=!0}c={point:g,pressure:a[d][2]>=0?a[d][2]:.5,vector:Jt(ue(c.point,g)),distance:S,runningLength:h},l.push(c)}return l[0].vector=((n=l[1])==null?void 0:n.vector)||[0,0],l}function Io(e,t={}){return ko(vo(e,t),t)}function Oo(e,t){var n=e[0]-t[0],o=e[1]-t[1];return n*n+o*o}function Po(e,t,n){var o=t[0],i=t[1],r=n[0]-o,s=n[1]-i;if(r!==0||s!==0){var a=((e[0]-o)*r+(e[1]-i)*s)/(r*r+s*s);a>1?(o=n[0],i=n[1]):a>0&&(o+=r*a,i+=s*a)}return r=e[0]-o,s=e[1]-i,r*r+s*s}function Do(e,t){for(var n=e[0],o=[n],i,r=1,s=e.length;r<s;r++)i=e[r],Oo(i,n)>t&&(o.push(i),n=i);return n!==i&&o.push(i),o}function yt(e,t,n,o,i){for(var r=o,s,a=t+1;a<n;a++){var l=Po(e[a],e[t],e[n]);l>r&&(s=a,r=l)}r>o&&(s-t>1&&yt(e,t,s,o,i),i.push(e[s]),n-s>1&&yt(e,s,n,o,i))}function Bo(e,t){var n=e.length-1,o=[e[0]];return yt(e,0,n,t,o),o.push(e[n]),o}function Yo(e,t,n){if(e.length<=2)return e;var o=t!==void 0?t*t:1;return e=n?e:Do(e,o),e=Bo(e,o),e}const Ze={size:2,thinning:.3,smoothing:.5,streamline:.5,easing:e=>e,start:{taper:0,easing:e=>e,cap:!0},end:{taper:0,easing:e=>e,cap:!0}};function Ro(e){if(!e.length)return"";const t=e.reduce((n,[o,i],r,s)=>{const[a,l]=s[(r+1)%s.length];return n.push(o,i,(o+a)/2,(i+l)/2),n},["M",...e[0],"Q"]);return t.push("Z"),t.join(" ")}function Je(e,t,n=!1){const o=Io(e,t);return Ro(n?Yo(o,.2):o)}const $t=e=>{const n=new DOMParser().parseFromString(e,"image/svg+xml"),o=n.lookupPrefix(jt),i=n.lookupNamespaceURI(null);return o||i?qt(n).firstChild:qt(wo(n)).firstChild},Xo=e=>{const[t,n,o]=e.match(/(<path d=["|'])([^("|')]*)/)||[];if(!o)return;const i=/([MQZT])([^MQZT]*)/g,s=Array.from(o.matchAll(i)).map(a=>(a[1],a[2].trim().split(/\s+/).map(parseFloat)));return{type:q.FREEHAND,geometry:{points:s,bounds:Ae(s)}}},No=e=>{const[t,n,o]=e.match(/(<polygon points=["|'])([^("|')]*)/)||[];if(!o)return;const i=o.split(" ").map(r=>r.split(",").map(parseFloat));return{type:q.POLYGON,geometry:{points:i,bounds:Ae(i)}}},Co=e=>{const t=$t(e),n=parseFloat(t.getAttribute("cx")),o=parseFloat(t.getAttribute("cy")),i=parseFloat(t.getAttribute("rx")),r=parseFloat(t.getAttribute("ry")),s={minX:n-i,minY:o-r,maxX:n+i,maxY:o+r};return{type:q.ELLIPSE,geometry:{cx:n,cy:o,rx:i,ry:r,bounds:s}}},Uo=e=>{const t=$t(e),n=parseFloat(t.getAttribute("x1")),o=parseFloat(t.getAttribute("x2")),i=parseFloat(t.getAttribute("y1")),r=parseFloat(t.getAttribute("y2")),s={minX:Math.min(n,o),minY:Math.min(i,r),maxX:Math.max(n,o),maxY:Math.max(i,r)};return{type:q.LINE,geometry:{x1:n,x2:o,y1:i,y2:r,bounds:s}}},en=e=>{const t=typeof e=="string"?e:e.value;if(t.includes("<polygon points="))return No(t);if(t.includes("<path d="))return Xo(t);if(t.includes("<ellipse "))return Co(t);if(t.includes("<line "))return Uo(t)},tn=e=>{let t;if(e.type===q.POLYGON){const n=e.geometry,{points:o}=n;t=`<svg><polygon points="${o.map(i=>i.join(",")).join(" ")}" /></svg>`}else if(e.type===q.FREEHAND){const n=e.geometry;t=`<svg><path d="${Je(n.points,Ze)}"/></svg>`}else if(e.type===q.ELLIPSE){const n=e.geometry;t=`<svg><ellipse cx="${n.cx}" cy="${n.cy}" rx="${n.rx}" ry="${n.ry}" /></svg>`}else if(e.type===q.LINE){const n=e.geometry;t=`<svg><line x1="${n.x1}" x2="${n.x2}" y1="${n.y1}" y2="${n.y2}" /></svg>`}if(t)return{type:"SvgSelector",value:t};throw`Unsupported shape type: ${e.type}`};let ot;const Fo=new Uint8Array(16);function Go(){if(!ot&&(ot=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ot))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ot(Fo)}const te=[];for(let e=0;e<256;++e)te.push((e+256).toString(16).slice(1));function Ho(e,t=0){return te[e[t+0]]+te[e[t+1]]+te[e[t+2]]+te[e[t+3]]+"-"+te[e[t+4]]+te[e[t+5]]+"-"+te[e[t+6]]+te[e[t+7]]+"-"+te[e[t+8]]+te[e[t+9]]+"-"+te[e[t+10]]+te[e[t+11]]+te[e[t+12]]+te[e[t+13]]+te[e[t+14]]+te[e[t+15]]}const nn={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function on(e,t,n){if(nn.randomUUID&&!t&&!e)return nn.randomUUID();e=e||{};const o=e.random||(e.rng||Go)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,t){n=n||0;for(let i=0;i<16;++i)t[n+i]=o[i];return t}return Ho(o)}var rn=Object.prototype.hasOwnProperty;function Ie(e,t){var n,o;if(e===t)return!0;if(e&&t&&(n=e.constructor)===t.constructor){if(n===Date)return e.getTime()===t.getTime();if(n===RegExp)return e.toString()===t.toString();if(n===Array){if((o=e.length)===t.length)for(;o--&&Ie(e[o],t[o]););return o===-1}if(!n||typeof e=="object"){o=0;for(n in e)if(rn.call(e,n)&&++o&&!rn.call(t,n)||!(n in t)||!Ie(e[n],t[n]))return!1;return Object.keys(t).length===o}}return e!==e&&t!==t}function _t(){}function Vo(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}const Ne=[];function wt(e,t=_t){let n;const o=new Set;function i(a){if(Vo(e,a)&&(e=a,n)){const l=!Ne.length;for(const u of o)u[1](),Ne.push(u,e);if(l){for(let u=0;u<Ne.length;u+=2)Ne[u][0](Ne[u+1]);Ne.length=0}}}function r(a){i(a(e))}function s(a,l=_t){const u=[a,l];return o.add(u),o.size===1&&(n=t(i)||_t),a(e),()=>{o.delete(u),o.size===0&&n&&(n(),n=null)}}return{set:i,update:r,subscribe:s}}const zo=e=>{const{subscribe:t,set:n}=wt(null);let o=null;return t(i=>o=i),e.observe(({changes:i})=>{if(o){i.deleted.some(s=>s.id===o)&&n(null);const r=i.updated.find(({oldValue:s})=>s.id===o);r&&n(r.newValue.id)}}),{get current(){return o},subscribe:t,set:n}};var sn=(e=>(e.EDIT="EDIT",e.SELECT="SELECT",e.NONE="NONE",e))(sn||{});const bt={selected:[]},jo=(e,t="EDIT")=>{const{subscribe:n,set:o}=wt(bt);let i=bt;n(c=>i=c);const r=()=>o(bt),s=()=>{var c;return((c=i.selected)==null?void 0:c.length)===0},a=c=>{if(i.selected.length===0)return!1;const m=typeof c=="string"?c:c.id;return i.selected.some(d=>d.id===m)},l=(c,m)=>{const d=e.getAnnotation(c);if(d){const g=qo(d,t);o(g==="EDIT"?{selected:[{id:c,editable:!0}],pointerEvent:m}:g==="SELECT"?{selected:[{id:c}],pointerEvent:m}:{selected:[],pointerEvent:m})}else console.warn("Invalid selection: "+c)},u=(c,m=!0)=>{const d=Array.isArray(c)?c:[c],g=d.map(S=>e.getAnnotation(S)).filter(S=>S);o({selected:g.map(({id:S})=>({id:S,editable:m}))}),g.length!==d.length&&console.warn("Invalid selection",c)},h=c=>{if(i.selected.length===0)return!1;const{selected:m}=i;m.filter(({id:d})=>c.includes(d)).length>0&&o({selected:m.filter(({id:d})=>!c.includes(d))})};return e.observe(({changes:c})=>h(c.deleted.map(m=>m.id))),{clear:r,clickSelect:l,get selected(){return i?[...i.selected]:null},get pointerEvent(){return i?i.pointerEvent:null},isEmpty:s,isSelected:a,setSelected:u,subscribe:n}},qo=(e,t)=>typeof t=="function"?t(e)||"EDIT":t||"EDIT",Wo=[];for(let e=0;e<256;++e)Wo.push((e+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Ko=(e,t)=>{const n=new Set(e.bodies.map(o=>o.id));return t.bodies.filter(o=>!n.has(o.id))},Zo=(e,t)=>{const n=new Set(t.bodies.map(o=>o.id));return e.bodies.filter(o=>!n.has(o.id))},Jo=(e,t)=>t.bodies.map(n=>{const o=e.bodies.find(i=>i.id===n.id);return{newBody:n,oldBody:o&&!Ie(o,n)?o:void 0}}).filter(({oldBody:n})=>n),Qo=(e,t)=>!Ie(e.target,t.target),ln=(e,t)=>{const n=Ko(e,t),o=Zo(e,t),i=Jo(e,t);return{oldValue:e,newValue:t,bodiesCreated:n.length>0?n:void 0,bodiesDeleted:o.length>0?o:void 0,bodiesUpdated:i.length>0?i:void 0,targetUpdated:Qo(e,t)?{oldTarget:e.target,newTarget:t.target}:void 0}};var Q=(e=>(e.LOCAL="LOCAL",e.REMOTE="REMOTE",e))(Q||{});const xo=(e,t)=>{var n,o;const{changes:i,origin:r}=t;if(!(!e.options.origin||e.options.origin===r))return!1;if(e.options.ignore){const{ignore:s}=e.options,a=l=>(l==null?void 0:l.length)>0;if(!(a(i.created)||a(i.deleted))){const l=(n=i.updated)==null?void 0:n.some(h=>a(h.bodiesCreated)||a(h.bodiesDeleted)||a(h.bodiesUpdated)),u=(o=i.updated)==null?void 0:o.some(h=>h.targetUpdated);if(s==="BODY_ONLY"&&l&&!u||s==="TARGET_ONLY"&&u&&!l)return!1}}if(e.options.annotations){const s=new Set([...i.created.map(a=>a.id),...i.deleted.map(a=>a.id),...i.updated.map(({oldValue:a})=>a.id)]);return!!(Array.isArray(e.options.annotations)?e.options.annotations:[e.options.annotations]).find(a=>s.has(a))}else return!0},$o=(e,t)=>{const n=new Set((e.created||[]).map(c=>c.id)),o=new Set((e.updated||[]).map(({newValue:c})=>c.id)),i=new Set((t.created||[]).map(c=>c.id)),r=new Set((t.deleted||[]).map(c=>c.id)),s=new Set((t.updated||[]).map(({oldValue:c})=>c.id)),a=new Set((t.updated||[]).filter(({oldValue:c})=>n.has(c.id)||o.has(c.id)).map(({oldValue:c})=>c.id)),l=[...(e.created||[]).filter(c=>!r.has(c.id)).map(c=>s.has(c.id)?t.updated.find(({oldValue:m})=>m.id===c.id).newValue:c),...t.created||[]],u=[...(e.deleted||[]).filter(c=>!i.has(c.id)),...(t.deleted||[]).filter(c=>!n.has(c.id))],h=[...(e.updated||[]).filter(({newValue:c})=>!r.has(c.id)).map(c=>{const{oldValue:m,newValue:d}=c;if(s.has(d.id)){const g=t.updated.find(S=>S.oldValue.id===d.id).newValue;return ln(m,g)}else return c}),...(t.updated||[]).filter(({oldValue:c})=>!a.has(c.id))];return{created:l,deleted:u,updated:h}},ei=e=>e.id!==void 0,ti=()=>{const e=new Map,t=new Map,n=[],o=(b,y={})=>n.push({onChange:b,options:y}),i=b=>{const y=n.findIndex(E=>E.onChange==b);y>-1&&n.splice(y,1)},r=(b,y)=>{const E={origin:b,changes:{created:y.created||[],updated:y.updated||[],deleted:y.deleted||[]},state:[...e.values()]};n.forEach(k=>{xo(k,E)&&k.onChange(E)})},s=(b,y=Q.LOCAL)=>{if(e.get(b.id))throw Error(`Cannot add annotation ${b.id} - exists already`);e.set(b.id,b),b.bodies.forEach(E=>t.set(E.id,b.id)),r(y,{created:[b]})},a=(b,y)=>{const E=typeof b=="string"?y:b,k=typeof b=="string"?b:b.id,D=e.get(k);if(D){const X=ln(D,E);return k===E.id?e.set(k,E):(e.delete(k),e.set(E.id,E)),D.bodies.forEach(C=>t.delete(C.id)),E.bodies.forEach(C=>t.set(C.id,E.id)),X}else console.warn(`Cannot update annotation ${k} - does not exist`)},l=(b,y=Q.LOCAL,E=Q.LOCAL)=>{const k=ei(y)?E:y,D=a(b,y);D&&r(k,{updated:[D]})},u=(b,y=Q.LOCAL)=>{const E=b.reduce((k,D)=>{const X=a(D);return X?[...k,X]:k},[]);E.length>0&&r(y,{updated:E})},h=(b,y=Q.LOCAL)=>{const E=e.get(b.annotation);if(E){const k={...E,bodies:[...E.bodies,b]};e.set(E.id,k),t.set(b.id,k.id),r(y,{updated:[{oldValue:E,newValue:k,bodiesCreated:[b]}]})}else console.warn(`Attempt to add body to missing annotation: ${b.annotation}`)},c=()=>[...e.values()],m=(b=Q.LOCAL)=>{const y=[...e.values()];e.clear(),t.clear(),r(b,{deleted:y})},d=(b,y=!0,E=Q.LOCAL)=>{if(y){const k=[...e.values()];e.clear(),t.clear(),b.forEach(D=>{e.set(D.id,D),D.bodies.forEach(X=>t.set(X.id,D.id))}),r(E,{created:b,deleted:k})}else{const k=b.reduce((D,X)=>{const C=e.get(X.id);return C?[...D,C]:D},[]);if(k.length>0)throw Error(`Bulk insert would overwrite the following annotations: ${k.map(D=>D.id).join(", ")}`);b.forEach(D=>{e.set(D.id,D),D.bodies.forEach(X=>t.set(X.id,D.id))}),r(E,{created:b})}},g=b=>{const y=typeof b=="string"?b:b.id,E=e.get(y);if(E)return e.delete(y),E.bodies.forEach(k=>t.delete(k.id)),E;console.warn(`Attempt to delete missing annotation: ${y}`)},S=(b,y=Q.LOCAL)=>{const E=g(b);E&&r(y,{deleted:[E]})},A=(b,y=Q.LOCAL)=>{const E=b.reduce((k,D)=>{const X=g(D);return X?[...k,X]:k},[]);E.length>0&&r(y,{deleted:E})},w=(b,y=Q.LOCAL)=>{const E=e.get(b.annotation);if(E){const k=E.bodies.find(D=>D.id===b.id);if(k){t.delete(k.id);const D={...E,bodies:E.bodies.filter(X=>X.id!==b.id)};e.set(E.id,D),r(y,{updated:[{oldValue:E,newValue:D,bodiesDeleted:[k]}]})}else console.warn(`Attempt to delete missing body ${b.id} from annotation ${b.annotation}`)}else console.warn(`Attempt to delete body from missing annotation ${b.annotation}`)},p=b=>{const y=e.get(b);return y?{...y}:void 0},_=b=>{const y=t.get(b);if(y){const E=p(y).bodies.find(k=>k.id===b);if(E)return E;console.error(`Store integrity error: body ${b} in index, but not in annotation`)}else console.warn(`Attempt to retrieve missing body: ${b}`)},M=(b,y)=>{if(b.annotation!==y.annotation)throw"Annotation integrity violation: annotation ID must be the same when updating bodies";const E=e.get(b.annotation);if(E){const k=E.bodies.find(X=>X.id===b.id),D={...E,bodies:E.bodies.map(X=>X.id===k.id?y:X)};return e.set(E.id,D),k.id!==y.id&&(t.delete(k.id),t.set(y.id,D.id)),{oldValue:E,newValue:D,bodiesUpdated:[{oldBody:k,newBody:y}]}}else console.warn(`Attempt to add body to missing annotation ${b.annotation}`)},T=(b,y,E=Q.LOCAL)=>{const k=M(b,y);r(E,{updated:[k]})},B=(b,y=Q.LOCAL)=>{const E=b.map(k=>M({id:k.id,annotation:k.annotation},k));r(y,{updated:E})},N=b=>{const y=e.get(b.annotation);if(y){const E={...y,target:{...y.target,...b}};return e.set(y.id,E),{oldValue:y,newValue:E,targetUpdated:{oldTarget:y.target,newTarget:b}}}else console.warn(`Attempt to update target on missing annotation: ${b.annotation}`)};return{addAnnotation:s,addBody:h,all:c,bulkAddAnnotation:d,bulkDeleteAnnotation:A,bulkUpdateAnnotation:u,bulkUpdateBodies:B,bulkUpdateTargets:(b,y=Q.LOCAL)=>{const E=b.map(N).filter(k=>k);E.length>0&&r(y,{updated:E})},clear:m,deleteAnnotation:S,deleteBody:w,getAnnotation:p,getBody:_,observe:o,unobserve:i,updateAnnotation:l,updateBody:T,updateTarget:(b,y=Q.LOCAL)=>{const E=N(b);E&&r(y,{updated:[E]})}}},ni=e=>({...e,subscribe:t=>{const n=o=>t(o.state);return e.observe(n),t(e.all()),()=>e.unobserve(n)}});let oi=()=>({emit(e,...t){let n=this.events[e]||[];for(let o=0,i=n.length;o<i;o++)n[o](...t)},events:{},on(e,t){var n;return(n=this.events[e])!=null&&n.push(t)||(this.events[e]=[t]),()=>{var o;this.events[e]=(o=this.events[e])==null?void 0:o.filter(i=>t!==i)}}});const ii=250,ri=e=>{const t=oi(),n=[];let o=-1,i=!1,r=0;const s=d=>{if(!i){const{changes:g}=d,S=performance.now();if(S-r>ii)n.splice(o+1),n.push(g),o=n.length-1;else{const A=n.length-1;n[A]=$o(n[A],g)}r=S}i=!1};e.observe(s,{origin:Q.LOCAL});const a=d=>(d==null?void 0:d.length)>0&&e.bulkDeleteAnnotation(d),l=d=>(d==null?void 0:d.length)>0&&e.bulkAddAnnotation(d,!1),u=d=>(d==null?void 0:d.length)>0&&e.bulkUpdateAnnotation(d.map(({oldValue:g})=>g)),h=d=>(d==null?void 0:d.length)>0&&e.bulkUpdateAnnotation(d.map(({newValue:g})=>g)),c=d=>(d==null?void 0:d.length)>0&&e.bulkAddAnnotation(d,!1),m=d=>(d==null?void 0:d.length)>0&&e.bulkDeleteAnnotation(d);return{canRedo:()=>n.length-1>o,canUndo:()=>o>-1,destroy:()=>e.unobserve(s),on:(d,g)=>t.on(d,g),redo:()=>{if(n.length-1>o){i=!0;const{created:d,updated:g,deleted:S}=n[o+1];l(d),h(g),m(S),t.emit("redo",n[o+1]),o+=1}},undo:()=>{if(o>-1){i=!0;const{created:d,updated:g,deleted:S}=n[o];a(d),u(g),c(S),t.emit("undo",n[o]),o-=1}}}},si=()=>{const{subscribe:e,set:t}=wt([]);return{subscribe:e,set:t}},li=(e,t,n,o)=>{const{store:i,selection:r,hover:s,viewport:a}=e,l=new Map;let u=[],h,c;const m=(w,p)=>{l.has(w)?l.get(w).push(p):l.set(w,[p])},d=(w,p)=>{const _=l.get(w);_&&_.indexOf(p)>0&&_.splice(_.indexOf(p),1)},g=(w,p,_)=>{l.has(w)&&setTimeout(()=>{l.get(w).forEach(M=>{if(n){const T=Array.isArray(p)?p.map(N=>n.serialize(N)):n.serialize(p),B=_?_ instanceof PointerEvent?_:n.serialize(_):void 0;M(T,B)}else M(p,_)})},1)},S=()=>{const{selected:w}=r,p=w.map(({id:_})=>i.getAnnotation(_));p.forEach(_=>{const M=u.find(T=>T.id===_.id);(!M||!Ie(M,_))&&g("updateAnnotation",_,M)}),u=u.map(_=>p.find(({id:T})=>T===_.id)||_)};r.subscribe(({selected:w})=>{if(!(u.length===0&&w.length===0)){if(u.length===0&&w.length>0)u=w.map(({id:p})=>i.getAnnotation(p));else if(u.length>0&&w.length===0)u.forEach(p=>{const _=i.getAnnotation(p.id);_&&!Ie(_,p)&&g("updateAnnotation",_,p)}),u=[];else{const p=new Set(u.map(M=>M.id)),_=new Set(w.map(({id:M})=>M));u.filter(M=>!_.has(M.id)).forEach(M=>{const T=i.getAnnotation(M.id);T&&!Ie(T,M)&&g("updateAnnotation",T,M)}),u=[...u.filter(M=>_.has(M.id)),...w.filter(({id:M})=>!p.has(M)).map(({id:M})=>i.getAnnotation(M))]}g("selectionChanged",u)}}),s.subscribe(w=>{!h&&w?g("mouseEnterAnnotation",i.getAnnotation(w)):h&&!w?g("mouseLeaveAnnotation",i.getAnnotation(h)):h&&w&&(g("mouseLeaveAnnotation",i.getAnnotation(h)),g("mouseEnterAnnotation",i.getAnnotation(w))),h=w}),a==null||a.subscribe(w=>g("viewportIntersect",w.map(i.getAnnotation))),i.observe(w=>{o&&(c&&clearTimeout(c),c=setTimeout(S,1e3));const{created:p,deleted:_}=w.changes;p.forEach(M=>g("createAnnotation",M)),_.forEach(M=>g("deleteAnnotation",M)),w.changes.updated.filter(M=>[...M.bodiesCreated||[],...M.bodiesDeleted||[],...M.bodiesUpdated||[]].length>0).forEach(({oldValue:M,newValue:T})=>{const B=u.find(N=>N.id===M.id)||M;u=u.map(N=>N.id===M.id?T:N),g("updateAnnotation",T,B)})},{origin:Q.LOCAL}),i.observe(w=>{if(u){const p=new Set(u.map(M=>M.id)),_=w.changes.updated.filter(({newValue:M})=>p.has(M.id)).map(({newValue:M})=>M);_.length>0&&(u=u.map(M=>_.find(B=>B.id===M.id)||M))}},{origin:Q.REMOTE});const A=w=>p=>{const{created:_,deleted:M,updated:T}=p;_.forEach(B=>g("createAnnotation",B)),M.forEach(B=>g("deleteAnnotation",B)),w?T.forEach(B=>g("updateAnnotation",B.oldValue,B.newValue)):T.forEach(B=>g("updateAnnotation",B.newValue,B.oldValue))};return t.on("undo",A(!0)),t.on("redo",A(!1)),{on:m,off:d,emit:g}},ai=e=>t=>t.reduce((n,o)=>{const{parsed:i,error:r}=e.parse(o);return r?{parsed:n.parsed,failed:[...n.failed,o]}:{parsed:[...n.parsed,i],failed:n.failed}},{parsed:[],failed:[]}),fi=(e,t,n)=>{const{store:o,selection:i}=e,r=A=>{if(n){const{parsed:w,error:p}=n.parse(A);w?o.addAnnotation(w,Q.REMOTE):console.error(p)}else o.addAnnotation(A,Q.REMOTE)},s=()=>i.clear(),a=()=>o.clear(),l=A=>{const w=o.getAnnotation(A);return n&&w?n.serialize(w):w},u=()=>n?o.all().map(n.serialize):o.all(),h=()=>{var A;const w=(((A=i.selected)==null?void 0:A.map(p=>p.id))||[]).map(p=>o.getAnnotation(p));return n?w.map(n.serialize):w},c=A=>fetch(A).then(w=>w.json()).then(w=>(d(w),w)),m=A=>{if(typeof A=="string"){const w=o.getAnnotation(A);return o.deleteAnnotation(A),n?n.serialize(w):w}else{const w=n?n.parse(A).parsed:A;return o.deleteAnnotation(w),A}},d=A=>{if(n){const{parsed:w,failed:p}=ai(n)(A);p.length>0&&console.warn(`Discarded ${p.length} invalid annotations`,p),o.bulkAddAnnotation(w,!0,Q.REMOTE)}else o.bulkAddAnnotation(A,!0,Q.REMOTE)},g=A=>{A?i.setSelected(A):i.clear()},S=A=>{if(n){const w=n.parse(A).parsed,p=n.serialize(o.getAnnotation(w.id));return o.updateAnnotation(w),p}else{const w=o.getAnnotation(A.id);return o.updateAnnotation(A),w}};return{addAnnotation:r,cancelSelected:s,canRedo:t.canRedo,canUndo:t.canUndo,clearAnnotations:a,getAnnotationById:l,getAnnotations:u,getSelected:h,loadAnnotations:c,redo:t.redo,removeAnnotation:m,setAnnotations:d,setSelected:g,undo:t.undo,updateAnnotation:S}};let ci=e=>crypto.getRandomValues(new Uint8Array(e)),ui=(e,t,n)=>{let o=(2<<Math.log(e.length-1)/Math.LN2)-1,i=-~(1.6*o*t/e.length);return(r=t)=>{let s="";for(;;){let a=n(i),l=i;for(;l--;)if(s+=e[a[l]&o]||"",s.length===r)return s}}},di=(e,t=21)=>ui(e,t,ci),hi=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((t,n)=>(n&=63,n<36?t+=n.toString(36):n<62?t+=(n-26).toString(36).toUpperCase():n>62?t+="-":t+="_",t),"");const mi=()=>({isGuest:!0,id:di("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",20)()}),gi=e=>{const t=JSON.stringify(e);let n=0;for(let o=0,i=t.length;o<i;o++){let r=t.charCodeAt(o);n=(n<<5)-n+r,n|=0}return`${n}`},an=e=>e?typeof e=="object"?{...e}:e:void 0,pi=(e,t)=>(Array.isArray(e)?e:[e]).map(n=>{const{id:o,type:i,purpose:r,value:s,created:a,creator:l,...u}=n;return{id:o||`temp-${gi(n)}`,annotation:t,type:i,purpose:r,value:s,created:a?new Date(a):void 0,creator:an(l),...u}}),yi=e=>e.map(t=>{var n;const o={...t};return delete o.annotation,(n=o.id)!=null&&n.startsWith("temp-")&&delete o.id,o});hi();const _i=(e,t=!1)=>({parse:i=>fn(i,t),serialize:i=>cn(i,e)}),fn=(e,t=!1)=>{const n=e.id||on(),{creator:o,created:i,updatedBy:r,updated:s,body:a,...l}=e,u=pi(a,n),h=Array.isArray(e.target)?e.target[0]:e.target,c=Array.isArray(h.selector)?h.selector[0]:h.selector,m=c.type==="FragmentSelector"?Vt(c,t):c.type==="SvgSelector"?en(c):void 0;return m?{parsed:{...l,id:n,bodies:u,target:{created:i?new Date(i):void 0,creator:an(o),...l.target,annotation:n,selector:m}}}:{error:Error(`Unknown selector type: ${c.type}`)}},cn=(e,t)=>{const{selector:n,creator:o,created:i,updated:r,updatedBy:s,...a}=e.target,l=n.type==q.RECTANGLE?zt(n.geometry):tn(n);return{...e,"@context":"http://www.w3.org/ns/anno.jsonld",id:e.id,type:"Annotation",body:yi(e.bodies),creator:o,created:i==null?void 0:i.toISOString(),target:{...a,source:t,selector:l}}};function un(e,t,n){const o=e.slice();return o[11]=t[n],o[13]=n,o}function dn(e){let t,n,o,i,r;return{c(){t=P("rect"),f(t,"class","a9s-corner-handle"),f(t,"x",n=e[11][0]-e[3]/2),f(t,"y",o=e[11][1]-e[3]/2),f(t,"height",e[3]),f(t,"width",e[3])},m(s,a){I(s,t,a),i||(r=Z(t,"pointerdown",function(){K(e[10](L(e[13])))&&e[10](L(e[13])).apply(this,arguments)}),i=!0)},p(s,a){e=s,a&24&&n!==(n=e[11][0]-e[3]/2)&&f(t,"x",n),a&24&&o!==(o=e[11][1]-e[3]/2)&&f(t,"y",o),a&8&&f(t,"height",e[3]),a&8&&f(t,"width",e[3])},d(s){s&&v(t),i=!1,r()}}}function wi(e){let t,n,o,i,r,s,a,l,u,h,c=e[4].points,m=[];for(let d=0;d<c.length;d+=1)m[d]=dn(un(e,c,d));return{c(){t=P("polygon"),i=x(),r=P("polygon"),a=x();for(let d=0;d<m.length;d+=1)m[d].c();l=_e(),f(t,"class","a9s-outer"),f(t,"style",n=e[1]?"display:none;":void 0),f(t,"points",o=e[4].points.map(hn).join(" ")),f(r,"class","a9s-inner a9s-shape-handle"),f(r,"style",e[1]),f(r,"points",s=e[4].points.map(mn).join(" "))},m(d,g){I(d,t,g),I(d,i,g),I(d,r,g),I(d,a,g);for(let S=0;S<m.length;S+=1)m[S]&&m[S].m(d,g);I(d,l,g),u||(h=[Z(t,"pointerdown",function(){K(e[10](L.SHAPE))&&e[10](L.SHAPE).apply(this,arguments)}),Z(r,"pointerdown",function(){K(e[10](L.SHAPE))&&e[10](L.SHAPE).apply(this,arguments)})],u=!0)},p(d,g){if(e=d,g&2&&n!==(n=e[1]?"display:none;":void 0)&&f(t,"style",n),g&16&&o!==(o=e[4].points.map(hn).join(" "))&&f(t,"points",o),g&2&&f(r,"style",e[1]),g&16&&s!==(s=e[4].points.map(mn).join(" "))&&f(r,"points",s),g&1048){c=e[4].points;let S;for(S=0;S<c.length;S+=1){const A=un(e,c,S);m[S]?m[S].p(A,g):(m[S]=dn(A),m[S].c(),m[S].m(l.parentNode,l))}for(;S<m.length;S+=1)m[S].d(1);m.length=c.length}},d(d){d&&v(t),d&&v(i),d&&v(r),d&&v(a),ut(m,d),d&&v(l),u=!1,he(h)}}}function bi(e){let t,n;return t=new Ce({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[wi,({grab:o})=>({10:o}),({grab:o})=>o?1024:0]},$$scope:{ctx:e}}}),t.$on("change",e[7]),t.$on("grab",e[8]),t.$on("release",e[9]),{c(){ce(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&4&&(r.transform=o[2]),i&17434&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}const hn=e=>e.join(","),mn=e=>e.join(",");function Ei(e,t,n){let o,i,{shape:r}=t,{computedStyle:s=void 0}=t,{transform:a}=t,{viewportScale:l=1}=t;const u=(d,g,S)=>{let A;g===L.SHAPE?A=d.geometry.points.map(([p,_])=>[p+S[0],_+S[1]]):A=d.geometry.points.map(([p,_],M)=>g===L(M)?[p+S[0],_+S[1]]:[p,_]);const w=Ae(A);return{...d,geometry:{points:A,bounds:w}}};function h(d){oe.call(this,e,d)}function c(d){oe.call(this,e,d)}function m(d){oe.call(this,e,d)}return e.$$set=d=>{"shape"in d&&n(0,r=d.shape),"computedStyle"in d&&n(1,s=d.computedStyle),"transform"in d&&n(2,a=d.transform),"viewportScale"in d&&n(6,l=d.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=r.geometry),e.$$.dirty&64&&n(3,i=10/l)},[r,s,a,i,o,u,l,h,c,m]}class gn extends ee{constructor(t){super(),$(this,t,Ei,bi,J,{shape:0,computedStyle:1,transform:2,viewportScale:6})}}function Si(e){let t,n,o,i,r,s,a,l,u,h,c,m,d,g,S,A,w,p,_,M,T,B,N,b,y,E,k,D,X,C,U,pe,V,O,G,F,de,ie,ne,He,Oe,Te,et,se,Pe,fe,Le,ke,ye,at,ft,ct,It,to;return{c(){t=P("rect"),a=x(),l=P("rect"),d=x(),g=P("rect"),p=x(),_=P("rect"),N=x(),b=P("rect"),D=x(),X=P("rect"),V=x(),O=P("circle"),ie=x(),ne=P("circle"),et=x(),se=P("circle"),ke=x(),ye=P("circle"),f(t,"class","a9s-outer"),f(t,"style",n=e[1]?"display:none;":void 0),f(t,"x",o=e[4].x),f(t,"y",i=e[4].y),f(t,"width",r=e[4].w),f(t,"height",s=e[4].h),f(l,"class","a9s-inner a9s-shape-handle"),f(l,"style",e[1]),f(l,"x",u=e[4].x),f(l,"y",h=e[4].y),f(l,"width",c=e[4].w),f(l,"height",m=e[4].h),f(g,"class","a9s-edge-handle a9s-edge-handle-top"),f(g,"x",S=e[4].x),f(g,"y",A=e[4].y),f(g,"height",1),f(g,"width",w=e[4].w),f(_,"class","a9s-edge-handle a9s-edge-handle-right"),f(_,"x",M=e[4].x+e[4].w),f(_,"y",T=e[4].y),f(_,"height",B=e[4].h),f(_,"width",1),f(b,"class","a9s-edge-handle a9s-edge-handle-bottom"),f(b,"x",y=e[4].x),f(b,"y",E=e[4].y+e[4].h),f(b,"height",1),f(b,"width",k=e[4].w),f(X,"class","a9s-edge-handle a9s-edge-handle-left"),f(X,"x",C=e[4].x),f(X,"y",U=e[4].y),f(X,"height",pe=e[4].h),f(X,"width",1),f(O,"class","a9s-corner-handle a9s-corner-handle-topleft"),f(O,"cx",G=e[4].x),f(O,"cy",F=e[4].y),f(O,"r",de=e[3]/2),f(ne,"class","a9s-corner-handle a9s-corner-handle-topright"),f(ne,"cx",He=e[4].x+e[4].w),f(ne,"cy",Oe=e[4].y),f(ne,"r",Te=e[3]/2),f(se,"class","a9s-corner-handle a9s-corner-handle-bottomright"),f(se,"cx",Pe=e[4].x+e[4].w),f(se,"cy",fe=e[4].y+e[4].h),f(se,"r",Le=e[3]/2),f(ye,"class","a9s-corner-handle a9s-corner-handle-bottomleft"),f(ye,"cx",at=e[4].x),f(ye,"cy",ft=e[4].y+e[4].h),f(ye,"r",ct=e[3]/2)},m(H,Y){I(H,t,Y),I(H,a,Y),I(H,l,Y),I(H,d,Y),I(H,g,Y),I(H,p,Y),I(H,_,Y),I(H,N,Y),I(H,b,Y),I(H,D,Y),I(H,X,Y),I(H,V,Y),I(H,O,Y),I(H,ie,Y),I(H,ne,Y),I(H,et,Y),I(H,se,Y),I(H,ke,Y),I(H,ye,Y),It||(to=[Z(t,"pointerdown",function(){K(e[10](L.SHAPE))&&e[10](L.SHAPE).apply(this,arguments)}),Z(l,"pointerdown",function(){K(e[10](L.SHAPE))&&e[10](L.SHAPE).apply(this,arguments)}),Z(g,"pointerdown",function(){K(e[10](L.TOP))&&e[10](L.TOP).apply(this,arguments)}),Z(_,"pointerdown",function(){K(e[10](L.RIGHT))&&e[10](L.RIGHT).apply(this,arguments)}),Z(b,"pointerdown",function(){K(e[10](L.BOTTOM))&&e[10](L.BOTTOM).apply(this,arguments)}),Z(X,"pointerdown",function(){K(e[10](L.LEFT))&&e[10](L.LEFT).apply(this,arguments)}),Z(O,"pointerdown",function(){K(e[10](L.TOP_LEFT))&&e[10](L.TOP_LEFT).apply(this,arguments)}),Z(ne,"pointerdown",function(){K(e[10](L.TOP_RIGHT))&&e[10](L.TOP_RIGHT).apply(this,arguments)}),Z(se,"pointerdown",function(){K(e[10](L.BOTTOM_RIGHT))&&e[10](L.BOTTOM_RIGHT).apply(this,arguments)}),Z(ye,"pointerdown",function(){K(e[10](L.BOTTOM_LEFT))&&e[10](L.BOTTOM_LEFT).apply(this,arguments)})],It=!0)},p(H,Y){e=H,Y&2&&n!==(n=e[1]?"display:none;":void 0)&&f(t,"style",n),Y&16&&o!==(o=e[4].x)&&f(t,"x",o),Y&16&&i!==(i=e[4].y)&&f(t,"y",i),Y&16&&r!==(r=e[4].w)&&f(t,"width",r),Y&16&&s!==(s=e[4].h)&&f(t,"height",s),Y&2&&f(l,"style",e[1]),Y&16&&u!==(u=e[4].x)&&f(l,"x",u),Y&16&&h!==(h=e[4].y)&&f(l,"y",h),Y&16&&c!==(c=e[4].w)&&f(l,"width",c),Y&16&&m!==(m=e[4].h)&&f(l,"height",m),Y&16&&S!==(S=e[4].x)&&f(g,"x",S),Y&16&&A!==(A=e[4].y)&&f(g,"y",A),Y&16&&w!==(w=e[4].w)&&f(g,"width",w),Y&16&&M!==(M=e[4].x+e[4].w)&&f(_,"x",M),Y&16&&T!==(T=e[4].y)&&f(_,"y",T),Y&16&&B!==(B=e[4].h)&&f(_,"height",B),Y&16&&y!==(y=e[4].x)&&f(b,"x",y),Y&16&&E!==(E=e[4].y+e[4].h)&&f(b,"y",E),Y&16&&k!==(k=e[4].w)&&f(b,"width",k),Y&16&&C!==(C=e[4].x)&&f(X,"x",C),Y&16&&U!==(U=e[4].y)&&f(X,"y",U),Y&16&&pe!==(pe=e[4].h)&&f(X,"height",pe),Y&16&&G!==(G=e[4].x)&&f(O,"cx",G),Y&16&&F!==(F=e[4].y)&&f(O,"cy",F),Y&8&&de!==(de=e[3]/2)&&f(O,"r",de),Y&16&&He!==(He=e[4].x+e[4].w)&&f(ne,"cx",He),Y&16&&Oe!==(Oe=e[4].y)&&f(ne,"cy",Oe),Y&8&&Te!==(Te=e[3]/2)&&f(ne,"r",Te),Y&16&&Pe!==(Pe=e[4].x+e[4].w)&&f(se,"cx",Pe),Y&16&&fe!==(fe=e[4].y+e[4].h)&&f(se,"cy",fe),Y&8&&Le!==(Le=e[3]/2)&&f(se,"r",Le),Y&16&&at!==(at=e[4].x)&&f(ye,"cx",at),Y&16&&ft!==(ft=e[4].y+e[4].h)&&f(ye,"cy",ft),Y&8&&ct!==(ct=e[3]/2)&&f(ye,"r",ct)},d(H){H&&v(t),H&&v(a),H&&v(l),H&&v(d),H&&v(g),H&&v(p),H&&v(_),H&&v(N),H&&v(b),H&&v(D),H&&v(X),H&&v(V),H&&v(O),H&&v(ie),H&&v(ne),H&&v(et),H&&v(se),H&&v(ke),H&&v(ye),It=!1,he(to)}}}function Ai(e){let t,n;return t=new Ce({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[Si,({grab:o})=>({10:o}),({grab:o})=>o?1024:0]},$$scope:{ctx:e}}}),t.$on("grab",e[7]),t.$on("change",e[8]),t.$on("release",e[9]),{c(){ce(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&4&&(r.transform=o[2]),i&3098&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function Mi(e,t,n){let o,i,{shape:r}=t,{computedStyle:s=void 0}=t,{transform:a}=t,{viewportScale:l=1}=t;const u=(d,g,S)=>{const A=d.geometry.bounds;let[w,p]=[A.minX,A.minY],[_,M]=[A.maxX,A.maxY];const[T,B]=S;if(g===L.SHAPE)w+=T,_+=T,p+=B,M+=B;else{switch(g){case L.TOP:case L.TOP_LEFT:case L.TOP_RIGHT:{p+=B;break}case L.BOTTOM:case L.BOTTOM_LEFT:case L.BOTTOM_RIGHT:{M+=B;break}}switch(g){case L.LEFT:case L.TOP_LEFT:case L.BOTTOM_LEFT:{w+=T;break}case L.RIGHT:case L.TOP_RIGHT:case L.BOTTOM_RIGHT:{_+=T;break}}}const N=Math.min(w,_),b=Math.min(p,M),y=Math.abs(_-w),E=Math.abs(M-p);return{...d,geometry:{x:N,y:b,w:y,h:E,bounds:{minX:N,minY:b,maxX:N+y,maxY:b+E}}}};function h(d){oe.call(this,e,d)}function c(d){oe.call(this,e,d)}function m(d){oe.call(this,e,d)}return e.$$set=d=>{"shape"in d&&n(0,r=d.shape),"computedStyle"in d&&n(1,s=d.computedStyle),"transform"in d&&n(2,a=d.transform),"viewportScale"in d&&n(6,l=d.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=r.geometry),e.$$.dirty&64&&n(3,i=10/l)},[r,s,a,i,o,u,l,h,c,m]}class pn extends ee{constructor(t){super(),$(this,t,Mi,Ai,J,{shape:0,computedStyle:1,transform:2,viewportScale:6})}}function Ti(e){let t,n,o,i,r,s,a,l,u,h,c,m,d,g,S,A,w,p,_,M,T,B,N,b,y,E,k,D,X;return{c(){t=P("ellipse"),s=x(),a=P("ellipse"),m=x(),d=P("rect"),A=x(),w=P("rect"),M=x(),T=P("rect"),b=x(),y=P("rect"),f(t,"class","a9s-outer"),f(t,"cx",n=e[3].cx),f(t,"cy",o=e[3].cy),f(t,"rx",i=e[3].rx),f(t,"ry",r=e[3].ry),f(a,"class","a9s-inner a9s-shape-handle"),f(a,"cx",l=e[3].cx),f(a,"cy",u=e[3].cy),f(a,"rx",h=e[3].rx),f(a,"ry",c=e[3].ry),f(d,"class","a9s-corner-handle a9s-corner-top"),f(d,"x",g=e[3].cx-e[2]/2),f(d,"y",S=e[3].cy-e[2]/2-e[3].ry),f(d,"height",e[2]),f(d,"width",e[2]),f(w,"class","a9s-corner-handle a9s-corner-handle-right"),f(w,"x",p=e[3].cx+e[3].rx-e[2]/2),f(w,"y",_=e[3].cy-e[2]/2),f(w,"height",e[2]),f(w,"width",e[2]),f(T,"class","a9s-corner-handle a9s-corner-handle-bottom"),f(T,"x",B=e[3].cx-e[2]/2),f(T,"y",N=e[3].cy+e[3].ry-e[2]/2),f(T,"height",e[2]),f(T,"width",e[2]),f(y,"class","a9s-corner-handle a9s-corner-handle-left"),f(y,"x",E=e[3].cx-e[3].rx-e[2]/2),f(y,"y",k=e[3].cy-e[2]/2),f(y,"height",e[2]),f(y,"width",e[2])},m(C,U){I(C,t,U),I(C,s,U),I(C,a,U),I(C,m,U),I(C,d,U),I(C,A,U),I(C,w,U),I(C,M,U),I(C,T,U),I(C,b,U),I(C,y,U),D||(X=[Z(t,"pointerdown",function(){K(e[9](L.SHAPE))&&e[9](L.SHAPE).apply(this,arguments)}),Z(a,"pointerdown",function(){K(e[9](L.SHAPE))&&e[9](L.SHAPE).apply(this,arguments)}),Z(d,"pointerdown",function(){K(e[9](L.TOP))&&e[9](L.TOP).apply(this,arguments)}),Z(w,"pointerdown",function(){K(e[9](L.RIGHT))&&e[9](L.RIGHT).apply(this,arguments)}),Z(T,"pointerdown",function(){K(e[9](L.BOTTOM))&&e[9](L.BOTTOM).apply(this,arguments)}),Z(y,"pointerdown",function(){K(e[9](L.LEFT))&&e[9](L.LEFT).apply(this,arguments)})],D=!0)},p(C,U){e=C,U&8&&n!==(n=e[3].cx)&&f(t,"cx",n),U&8&&o!==(o=e[3].cy)&&f(t,"cy",o),U&8&&i!==(i=e[3].rx)&&f(t,"rx",i),U&8&&r!==(r=e[3].ry)&&f(t,"ry",r),U&8&&l!==(l=e[3].cx)&&f(a,"cx",l),U&8&&u!==(u=e[3].cy)&&f(a,"cy",u),U&8&&h!==(h=e[3].rx)&&f(a,"rx",h),U&8&&c!==(c=e[3].ry)&&f(a,"ry",c),U&12&&g!==(g=e[3].cx-e[2]/2)&&f(d,"x",g),U&12&&S!==(S=e[3].cy-e[2]/2-e[3].ry)&&f(d,"y",S),U&4&&f(d,"height",e[2]),U&4&&f(d,"width",e[2]),U&12&&p!==(p=e[3].cx+e[3].rx-e[2]/2)&&f(w,"x",p),U&12&&_!==(_=e[3].cy-e[2]/2)&&f(w,"y",_),U&4&&f(w,"height",e[2]),U&4&&f(w,"width",e[2]),U&12&&B!==(B=e[3].cx-e[2]/2)&&f(T,"x",B),U&12&&N!==(N=e[3].cy+e[3].ry-e[2]/2)&&f(T,"y",N),U&4&&f(T,"height",e[2]),U&4&&f(T,"width",e[2]),U&12&&E!==(E=e[3].cx-e[3].rx-e[2]/2)&&f(y,"x",E),U&12&&k!==(k=e[3].cy-e[2]/2)&&f(y,"y",k),U&4&&f(y,"height",e[2]),U&4&&f(y,"width",e[2])},d(C){C&&v(t),C&&v(s),C&&v(a),C&&v(m),C&&v(d),C&&v(A),C&&v(w),C&&v(M),C&&v(T),C&&v(b),C&&v(y),D=!1,he(X)}}}function Li(e){let t,n;return t=new Ce({props:{shape:e[0],transform:e[1],editor:e[4],$$slots:{default:[Ti,({grab:o})=>({9:o}),({grab:o})=>o?512:0]},$$scope:{ctx:e}}}),t.$on("grab",e[6]),t.$on("change",e[7]),t.$on("release",e[8]),{c(){ce(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&2&&(r.transform=o[1]),i&1548&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function ki(e,t,n){let o,i,{shape:r}=t,{transform:s}=t,{viewportScale:a=1}=t;const l=(m,d,g)=>{const S=m.geometry.bounds;let[A,w]=[S.minX,S.minY],[p,_]=[S.maxX,S.maxY];const[M,T]=g;if(d===L.SHAPE)A+=M,p+=M,w+=T,_+=T;else switch(d){case L.TOP:{w+=T;break}case L.BOTTOM:{_+=T;break}case L.LEFT:{A+=M;break}case L.RIGHT:{p+=M;break}}const B=Math.min(A,p),N=Math.min(w,_),b=Math.abs(p-A),y=Math.abs(_-w),E=(A+p)/2,k=(w+_)/2,D=b/2,X=y/2;return{...m,geometry:{...m.geometry,cx:E,cy:k,rx:D,ry:X,bounds:{minX:B,minY:N,maxX:B+b,maxY:N+y}}}};function u(m){oe.call(this,e,m)}function h(m){oe.call(this,e,m)}function c(m){oe.call(this,e,m)}return e.$$set=m=>{"shape"in m&&n(0,r=m.shape),"transform"in m&&n(1,s=m.transform),"viewportScale"in m&&n(5,a=m.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(3,o=r.geometry),e.$$.dirty&32&&n(2,i=10/a)},[r,s,i,o,l,a,u,h,c]}class yn extends ee{constructor(t){super(),$(this,t,ki,Li,J,{shape:0,transform:1,viewportScale:5})}}const Me=(e,t,n)=>{const o=typeof t=="function"?t(e):t;if(o){const{fill:i,fillOpacity:r}=o;let s="",a;return i&&(s+=`fill:${i};stroke:${i};`),n&&(a=n.fillOpacity),s+=`fill-opacity:${a||r||"0.25"};`,s}};function vi(e){let t,n,o;return{c(){t=P("path"),f(t,"class","a9s-shape-handle"),f(t,"style",e[3]),f(t,"d",e[2])},m(i,r){I(i,t,r),n||(o=Z(t,"pointerdown",function(){K(e[14](L.SHAPE))&&e[14](L.SHAPE).apply(this,arguments)}),n=!0)},p(i,r){e=i,r&8&&f(t,"style",e[3]),r&4&&f(t,"d",e[2])},d(i){i&&v(t),n=!1,o()}}}function Ii(e){let t,n;return t=new Ce({props:{shape:e[0],transform:e[1],editor:e[4],$$slots:{default:[vi,({grab:o})=>({14:o}),({grab:o})=>o?16384:0]},$$scope:{ctx:e}}}),t.$on("change",e[9]),t.$on("grab",e[10]),t.$on("release",e[11]),{c(){ce(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&2&&(r.transform=o[1]),i&49164&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function Oi(e,t,n){let o,i,r,{shape:s}=t,{annotation:a}=t,{transform:l}=t,{viewportScale:u=1}=t,{style:h=void 0}=t,c={fillOpacity:1};const m=(A,w,p)=>{let _;w===L.SHAPE&&(_=A.geometry.points.map(([T,B,N])=>[T+p[0],B+p[1],N]));const M=Ae(_.map(T=>[T[0],T[1]]));return{...A,geometry:{points:_,bounds:M}}};function d(A){oe.call(this,e,A)}function g(A){oe.call(this,e,A)}function S(A){oe.call(this,e,A)}return e.$$set=A=>{"shape"in A&&n(0,s=A.shape),"annotation"in A&&n(5,a=A.annotation),"transform"in A&&n(1,l=A.transform),"viewportScale"in A&&n(6,u=A.viewportScale),"style"in A&&n(7,h=A.style)},e.$$.update=()=>{e.$$.dirty&1&&n(8,o=s.geometry),e.$$.dirty&64,e.$$.dirty&160&&n(3,i=Me(a,h,c)),e.$$.dirty&256&&n(2,r=Je(o.points,Ze,!0))},[s,l,r,i,m,a,u,h,o,d,g,S]}class _n extends ee{constructor(t){super(),$(this,t,Oi,Ii,J,{shape:0,annotation:5,transform:1,viewportScale:6,style:7})}}function Pi(e){let t,n,o,i,r,s,a,l,u,h,c,m,d,g,S,A,w,p,_,M,T,B,N,b;return{c(){t=P("line"),a=x(),l=P("line"),d=x(),g=P("circle"),p=x(),_=P("circle"),f(t,"class","a9s-outer"),f(t,"stroke-linecap","round"),f(t,"stroke-linejoin","round"),f(t,"style",n=e[1]?"display:none;":void 0),f(t,"x1",o=e[4].x1),f(t,"y1",i=e[4].y1),f(t,"x2",r=e[4].x2),f(t,"y2",s=e[4].y2),f(t,"marker-end","url(#arrow)"),f(l,"class","a9s-inner a9s-shape-handle"),f(l,"style",e[1]),f(l,"stroke-linecap","round"),f(l,"stroke-linejoin","round"),f(l,"marker-end","url(#arrow)"),f(l,"x1",u=e[4].x1),f(l,"y1",h=e[4].y1),f(l,"x2",c=e[4].x2),f(l,"y2",m=e[4].y2),f(g,"class","a9s-corner-handle"),f(g,"cx",S=e[4].x1),f(g,"cy",A=e[4].y1),f(g,"r",w=e[3]/2),f(_,"class","a9s-corner-handle"),f(_,"cx",M=e[4].x2),f(_,"cy",T=e[4].y2),f(_,"r",B=e[3]/2)},m(y,E){I(y,t,E),I(y,a,E),I(y,l,E),I(y,d,E),I(y,g,E),I(y,p,E),I(y,_,E),N||(b=[Z(t,"pointerdown",function(){K(e[10](L.SHAPE))&&e[10](L.SHAPE).apply(this,arguments)}),Z(l,"pointerdown",function(){K(e[10](L.SHAPE))&&e[10](L.SHAPE).apply(this,arguments)}),Z(g,"pointerdown",function(){K(e[10](L.LEFT))&&e[10](L.LEFT).apply(this,arguments)}),Z(_,"pointerdown",function(){K(e[10](L.RIGHT))&&e[10](L.RIGHT).apply(this,arguments)})],N=!0)},p(y,E){e=y,E&2&&n!==(n=e[1]?"display:none;":void 0)&&f(t,"style",n),E&16&&o!==(o=e[4].x1)&&f(t,"x1",o),E&16&&i!==(i=e[4].y1)&&f(t,"y1",i),E&16&&r!==(r=e[4].x2)&&f(t,"x2",r),E&16&&s!==(s=e[4].y2)&&f(t,"y2",s),E&2&&f(l,"style",e[1]),E&16&&u!==(u=e[4].x1)&&f(l,"x1",u),E&16&&h!==(h=e[4].y1)&&f(l,"y1",h),E&16&&c!==(c=e[4].x2)&&f(l,"x2",c),E&16&&m!==(m=e[4].y2)&&f(l,"y2",m),E&16&&S!==(S=e[4].x1)&&f(g,"cx",S),E&16&&A!==(A=e[4].y1)&&f(g,"cy",A),E&8&&w!==(w=e[3]/2)&&f(g,"r",w),E&16&&M!==(M=e[4].x2)&&f(_,"cx",M),E&16&&T!==(T=e[4].y2)&&f(_,"cy",T),E&8&&B!==(B=e[3]/2)&&f(_,"r",B)},d(y){y&&v(t),y&&v(a),y&&v(l),y&&v(d),y&&v(g),y&&v(p),y&&v(_),N=!1,he(b)}}}function Di(e){let t,n;return t=new Ce({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[Pi,({grab:o})=>({10:o}),({grab:o})=>o?1024:0]},$$scope:{ctx:e}}}),t.$on("grab",e[7]),t.$on("change",e[8]),t.$on("release",e[9]),{c(){ce(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&4&&(r.transform=o[2]),i&3098&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function Bi(e,t,n){let o,i,{shape:r}=t,{computedStyle:s=void 0}=t,{transform:a}=t,{viewportScale:l=1}=t;const u=(d,g,S)=>{d.geometry.bounds;let A=d.geometry.x1,w=d.geometry.x2,p=d.geometry.y1,_=d.geometry.y2;const[M,T]=S;if(g===L.SHAPE)A+=M,w+=M,p+=T,_+=T;else switch(g){case L.LEFT:{A+=M,p+=T;break}case L.RIGHT:{w+=M,_+=T;break}}return{...d,geometry:{x1:A,y1:p,x2:w,y2:_,bounds:{minX:Math.min(A,w),minY:Math.min(p,_),maxX:Math.max(A,w),maxY:Math.max(p,_)}}}};function h(d){oe.call(this,e,d)}function c(d){oe.call(this,e,d)}function m(d){oe.call(this,e,d)}return e.$$set=d=>{"shape"in d&&n(0,r=d.shape),"computedStyle"in d&&n(1,s=d.computedStyle),"transform"in d&&n(2,a=d.transform),"viewportScale"in d&&n(6,l=d.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=r.geometry),e.$$.dirty&64&&n(3,i=10/l)},[r,s,a,i,o,u,l,h,c,m]}class wn extends ee{constructor(t){super(),$(this,t,Bi,Di,J,{shape:0,computedStyle:1,transform:2,viewportScale:6})}}const bn=new Map([[q.RECTANGLE,pn],[q.POLYGON,gn],[q.ELLIPSE,yn],[q.FREEHAND,_n],[q.LINE,wn]]),Et=e=>bn.get(e.type),En=(e,t)=>bn.set(e,t),L=e=>`HANDLE-${e}`;L.SHAPE="SHAPE",L.TOP="TOP",L.RIGHT="RIGHT",L.BOTTOM="BOTTOM",L.LEFT="LEFT",L.TOP_LEFT="TOP_LEFT",L.TOP_RIGHT="TOP_RIGHT",L.BOTTOM_RIGHT="BOTTOM_RIGHT",L.BOTTOM_LEFT="BOTTOM_LEFT",L.START="START",L.END="END";const Yi=e=>({}),Sn=e=>({grab:e[0]});function Ri(e){let t,n,o,i;const r=e[7].default,s=io(r,e,e[6],Sn);return{c(){t=P("g"),s&&s.c(),f(t,"class","a9s-annotation selected")},m(a,l){I(a,t,l),s&&s.m(t,null),n=!0,o||(i=[Z(t,"pointerup",e[2]),Z(t,"pointermove",e[1])],o=!0)},p(a,[l]){s&&s.p&&(!n||l&64)&&so(s,r,a,a[6],n?ro(r,a[6],l,Yi):lo(a[6]),Sn)},i(a){n||(z(s,a),n=!0)},o(a){W(s,a),n=!1},d(a){a&&v(t),s&&s.d(a),o=!1,he(i)}}}function Xi(e,t,n){let{$$slots:o={},$$scope:i}=t;const r=we();let{shape:s}=t,{editor:a}=t,{transform:l}=t,u=null,h,c=null;const m=S=>A=>{u=S,h=l.elementToImage(A.offsetX,A.offsetY),c=s,A.target.setPointerCapture(A.pointerId),r("grab")},d=S=>{if(u){const[A,w]=l.elementToImage(S.offsetX,S.offsetY),p=[A-h[0],w-h[1]];n(3,s=a(c,u,p)),r("change",s)}},g=S=>{S.target.releasePointerCapture(S.pointerId),u=null,c=s,r("release")};return e.$$set=S=>{"shape"in S&&n(3,s=S.shape),"editor"in S&&n(4,a=S.editor),"transform"in S&&n(5,l=S.transform),"$$scope"in S&&n(6,i=S.$$scope)},[m,d,g,s,a,l,i,o]}class Ce extends ee{constructor(t){super(),$(this,t,Xi,Ri,J,{shape:3,editor:4,transform:5})}}function Ni(e,t,n){let o;const i=we();let{annotation:r}=t,{editor:s}=t,{style:a=void 0}=t,{target:l}=t,{transform:u}=t,{viewportScale:h}=t,c;return Se(()=>(n(6,c=new s({target:l,props:{shape:r.target.selector,computedStyle:o,transform:u,viewportScale:h}})),c.$on("change",m=>{c.$$set({shape:m.detail}),i("change",m.detail)}),c.$on("grab",m=>i("grab",m.detail)),c.$on("release",m=>i("release",m.detail)),()=>{c.$destroy()})),e.$$set=m=>{"annotation"in m&&n(0,r=m.annotation),"editor"in m&&n(1,s=m.editor),"style"in m&&n(2,a=m.style),"target"in m&&n(3,l=m.target),"transform"in m&&n(4,u=m.transform),"viewportScale"in m&&n(5,h=m.viewportScale)},e.$$.update=()=>{e.$$.dirty&5&&(o=Me(r,a)),e.$$.dirty&65&&r&&(c==null||c.$set({shape:r.target.selector})),e.$$.dirty&80&&c&&c.$set({transform:u}),e.$$.dirty&96&&c&&c.$set({viewportScale:h})},[r,s,a,l,u,h,c]}class An extends ee{constructor(t){super(),$(this,t,Ni,null,J,{annotation:0,editor:1,style:2,target:3,transform:4,viewportScale:5})}}function Ci(e,t,n){const o=we();let{drawingMode:i}=t,{target:r}=t,{tool:s}=t,{transform:a}=t,{viewportScale:l}=t,u;return Se(()=>{const h=r.closest("svg"),c=[],m=(d,g,S)=>{h.addEventListener(d,g,S),c.push(()=>h.removeEventListener(d,g,S))};return n(5,u=new s({target:r,props:{addEventListener:m,drawingMode:i,transform:a,viewportScale:l}})),u.$on("create",d=>o("create",d.detail)),()=>{c.forEach(d=>d()),u.$destroy()}}),e.$$set=h=>{"drawingMode"in h&&n(0,i=h.drawingMode),"target"in h&&n(1,r=h.target),"tool"in h&&n(2,s=h.tool),"transform"in h&&n(3,a=h.transform),"viewportScale"in h&&n(4,l=h.viewportScale)},e.$$.update=()=>{e.$$.dirty&40&&u&&u.$set({transform:a}),e.$$.dirty&48&&u&&u.$set({viewportScale:l})},[i,r,s,a,l,u]}class Mn extends ee{constructor(t){super(),$(this,t,Ci,null,J,{drawingMode:0,target:1,tool:2,transform:3,viewportScale:4})}}function Tn(e){let t,n;return{c(){t=P("rect"),n=P("rect"),f(t,"class","a9s-outer"),f(t,"x",e[1]),f(t,"y",e[2]),f(t,"width",e[3]),f(t,"height",e[4]),f(n,"class","a9s-inner"),f(n,"x",e[1]),f(n,"y",e[2]),f(n,"width",e[3]),f(n,"height",e[4])},m(o,i){I(o,t,i),I(o,n,i)},p(o,i){i&2&&f(t,"x",o[1]),i&4&&f(t,"y",o[2]),i&8&&f(t,"width",o[3]),i&16&&f(t,"height",o[4]),i&2&&f(n,"x",o[1]),i&4&&f(n,"y",o[2]),i&8&&f(n,"width",o[3]),i&16&&f(n,"height",o[4])},d(o){o&&v(t),o&&v(n)}}}function Ui(e){let t,n=e[0]&&Tn(e);return{c(){t=P("g"),n&&n.c(),f(t,"class","a9s-annotation a9s-rubberband")},m(o,i){I(o,t,i),n&&n.m(t,null)},p(o,[i]){o[0]?n?n.p(o,i):(n=Tn(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:j,o:j,d(o){o&&v(t),n&&n.d()}}}function Fi(e,t,n){const o=we();let{addEventListener:i}=t,{drawingMode:r}=t,{transform:s}=t,a,l,u,h,c,m,d;const g=p=>{a=performance.now(),r==="drag"&&(n(0,l=s.elementToImage(p.offsetX,p.offsetY)),u=l,n(1,h=l[0]),n(2,c=l[1]),n(3,m=1),n(4,d=1))},S=p=>{l&&(u=s.elementToImage(p.offsetX,p.offsetY),n(1,h=Math.min(u[0],l[0])),n(2,c=Math.min(u[1],l[1])),n(3,m=Math.abs(u[0]-l[0])),n(4,d=Math.abs(u[1]-l[1])))},A=p=>{const _=performance.now()-a;if(r==="click"){if(_>300)return;p.stopPropagation(),l?w():(n(0,l=s.elementToImage(p.offsetX,p.offsetY)),u=l,n(1,h=l[0]),n(2,c=l[1]),n(3,m=1),n(4,d=1))}else l&&(_>300||m*d>100?(p.stopPropagation(),w()):(n(0,l=null),u=null))},w=()=>{if(m*d>15){const p={type:q.RECTANGLE,geometry:{bounds:{minX:h,minY:c,maxX:h+m,maxY:c+d},x:h,y:c,w:m,h:d}};o("create",p)}n(0,l=null),u=null};return Se(()=>{i("pointerdown",g),i("pointermove",S),i("pointerup",A,!0)}),e.$$set=p=>{"addEventListener"in p&&n(5,i=p.addEventListener),"drawingMode"in p&&n(6,r=p.drawingMode),"transform"in p&&n(7,s=p.transform)},[l,h,c,m,d,i,r,s]}class Ln extends ee{constructor(t){super(),$(this,t,Fi,Ui,J,{addEventListener:5,drawingMode:6,transform:7})}}const it=(e,t)=>{const n=Math.abs(t[0]-e[0]),o=Math.abs(t[1]-e[1]);return Math.sqrt(Math.pow(n,2)+Math.pow(o,2))},Ue=[];function Gi(e,t=j){let n;const o=new Set;function i(a){if(J(e,a)&&(e=a,n)){const l=!Ue.length;for(const u of o)u[1](),Ue.push(u,e);if(l){for(let u=0;u<Ue.length;u+=2)Ue[u][0](Ue[u+1]);Ue.length=0}}}function r(a){i(a(e))}function s(a,l=j){const u=[a,l];return o.add(u),o.size===1&&(n=t(i)||j),a(e),()=>{o.delete(u),o.size===0&&n&&(n(),n=null)}}return{set:i,update:r,subscribe:s}}const Hi=(e,t)=>{const{naturalWidth:n,naturalHeight:o}=e;if(!n&&!o){const{width:i,height:r}=e;t.setAttribute("viewBox",`0 0 ${i} ${r}`),e.addEventListener("load",s=>{const a=s.target;t.setAttribute("viewBox",`0 0 ${a.naturalWidth} ${a.naturalHeight}`)})}else t.setAttribute("viewBox",`0 0 ${n} ${o}`)},kn=(e,t)=>{Hi(e,t);const{subscribe:n,set:o}=Gi(1);let i;return window.ResizeObserver&&(i=new ResizeObserver(()=>{const s=t.getBoundingClientRect(),{width:a,height:l}=t.viewBox.baseVal,u=Math.max(s.width/a,s.height/l);o(u)}),i.observe(t.parentElement)),{destroy:()=>{i&&i.disconnect()},subscribe:n}},Vi="ontouchstart"in window||navigator.maxTouchPoints>0;function St(e){const t=e.slice(),n=(t[2]?t[0]:[...t[0],t[1]]).map(o=>o.join(",")).join(" ");return t[15]=n,t}function vn(e){let t,n,o,i,r,s=e[2]&&In(e);return{c(){t=P("polygon"),o=P("polygon"),s&&s.c(),r=_e(),f(t,"class","a9s-outer"),f(t,"points",n=e[15]),f(o,"class","a9s-inner"),f(o,"points",i=e[15])},m(a,l){I(a,t,l),I(a,o,l),s&&s.m(a,l),I(a,r,l)},p(a,l){l&7&&n!==(n=a[15])&&f(t,"points",n),l&7&&i!==(i=a[15])&&f(o,"points",i),a[2]?s?s.p(a,l):(s=In(a),s.c(),s.m(r.parentNode,r)):s&&(s.d(1),s=null)},d(a){a&&v(t),a&&v(o),s&&s.d(a),a&&v(r)}}}function In(e){let t,n,o;return{c(){t=P("rect"),f(t,"class","a9s-corner-handle"),f(t,"x",n=e[0][0][0]-e[3]/2),f(t,"y",o=e[0][0][1]-e[3]/2),f(t,"height",e[3]),f(t,"width",e[3])},m(i,r){I(i,t,r)},p(i,r){r&9&&n!==(n=i[0][0][0]-i[3]/2)&&f(t,"x",n),r&9&&o!==(o=i[0][0][1]-i[3]/2)&&f(t,"y",o),r&8&&f(t,"height",i[3]),r&8&&f(t,"width",i[3])},d(i){i&&v(t)}}}function zi(e){let t,n=e[1]&&vn(St(e));return{c(){t=P("g"),n&&n.c(),f(t,"class","a9s-annotation a9s-rubberband")},m(o,i){I(o,t,i),n&&n.m(t,null)},p(o,[i]){o[1]?n?n.p(St(o),i):(n=vn(St(o)),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:j,o:j,d(o){o&&v(t),n&&n.d()}}}const ji=20;function qi(e,t,n){let o;const i=we();let{addEventListener:r}=t,{drawingMode:s}=t,{transform:a}=t,{viewportScale:l=1}=t,u,h=[],c=null,m=!1;const d=p=>{const{timeStamp:_,offsetX:M,offsetY:T}=p;if(u={timeStamp:_,offsetX:M,offsetY:T},s==="drag"&&h.length===0){const B=a.elementToImage(p.offsetX,p.offsetY);h.push(B),n(1,c=B)}},g=p=>{if(h.length>0&&(n(1,c=a.elementToImage(p.offsetX,p.offsetY)),h.length>2)){const _=it(c,h[0])*l;n(2,m=_<ji)}},S=p=>{if(s==="click"){const _=p.timeStamp-u.timeStamp,M=it([u.offsetX,u.offsetY],[p.offsetX,p.offsetY]);if(_>300||M>15)return;if(m)w();else if(h.length===0){const T=a.elementToImage(p.offsetX,p.offsetY);h.push(T),n(1,c=T)}else h.push(c)}else{if(h.length===1&&it(h[0],c)<=4){n(0,h=[]),n(1,c=null);return}p.stopImmediatePropagation(),m?w():h.push(c)}},A=()=>{const p=[...h,c],_={type:q.POLYGON,geometry:{bounds:Ae(p),points:p}};nt(_)>4&&(n(0,h=[]),n(1,c=null),i("create",_))},w=()=>{const p={type:q.POLYGON,geometry:{bounds:Ae(h),points:[...h]}};n(0,h=[]),n(1,c=null),i("create",p)};return Se(()=>{r("pointerdown",d,!0),r("pointermove",g),r("pointerup",S,!0),r("dblclick",A,!0)}),e.$$set=p=>{"addEventListener"in p&&n(4,r=p.addEventListener),"drawingMode"in p&&n(5,s=p.drawingMode),"transform"in p&&n(6,a=p.transform),"viewportScale"in p&&n(7,l=p.viewportScale)},e.$$.update=()=>{e.$$.dirty&128&&n(3,o=10/l)},[h,c,m,o,r,s,a,l]}class Wi extends ee{constructor(t){super(),$(this,t,qi,zi,J,{addEventListener:4,drawingMode:5,transform:6,viewportScale:7})}}function On(e){let t,n,o,i,r,s,a,l,u,h;return{c(){t=P("ellipse"),s=P("ellipse"),f(t,"class","a9s-outer"),f(t,"cx",n=e[2]+e[4]/2),f(t,"cy",o=e[3]+e[5]/2),f(t,"rx",i=e[4]/2),f(t,"ry",r=e[5]/2),f(s,"class","a9s-inner"),f(s,"cx",a=e[2]+e[4]/2),f(s,"cy",l=e[3]+e[5]/2),f(s,"rx",u=e[4]/2),f(s,"ry",h=e[5]/2)},m(c,m){I(c,t,m),I(c,s,m)},p(c,m){m&20&&n!==(n=c[2]+c[4]/2)&&f(t,"cx",n),m&40&&o!==(o=c[3]+c[5]/2)&&f(t,"cy",o),m&16&&i!==(i=c[4]/2)&&f(t,"rx",i),m&32&&r!==(r=c[5]/2)&&f(t,"ry",r),m&20&&a!==(a=c[2]+c[4]/2)&&f(s,"cx",a),m&40&&l!==(l=c[3]+c[5]/2)&&f(s,"cy",l),m&16&&u!==(u=c[4]/2)&&f(s,"rx",u),m&32&&h!==(h=c[5]/2)&&f(s,"ry",h)},d(c){c&&v(t),c&&v(s)}}}function Ki(e){let t,n=e[1]&&On(e);return{c(){t=P("g"),n&&n.c(),f(t,"class","a9s-annotation a9s-rubberband")},m(o,i){I(o,t,i),n&&n.m(t,null),e[9](t)},p(o,[i]){o[1]?n?n.p(o,i):(n=On(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:j,o:j,d(o){o&&v(t),n&&n.d(),e[9](null)}}}function Zi(e,t,n){const o=we();let{addEventListener:i}=t,{drawingMode:r}=t,{transform:s}=t,a,l,u,h,c,m,d,g=!1,S=!1,A,w;const p=y=>{A=performance.now(),r==="drag"&&(n(1,l=s.elementToImage(y.offsetX,y.offsetY)),u=l,n(2,h=l[0]),n(3,c=l[1]),n(4,m=1),n(5,d=1))},_=y=>{const E=y||w;if(l)if(u=s.elementToImage(E.offsetX,E.offsetY),S){const k=2*Math.abs(u[0]-l[0]),D=2*Math.abs(u[1]-l[1]);n(4,m=g?Math.max(k,D):k),n(5,d=g?m:D),n(2,h=Math.min(u[0],l[0]-m/2)),n(3,c=Math.min(u[1],l[1]-d/2))}else{const k=Math.abs(u[0]-l[0]),D=Math.abs(u[1]-l[1]);n(4,m=g?Math.max(k,D):k),n(5,d=g?m:D),n(2,h=Math.min(u[0],l[0])),n(3,c=Math.min(u[1],l[1]))}y&&(w=y)},M=y=>{r==="click"&&y.stopImmediatePropagation();const E=performance.now()-A;if(r==="click"){if(E>300)return;y.stopPropagation(),l?T():(n(1,l=s.elementToImage(y.offsetX,y.offsetY)),u=l,n(2,h=l[0]),n(3,c=l[1]),n(4,m=1),n(5,d=1))}else l&&(E>300||m*d>100?(y.stopPropagation(),T()):(n(1,l=null),u=null,w=void 0))},T=()=>{if(m*d>15){const y={type:q.ELLIPSE,geometry:{bounds:{minX:h,minY:c,maxX:h+m,maxY:c+d},cx:h+m/2,cy:c+d/2,rx:m/2,ry:d/2}};o("create",y)}n(1,l=null),u=null,w=void 0},B=y=>{y.key==="Shift"&&(g=!0,_()),y.key==="Control"&&(S=!0,_())},N=y=>{y.key==="Shift"&&(g=!1,_()),y.key==="Control"&&(S=!1,_())};Se(()=>(document.addEventListener("keyup",N),document.addEventListener("keydown",B),i("pointerdown",p),i("pointermove",_),i("pointerup",M),()=>{document.removeEventListener("keyup",N),document.removeEventListener("keydown",B)}));function b(y){je[y?"unshift":"push"](()=>{a=y,n(0,a)})}return e.$$set=y=>{"addEventListener"in y&&n(6,i=y.addEventListener),"drawingMode"in y&&n(7,r=y.drawingMode),"transform"in y&&n(8,s=y.transform)},[a,l,h,c,m,d,i,r,s,b]}class Ji extends ee{constructor(t){super(),$(this,t,Zi,Ki,J,{addEventListener:6,drawingMode:7,transform:8})}}function Pn(e){let t;return{c(){t=P("path"),f(t,"style",e[2]),f(t,"d",e[0])},m(n,o){I(n,t,o)},p(n,o){o&4&&f(t,"style",n[2]),o&1&&f(t,"d",n[0])},d(n){n&&v(t)}}}function Qi(e){let t,n=e[1]&&Pn(e);return{c(){t=P("g"),n&&n.c(),f(t,"class","a9s-annotation a9s-rubberband")},m(o,i){I(o,t,i),n&&n.m(t,null)},p(o,[i]){o[1]?n?n.p(o,i):(n=Pn(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:j,o:j,d(o){o&&v(t),n&&n.d()}}}function xi(e,t,n){let o;const i=we();let{addEventListener:r}=t,{drawingMode:s}=t,{annotation:a}=t,{transform:l}=t,{viewportScale:u=1}=t,{style:h=void 0}=t,c={fillOpacity:1},m=[],d="",g=!1;const S=_=>{if(s==="drag"&&m.length===0){n(1,g=!0);const M=l.elementToImage(_.offsetX,_.offsetY);m.push([...M,_.pressure]),n(0,d=Je(m,Ze))}},A=_=>{if(g){const M=l.elementToImage(_.offsetX,_.offsetY);m.push([...M,_.pressure]),n(0,d=Je(m,Ze,!0))}},w=_=>{g&&p()},p=()=>{const _={type:q.FREEHAND,geometry:{bounds:Ae(m.map(M=>[M[0],M[1]])),points:m}};n(1,g=!1),m=[],i("create",_)};return Se(()=>{r("pointerdown",S,!0),r("pointermove",A),r("pointerup",w,!0)}),e.$$set=_=>{"addEventListener"in _&&n(3,r=_.addEventListener),"drawingMode"in _&&n(4,s=_.drawingMode),"annotation"in _&&n(5,a=_.annotation),"transform"in _&&n(6,l=_.transform),"viewportScale"in _&&n(7,u=_.viewportScale),"style"in _&&n(8,h=_.style)},e.$$.update=()=>{e.$$.dirty&128,e.$$.dirty&288&&n(2,o=Me(a,h,c))},[d,g,o,r,s,a,l,u,h]}class $i extends ee{constructor(t){super(),$(this,t,xi,Qi,J,{addEventListener:3,drawingMode:4,annotation:5,transform:6,viewportScale:7,style:8})}}function Dn(e){let t,n;return{c(){t=P("line"),n=P("line"),f(t,"class","a9s-outer"),f(t,"x1",e[1]),f(t,"y1",e[2]),f(t,"x2",e[3]),f(t,"y2",e[4]),f(t,"stroke-linecap","round"),f(t,"stroke-linejoin","round"),f(n,"class","a9s-inner"),f(n,"x1",e[1]),f(n,"y1",e[2]),f(n,"x2",e[3]),f(n,"y2",e[4]),f(n,"stroke-linecap","round"),f(n,"stroke-linejoin","round")},m(o,i){I(o,t,i),I(o,n,i)},p(o,i){i&2&&f(t,"x1",o[1]),i&4&&f(t,"y1",o[2]),i&8&&f(t,"x2",o[3]),i&16&&f(t,"y2",o[4]),i&2&&f(n,"x1",o[1]),i&4&&f(n,"y1",o[2]),i&8&&f(n,"x2",o[3]),i&16&&f(n,"y2",o[4])},d(o){o&&v(t),o&&v(n)}}}function er(e){let t,n=e[0]&&Dn(e);return{c(){t=P("g"),n&&n.c(),f(t,"class","a9s-annotation a9s-rubberband")},m(o,i){I(o,t,i),n&&n.m(t,null)},p(o,[i]){o[0]?n?n.p(o,i):(n=Dn(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:j,o:j,d(o){o&&v(t),n&&n.d()}}}function tr(e,t,n){const o=we();let{addEventListener:i}=t,{drawingMode:r}=t,{transform:s}=t,a,l,u,h,c,m,d;const g=p=>{a=performance.now(),r==="drag"&&(n(0,l=s.elementToImage(p.offsetX,p.offsetY)),u=l,n(1,h=l[0]),n(2,c=l[1]),n(3,m=l[0]+1),n(4,d=l[1]+1))},S=p=>{l&&(u=s.elementToImage(p.offsetX,p.offsetY),n(3,m=u[0]),n(4,d=u[1]))},A=p=>{const _=performance.now()-a;if(r==="click"){if(_>300)return;p.stopPropagation(),l?w():(n(0,l=s.elementToImage(p.offsetX,p.offsetY)),u=l,n(1,h=l[0]),n(2,c=l[1]),n(3,m=l[0]+1),n(4,d=l[1]+1))}else l&&(_>300||Math.sqrt(Math.pow(m-h,2)+Math.pow(d-c,2))>8?(p.stopPropagation(),w()):(n(0,l=null),u=null))},w=()=>{if(Math.sqrt(Math.pow(m-h,2)+Math.pow(d-c,2))>8){const p={type:q.LINE,geometry:{bounds:{minX:Math.min(h,m),minY:Math.min(c,d),maxX:Math.max(h,m),maxY:Math.max(c,d)},x1:h,y1:c,x2:m,y2:d}};o("create",p)}n(0,l=null),u=null};return Se(()=>{i("pointerdown",g),i("pointermove",S),i("pointerup",A,!0)}),e.$$set=p=>{"addEventListener"in p&&n(5,i=p.addEventListener),"drawingMode"in p&&n(6,r=p.drawingMode),"transform"in p&&n(7,s=p.transform)},[l,h,c,m,d,i,r,s]}class nr extends ee{constructor(t){super(),$(this,t,tr,er,J,{addEventListener:5,drawingMode:6,transform:7})}}const At=new Map([["rectangle",{tool:Ln}],["polygon",{tool:Wi}],["ellipse",{tool:Ji}],["freehand",{tool:$i}],["line",{tool:nr}]]),rt=()=>[...At.keys()],Mt=e=>At.get(e),Bn=(e,t,n)=>At.set(e,{tool:t,opts:n});function or(e){let t,n,o,i,r;return{c(){t=P("g"),n=P("ellipse"),i=P("ellipse"),f(n,"class","a9s-outer"),f(n,"style",o=e[1]?"display:none;":void 0),f(n,"cx",e[2]),f(n,"cy",e[3]),f(n,"rx",e[4]),f(n,"ry",e[5]),f(i,"class","a9s-inner"),f(i,"style",e[1]),f(i,"cx",e[2]),f(i,"cy",e[3]),f(i,"rx",e[4]),f(i,"ry",e[5]),f(t,"data-id",r=e[0].id)},m(s,a){I(s,t,a),re(t,n),re(t,i)},p(s,[a]){a&2&&o!==(o=s[1]?"display:none;":void 0)&&f(n,"style",o),a&2&&f(i,"style",s[1]),a&1&&r!==(r=s[0].id)&&f(t,"data-id",r)},i:j,o:j,d(s){s&&v(t)}}}function ir(e,t,n){let o,{annotation:i}=t,{geom:r}=t,{style:s=void 0}=t;const{cx:a,cy:l,rx:u,ry:h}=r;return e.$$set=c=>{"annotation"in c&&n(0,i=c.annotation),"geom"in c&&n(6,r=c.geom),"style"in c&&n(7,s=c.style)},e.$$.update=()=>{e.$$.dirty&129&&n(1,o=Me(i,s))},[i,o,a,l,u,h,r,s]}class rr extends ee{constructor(t){super(),$(this,t,ir,or,J,{annotation:0,geom:6,style:7})}}function sr(e){let t,n,o,i,r;return{c(){t=P("g"),n=P("polygon"),i=P("polygon"),f(n,"class","a9s-outer"),f(n,"style",o=e[1]?"display:none;":void 0),f(n,"points",e[2].map(lr).join(" ")),f(i,"class","a9s-inner"),f(i,"style",e[1]),f(i,"points",e[2].map(ar).join(" ")),f(t,"data-id",r=e[0].id)},m(s,a){I(s,t,a),re(t,n),re(t,i)},p(s,[a]){a&2&&o!==(o=s[1]?"display:none;":void 0)&&f(n,"style",o),a&2&&f(i,"style",s[1]),a&1&&r!==(r=s[0].id)&&f(t,"data-id",r)},i:j,o:j,d(s){s&&v(t)}}}const lr=e=>e.join(","),ar=e=>e.join(",");function fr(e,t,n){let o,{annotation:i}=t,{geom:r}=t,{style:s=void 0}=t;const{points:a}=r;return e.$$set=l=>{"annotation"in l&&n(0,i=l.annotation),"geom"in l&&n(3,r=l.geom),"style"in l&&n(4,s=l.style)},e.$$.update=()=>{e.$$.dirty&17&&n(1,o=Me(i,s))},[i,o,a,r,s]}class cr extends ee{constructor(t){super(),$(this,t,fr,sr,J,{annotation:0,geom:3,style:4})}}function ur(e){let t,n,o,i,r;return{c(){t=P("g"),n=P("rect"),i=P("rect"),f(n,"class","a9s-outer"),f(n,"style",o=e[5]?"display:none;":void 0),f(n,"x",e[4]),f(n,"y",e[3]),f(n,"width",e[2]),f(n,"height",e[1]),f(i,"class","a9s-inner"),f(i,"style",e[5]),f(i,"x",e[4]),f(i,"y",e[3]),f(i,"width",e[2]),f(i,"height",e[1]),f(t,"data-id",r=e[0].id)},m(s,a){I(s,t,a),re(t,n),re(t,i)},p(s,[a]){a&32&&o!==(o=s[5]?"display:none;":void 0)&&f(n,"style",o),a&16&&f(n,"x",s[4]),a&8&&f(n,"y",s[3]),a&4&&f(n,"width",s[2]),a&2&&f(n,"height",s[1]),a&32&&f(i,"style",s[5]),a&16&&f(i,"x",s[4]),a&8&&f(i,"y",s[3]),a&4&&f(i,"width",s[2]),a&2&&f(i,"height",s[1]),a&1&&r!==(r=s[0].id)&&f(t,"data-id",r)},i:j,o:j,d(s){s&&v(t)}}}function dr(e,t,n){let o,i,r,s,a,{annotation:l}=t,{geom:u}=t,{style:h=void 0}=t;return e.$$set=c=>{"annotation"in c&&n(0,l=c.annotation),"geom"in c&&n(6,u=c.geom),"style"in c&&n(7,h=c.style)},e.$$.update=()=>{e.$$.dirty&129&&n(5,o=Me(l,h)),e.$$.dirty&64&&n(4,{x:i,y:r,w:s,h:a}=u,i,(n(3,r),n(6,u)),(n(2,s),n(6,u)),(n(1,a),n(6,u)))},[l,a,s,r,i,o,u,h]}class hr extends ee{constructor(t){super(),$(this,t,dr,ur,J,{annotation:0,geom:6,style:7})}}function mr(e){let t,n,o;return{c(){t=P("g"),n=P("path"),f(n,"style",e[2]),f(n,"d",e[1]),f(t,"data-id",o=e[0].id)},m(i,r){I(i,t,r),re(t,n)},p(i,[r]){r&4&&f(n,"style",i[2]),r&2&&f(n,"d",i[1]),r&1&&o!==(o=i[0].id)&&f(t,"data-id",o)},i:j,o:j,d(i){i&&v(t)}}}function gr(e,t,n){let o,i,{annotation:r}=t,{geom:s}=t,{style:a=void 0}=t,l={fillOpacity:1};const{points:u}=s;return e.$$set=h=>{"annotation"in h&&n(0,r=h.annotation),"geom"in h&&n(3,s=h.geom),"style"in h&&n(4,a=h.style)},e.$$.update=()=>{e.$$.dirty&17&&n(2,o=Me(r,a,l))},n(1,i=Je(u,Ze,!0)),[r,i,o,s,a]}class pr extends ee{constructor(t){super(),$(this,t,gr,mr,J,{annotation:0,geom:3,style:4})}}function yr(e){let t,n,o,i,r,s,a,l,u;return{c(){t=P("g"),n=P("defs"),o=P("marker"),i=P("path"),r=P("line"),a=P("line"),f(i,"stroke-linecap","round"),f(i,"stroke-linejoin","round"),f(i,"d","M 0 0 L 10 5 L 0 10 z"),f(o,"id","arrow"),f(o,"viewBox","0 0 10 10"),f(o,"refX","9"),f(o,"refY","5"),f(o,"markerWidth","6"),f(o,"markerHeight","6"),f(o,"orient","auto-start-reverse"),f(r,"class","a9s-outer"),f(r,"style",s=e[5]?"display:none;":"stroke-width: 3"),f(r,"x1",e[4]),f(r,"y1",e[3]),f(r,"x2",e[2]),f(r,"y2",e[1]),f(r,"stroke-linecap","round"),f(r,"stroke-linejoin","round"),f(r,"marker-end","url(#arrow)"),f(a,"class","a9s-inner"),f(a,"style",l=e[5]||"stroke-width: 3"),f(a,"x1",e[4]),f(a,"y1",e[3]),f(a,"x2",e[2]),f(a,"y2",e[1]),f(a,"stroke-linecap","round"),f(a,"stroke-linejoin","round"),f(a,"marker-end","url(#arrow)"),f(t,"data-id",u=e[0].id)},m(h,c){I(h,t,c),re(t,n),re(n,o),re(o,i),re(t,r),re(t,a)},p(h,[c]){c&32&&s!==(s=h[5]?"display:none;":"stroke-width: 3")&&f(r,"style",s),c&16&&f(r,"x1",h[4]),c&8&&f(r,"y1",h[3]),c&4&&f(r,"x2",h[2]),c&2&&f(r,"y2",h[1]),c&32&&l!==(l=h[5]||"stroke-width: 3")&&f(a,"style",l),c&16&&f(a,"x1",h[4]),c&8&&f(a,"y1",h[3]),c&4&&f(a,"x2",h[2]),c&2&&f(a,"y2",h[1]),c&1&&u!==(u=h[0].id)&&f(t,"data-id",u)},i:j,o:j,d(h){h&&v(t)}}}function _r(e,t,n){let o,i,r,s,a,{annotation:l}=t,{geom:u}=t,{style:h=void 0}=t;return e.$$set=c=>{"annotation"in c&&n(0,l=c.annotation),"geom"in c&&n(6,u=c.geom),"style"in c&&n(7,h=c.style)},e.$$.update=()=>{e.$$.dirty&129&&n(5,o=Me(l,h)),e.$$.dirty&64&&n(4,{x1:i,y1:r,x2:s,y2:a}=u,i,(n(3,r),n(6,u)),(n(2,s),n(6,u)),(n(1,a),n(6,u)))},[l,a,s,r,i,o,u,h]}class wr extends ee{constructor(t){super(),$(this,t,_r,yr,J,{annotation:0,geom:6,style:7})}}const br={elementToImage:(e,t)=>[e,t]},Yn=e=>({elementToImage:(t,n)=>{const o=e.getBoundingClientRect(),i=e.createSVGPoint();i.x=t+o.x,i.y=n+o.y;const{x:r,y:s}=i.matrixTransform(e.getScreenCTM().inverse());return[r,s]}}),Er=250,Rn=(e,t)=>{const n=we();let o;return{onPointerDown:()=>o=performance.now(),onPointerUp:s=>{if(performance.now()-o<Er){const{x:l,y:u}=Sr(s,e),h=t.getAt(l,u);h?n("click",{originalEvent:s,annotation:h}):n("click",{originalEvent:s})}}}},Sr=(e,t)=>{const n=t.createSVGPoint(),o=t.getBoundingClientRect(),i=e.clientX-o.x,r=e.clientY-o.y,{left:s,top:a}=t.getBoundingClientRect();return n.x=i+s,n.y=r+a,n.matrixTransform(t.getScreenCTM().inverse())};function Xn(e,t,n){const o=e.slice();return o[29]=t[n],o}function Nn(e,t,n){const o=e.slice();return o[32]=t[n],o}function Tt(e){const t=e.slice(),n=t[32].target.selector;return t[35]=n,t}function Cn(e){let t=e[32].id,n,o,i=Un(e);return{c(){i.c(),n=_e()},m(r,s){i.m(r,s),I(r,n,s),o=!0},p(r,s){s[0]&8192&&J(t,t=r[32].id)?(be(),W(i,1,1,j),Ee(),i=Un(r),i.c(),z(i,1),i.m(n.parentNode,n)):i.p(r,s)},i(r){o||(z(i),o=!0)},o(r){W(i),o=!1},d(r){r&&v(n),i.d(r)}}}function Ar(e){let t,n;return t=new wr({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){ce(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function Mr(e){let t,n;return t=new pr({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){ce(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function Tr(e){let t,n;return t=new cr({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){ce(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function Lr(e){let t,n;return t=new hr({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){ce(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function kr(e){let t,n;return t=new rr({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){ce(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function Un(e){let t,n,o,i;const r=[kr,Lr,Tr,Mr,Ar],s=[];function a(l,u){return l[35].type===q.ELLIPSE?0:l[35].type===q.RECTANGLE?1:l[35].type===q.POLYGON?2:l[35].type===q.FREEHAND?3:l[35].type===q.LINE?4:-1}return~(t=a(e))&&(n=s[t]=r[t](e)),{c(){n&&n.c(),o=_e()},m(l,u){~t&&s[t].m(l,u),I(l,o,u),i=!0},p(l,u){let h=t;t=a(l),t===h?~t&&s[t].p(l,u):(n&&(be(),W(s[h],1,1,()=>{s[h]=null}),Ee()),~t?(n=s[t],n?n.p(l,u):(n=s[t]=r[t](l),n.c()),z(n,1),n.m(o.parentNode,o)):n=null)},i(l){i||(z(n),i=!0)},o(l){W(n),i=!1},d(l){~t&&s[t].d(l),l&&v(o)}}}function Fn(e){let t=!e[7](e[32]),n,o,i=t&&Cn(Tt(e));return{c(){i&&i.c(),n=_e()},m(r,s){i&&i.m(r,s),I(r,n,s),o=!0},p(r,s){s[0]&8320&&(t=!r[7](r[32])),t?i?(i.p(Tt(r),s),s[0]&8320&&z(i,1)):(i=Cn(Tt(r)),i.c(),z(i,1),i.m(n.parentNode,n)):i&&(be(),W(i,1,1,()=>{i=null}),Ee())},i(r){o||(z(i),o=!0)},o(r){W(i),o=!1},d(r){i&&i.d(r),r&&v(n)}}}function Gn(e){let t,n,o,i;const r=[Ir,vr],s=[];function a(l,u){return l[6]?0:l[12]&&l[0]?1:-1}return~(t=a(e))&&(n=s[t]=r[t](e)),{c(){n&&n.c(),o=_e()},m(l,u){~t&&s[t].m(l,u),I(l,o,u),i=!0},p(l,u){let h=t;t=a(l),t===h?~t&&s[t].p(l,u):(n&&(be(),W(s[h],1,1,()=>{s[h]=null}),Ee()),~t?(n=s[t],n?n.p(l,u):(n=s[t]=r[t](l),n.c()),z(n,1),n.m(o.parentNode,o)):n=null)},i(l){i||(z(n),i=!0)},o(l){W(n),i=!1},d(l){~t&&s[t].d(l),l&&v(o)}}}function vr(e){let t=e[2],n,o,i=Hn(e);return{c(){i.c(),n=_e()},m(r,s){i.m(r,s),I(r,n,s),o=!0},p(r,s){s[0]&4&&J(t,t=r[2])?(be(),W(i,1,1,j),Ee(),i=Hn(r),i.c(),z(i,1),i.m(n.parentNode,n)):i.p(r,s)},i(r){o||(z(i),o=!0)},o(r){W(i),o=!1},d(r){r&&v(n),i.d(r)}}}function Ir(e){let t,n,o=e[6],i=[];for(let s=0;s<o.length;s+=1)i[s]=zn(Xn(e,o,s));const r=s=>W(i[s],1,1,()=>{i[s]=null});return{c(){for(let s=0;s<i.length;s+=1)i[s].c();t=_e()},m(s,a){for(let l=0;l<i.length;l+=1)i[l]&&i[l].m(s,a);I(s,t,a),n=!0},p(s,a){if(a[0]&279634){o=s[6];let l;for(l=0;l<o.length;l+=1){const u=Xn(s,o,l);i[l]?(i[l].p(u,a),z(i[l],1)):(i[l]=zn(u),i[l].c(),z(i[l],1),i[l].m(t.parentNode,t))}for(be(),l=o.length;l<i.length;l+=1)r(l);Ee()}},i(s){if(!n){for(let a=0;a<o.length;a+=1)z(i[a]);n=!0}},o(s){i=i.filter(Boolean);for(let a=0;a<i.length;a+=1)W(i[a]);n=!1},d(s){ut(i,s),s&&v(t)}}}function Hn(e){let t,n;return t=new Mn({props:{target:e[4],tool:e[12],drawingMode:e[11],transform:e[10],viewportScale:e[14]}}),t.$on("create",e[17]),{c(){ce(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,i){const r={};i[0]&16&&(r.target=o[4]),i[0]&4096&&(r.tool=o[12]),i[0]&2048&&(r.drawingMode=o[11]),i[0]&1024&&(r.transform=o[10]),i[0]&16384&&(r.viewportScale=o[14]),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function Vn(e){let t,n;return t=new An({props:{target:e[4],editor:Et(e[29].target.selector),annotation:e[29],style:e[1],transform:e[10],viewportScale:e[14]}}),t.$on("change",function(){K(e[18](e[29]))&&e[18](e[29]).apply(this,arguments)}),{c(){ce(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,i){e=o;const r={};i[0]&16&&(r.target=e[4]),i[0]&64&&(r.editor=Et(e[29].target.selector)),i[0]&64&&(r.annotation=e[29]),i[0]&2&&(r.style=e[1]),i[0]&1024&&(r.transform=e[10]),i[0]&16384&&(r.viewportScale=e[14]),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function zn(e){let t=e[29].id,n,o,i=Vn(e);return{c(){i.c(),n=_e()},m(r,s){i.m(r,s),I(r,n,s),o=!0},p(r,s){s[0]&64&&J(t,t=r[29].id)?(be(),W(i,1,1,j),Ee(),i=Vn(r),i.c(),z(i,1),i.m(n.parentNode,n)):i.p(r,s)},i(r){o||(z(i),o=!0)},o(r){W(i),o=!1},d(r){r&&v(n),i.d(r)}}}function Or(e){let t,n,o,i,r,s,a=e[13],l=[];for(let c=0;c<a.length;c+=1)l[c]=Fn(Nn(e,a,c));const u=c=>W(l[c],1,1,()=>{l[c]=null});let h=e[4]&&Gn(e);return{c(){t=P("svg"),n=P("g");for(let c=0;c<l.length;c+=1)l[c].c();o=P("g"),h&&h.c(),f(o,"class","drawing"),f(t,"class","a9s-annotationlayer"),Xt(t,"drawing",e[12])},m(c,m){I(c,t,m),re(t,n);for(let d=0;d<l.length;d+=1)l[d]&&l[d].m(n,null);re(t,o),h&&h.m(o,null),e[25](o),e[26](t),i=!0,r||(s=[Z(t,"pointerup",function(){K(e[8])&&e[8].apply(this,arguments)}),Z(t,"pointerdown",function(){K(e[9])&&e[9].apply(this,arguments)})],r=!0)},p(c,m){if(e=c,m[0]&8322){a=e[13];let d;for(d=0;d<a.length;d+=1){const g=Nn(e,a,d);l[d]?(l[d].p(g,m),z(l[d],1)):(l[d]=Fn(g),l[d].c(),z(l[d],1),l[d].m(n,null))}for(be(),d=a.length;d<l.length;d+=1)u(d);Ee()}e[4]?h?(h.p(e,m),m[0]&16&&z(h,1)):(h=Gn(e),h.c(),z(h,1),h.m(o,null)):h&&(be(),W(h,1,1,()=>{h=null}),Ee()),(!i||m[0]&4096)&&Xt(t,"drawing",e[12])},i(c){if(!i){for(let m=0;m<a.length;m+=1)z(l[m]);z(h),i=!0}},o(c){l=l.filter(Boolean);for(let m=0;m<l.length;m+=1)W(l[m]);W(h),i=!1},d(c){c&&v(t),ut(l,c),h&&h.d(),e[25](null),e[26](null),r=!1,he(s)}}}function Pr(e,t,n){let o,i,r,s,a,l,u,h,c,m,d=j,g=()=>(d(),d=Dt(b,O=>n(14,m=O)),b);e.$$.on_destroy.push(()=>d());let{drawingEnabled:S}=t,{image:A}=t,{preferredDrawingMode:w}=t,{state:p}=t,{style:_=void 0}=t,{toolName:M=rt().length>0?rt()[0]:void 0}=t,{user:T}=t,B,N,b;Se(()=>g(n(5,b=kn(A,N))));const{selection:y,store:E}=p;Bt(e,y,O=>n(24,h=O)),Bt(e,E,O=>n(13,c=O));let k=null,D=null;const X=O=>{E.unobserve(k);const G=O.filter(({editable:F})=>F).map(({id:F})=>F);G.length>0?(n(6,D=G.map(F=>E.getAnnotation(F))),k=F=>{const{updated:de}=F.changes;n(6,D=de.map(ie=>ie.newValue))},E.observe(k,{annotations:G})):n(6,D=null)},C=O=>{const G=on(),F={id:G,bodies:[],target:{annotation:G,selector:O.detail,creator:T,created:new Date}};E.addAnnotation(F),y.setSelected(F.id)},U=O=>G=>{var ne;const{target:F}=O,de=10*60*1e3,ie=((ne=F.creator)==null?void 0:ne.id)!==T.id||!F.created||new Date().getTime()-F.created.getTime()>de;E.updateTarget({...F,selector:G.detail,created:ie?F.created:new Date,updated:ie?new Date:null,updatedBy:ie?T:null})};function pe(O){je[O?"unshift":"push"](()=>{B=O,n(4,B)})}function V(O){je[O?"unshift":"push"](()=>{N=O,n(3,N)})}return e.$$set=O=>{"drawingEnabled"in O&&n(0,S=O.drawingEnabled),"image"in O&&n(19,A=O.image),"preferredDrawingMode"in O&&n(20,w=O.preferredDrawingMode),"state"in O&&n(21,p=O.state),"style"in O&&n(1,_=O.style),"toolName"in O&&n(2,M=O.toolName),"user"in O&&n(22,T=O.user)},e.$$.update=()=>{e.$$.dirty[0]&4&&n(12,{tool:o,opts:i}=Mt(M),o,(n(23,i),n(2,M))),e.$$.dirty[0]&9437184&&n(11,r=(i==null?void 0:i.drawingMode)||w),e.$$.dirty[0]&8&&n(10,s=Yn(N)),e.$$.dirty[0]&8&&n(9,{onPointerDown:a,onPointerUp:l}=Rn(N,E),a,(n(8,l),n(3,N))),e.$$.dirty[0]&16777216&&n(7,u=O=>h.selected.find(G=>G.id===O.id&&G.editable)),e.$$.dirty[0]&16777216&&X(h.selected)},[S,_,M,N,B,b,D,u,l,a,s,r,o,c,m,y,E,C,U,A,w,p,T,i,h,pe,V]}class jn extends ee{constructor(t){super(),$(this,t,Pr,Or,J,{drawingEnabled:0,image:19,preferredDrawingMode:20,state:21,style:1,toolName:2,user:22},null,[-1,-1])}}function Dr(e,t,n,o,i){qn(e,t,n||0,o||e.length-1,i||Br)}function qn(e,t,n,o,i){for(;o>n;){if(o-n>600){var r=o-n+1,s=t-n+1,a=Math.log(r),l=.5*Math.exp(2*a/3),u=.5*Math.sqrt(a*l*(r-l)/r)*(s-r/2<0?-1:1),h=Math.max(n,Math.floor(t-s*l/r+u)),c=Math.min(o,Math.floor(t+(r-s)*l/r+u));qn(e,t,h,c,i)}var m=e[t],d=n,g=o;for(Qe(e,n,t),i(e[o],m)>0&&Qe(e,n,o);d<g;){for(Qe(e,d,g),d++,g--;i(e[d],m)<0;)d++;for(;i(e[g],m)>0;)g--}i(e[n],m)===0?Qe(e,n,g):(g++,Qe(e,g,o)),g<=t&&(n=g+1),t<=g&&(o=g-1)}}function Qe(e,t,n){var o=e[t];e[t]=e[n],e[n]=o}function Br(e,t){return e<t?-1:e>t?1:0}class Yr{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let n=this.data;const o=[];if(!lt(t,n))return o;const i=this.toBBox,r=[];for(;n;){for(let s=0;s<n.children.length;s++){const a=n.children[s],l=n.leaf?i(a):a;lt(t,l)&&(n.leaf?o.push(a):kt(t,l)?this._all(a,o):r.push(a))}n=r.pop()}return o}collides(t){let n=this.data;if(!lt(t,n))return!1;const o=[];for(;n;){for(let i=0;i<n.children.length;i++){const r=n.children[i],s=n.leaf?this.toBBox(r):r;if(lt(t,s)){if(n.leaf||kt(t,s))return!0;o.push(r)}}n=o.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let o=0;o<t.length;o++)this.insert(t[o]);return this}let n=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=n;else if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const o=this.data;this.data=n,n=o}this._insert(n,this.data.height-n.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=Ge([]),this}remove(t,n){if(!t)return this;let o=this.data;const i=this.toBBox(t),r=[],s=[];let a,l,u;for(;o||r.length;){if(o||(o=r.pop(),l=r[r.length-1],a=s.pop(),u=!0),o.leaf){const h=Rr(t,o.children,n);if(h!==-1)return o.children.splice(h,1),r.push(o),this._condense(r),this}!u&&!o.leaf&&kt(o,i)?(r.push(o),s.push(a),a=0,l=o,o=o.children[0]):l?(a++,o=l.children[a],u=!1):o=null}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,n){const o=[];for(;t;)t.leaf?n.push(...t.children):o.push(...t.children),t=o.pop();return n}_build(t,n,o,i){const r=o-n+1;let s=this._maxEntries,a;if(r<=s)return a=Ge(t.slice(n,o+1)),Fe(a,this.toBBox),a;i||(i=Math.ceil(Math.log(r)/Math.log(s)),s=Math.ceil(r/Math.pow(s,i-1))),a=Ge([]),a.leaf=!1,a.height=i;const l=Math.ceil(r/s),u=l*Math.ceil(Math.sqrt(s));Wn(t,n,o,u,this.compareMinX);for(let h=n;h<=o;h+=u){const c=Math.min(h+u-1,o);Wn(t,h,c,l,this.compareMinY);for(let m=h;m<=c;m+=l){const d=Math.min(m+l-1,c);a.children.push(this._build(t,m,d,i-1))}}return Fe(a,this.toBBox),a}_chooseSubtree(t,n,o,i){for(;i.push(n),!(n.leaf||i.length-1===o);){let r=1/0,s=1/0,a;for(let l=0;l<n.children.length;l++){const u=n.children[l],h=Lt(u),c=Cr(t,u)-h;c<s?(s=c,r=h<r?h:r,a=u):c===s&&h<r&&(r=h,a=u)}n=a||n.children[0]}return n}_insert(t,n,o){const i=o?t:this.toBBox(t),r=[],s=this._chooseSubtree(i,this.data,n,r);for(s.children.push(t),$e(s,i);n>=0&&r[n].children.length>this._maxEntries;)this._split(r,n),n--;this._adjustParentBBoxes(i,r,n)}_split(t,n){const o=t[n],i=o.children.length,r=this._minEntries;this._chooseSplitAxis(o,r,i);const s=this._chooseSplitIndex(o,r,i),a=Ge(o.children.splice(s,o.children.length-s));a.height=o.height,a.leaf=o.leaf,Fe(o,this.toBBox),Fe(a,this.toBBox),n?t[n-1].children.push(a):this._splitRoot(o,a)}_splitRoot(t,n){this.data=Ge([t,n]),this.data.height=t.height+1,this.data.leaf=!1,Fe(this.data,this.toBBox)}_chooseSplitIndex(t,n,o){let i,r=1/0,s=1/0;for(let a=n;a<=o-n;a++){const l=xe(t,0,a,this.toBBox),u=xe(t,a,o,this.toBBox),h=Ur(l,u),c=Lt(l)+Lt(u);h<r?(r=h,i=a,s=c<s?c:s):h===r&&c<s&&(s=c,i=a)}return i||o-n}_chooseSplitAxis(t,n,o){const i=t.leaf?this.compareMinX:Xr,r=t.leaf?this.compareMinY:Nr,s=this._allDistMargin(t,n,o,i),a=this._allDistMargin(t,n,o,r);s<a&&t.children.sort(i)}_allDistMargin(t,n,o,i){t.children.sort(i);const r=this.toBBox,s=xe(t,0,n,r),a=xe(t,o-n,o,r);let l=st(s)+st(a);for(let u=n;u<o-n;u++){const h=t.children[u];$e(s,t.leaf?r(h):h),l+=st(s)}for(let u=o-n-1;u>=n;u--){const h=t.children[u];$e(a,t.leaf?r(h):h),l+=st(a)}return l}_adjustParentBBoxes(t,n,o){for(let i=o;i>=0;i--)$e(n[i],t)}_condense(t){for(let n=t.length-1,o;n>=0;n--)t[n].children.length===0?n>0?(o=t[n-1].children,o.splice(o.indexOf(t[n]),1)):this.clear():Fe(t[n],this.toBBox)}}function Rr(e,t,n){if(!n)return t.indexOf(e);for(let o=0;o<t.length;o++)if(n(e,t[o]))return o;return-1}function Fe(e,t){xe(e,0,e.children.length,t,e)}function xe(e,t,n,o,i){i||(i=Ge(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let r=t;r<n;r++){const s=e.children[r];$e(i,e.leaf?o(s):s)}return i}function $e(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function Xr(e,t){return e.minX-t.minX}function Nr(e,t){return e.minY-t.minY}function Lt(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function st(e){return e.maxX-e.minX+(e.maxY-e.minY)}function Cr(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function Ur(e,t){const n=Math.max(e.minX,t.minX),o=Math.max(e.minY,t.minY),i=Math.min(e.maxX,t.maxX),r=Math.min(e.maxY,t.maxY);return Math.max(0,i-n)*Math.max(0,r-o)}function kt(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function lt(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function Ge(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Wn(e,t,n,o,i){const r=[t,n];for(;r.length;){if(n=r.pop(),t=r.pop(),n-t<=o)continue;const s=t+Math.ceil((n-t)/o/2)*o;Dr(e,s,t,n,i),r.push(t,s,s,n)}}const Fr=()=>{const e=new Yr,t=new Map,n=()=>[...t.values()],o=()=>{e.clear(),t.clear()},i=c=>{const{minX:m,minY:d,maxX:g,maxY:S}=c.selector.geometry.bounds,A={minX:m,minY:d,maxX:g,maxY:S,target:c};e.insert(A),t.set(c.annotation,A)},r=c=>{const m=t.get(c.annotation);e.remove(m),t.delete(c.annotation)};return{all:n,clear:o,getAt:(c,m)=>{const g=e.search({minX:c,minY:m,maxX:c,maxY:m}).map(S=>S.target).filter(S=>S.selector.type===q.RECTANGLE||Ft(S.selector,c,m));if(g.length>0)return g.sort((S,A)=>nt(S.selector)-nt(A.selector)),g[0]},getIntersecting:(c,m,d,g)=>e.search({minX:c,minY:m,maxX:c+d,maxY:m+g}).map(S=>S.target),insert:i,remove:r,set:(c,m=!0)=>{m&&o();const d=c.map(g=>{const{minX:S,minY:A,maxX:w,maxY:p}=g.selector.geometry.bounds;return{minX:S,minY:A,maxX:w,maxY:p,target:g}});d.forEach(g=>t.set(g.target.annotation,g)),e.load(d)},size:()=>e.all().length,update:(c,m)=>{r(c),i(m)}}},Kn=e=>{const t=ti(),n=Fr(),o=jo(t,e.pointerSelectAction),i=zo(t),r=si();return t.observe(({changes:l})=>{n.set(l.created.map(u=>u.target),!1),l.deleted.forEach(u=>n.remove(u.target)),l.updated.forEach(({oldValue:u,newValue:h})=>n.update(u.target,h.target))}),{store:{...t,getAt:(l,u)=>{const h=n.getAt(l,u);return h?t.getAnnotation(h.annotation):void 0},getIntersecting:(l,u,h,c)=>n.getIntersecting(l,u,h,c).map(m=>t.getAnnotation(m.annotation))},selection:o,hover:i,viewport:r}},Zn=e=>{const t=Kn(e);return{...t,store:ni(t.store)}},Jn=e=>{let t,n;if(e.nodeName==="CANVAS")t=e,n=t.getContext("2d",{willReadFrequently:!0});else{const i=e;t=document.createElement("canvas"),t.width=i.width,t.height=i.height,n=t.getContext("2d",{willReadFrequently:!0}),n.drawImage(i,0,0,i.width,i.height)}let o=0;for(let i=1;i<10;i++)for(let r=1;r<10;r++){const s=Math.round(r*t.width/10),a=Math.round(i*t.height/10),l=n.getImageData(s,a,1,1).data,u=(.299*l[0]+.587*l[1]+.114*l[2])/255;o+=u}return o/81},Qn=e=>{const t=Jn(e),n=t>.6?"dark":"light";return console.log(`[Annotorious] Image brightness: ${t.toFixed(1)}. Setting ${n} theme.`),n},vt=(e,t,n)=>t.setAttribute("data-theme",n==="auto"?Qn(e):n),xn=(e,t)=>({...e,drawingEnabled:e.drawingEnabled===void 0?t.drawingEnabled:e.drawingEnabled,drawingMode:e.drawingMode||t.drawingMode,pointerSelectAction:e.pointerSelectAction||t.pointerSelectAction,theme:e.theme||t.theme}),$n=navigator.userAgent.indexOf("Mac OS X")!==-1,eo=(e,t)=>{const n=t||document,o=s=>{s.key==="Z"&&s.ctrlKey?e.undo():s.key==="Y"&&s.ctrlKey&&e.redo()},i=s=>{s.key==="z"&&s.metaKey&&(s.shiftKey?e.redo():e.undo())},r=()=>{$n?n.removeEventListener("keydown",i):n.removeEventListener("keydown",o)};return $n?n.addEventListener("keydown",i):n.addEventListener("keydown",o),{destroy:r}},Vr="",zr="",jr="",Gr=(e,t={})=>{if(!e)throw"Missing argument: image";const n=typeof e=="string"?document.getElementById(e):e,o=xn(t,{drawingEnabled:!0,drawingMode:"drag",pointerSelectAction:sn.EDIT,theme:"light"}),i=Zn(o),{selection:r,store:s}=i,a=ri(s),l=li(i,a,o.adapter,o.autoSave),u=document.createElement("DIV");u.style.position="relative",u.style.display="inline-block",n.style.display="block",n.parentNode.insertBefore(u,n),u.appendChild(n);const h=eo(a);let c=mi();vt(n,u,o.theme);const m=new jn({target:u,props:{drawingEnabled:o.drawingEnabled,image:n,preferredDrawingMode:o.drawingMode,state:i,style:o.style,user:c}});m.$on("click",b=>{const{originalEvent:y,annotation:E}=b.detail;E?r.clickSelect(E.id,y):r.isEmpty()||r.clear()});const d=fi(i,a,o.adapter),g=()=>{m.$destroy(),u.parentNode.insertBefore(n,u),u.parentNode.removeChild(u),h.destroy(),a.destroy()},S=()=>c,A=(b,y,E)=>Bn(b,y,E),w=(b,y)=>En(b,y),p=b=>{if(!Mt(b))throw`No drawing tool named ${b}`;m.$set({toolName:b})},_=b=>m.$set({drawingEnabled:b}),M=b=>{console.warn("Filter not implemented yet")},T=b=>m.$set({style:b}),B=b=>vt(n,u,b),N=b=>{c=b,m.$set({user:b})};return{...d,destroy:g,getUser:S,listDrawingTools:rt,on:l.on,off:l.off,registerDrawingTool:A,registerShapeEditor:w,setDrawingEnabled:_,setDrawingTool:p,setFilter:M,setStyle:T,setTheme:B,setUser:N,state:i}};R.Editor=Ce,R.EditorMount=An,R.EllipseEditor=yn,R.FreehandEditor=_n,R.Handle=L,R.IdentityTransform=br,R.LineEditor=wn,R.LineUtil=Ht,R.PolygonEditor=gn,R.RectangleEditor=pn,R.RectangleUtil=Gt,R.RubberbandRectangle=Ln,R.SVGAnnotationLayer=jn,R.ShapeType=q,R.ToolMount=Mn,R.W3CImageFormat=_i,R.addEventListeners=Rn,R.boundsFromPoints=Ae,R.computeArea=nt,R.createImageAnnotator=Gr,R.createImageAnnotatorState=Kn,R.createSVGTransform=Yn,R.createSvelteImageAnnotatorState=Zn,R.detectTheme=Qn,R.distance=it,R.enableResponsive=kn,R.fillDefaults=xn,R.getEditor=Et,R.getTool=Mt,R.initKeyboardCommands=eo,R.intersects=Ft,R.isTouch=Vi,R.listDrawingTools=rt,R.parseFragmentSelector=Vt,R.parseSVGSelector=en,R.parseW3CImageAnnotation=fn,R.registerEditor=En,R.registerShapeUtil=Re,R.registerTool=Bn,R.sampleBrightness=Jn,R.serializeFragmentSelector=zt,R.serializeSVGSelector=tn,R.serializeW3CImageAnnotation=cn,R.setTheme=vt,Object.defineProperty(R,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=annotorious.js.map
