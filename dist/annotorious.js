(function(X,j){typeof exports=="object"&&typeof module<"u"?j(exports):typeof define=="function"&&define.amd?define(["exports"],j):(X=typeof globalThis<"u"?globalThis:X||self,j(X.Annotorious={}))})(this,function(X){"use strict";function j(){}function Kn(e,t){for(const n in t)e[n]=t[n];return e}function Mt(e){return e()}function Lt(){return Object.create(null)}function he(e){e.forEach(Mt)}function q(e){return typeof e=="function"}function $(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function qn(e){return Object.keys(e).length===0}function vt(e,...t){if(e==null)return j;const n=e.subscribe(...t);return n.unsubscribe?()=>n.unsubscribe():n}function Ot(e,t,n){e.$$.on_destroy.push(vt(t,n))}function Zn(e,t,n,o){if(e){const i=kt(e,t,n,o);return e[0](i)}}function kt(e,t,n,o){return e[1]&&o?Kn(n.ctx.slice(),e[1](o(t))):n.ctx}function Jn(e,t,n,o){if(e[2]&&o){const i=e[2](o(n));if(t.dirty===void 0)return i;if(typeof i=="object"){const r=[],s=Math.max(t.dirty.length,i.length);for(let l=0;l<s;l+=1)r[l]=t.dirty[l]|i[l];return r}return t.dirty|i}return t.dirty}function Qn(e,t,n,o,i,r){if(i){const s=kt(t,n,o,r);e.p(s,i)}}function xn(e){if(e.ctx.length>32){const t=[],n=e.ctx.length/32;for(let o=0;o<n;o++)t[o]=-1;return t}return-1}function ge(e,t){e.appendChild(t)}function I(e,t,n){e.insertBefore(t,n||null)}function k(e){e.parentNode&&e.parentNode.removeChild(e)}function lt(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function C(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function It(e){return document.createTextNode(e)}function ne(){return It(" ")}function pe(){return It("")}function J(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)}function c(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function $n(e){return Array.from(e.childNodes)}function Pt(e,t,n){e.classList[n?"add":"remove"](t)}function eo(e,t,{bubbles:n=!1,cancelable:o=!1}={}){const i=document.createEvent("CustomEvent");return i.initCustomEvent(e,n,o,t),i}let Ge;function Fe(e){Ge=e}function Bt(){if(!Ge)throw new Error("Function called outside component initialization");return Ge}function Te(e){Bt().$$.on_mount.push(e)}function Ee(){const e=Bt();return(t,n,{cancelable:o=!1}={})=>{const i=e.$$.callbacks[t];if(i){const r=eo(t,n,{cancelable:o});return i.slice().forEach(s=>{s.call(e,r)}),!r.defaultPrevented}return!0}}function re(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach(o=>o.call(this,t))}const Oe=[],He=[];let ke=[];const Dt=[],to=Promise.resolve();let at=!1;function no(){at||(at=!0,to.then(Yt))}function ct(e){ke.push(e)}const ft=new Set;let Ie=0;function Yt(){if(Ie!==0)return;const e=Ge;do{try{for(;Ie<Oe.length;){const t=Oe[Ie];Ie++,Fe(t),oo(t.$$)}}catch(t){throw Oe.length=0,Ie=0,t}for(Fe(null),Oe.length=0,Ie=0;He.length;)He.pop()();for(let t=0;t<ke.length;t+=1){const n=ke[t];ft.has(n)||(ft.add(n),n())}ke.length=0}while(Oe.length);for(;Dt.length;)Dt.pop()();at=!1,ft.clear(),Fe(e)}function oo(e){if(e.fragment!==null){e.update(),he(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(ct)}}function io(e){const t=[],n=[];ke.forEach(o=>e.indexOf(o)===-1?t.push(o):n.push(o)),n.forEach(o=>o()),ke=t}const et=new Set;let Me;function ye(){Me={r:0,c:[],p:Me}}function _e(){Me.r||he(Me.c),Me=Me.p}function z(e,t){e&&e.i&&(et.delete(e),e.i(t))}function W(e,t,n,o){if(e&&e.o){if(et.has(e))return;et.add(e),Me.c.push(()=>{et.delete(e),o&&(n&&e.d(1),o())}),e.o(t)}else o&&o()}function me(e){e&&e.c()}function le(e,t,n,o){const{fragment:i,after_update:r}=e.$$;i&&i.m(t,n),o||ct(()=>{const s=e.$$.on_mount.map(Mt).filter(q);e.$$.on_destroy?e.$$.on_destroy.push(...s):he(s),e.$$.on_mount=[]}),r.forEach(ct)}function ae(e,t){const n=e.$$;n.fragment!==null&&(io(n.after_update),he(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function ro(e,t){e.$$.dirty[0]===-1&&(Oe.push(e),no(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function oe(e,t,n,o,i,r,s,l=[-1]){const a=Ge;Fe(e);const d=e.$$={fragment:null,ctx:[],props:r,update:j,not_equal:i,bound:Lt(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(a?a.$$.context:[])),callbacks:Lt(),dirty:l,skip_bound:!1,root:t.target||a.$$.root};s&&s(d.root);let h=!1;if(d.ctx=n?n(e,t.props||{},(f,m,...u)=>{const g=u.length?u[0]:m;return d.ctx&&i(d.ctx[f],d.ctx[f]=g)&&(!d.skip_bound&&d.bound[f]&&d.bound[f](g),h&&ro(e,f)),m}):[],d.update(),h=!0,he(d.before_update),d.fragment=o?o(d.ctx):!1,t.target){if(t.hydrate){const f=$n(t.target);d.fragment&&d.fragment.l(f),f.forEach(k)}else d.fragment&&d.fragment.c();t.intro&&z(e.$$.fragment),le(e,t.target,t.anchor,t.customElement),Yt()}Fe(a)}class ie{$destroy(){ae(this,1),this.$destroy=j}$on(t,n){if(!q(n))return j;const o=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return o.push(n),()=>{const i=o.indexOf(n);i!==-1&&o.splice(i,1)}}$set(t){this.$$set&&!qn(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}var K=(e=>(e.ELLIPSE="ELLIPSE",e.POLYGON="POLYGON",e.RECTANGLE="RECTANGLE",e.FREEHAND="FREEHAND",e))(K||{});const ut={},ze=(e,t)=>ut[e]=t,tt=e=>ut[e.type].area(e),Rt=(e,t,n)=>ut[e.type].intersects(e,t,n),Ae=e=>{let t=1/0,n=1/0,o=-1/0,i=-1/0;return e.forEach(([r,s])=>{t=Math.min(t,r),n=Math.min(n,s),o=Math.max(o,r),i=Math.max(i,s)}),{minX:t,minY:n,maxX:o,maxY:i}},so={area:e=>Math.PI*e.geometry.rx*e.geometry.ry,intersects:(e,t,n)=>{const{cx:o,cy:i,rx:r,ry:s}=e.geometry,l=0,a=Math.cos(l),d=Math.sin(l),h=t-o,f=n-i,m=a*h+d*f,u=d*h-a*f;return m*m/(r*r)+u*u/(s*s)<=1}};ze(K.ELLIPSE,so);const lo={area:e=>{const{points:t}=e.geometry;let n=0,o=t.length-1;for(let i=0;i<t.length;i++)n+=(t[o][0]+t[i][0])*(t[o][1]-t[i][1]),o=i;return Math.abs(.5*n)},intersects:(e,t,n)=>{const{points:o}=e.geometry;let i=!1;for(let r=0,s=o.length-1;r<o.length;s=r++){const l=o[r][0],a=o[r][1],d=o[s][0],h=o[s][1];a>n!=h>n&&t<(d-l)*(n-a)/(h-a)+l&&(i=!i)}return i}};ze(K.POLYGON,lo);const Xt={area:e=>e.geometry.w*e.geometry.h,intersects:(e,t,n)=>t>=e.geometry.x&&t<=e.geometry.x+e.geometry.w&&n>=e.geometry.y&&n<=e.geometry.y+e.geometry.h};ze(K.RECTANGLE,Xt);const ao={area:e=>{const{points:t}=e.geometry;let n=0,o=t.length-1;for(let i=0;i<t.length;i++)n+=(t[o][0]+t[i][0])*(t[o][1]-t[i][1]),o=i;return Math.abs(.5*n)},intersects:(e,t,n)=>{const{points:o}=e.geometry;let i=!1;for(let r=0,s=o.length-1;r<o.length;s=r++){const l=o[r][0],a=o[r][1],d=o[s][0],h=o[s][1];a>n!=h>n&&t<(d-l)*(n-a)/(h-a)+l&&(i=!i)}return i}};ze(K.FREEHAND,ao);const Ct=(e,t=!1)=>{const n=typeof e=="string"?e:e.value,o=/^(xywh)=(pixel|percent)?:?(.+?),(.+?),(.+?),(.+)*/g,i=[...n.matchAll(o)][0],[r,s,l,a,d,h,f]=i;if(s!=="xywh")throw new Error("Unsupported MediaFragment: "+n);if(l&&l!=="pixel")throw new Error(`Unsupported MediaFragment unit: ${l}`);const[m,u,g,w]=[a,d,h,f].map(parseFloat);return{type:K.RECTANGLE,geometry:{x:m,y:u,w:g,h:w,bounds:{minX:m,minY:t?u-w:u,maxX:m+g,maxY:t?u:u+w}}}},Ut=e=>{const{x:t,y:n,w:o,h:i}=e;return{type:"FragmentSelector",conformsTo:"http://www.w3.org/TR/media-frags/",value:`xywh=pixel:${t},${n},${o},${i}`}},Nt="http://www.w3.org/2000/svg",Vt=e=>{const t=o=>{Array.from(o.attributes).forEach(i=>{i.name.startsWith("on")&&o.removeAttribute(i.name)})},n=e.getElementsByTagName("script");return Array.from(n).reverse().forEach(o=>o.parentNode.removeChild(o)),Array.from(e.querySelectorAll("*")).forEach(t),e},co=e=>{const o=new XMLSerializer().serializeToString(e.documentElement).replace("<svg>",`<svg xmlns="${Nt}">`);return new DOMParser().parseFromString(o,"image/svg+xml").documentElement};function Gt(e,t,n,o=i=>i){return e*o(.5-t*(.5-n))}function fo(e){return[-e[0],-e[1]]}function ce(e,t){return[e[0]+t[0],e[1]+t[1]]}function se(e,t){return[e[0]-t[0],e[1]-t[1]]}function fe(e,t){return[e[0]*t,e[1]*t]}function uo(e,t){return[e[0]/t,e[1]/t]}function je(e){return[e[1],-e[0]]}function Ft(e,t){return e[0]*t[0]+e[1]*t[1]}function ho(e,t){return e[0]===t[0]&&e[1]===t[1]}function mo(e){return Math.hypot(e[0],e[1])}function go(e){return e[0]*e[0]+e[1]*e[1]}function Ht(e,t){return go(se(e,t))}function zt(e){return uo(e,mo(e))}function po(e,t){return Math.hypot(e[1]-t[1],e[0]-t[0])}function We(e,t,n){let o=Math.sin(n),i=Math.cos(n),r=e[0]-t[0],s=e[1]-t[1],l=r*i-s*o,a=r*o+s*i;return[l+t[0],a+t[1]]}function dt(e,t,n){return ce(e,fe(se(t,e),n))}function jt(e,t,n){return ce(e,fe(t,n))}var{min:Pe,PI:yo}=Math,Wt=.275,Ke=yo+1e-4;function _o(e,t={}){let{size:n=16,smoothing:o=.5,thinning:i=.5,simulatePressure:r=!0,easing:s=H=>H,start:l={},end:a={},last:d=!1}=t,{cap:h=!0,easing:f=H=>H*(2-H)}=l,{cap:m=!0,easing:u=H=>--H*H*H+1}=a;if(e.length===0||n<=0)return[];let g=e[e.length-1].runningLength,w=l.taper===!1?0:l.taper===!0?Math.max(n,g):l.taper,S=a.taper===!1?0:a.taper===!0?Math.max(n,g):a.taper,E=Math.pow(n*o,2),p=[],b=[],T=e.slice(0,10).reduce((H,O)=>{let G=O.pressure;if(r){let N=Pe(1,O.distance/n),de=Pe(1,1-N);G=Pe(1,H+(de-H)*(N*Wt))}return(H+G)/2},e[0].pressure),M=Gt(n,i,e[e.length-1].pressure,s),D,V=e[0].vector,y=e[0].point,_=y,A=y,L=_,P=!1;for(let H=0;H<e.length;H++){let{pressure:O}=e[H],{point:G,vector:N,distance:de,runningLength:Z}=e[H];if(H<e.length-1&&g-Z<3)continue;if(i){if(r){let x=Pe(1,de/n),Se=Pe(1,1-x);O=Pe(1,T+(Se-T)*(x*Wt))}M=Gt(n,i,O,s)}else M=n/2;D===void 0&&(D=M);let we=Z<w?f(Z/w):1,Ce=g-Z<S?u((g-Z)/S):1;M=Math.max(.01,M*Math.min(we,Ce));let Ue=(H<e.length-1?e[H+1]:e[H]).vector,te=H<e.length-1?Ft(N,Ue):1,Ne=Ft(N,V)<0&&!P,ve=te!==null&&te<0;if(Ne||ve){let x=fe(je(V),M);for(let Se=1/13,be=0;be<=1;be+=Se)A=We(se(G,x),G,Ke*be),p.push(A),L=We(ce(G,x),G,Ke*-be),b.push(L);y=A,_=L,ve&&(P=!0);continue}if(P=!1,H===e.length-1){let x=fe(je(N),M);p.push(se(G,x)),b.push(ce(G,x));continue}let Ve=fe(je(dt(Ue,N,te)),M);A=se(G,Ve),(H<=1||Ht(y,A)>E)&&(p.push(A),y=A),L=ce(G,Ve),(H<=1||Ht(_,L)>E)&&(b.push(L),_=L),T=O,V=N}let Y=e[0].point.slice(0,2),R=e.length>1?e[e.length-1].point.slice(0,2):ce(e[0].point,[1,1]),U=[],ue=[];if(e.length===1){if(!(w||S)||d){let H=jt(Y,zt(je(se(Y,R))),-(D||M)),O=[];for(let G=1/13,N=G;N<=1;N+=G)O.push(We(H,Y,Ke*2*N));return O}}else{if(!(w||S&&e.length===1))if(h)for(let O=1/13,G=O;G<=1;G+=O){let N=We(b[0],Y,Ke*G);U.push(N)}else{let O=se(p[0],b[0]),G=fe(O,.5),N=fe(O,.51);U.push(se(Y,G),se(Y,N),ce(Y,N),ce(Y,G))}let H=je(fo(e[e.length-1].vector));if(S||w&&e.length===1)ue.push(R);else if(m){let O=jt(R,H,M);for(let G=1/29,N=G;N<1;N+=G)ue.push(We(O,R,Ke*3*N))}else ue.push(ce(R,fe(H,M)),ce(R,fe(H,M*.99)),se(R,fe(H,M*.99)),se(R,fe(H,M)))}return p.concat(ue,b.reverse(),U)}function wo(e,t={}){var n;let{streamline:o=.5,size:i=16,last:r=!1}=t;if(e.length===0)return[];let s=.15+(1-o)*.85,l=Array.isArray(e[0])?e:e.map(({x:u,y:g,pressure:w=.5})=>[u,g,w]);if(l.length===2){let u=l[1];l=l.slice(0,-1);for(let g=1;g<5;g++)l.push(dt(l[0],u,g/4))}l.length===1&&(l=[...l,[...ce(l[0],[1,1]),...l[0].slice(2)]]);let a=[{point:[l[0][0],l[0][1]],pressure:l[0][2]>=0?l[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],d=!1,h=0,f=a[0],m=l.length-1;for(let u=1;u<l.length;u++){let g=r&&u===m?l[u].slice(0,2):dt(f.point,l[u],s);if(ho(f.point,g))continue;let w=po(g,f.point);if(h+=w,u<m&&!d){if(h<i)continue;d=!0}f={point:g,pressure:l[u][2]>=0?l[u][2]:.5,vector:zt(se(f.point,g)),distance:w,runningLength:h},a.push(f)}return a[0].vector=((n=a[1])==null?void 0:n.vector)||[0,0],a}function bo(e,t={}){return _o(wo(e,t),t)}const qe={size:6,thinning:.5,smoothing:.5,streamline:.5,easing:e=>e,start:{taper:0,easing:e=>e,cap:!0},end:{taper:0,easing:e=>e,cap:!0}};function Eo(e){if(!e.length)return"";const t=e.reduce((n,[o,i],r,s)=>{const[l,a]=s[(r+1)%s.length];return n.push(o,i,(o+l)/2,(i+a)/2),n},["M",...e[0],"Q"]);return t.push("Z"),t.join(" ")}function Ze(e,t){const n=bo(e,t);return Eo(n)}const Ao=e=>{const n=new DOMParser().parseFromString(e,"image/svg+xml"),o=n.lookupPrefix(Nt),i=n.lookupNamespaceURI(null);return o||i?Vt(n).firstChild:Vt(co(n)).firstChild},So=e=>{const[t,n,o]=e.match(/(<path d=["|'])([^("|')]*)/)||[];if(!o)return;const i=/([MQZT])([^MQZT]*)/g,s=Array.from(o.matchAll(i)).map(l=>(l[1],l[2].trim().split(/\s+/).map(parseFloat)));return{type:K.FREEHAND,geometry:{points:s,bounds:Ae(s)}}},To=e=>{const[t,n,o]=e.match(/(<polygon points=["|'])([^("|')]*)/)||[];if(!o)return;const i=o.split(" ").map(r=>r.split(",").map(parseFloat));return{type:K.POLYGON,geometry:{points:i,bounds:Ae(i)}}},Mo=e=>{const t=Ao(e),n=parseFloat(t.getAttribute("cx")),o=parseFloat(t.getAttribute("cy")),i=parseFloat(t.getAttribute("rx")),r=parseFloat(t.getAttribute("ry")),s={minX:n-i,minY:o-r,maxX:n+i,maxY:o+r};return{type:K.ELLIPSE,geometry:{cx:n,cy:o,rx:i,ry:r,bounds:s}}},Kt=e=>{const t=typeof e=="string"?e:e.value;if(t.includes("<polygon points="))return To(t);if(t.includes("<path d="))return So(t);if(t.includes("<ellipse "))return Mo(t)},qt=e=>{let t;if(e.type===K.POLYGON){const n=e.geometry,{points:o}=n;t=`<svg><polygon points="${o.map(i=>i.join(",")).join(" ")}" /></svg>`}else if(e.type===K.FREEHAND){const n=e.geometry;t=`<svg><path d="${Ze(n.points,qe)}"/></svg>`}else if(e.type===K.ELLIPSE){const n=e.geometry;t=`<svg><ellipse cx="${n.cx}" cy="${n.cy}" rx="${n.rx}" ry="${n.ry}" /></svg>`}if(t)return{type:"SvgSelector",value:t};throw`Unsupported shape type: ${e.type}`};let nt;const Lo=new Uint8Array(16);function vo(){if(!nt&&(nt=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!nt))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return nt(Lo)}const ee=[];for(let e=0;e<256;++e)ee.push((e+256).toString(16).slice(1));function Oo(e,t=0){return ee[e[t+0]]+ee[e[t+1]]+ee[e[t+2]]+ee[e[t+3]]+"-"+ee[e[t+4]]+ee[e[t+5]]+"-"+ee[e[t+6]]+ee[e[t+7]]+"-"+ee[e[t+8]]+ee[e[t+9]]+"-"+ee[e[t+10]]+ee[e[t+11]]+ee[e[t+12]]+ee[e[t+13]]+ee[e[t+14]]+ee[e[t+15]]}const Zt={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Jt(e,t,n){if(Zt.randomUUID&&!t&&!e)return Zt.randomUUID();e=e||{};const o=e.random||(e.rng||vo)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,t){n=n||0;for(let i=0;i<16;++i)t[n+i]=o[i];return t}return Oo(o)}var Qt=Object.prototype.hasOwnProperty;function Le(e,t){var n,o;if(e===t)return!0;if(e&&t&&(n=e.constructor)===t.constructor){if(n===Date)return e.getTime()===t.getTime();if(n===RegExp)return e.toString()===t.toString();if(n===Array){if((o=e.length)===t.length)for(;o--&&Le(e[o],t[o]););return o===-1}if(!n||typeof e=="object"){o=0;for(n in e)if(Qt.call(e,n)&&++o&&!Qt.call(t,n)||!(n in t)||!Le(e[n],t[n]))return!1;return Object.keys(t).length===o}}return e!==e&&t!==t}function ht(){}function ko(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}const Be=[];function mt(e,t=ht){let n;const o=new Set;function i(l){if(ko(e,l)&&(e=l,n)){const a=!Be.length;for(const d of o)d[1](),Be.push(d,e);if(a){for(let d=0;d<Be.length;d+=2)Be[d][0](Be[d+1]);Be.length=0}}}function r(l){i(l(e))}function s(l,a=ht){const d=[l,a];return o.add(d),o.size===1&&(n=t(i)||ht),l(e),()=>{o.delete(d),o.size===0&&n&&(n(),n=null)}}return{set:i,update:r,subscribe:s}}const Io=e=>{const{subscribe:t,set:n}=mt(null);let o=null;return t(i=>o=i),e.observe(({changes:i})=>{if(o){i.deleted.some(s=>s.id===o)&&n(null);const r=i.updated.find(({oldValue:s})=>s.id===o);r&&n(r.newValue.id)}}),{get current(){return o},subscribe:t,set:n}};var xt=(e=>(e.EDIT="EDIT",e.SELECT="SELECT",e.NONE="NONE",e))(xt||{});const gt={selected:[]},Po=(e,t="EDIT")=>{const{subscribe:n,set:o}=mt(gt);let i=gt;n(f=>i=f);const r=()=>o(gt),s=()=>{var f;return((f=i.selected)==null?void 0:f.length)===0},l=f=>{if(i.selected.length===0)return!1;const m=typeof f=="string"?f:f.id;return i.selected.some(u=>u.id===m)},a=(f,m)=>{const u=e.getAnnotation(f);if(u){const g=Bo(u,t);o(g==="EDIT"?{selected:[{id:f,editable:!0}],pointerEvent:m}:g==="SELECT"?{selected:[{id:f}],pointerEvent:m}:{selected:[],pointerEvent:m})}else console.warn("Invalid selection: "+f)},d=(f,m=!0)=>{const u=Array.isArray(f)?f:[f],g=u.map(w=>e.getAnnotation(w)).filter(w=>w);o({selected:g.map(({id:w})=>({id:w,editable:m}))}),g.length!==u.length&&console.warn("Invalid selection",f)},h=f=>{if(i.selected.length===0)return!1;const{selected:m}=i;m.filter(({id:u})=>f.includes(u)).length>0&&o({selected:m.filter(({id:u})=>!f.includes(u))})};return e.observe(({changes:f})=>h(f.deleted.map(m=>m.id))),{clear:r,clickSelect:a,get selected(){return i?[...i.selected]:null},get pointerEvent(){return i?i.pointerEvent:null},isEmpty:s,isSelected:l,setSelected:d,subscribe:n}},Bo=(e,t)=>typeof t=="function"?t(e)||"EDIT":t||"EDIT",Do=[];for(let e=0;e<256;++e)Do.push((e+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Yo=(e,t)=>{const n=new Set(e.bodies.map(o=>o.id));return t.bodies.filter(o=>!n.has(o.id))},Ro=(e,t)=>{const n=new Set(t.bodies.map(o=>o.id));return e.bodies.filter(o=>!n.has(o.id))},Xo=(e,t)=>t.bodies.map(n=>{const o=e.bodies.find(i=>i.id===n.id);return{newBody:n,oldBody:o&&!Le(o,n)?o:void 0}}).filter(({oldBody:n})=>n),Co=(e,t)=>!Le(e.target,t.target),$t=(e,t)=>{const n=Yo(e,t),o=Ro(e,t),i=Xo(e,t);return{oldValue:e,newValue:t,bodiesCreated:n.length>0?n:void 0,bodiesDeleted:o.length>0?o:void 0,bodiesUpdated:i.length>0?i:void 0,targetUpdated:Co(e,t)?{oldTarget:e.target,newTarget:t.target}:void 0}};var Q=(e=>(e.LOCAL="LOCAL",e.REMOTE="REMOTE",e))(Q||{});const Uo=(e,t)=>{var n,o;const{changes:i,origin:r}=t;if(!(!e.options.origin||e.options.origin===r))return!1;if(e.options.ignore){const{ignore:s}=e.options,l=a=>(a==null?void 0:a.length)>0;if(!(l(i.created)||l(i.deleted))){const a=(n=i.updated)==null?void 0:n.some(h=>l(h.bodiesCreated)||l(h.bodiesDeleted)||l(h.bodiesUpdated)),d=(o=i.updated)==null?void 0:o.some(h=>h.targetUpdated);if(s==="BODY_ONLY"&&a&&!d||s==="TARGET_ONLY"&&d&&!a)return!1}}if(e.options.annotations){const s=new Set([...i.created.map(l=>l.id),...i.deleted.map(l=>l.id),...i.updated.map(({oldValue:l})=>l.id)]);return!!(Array.isArray(e.options.annotations)?e.options.annotations:[e.options.annotations]).find(l=>s.has(l))}else return!0},No=(e,t)=>{const n=new Set((e.created||[]).map(f=>f.id)),o=new Set((e.updated||[]).map(({newValue:f})=>f.id)),i=new Set((t.created||[]).map(f=>f.id)),r=new Set((t.deleted||[]).map(f=>f.id)),s=new Set((t.updated||[]).map(({oldValue:f})=>f.id)),l=new Set((t.updated||[]).filter(({oldValue:f})=>n.has(f.id)||o.has(f.id)).map(({oldValue:f})=>f.id)),a=[...(e.created||[]).filter(f=>!r.has(f.id)).map(f=>s.has(f.id)?t.updated.find(({oldValue:m})=>m.id===f.id).newValue:f),...t.created||[]],d=[...(e.deleted||[]).filter(f=>!i.has(f.id)),...(t.deleted||[]).filter(f=>!n.has(f.id))],h=[...(e.updated||[]).filter(({newValue:f})=>!r.has(f.id)).map(f=>{const{oldValue:m,newValue:u}=f;if(s.has(u.id)){const g=t.updated.find(w=>w.oldValue.id===u.id).newValue;return $t(m,g)}else return f}),...(t.updated||[]).filter(({oldValue:f})=>!l.has(f.id))];return{created:a,deleted:d,updated:h}},Vo=e=>e.id!==void 0,Go=()=>{const e=new Map,t=new Map,n=[],o=(y,_={})=>n.push({onChange:y,options:_}),i=y=>{const _=n.findIndex(A=>A.onChange==y);_>-1&&n.splice(_,1)},r=(y,_)=>{const A={origin:y,changes:{created:_.created||[],updated:_.updated||[],deleted:_.deleted||[]},state:[...e.values()]};n.forEach(L=>{Uo(L,A)&&L.onChange(A)})},s=(y,_=Q.LOCAL)=>{if(e.get(y.id))throw Error(`Cannot add annotation ${y.id} - exists already`);e.set(y.id,y),y.bodies.forEach(A=>t.set(A.id,y.id)),r(_,{created:[y]})},l=(y,_)=>{const A=typeof y=="string"?_:y,L=typeof y=="string"?y:y.id,P=e.get(L);if(P){const Y=$t(P,A);return L===A.id?e.set(L,A):(e.delete(L),e.set(A.id,A)),P.bodies.forEach(R=>t.delete(R.id)),A.bodies.forEach(R=>t.set(R.id,A.id)),Y}else console.warn(`Cannot update annotation ${L} - does not exist`)},a=(y,_=Q.LOCAL,A=Q.LOCAL)=>{const L=Vo(_)?A:_,P=l(y,_);P&&r(L,{updated:[P]})},d=(y,_=Q.LOCAL)=>{const A=y.reduce((L,P)=>{const Y=l(P);return Y?[...L,Y]:L},[]);A.length>0&&r(_,{updated:A})},h=(y,_=Q.LOCAL)=>{const A=e.get(y.annotation);if(A){const L={...A,bodies:[...A.bodies,y]};e.set(A.id,L),t.set(y.id,L.id),r(_,{updated:[{oldValue:A,newValue:L,bodiesCreated:[y]}]})}else console.warn(`Attempt to add body to missing annotation: ${y.annotation}`)},f=()=>[...e.values()],m=(y=Q.LOCAL)=>{const _=[...e.values()];e.clear(),t.clear(),r(y,{deleted:_})},u=(y,_=!0,A=Q.LOCAL)=>{if(_){const L=[...e.values()];e.clear(),t.clear(),y.forEach(P=>{e.set(P.id,P),P.bodies.forEach(Y=>t.set(Y.id,P.id))}),r(A,{created:y,deleted:L})}else{const L=y.reduce((P,Y)=>{const R=e.get(Y.id);return R?[...P,R]:P},[]);if(L.length>0)throw Error(`Bulk insert would overwrite the following annotations: ${L.map(P=>P.id).join(", ")}`);y.forEach(P=>{e.set(P.id,P),P.bodies.forEach(Y=>t.set(Y.id,P.id))}),r(A,{created:y})}},g=y=>{const _=typeof y=="string"?y:y.id,A=e.get(_);if(A)return e.delete(_),A.bodies.forEach(L=>t.delete(L.id)),A;console.warn(`Attempt to delete missing annotation: ${_}`)},w=(y,_=Q.LOCAL)=>{const A=g(y);A&&r(_,{deleted:[A]})},S=(y,_=Q.LOCAL)=>{const A=y.reduce((L,P)=>{const Y=g(P);return Y?[...L,Y]:L},[]);A.length>0&&r(_,{deleted:A})},E=(y,_=Q.LOCAL)=>{const A=e.get(y.annotation);if(A){const L=A.bodies.find(P=>P.id===y.id);if(L){t.delete(L.id);const P={...A,bodies:A.bodies.filter(Y=>Y.id!==y.id)};e.set(A.id,P),r(_,{updated:[{oldValue:A,newValue:P,bodiesDeleted:[L]}]})}else console.warn(`Attempt to delete missing body ${y.id} from annotation ${y.annotation}`)}else console.warn(`Attempt to delete body from missing annotation ${y.annotation}`)},p=y=>{const _=e.get(y);return _?{..._}:void 0},b=y=>{const _=t.get(y);if(_){const A=p(_).bodies.find(L=>L.id===y);if(A)return A;console.error(`Store integrity error: body ${y} in index, but not in annotation`)}else console.warn(`Attempt to retrieve missing body: ${y}`)},T=(y,_)=>{if(y.annotation!==_.annotation)throw"Annotation integrity violation: annotation ID must be the same when updating bodies";const A=e.get(y.annotation);if(A){const L=A.bodies.find(Y=>Y.id===y.id),P={...A,bodies:A.bodies.map(Y=>Y.id===L.id?_:Y)};return e.set(A.id,P),L.id!==_.id&&(t.delete(L.id),t.set(_.id,P.id)),{oldValue:A,newValue:P,bodiesUpdated:[{oldBody:L,newBody:_}]}}else console.warn(`Attempt to add body to missing annotation ${y.annotation}`)},M=(y,_,A=Q.LOCAL)=>{const L=T(y,_);r(A,{updated:[L]})},D=(y,_=Q.LOCAL)=>{const A=y.map(L=>T({id:L.id,annotation:L.annotation},L));r(_,{updated:A})},V=y=>{const _=e.get(y.annotation);if(_){const A={..._,target:{..._.target,...y}};return e.set(_.id,A),{oldValue:_,newValue:A,targetUpdated:{oldTarget:_.target,newTarget:y}}}else console.warn(`Attempt to update target on missing annotation: ${y.annotation}`)};return{addAnnotation:s,addBody:h,all:f,bulkAddAnnotation:u,bulkDeleteAnnotation:S,bulkUpdateAnnotation:d,bulkUpdateBodies:D,bulkUpdateTargets:(y,_=Q.LOCAL)=>{const A=y.map(V).filter(L=>L);A.length>0&&r(_,{updated:A})},clear:m,deleteAnnotation:w,deleteBody:E,getAnnotation:p,getBody:b,observe:o,unobserve:i,updateAnnotation:a,updateBody:M,updateTarget:(y,_=Q.LOCAL)=>{const A=V(y);A&&r(_,{updated:[A]})}}},Fo=e=>({...e,subscribe:t=>{const n=o=>t(o.state);return e.observe(n),t(e.all()),()=>e.unobserve(n)}});let Ho=()=>({emit(e,...t){let n=this.events[e]||[];for(let o=0,i=n.length;o<i;o++)n[o](...t)},events:{},on(e,t){var n;return(n=this.events[e])!=null&&n.push(t)||(this.events[e]=[t]),()=>{var o;this.events[e]=(o=this.events[e])==null?void 0:o.filter(i=>t!==i)}}});const zo=250,jo=e=>{const t=Ho(),n=[];let o=-1,i=!1,r=0;const s=u=>{if(!i){const{changes:g}=u,w=performance.now();if(w-r>zo)n.splice(o+1),n.push(g),o=n.length-1;else{const S=n.length-1;n[S]=No(n[S],g)}r=w}i=!1};e.observe(s,{origin:Q.LOCAL});const l=u=>(u==null?void 0:u.length)>0&&e.bulkDeleteAnnotation(u),a=u=>(u==null?void 0:u.length)>0&&e.bulkAddAnnotation(u,!1),d=u=>(u==null?void 0:u.length)>0&&e.bulkUpdateAnnotation(u.map(({oldValue:g})=>g)),h=u=>(u==null?void 0:u.length)>0&&e.bulkUpdateAnnotation(u.map(({newValue:g})=>g)),f=u=>(u==null?void 0:u.length)>0&&e.bulkAddAnnotation(u,!1),m=u=>(u==null?void 0:u.length)>0&&e.bulkDeleteAnnotation(u);return{canRedo:()=>n.length-1>o,canUndo:()=>o>-1,destroy:()=>e.unobserve(s),on:(u,g)=>t.on(u,g),redo:()=>{if(n.length-1>o){i=!0;const{created:u,updated:g,deleted:w}=n[o+1];a(u),h(g),m(w),t.emit("redo",n[o+1]),o+=1}},undo:()=>{if(o>-1){i=!0;const{created:u,updated:g,deleted:w}=n[o];l(u),d(g),f(w),t.emit("undo",n[o]),o-=1}}}},Wo=()=>{const{subscribe:e,set:t}=mt([]);return{subscribe:e,set:t}},Ko=(e,t,n,o)=>{const{store:i,selection:r,hover:s,viewport:l}=e,a=new Map;let d=[],h,f;const m=(E,p)=>{a.has(E)?a.get(E).push(p):a.set(E,[p])},u=(E,p)=>{const b=a.get(E);b&&b.indexOf(p)>0&&b.splice(b.indexOf(p),1)},g=(E,p,b)=>{a.has(E)&&setTimeout(()=>{a.get(E).forEach(T=>{if(n){const M=Array.isArray(p)?p.map(V=>n.serialize(V)):n.serialize(p),D=b?b instanceof PointerEvent?b:n.serialize(b):void 0;T(M,D)}else T(p,b)})},1)},w=()=>{const{selected:E}=r,p=E.map(({id:b})=>i.getAnnotation(b));p.forEach(b=>{const T=d.find(M=>M.id===b.id);(!T||!Le(T,b))&&g("updateAnnotation",b,T)}),d=d.map(b=>p.find(({id:M})=>M===b.id)||b)};r.subscribe(({selected:E})=>{if(!(d.length===0&&E.length===0)){if(d.length===0&&E.length>0)d=E.map(({id:p})=>i.getAnnotation(p));else if(d.length>0&&E.length===0)d.forEach(p=>{const b=i.getAnnotation(p.id);b&&!Le(b,p)&&g("updateAnnotation",b,p)}),d=[];else{const p=new Set(d.map(T=>T.id)),b=new Set(E.map(({id:T})=>T));d.filter(T=>!b.has(T.id)).forEach(T=>{const M=i.getAnnotation(T.id);M&&!Le(M,T)&&g("updateAnnotation",M,T)}),d=[...d.filter(T=>b.has(T.id)),...E.filter(({id:T})=>!p.has(T)).map(({id:T})=>i.getAnnotation(T))]}g("selectionChanged",d)}}),s.subscribe(E=>{!h&&E?g("mouseEnterAnnotation",i.getAnnotation(E)):h&&!E?g("mouseLeaveAnnotation",i.getAnnotation(h)):h&&E&&(g("mouseLeaveAnnotation",i.getAnnotation(h)),g("mouseEnterAnnotation",i.getAnnotation(E))),h=E}),l==null||l.subscribe(E=>g("viewportIntersect",E.map(i.getAnnotation))),i.observe(E=>{o&&(f&&clearTimeout(f),f=setTimeout(w,1e3));const{created:p,deleted:b}=E.changes;p.forEach(T=>g("createAnnotation",T)),b.forEach(T=>g("deleteAnnotation",T)),E.changes.updated.filter(T=>[...T.bodiesCreated||[],...T.bodiesDeleted||[],...T.bodiesUpdated||[]].length>0).forEach(({oldValue:T,newValue:M})=>{const D=d.find(V=>V.id===T.id)||T;d=d.map(V=>V.id===T.id?M:V),g("updateAnnotation",M,D)})},{origin:Q.LOCAL}),i.observe(E=>{if(d){const p=new Set(d.map(T=>T.id)),b=E.changes.updated.filter(({newValue:T})=>p.has(T.id)).map(({newValue:T})=>T);b.length>0&&(d=d.map(T=>b.find(D=>D.id===T.id)||T))}},{origin:Q.REMOTE});const S=E=>p=>{const{created:b,deleted:T,updated:M}=p;b.forEach(D=>g("createAnnotation",D)),T.forEach(D=>g("deleteAnnotation",D)),E?M.forEach(D=>g("updateAnnotation",D.oldValue,D.newValue)):M.forEach(D=>g("updateAnnotation",D.newValue,D.oldValue))};return t.on("undo",S(!0)),t.on("redo",S(!1)),{on:m,off:u,emit:g}},qo=e=>t=>t.reduce((n,o)=>{const{parsed:i,error:r}=e.parse(o);return r?{parsed:n.parsed,failed:[...n.failed,o]}:{parsed:[...n.parsed,i],failed:n.failed}},{parsed:[],failed:[]}),Zo=(e,t,n)=>{const{store:o,selection:i}=e,r=S=>{if(n){const{parsed:E,error:p}=n.parse(S);E?o.addAnnotation(E,Q.REMOTE):console.error(p)}else o.addAnnotation(S,Q.REMOTE)},s=()=>i.clear(),l=()=>o.clear(),a=S=>{const E=o.getAnnotation(S);return n&&E?n.serialize(E):E},d=()=>n?o.all().map(n.serialize):o.all(),h=()=>{var S;const E=(((S=i.selected)==null?void 0:S.map(p=>p.id))||[]).map(p=>o.getAnnotation(p));return n?E.map(n.serialize):E},f=S=>fetch(S).then(E=>E.json()).then(E=>(u(E),E)),m=S=>{if(typeof S=="string"){const E=o.getAnnotation(S);return o.deleteAnnotation(S),n?n.serialize(E):E}else{const E=n?n.parse(S).parsed:S;return o.deleteAnnotation(E),S}},u=S=>{if(n){const{parsed:E,failed:p}=qo(n)(S);p.length>0&&console.warn(`Discarded ${p.length} invalid annotations`,p),o.bulkAddAnnotation(E,!0,Q.REMOTE)}else o.bulkAddAnnotation(S,!0,Q.REMOTE)},g=S=>{S?i.setSelected(S):i.clear()},w=S=>{if(n){const E=n.parse(S).parsed,p=n.serialize(o.getAnnotation(E.id));return o.updateAnnotation(E),p}else{const E=o.getAnnotation(S.id);return o.updateAnnotation(S),E}};return{addAnnotation:r,cancelSelected:s,canRedo:t.canRedo,canUndo:t.canUndo,clearAnnotations:l,getAnnotationById:a,getAnnotations:d,getSelected:h,loadAnnotations:f,redo:t.redo,removeAnnotation:m,setAnnotations:u,setSelected:g,undo:t.undo,updateAnnotation:w}};let Jo=e=>crypto.getRandomValues(new Uint8Array(e)),Qo=(e,t,n)=>{let o=(2<<Math.log(e.length-1)/Math.LN2)-1,i=-~(1.6*o*t/e.length);return(r=t)=>{let s="";for(;;){let l=n(i),a=i;for(;a--;)if(s+=e[l[a]&o]||"",s.length===r)return s}}},xo=(e,t=21)=>Qo(e,t,Jo),$o=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((t,n)=>(n&=63,n<36?t+=n.toString(36):n<62?t+=(n-26).toString(36).toUpperCase():n>62?t+="-":t+="_",t),"");const ei=()=>({isGuest:!0,id:xo("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",20)()}),ti=e=>{const t=JSON.stringify(e);let n=0;for(let o=0,i=t.length;o<i;o++){let r=t.charCodeAt(o);n=(n<<5)-n+r,n|=0}return`${n}`},en=e=>e?typeof e=="object"?{...e}:e:void 0,ni=(e,t)=>(Array.isArray(e)?e:[e]).map(n=>{const{id:o,type:i,purpose:r,value:s,created:l,creator:a,...d}=n;return{id:o||`temp-${ti(n)}`,annotation:t,type:i,purpose:r,value:s,created:l?new Date(l):void 0,creator:en(a),...d}}),oi=e=>e.map(t=>{var n;const o={...t};return delete o.annotation,(n=o.id)!=null&&n.startsWith("temp-")&&delete o.id,o});$o();const ii=(e,t=!1)=>({parse:i=>tn(i,t),serialize:i=>nn(i,e)}),tn=(e,t=!1)=>{const n=e.id||Jt(),{creator:o,created:i,updatedBy:r,updated:s,body:l,...a}=e,d=ni(l,n),h=Array.isArray(e.target)?e.target[0]:e.target,f=Array.isArray(h.selector)?h.selector[0]:h.selector,m=f.type==="FragmentSelector"?Ct(f,t):f.type==="SvgSelector"?Kt(f):void 0;return m?{parsed:{...a,id:n,bodies:d,target:{created:i?new Date(i):void 0,creator:en(o),...a.target,annotation:n,selector:m}}}:{error:Error(`Unknown selector type: ${f.type}`)}},nn=(e,t)=>{const{selector:n,creator:o,created:i,updated:r,updatedBy:s,...l}=e.target,a=n.type==K.RECTANGLE?Ut(n.geometry):qt(n);return{...e,"@context":"http://www.w3.org/ns/anno.jsonld",id:e.id,type:"Annotation",body:oi(e.bodies),creator:o,created:i==null?void 0:i.toISOString(),target:{...l,source:t,selector:a}}};function on(e,t,n){const o=e.slice();return o[11]=t[n],o[13]=n,o}function rn(e){let t,n,o,i,r;return{c(){t=C("rect"),c(t,"class","a9s-corner-handle"),c(t,"x",n=e[11][0]-e[3]/2),c(t,"y",o=e[11][1]-e[3]/2),c(t,"height",e[3]),c(t,"width",e[3])},m(s,l){I(s,t,l),i||(r=J(t,"pointerdown",function(){q(e[10](v(e[13])))&&e[10](v(e[13])).apply(this,arguments)}),i=!0)},p(s,l){e=s,l&24&&n!==(n=e[11][0]-e[3]/2)&&c(t,"x",n),l&24&&o!==(o=e[11][1]-e[3]/2)&&c(t,"y",o),l&8&&c(t,"height",e[3]),l&8&&c(t,"width",e[3])},d(s){s&&k(t),i=!1,r()}}}function ri(e){let t,n,o,i,r,s,l,a,d,h,f=e[4].points,m=[];for(let u=0;u<f.length;u+=1)m[u]=rn(on(e,f,u));return{c(){t=C("polygon"),i=ne(),r=C("polygon"),l=ne();for(let u=0;u<m.length;u+=1)m[u].c();a=pe(),c(t,"class","a9s-outer"),c(t,"style",n=e[1]?"display:none;":void 0),c(t,"points",o=e[4].points.map(sn).join(" ")),c(r,"class","a9s-inner a9s-shape-handle"),c(r,"style",e[1]),c(r,"points",s=e[4].points.map(ln).join(" "))},m(u,g){I(u,t,g),I(u,i,g),I(u,r,g),I(u,l,g);for(let w=0;w<m.length;w+=1)m[w]&&m[w].m(u,g);I(u,a,g),d||(h=[J(t,"pointerdown",function(){q(e[10](v.SHAPE))&&e[10](v.SHAPE).apply(this,arguments)}),J(r,"pointerdown",function(){q(e[10](v.SHAPE))&&e[10](v.SHAPE).apply(this,arguments)})],d=!0)},p(u,g){if(e=u,g&2&&n!==(n=e[1]?"display:none;":void 0)&&c(t,"style",n),g&16&&o!==(o=e[4].points.map(sn).join(" "))&&c(t,"points",o),g&2&&c(r,"style",e[1]),g&16&&s!==(s=e[4].points.map(ln).join(" "))&&c(r,"points",s),g&1048){f=e[4].points;let w;for(w=0;w<f.length;w+=1){const S=on(e,f,w);m[w]?m[w].p(S,g):(m[w]=rn(S),m[w].c(),m[w].m(a.parentNode,a))}for(;w<m.length;w+=1)m[w].d(1);m.length=f.length}},d(u){u&&k(t),u&&k(i),u&&k(r),u&&k(l),lt(m,u),u&&k(a),d=!1,he(h)}}}function si(e){let t,n;return t=new Je({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[ri,({grab:o})=>({10:o}),({grab:o})=>o?1024:0]},$$scope:{ctx:e}}}),t.$on("change",e[7]),t.$on("grab",e[8]),t.$on("release",e[9]),{c(){me(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&4&&(r.transform=o[2]),i&17434&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}const sn=e=>e.join(","),ln=e=>e.join(",");function li(e,t,n){let o,i,{shape:r}=t,{computedStyle:s=void 0}=t,{transform:l}=t,{viewportScale:a=1}=t;const d=(u,g,w)=>{let S;g===v.SHAPE?S=u.geometry.points.map(([p,b])=>[p+w[0],b+w[1]]):S=u.geometry.points.map(([p,b],T)=>g===v(T)?[p+w[0],b+w[1]]:[p,b]);const E=Ae(S);return{...u,geometry:{points:S,bounds:E}}};function h(u){re.call(this,e,u)}function f(u){re.call(this,e,u)}function m(u){re.call(this,e,u)}return e.$$set=u=>{"shape"in u&&n(0,r=u.shape),"computedStyle"in u&&n(1,s=u.computedStyle),"transform"in u&&n(2,l=u.transform),"viewportScale"in u&&n(6,a=u.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=r.geometry),e.$$.dirty&64&&n(3,i=10/a)},[r,s,l,i,o,d,a,h,f,m]}class an extends ie{constructor(t){super(),oe(this,t,li,si,$,{shape:0,computedStyle:1,transform:2,viewportScale:6})}}function ai(e){let t,n,o,i,r,s,l,a,d,h,f,m,u,g,w,S,E,p,b,T,M,D,V,y,_,A,L,P,Y,R,U,ue,H,O,G,N,de,Z,we,Ce,Ue,te,Ne,ve,Ve,x,Se,be,Tt,Wn;return{c(){t=C("rect"),l=ne(),a=C("rect"),u=ne(),g=C("rect"),p=ne(),b=C("rect"),V=ne(),y=C("rect"),P=ne(),Y=C("rect"),H=ne(),O=C("rect"),de=ne(),Z=C("rect"),Ue=ne(),te=C("rect"),Ve=ne(),x=C("rect"),c(t,"class","a9s-outer"),c(t,"style",n=e[1]?"display:none;":void 0),c(t,"x",o=e[4].x),c(t,"y",i=e[4].y),c(t,"width",r=e[4].w),c(t,"height",s=e[4].h),c(a,"class","a9s-inner a9s-shape-handle"),c(a,"style",e[1]),c(a,"x",d=e[4].x),c(a,"y",h=e[4].y),c(a,"width",f=e[4].w),c(a,"height",m=e[4].h),c(g,"class","a9s-edge-handle a9s-edge-handle-top"),c(g,"x",w=e[4].x),c(g,"y",S=e[4].y),c(g,"height",1),c(g,"width",E=e[4].w),c(b,"class","a9s-edge-handle a9s-edge-handle-right"),c(b,"x",T=e[4].x+e[4].w),c(b,"y",M=e[4].y),c(b,"height",D=e[4].h),c(b,"width",1),c(y,"class","a9s-edge-handle a9s-edge-handle-bottom"),c(y,"x",_=e[4].x),c(y,"y",A=e[4].y+e[4].h),c(y,"height",1),c(y,"width",L=e[4].w),c(Y,"class","a9s-edge-handle a9s-edge-handle-left"),c(Y,"x",R=e[4].x),c(Y,"y",U=e[4].y),c(Y,"height",ue=e[4].h),c(Y,"width",1),c(O,"class","a9s-corner-handle a9s-corner-handle-topleft"),c(O,"x",G=e[4].x-e[3]/2),c(O,"y",N=e[4].y-e[3]/2),c(O,"height",e[3]),c(O,"width",e[3]),c(Z,"class","a9s-corner-handle a9s-corner-handle-topright"),c(Z,"x",we=e[4].x+e[4].w-e[3]/2),c(Z,"y",Ce=e[4].y-e[3]/2),c(Z,"height",e[3]),c(Z,"width",e[3]),c(te,"class","a9s-corner-handle a9s-corner-handle-bottomright"),c(te,"x",Ne=e[4].x+e[4].w-e[3]/2),c(te,"y",ve=e[4].y+e[4].h-e[3]/2),c(te,"height",e[3]),c(te,"width",e[3]),c(x,"class","a9s-corner-handle a9s-corner-handle-bottomleft"),c(x,"x",Se=e[4].x-e[3]/2),c(x,"y",be=e[4].y+e[4].h-e[3]/2),c(x,"height",e[3]),c(x,"width",e[3])},m(F,B){I(F,t,B),I(F,l,B),I(F,a,B),I(F,u,B),I(F,g,B),I(F,p,B),I(F,b,B),I(F,V,B),I(F,y,B),I(F,P,B),I(F,Y,B),I(F,H,B),I(F,O,B),I(F,de,B),I(F,Z,B),I(F,Ue,B),I(F,te,B),I(F,Ve,B),I(F,x,B),Tt||(Wn=[J(t,"pointerdown",function(){q(e[10](v.SHAPE))&&e[10](v.SHAPE).apply(this,arguments)}),J(a,"pointerdown",function(){q(e[10](v.SHAPE))&&e[10](v.SHAPE).apply(this,arguments)}),J(g,"pointerdown",function(){q(e[10](v.TOP))&&e[10](v.TOP).apply(this,arguments)}),J(b,"pointerdown",function(){q(e[10](v.RIGHT))&&e[10](v.RIGHT).apply(this,arguments)}),J(y,"pointerdown",function(){q(e[10](v.BOTTOM))&&e[10](v.BOTTOM).apply(this,arguments)}),J(Y,"pointerdown",function(){q(e[10](v.LEFT))&&e[10](v.LEFT).apply(this,arguments)}),J(O,"pointerdown",function(){q(e[10](v.TOP_LEFT))&&e[10](v.TOP_LEFT).apply(this,arguments)}),J(Z,"pointerdown",function(){q(e[10](v.TOP_RIGHT))&&e[10](v.TOP_RIGHT).apply(this,arguments)}),J(te,"pointerdown",function(){q(e[10](v.BOTTOM_RIGHT))&&e[10](v.BOTTOM_RIGHT).apply(this,arguments)}),J(x,"pointerdown",function(){q(e[10](v.BOTTOM_LEFT))&&e[10](v.BOTTOM_LEFT).apply(this,arguments)})],Tt=!0)},p(F,B){e=F,B&2&&n!==(n=e[1]?"display:none;":void 0)&&c(t,"style",n),B&16&&o!==(o=e[4].x)&&c(t,"x",o),B&16&&i!==(i=e[4].y)&&c(t,"y",i),B&16&&r!==(r=e[4].w)&&c(t,"width",r),B&16&&s!==(s=e[4].h)&&c(t,"height",s),B&2&&c(a,"style",e[1]),B&16&&d!==(d=e[4].x)&&c(a,"x",d),B&16&&h!==(h=e[4].y)&&c(a,"y",h),B&16&&f!==(f=e[4].w)&&c(a,"width",f),B&16&&m!==(m=e[4].h)&&c(a,"height",m),B&16&&w!==(w=e[4].x)&&c(g,"x",w),B&16&&S!==(S=e[4].y)&&c(g,"y",S),B&16&&E!==(E=e[4].w)&&c(g,"width",E),B&16&&T!==(T=e[4].x+e[4].w)&&c(b,"x",T),B&16&&M!==(M=e[4].y)&&c(b,"y",M),B&16&&D!==(D=e[4].h)&&c(b,"height",D),B&16&&_!==(_=e[4].x)&&c(y,"x",_),B&16&&A!==(A=e[4].y+e[4].h)&&c(y,"y",A),B&16&&L!==(L=e[4].w)&&c(y,"width",L),B&16&&R!==(R=e[4].x)&&c(Y,"x",R),B&16&&U!==(U=e[4].y)&&c(Y,"y",U),B&16&&ue!==(ue=e[4].h)&&c(Y,"height",ue),B&24&&G!==(G=e[4].x-e[3]/2)&&c(O,"x",G),B&24&&N!==(N=e[4].y-e[3]/2)&&c(O,"y",N),B&8&&c(O,"height",e[3]),B&8&&c(O,"width",e[3]),B&24&&we!==(we=e[4].x+e[4].w-e[3]/2)&&c(Z,"x",we),B&24&&Ce!==(Ce=e[4].y-e[3]/2)&&c(Z,"y",Ce),B&8&&c(Z,"height",e[3]),B&8&&c(Z,"width",e[3]),B&24&&Ne!==(Ne=e[4].x+e[4].w-e[3]/2)&&c(te,"x",Ne),B&24&&ve!==(ve=e[4].y+e[4].h-e[3]/2)&&c(te,"y",ve),B&8&&c(te,"height",e[3]),B&8&&c(te,"width",e[3]),B&24&&Se!==(Se=e[4].x-e[3]/2)&&c(x,"x",Se),B&24&&be!==(be=e[4].y+e[4].h-e[3]/2)&&c(x,"y",be),B&8&&c(x,"height",e[3]),B&8&&c(x,"width",e[3])},d(F){F&&k(t),F&&k(l),F&&k(a),F&&k(u),F&&k(g),F&&k(p),F&&k(b),F&&k(V),F&&k(y),F&&k(P),F&&k(Y),F&&k(H),F&&k(O),F&&k(de),F&&k(Z),F&&k(Ue),F&&k(te),F&&k(Ve),F&&k(x),Tt=!1,he(Wn)}}}function ci(e){let t,n;return t=new Je({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[ai,({grab:o})=>({10:o}),({grab:o})=>o?1024:0]},$$scope:{ctx:e}}}),t.$on("grab",e[7]),t.$on("change",e[8]),t.$on("release",e[9]),{c(){me(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&4&&(r.transform=o[2]),i&3098&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function fi(e,t,n){let o,i,{shape:r}=t,{computedStyle:s=void 0}=t,{transform:l}=t,{viewportScale:a=1}=t;const d=(u,g,w)=>{const S=u.geometry.bounds;let[E,p]=[S.minX,S.minY],[b,T]=[S.maxX,S.maxY];const[M,D]=w;if(g===v.SHAPE)E+=M,b+=M,p+=D,T+=D;else{switch(g){case v.TOP:case v.TOP_LEFT:case v.TOP_RIGHT:{p+=D;break}case v.BOTTOM:case v.BOTTOM_LEFT:case v.BOTTOM_RIGHT:{T+=D;break}}switch(g){case v.LEFT:case v.TOP_LEFT:case v.BOTTOM_LEFT:{E+=M;break}case v.RIGHT:case v.TOP_RIGHT:case v.BOTTOM_RIGHT:{b+=M;break}}}const V=Math.min(E,b),y=Math.min(p,T),_=Math.abs(b-E),A=Math.abs(T-p);return{...u,geometry:{x:V,y,w:_,h:A,bounds:{minX:V,minY:y,maxX:V+_,maxY:y+A}}}};function h(u){re.call(this,e,u)}function f(u){re.call(this,e,u)}function m(u){re.call(this,e,u)}return e.$$set=u=>{"shape"in u&&n(0,r=u.shape),"computedStyle"in u&&n(1,s=u.computedStyle),"transform"in u&&n(2,l=u.transform),"viewportScale"in u&&n(6,a=u.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=r.geometry),e.$$.dirty&64&&n(3,i=10/a)},[r,s,l,i,o,d,a,h,f,m]}class cn extends ie{constructor(t){super(),oe(this,t,fi,ci,$,{shape:0,computedStyle:1,transform:2,viewportScale:6})}}function ui(e){let t,n,o,i,r,s,l,a,d,h,f,m,u,g,w,S,E,p,b,T,M,D,V,y,_,A,L,P,Y;return{c(){t=C("ellipse"),s=ne(),l=C("ellipse"),m=ne(),u=C("rect"),S=ne(),E=C("rect"),T=ne(),M=C("rect"),y=ne(),_=C("rect"),c(t,"class","a9s-outer"),c(t,"cx",n=e[3].cx),c(t,"cy",o=e[3].cy),c(t,"rx",i=e[3].rx),c(t,"ry",r=e[3].ry),c(l,"class","a9s-inner a9s-shape-handle"),c(l,"cx",a=e[3].cx),c(l,"cy",d=e[3].cy),c(l,"rx",h=e[3].rx),c(l,"ry",f=e[3].ry),c(u,"class","a9s-corner-handle a9s-corner-top"),c(u,"x",g=e[3].cx-e[2]/2),c(u,"y",w=e[3].cy-e[2]/2-e[3].ry),c(u,"height",e[2]),c(u,"width",e[2]),c(E,"class","a9s-corner-handle a9s-corner-handle-right"),c(E,"x",p=e[3].cx+e[3].rx-e[2]/2),c(E,"y",b=e[3].cy-e[2]/2),c(E,"height",e[2]),c(E,"width",e[2]),c(M,"class","a9s-corner-handle a9s-corner-handle-bottom"),c(M,"x",D=e[3].cx-e[2]/2),c(M,"y",V=e[3].cy+e[3].ry-e[2]/2),c(M,"height",e[2]),c(M,"width",e[2]),c(_,"class","a9s-corner-handle a9s-corner-handle-left"),c(_,"x",A=e[3].cx-e[3].rx-e[2]/2),c(_,"y",L=e[3].cy-e[2]/2),c(_,"height",e[2]),c(_,"width",e[2])},m(R,U){I(R,t,U),I(R,s,U),I(R,l,U),I(R,m,U),I(R,u,U),I(R,S,U),I(R,E,U),I(R,T,U),I(R,M,U),I(R,y,U),I(R,_,U),P||(Y=[J(t,"pointerdown",function(){q(e[9](v.SHAPE))&&e[9](v.SHAPE).apply(this,arguments)}),J(l,"pointerdown",function(){q(e[9](v.SHAPE))&&e[9](v.SHAPE).apply(this,arguments)}),J(u,"pointerdown",function(){q(e[9](v.TOP))&&e[9](v.TOP).apply(this,arguments)}),J(E,"pointerdown",function(){q(e[9](v.RIGHT))&&e[9](v.RIGHT).apply(this,arguments)}),J(M,"pointerdown",function(){q(e[9](v.BOTTOM))&&e[9](v.BOTTOM).apply(this,arguments)}),J(_,"pointerdown",function(){q(e[9](v.LEFT))&&e[9](v.LEFT).apply(this,arguments)})],P=!0)},p(R,U){e=R,U&8&&n!==(n=e[3].cx)&&c(t,"cx",n),U&8&&o!==(o=e[3].cy)&&c(t,"cy",o),U&8&&i!==(i=e[3].rx)&&c(t,"rx",i),U&8&&r!==(r=e[3].ry)&&c(t,"ry",r),U&8&&a!==(a=e[3].cx)&&c(l,"cx",a),U&8&&d!==(d=e[3].cy)&&c(l,"cy",d),U&8&&h!==(h=e[3].rx)&&c(l,"rx",h),U&8&&f!==(f=e[3].ry)&&c(l,"ry",f),U&12&&g!==(g=e[3].cx-e[2]/2)&&c(u,"x",g),U&12&&w!==(w=e[3].cy-e[2]/2-e[3].ry)&&c(u,"y",w),U&4&&c(u,"height",e[2]),U&4&&c(u,"width",e[2]),U&12&&p!==(p=e[3].cx+e[3].rx-e[2]/2)&&c(E,"x",p),U&12&&b!==(b=e[3].cy-e[2]/2)&&c(E,"y",b),U&4&&c(E,"height",e[2]),U&4&&c(E,"width",e[2]),U&12&&D!==(D=e[3].cx-e[2]/2)&&c(M,"x",D),U&12&&V!==(V=e[3].cy+e[3].ry-e[2]/2)&&c(M,"y",V),U&4&&c(M,"height",e[2]),U&4&&c(M,"width",e[2]),U&12&&A!==(A=e[3].cx-e[3].rx-e[2]/2)&&c(_,"x",A),U&12&&L!==(L=e[3].cy-e[2]/2)&&c(_,"y",L),U&4&&c(_,"height",e[2]),U&4&&c(_,"width",e[2])},d(R){R&&k(t),R&&k(s),R&&k(l),R&&k(m),R&&k(u),R&&k(S),R&&k(E),R&&k(T),R&&k(M),R&&k(y),R&&k(_),P=!1,he(Y)}}}function di(e){let t,n;return t=new Je({props:{shape:e[0],transform:e[1],editor:e[4],$$slots:{default:[ui,({grab:o})=>({9:o}),({grab:o})=>o?512:0]},$$scope:{ctx:e}}}),t.$on("grab",e[6]),t.$on("change",e[7]),t.$on("release",e[8]),{c(){me(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&2&&(r.transform=o[1]),i&1548&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function hi(e,t,n){let o,i,{shape:r}=t,{transform:s}=t,{viewportScale:l=1}=t;const a=(m,u,g)=>{const w=m.geometry.bounds;let[S,E]=[w.minX,w.minY],[p,b]=[w.maxX,w.maxY];const[T,M]=g;if(u===v.SHAPE)S+=T,p+=T,E+=M,b+=M;else switch(u){case v.TOP:{E+=M;break}case v.BOTTOM:{b+=M;break}case v.LEFT:{S+=T;break}case v.RIGHT:{p+=T;break}}const D=Math.min(S,p),V=Math.min(E,b),y=Math.abs(p-S),_=Math.abs(b-E),A=(S+p)/2,L=(E+b)/2,P=y/2,Y=_/2;return{...m,geometry:{...m.geometry,cx:A,cy:L,rx:P,ry:Y,bounds:{minX:D,minY:V,maxX:D+y,maxY:V+_}}}};function d(m){re.call(this,e,m)}function h(m){re.call(this,e,m)}function f(m){re.call(this,e,m)}return e.$$set=m=>{"shape"in m&&n(0,r=m.shape),"transform"in m&&n(1,s=m.transform),"viewportScale"in m&&n(5,l=m.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(3,o=r.geometry),e.$$.dirty&32&&n(2,i=10/l)},[r,s,i,o,a,l,d,h,f]}class fn extends ie{constructor(t){super(),oe(this,t,hi,di,$,{shape:0,transform:1,viewportScale:5})}}function mi(e){let t,n,o;return{c(){t=C("path"),c(t,"class","a9s-inner a9s-shape-handle"),c(t,"style",e[1]),c(t,"d",e[3])},m(i,r){I(i,t,r),n||(o=J(t,"pointerdown",function(){q(e[11](v.SHAPE))&&e[11](v.SHAPE).apply(this,arguments)}),n=!0)},p(i,r){e=i,r&2&&c(t,"style",e[1]),r&8&&c(t,"d",e[3])},d(i){i&&k(t),n=!1,o()}}}function gi(e){let t,n;return t=new Je({props:{shape:e[0],transform:e[2],editor:e[4],$$slots:{default:[mi,({grab:o})=>({11:o}),({grab:o})=>o?2048:0]},$$scope:{ctx:e}}}),t.$on("change",e[7]),t.$on("grab",e[8]),t.$on("release",e[9]),{c(){me(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&4&&(r.transform=o[2]),i&6154&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function pi(e,t,n){let o,i,{shape:r}=t,{computedStyle:s=void 0}=t,{transform:l}=t,{viewportScale:a=1}=t;const d=(u,g,w)=>{let S;g===v.SHAPE&&(S=u.geometry.points.map(([p,b,T])=>[p+w[0],b+w[1],T]));const E=Ae(S.map(p=>[p[0],p[1]]));return{...u,geometry:{points:S,bounds:E}}};function h(u){re.call(this,e,u)}function f(u){re.call(this,e,u)}function m(u){re.call(this,e,u)}return e.$$set=u=>{"shape"in u&&n(0,r=u.shape),"computedStyle"in u&&n(1,s=u.computedStyle),"transform"in u&&n(2,l=u.transform),"viewportScale"in u&&n(5,a=u.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(6,o=r.geometry),e.$$.dirty&32,e.$$.dirty&64&&n(3,i=Ze(o.points,qe))},[r,s,l,i,d,a,o,h,f,m]}class un extends ie{constructor(t){super(),oe(this,t,pi,gi,$,{shape:0,computedStyle:1,transform:2,viewportScale:5})}}const dn=new Map([[K.RECTANGLE,cn],[K.POLYGON,an],[K.ELLIPSE,fn],[K.FREEHAND,un]]),pt=e=>dn.get(e.type),hn=(e,t)=>dn.set(e,t),v=e=>`HANDLE-${e}`;v.SHAPE="SHAPE",v.TOP="TOP",v.RIGHT="RIGHT",v.BOTTOM="BOTTOM",v.LEFT="LEFT",v.TOP_LEFT="TOP_LEFT",v.TOP_RIGHT="TOP_RIGHT",v.BOTTOM_RIGHT="BOTTOM_RIGHT",v.BOTTOM_LEFT="BOTTOM_LEFT";const yi=e=>({}),mn=e=>({grab:e[0]});function _i(e){let t,n,o,i;const r=e[7].default,s=Zn(r,e,e[6],mn);return{c(){t=C("g"),s&&s.c(),c(t,"class","a9s-annotation selected")},m(l,a){I(l,t,a),s&&s.m(t,null),n=!0,o||(i=[J(t,"pointerup",e[2]),J(t,"pointermove",e[1])],o=!0)},p(l,[a]){s&&s.p&&(!n||a&64)&&Qn(s,r,l,l[6],n?Jn(r,l[6],a,yi):xn(l[6]),mn)},i(l){n||(z(s,l),n=!0)},o(l){W(s,l),n=!1},d(l){l&&k(t),s&&s.d(l),o=!1,he(i)}}}function wi(e,t,n){let{$$slots:o={},$$scope:i}=t;const r=Ee();let{shape:s}=t,{editor:l}=t,{transform:a}=t,d=null,h,f=null;const m=w=>S=>{d=w,h=a.elementToImage(S.offsetX,S.offsetY),f=s,S.target.setPointerCapture(S.pointerId),r("grab")},u=w=>{if(d){const[S,E]=a.elementToImage(w.offsetX,w.offsetY),p=[S-h[0],E-h[1]];n(3,s=l(f,d,p)),r("change",s)}},g=w=>{w.target.releasePointerCapture(w.pointerId),d=null,f=s,r("release")};return e.$$set=w=>{"shape"in w&&n(3,s=w.shape),"editor"in w&&n(4,l=w.editor),"transform"in w&&n(5,a=w.transform),"$$scope"in w&&n(6,i=w.$$scope)},[m,u,g,s,l,a,i,o]}class Je extends ie{constructor(t){super(),oe(this,t,wi,_i,$,{shape:3,editor:4,transform:5})}}const De=(e,t,n)=>{const o=typeof t=="function"?t(e):t;if(o){const{fill:i,fillOpacity:r}=o;let s="",l;return i&&(s+=`fill:${i};stroke:${i};`),n&&(l=n.fillOpacity),s+=`fill-opacity:${l||r||"0.25"};`,s}};function bi(e,t,n){let o;const i=Ee();let{annotation:r}=t,{editor:s}=t,{style:l=void 0}=t,{target:a}=t,{transform:d}=t,{viewportScale:h}=t,f;return Te(()=>(n(6,f=new s({target:a,props:{shape:r.target.selector,computedStyle:o,transform:d,viewportScale:h}})),f.$on("change",m=>{f.$$set({shape:m.detail}),i("change",m.detail)}),f.$on("grab",m=>i("grab",m.detail)),f.$on("release",m=>i("release",m.detail)),()=>{f.$destroy()})),e.$$set=m=>{"annotation"in m&&n(0,r=m.annotation),"editor"in m&&n(1,s=m.editor),"style"in m&&n(2,l=m.style),"target"in m&&n(3,a=m.target),"transform"in m&&n(4,d=m.transform),"viewportScale"in m&&n(5,h=m.viewportScale)},e.$$.update=()=>{e.$$.dirty&5&&(o=De(r,l)),e.$$.dirty&65&&r&&(f==null||f.$set({shape:r.target.selector})),e.$$.dirty&80&&f&&f.$set({transform:d}),e.$$.dirty&96&&f&&f.$set({viewportScale:h})},[r,s,l,a,d,h,f]}class gn extends ie{constructor(t){super(),oe(this,t,bi,null,$,{annotation:0,editor:1,style:2,target:3,transform:4,viewportScale:5})}}function Ei(e,t,n){const o=Ee();let{drawingMode:i}=t,{target:r}=t,{tool:s}=t,{transform:l}=t,{viewportScale:a}=t,d;return Te(()=>{const h=r.closest("svg"),f=[],m=(u,g,w)=>{h.addEventListener(u,g,w),f.push(()=>h.removeEventListener(u,g,w))};return n(5,d=new s({target:r,props:{addEventListener:m,drawingMode:i,transform:l,viewportScale:a}})),d.$on("create",u=>o("create",u.detail)),()=>{f.forEach(u=>u()),d.$destroy()}}),e.$$set=h=>{"drawingMode"in h&&n(0,i=h.drawingMode),"target"in h&&n(1,r=h.target),"tool"in h&&n(2,s=h.tool),"transform"in h&&n(3,l=h.transform),"viewportScale"in h&&n(4,a=h.viewportScale)},e.$$.update=()=>{e.$$.dirty&40&&d&&d.$set({transform:l}),e.$$.dirty&48&&d&&d.$set({viewportScale:a})},[i,r,s,l,a,d]}class pn extends ie{constructor(t){super(),oe(this,t,Ei,null,$,{drawingMode:0,target:1,tool:2,transform:3,viewportScale:4})}}function yn(e){let t,n;return{c(){t=C("rect"),n=C("rect"),c(t,"class","a9s-outer"),c(t,"x",e[1]),c(t,"y",e[2]),c(t,"width",e[3]),c(t,"height",e[4]),c(n,"class","a9s-inner"),c(n,"x",e[1]),c(n,"y",e[2]),c(n,"width",e[3]),c(n,"height",e[4])},m(o,i){I(o,t,i),I(o,n,i)},p(o,i){i&2&&c(t,"x",o[1]),i&4&&c(t,"y",o[2]),i&8&&c(t,"width",o[3]),i&16&&c(t,"height",o[4]),i&2&&c(n,"x",o[1]),i&4&&c(n,"y",o[2]),i&8&&c(n,"width",o[3]),i&16&&c(n,"height",o[4])},d(o){o&&k(t),o&&k(n)}}}function Ai(e){let t,n=e[0]&&yn(e);return{c(){t=C("g"),n&&n.c(),c(t,"class","a9s-annotation a9s-rubberband")},m(o,i){I(o,t,i),n&&n.m(t,null)},p(o,[i]){o[0]?n?n.p(o,i):(n=yn(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:j,o:j,d(o){o&&k(t),n&&n.d()}}}function Si(e,t,n){const o=Ee();let{addEventListener:i}=t,{drawingMode:r}=t,{transform:s}=t,l,a,d,h,f,m,u;const g=p=>{l=performance.now(),r==="drag"&&(n(0,a=s.elementToImage(p.offsetX,p.offsetY)),d=a,n(1,h=a[0]),n(2,f=a[1]),n(3,m=1),n(4,u=1))},w=p=>{a&&(d=s.elementToImage(p.offsetX,p.offsetY),n(1,h=Math.min(d[0],a[0])),n(2,f=Math.min(d[1],a[1])),n(3,m=Math.abs(d[0]-a[0])),n(4,u=Math.abs(d[1]-a[1])))},S=p=>{const b=performance.now()-l;if(r==="click"){if(b>300)return;p.stopPropagation(),a?E():(n(0,a=s.elementToImage(p.offsetX,p.offsetY)),d=a,n(1,h=a[0]),n(2,f=a[1]),n(3,m=1),n(4,u=1))}else a&&(b>300||m*u>100?(p.stopPropagation(),E()):(n(0,a=null),d=null))},E=()=>{if(m*u>15){const p={type:K.RECTANGLE,geometry:{bounds:{minX:h,minY:f,maxX:h+m,maxY:f+u},x:h,y:f,w:m,h:u}};o("create",p)}n(0,a=null),d=null};return Te(()=>{i("pointerdown",g),i("pointermove",w),i("pointerup",S,!0)}),e.$$set=p=>{"addEventListener"in p&&n(5,i=p.addEventListener),"drawingMode"in p&&n(6,r=p.drawingMode),"transform"in p&&n(7,s=p.transform)},[a,h,f,m,u,i,r,s]}class _n extends ie{constructor(t){super(),oe(this,t,Si,Ai,$,{addEventListener:5,drawingMode:6,transform:7})}}const ot=(e,t)=>{const n=Math.abs(t[0]-e[0]),o=Math.abs(t[1]-e[1]);return Math.sqrt(Math.pow(n,2)+Math.pow(o,2))},Ye=[];function Ti(e,t=j){let n;const o=new Set;function i(l){if($(e,l)&&(e=l,n)){const a=!Ye.length;for(const d of o)d[1](),Ye.push(d,e);if(a){for(let d=0;d<Ye.length;d+=2)Ye[d][0](Ye[d+1]);Ye.length=0}}}function r(l){i(l(e))}function s(l,a=j){const d=[l,a];return o.add(d),o.size===1&&(n=t(i)||j),l(e),()=>{o.delete(d),o.size===0&&n&&(n(),n=null)}}return{set:i,update:r,subscribe:s}}const Mi=(e,t)=>{const{naturalWidth:n,naturalHeight:o}=e;if(!n&&!o){const{width:i,height:r}=e;t.setAttribute("viewBox",`0 0 ${i} ${r}`),e.addEventListener("load",s=>{const l=s.target;t.setAttribute("viewBox",`0 0 ${l.naturalWidth} ${l.naturalHeight}`)})}else t.setAttribute("viewBox",`0 0 ${n} ${o}`)},wn=(e,t)=>{Mi(e,t);const{subscribe:n,set:o}=Ti(1);let i;return window.ResizeObserver&&(i=new ResizeObserver(()=>{const s=t.getBoundingClientRect(),{width:l,height:a}=t.viewBox.baseVal,d=Math.max(s.width/l,s.height/a);o(d)}),i.observe(t.parentElement)),{destroy:()=>{i&&i.disconnect()},subscribe:n}},Li="ontouchstart"in window||navigator.maxTouchPoints>0;function yt(e){const t=e.slice(),n=(t[2]?t[0]:[...t[0],t[1]]).map(o=>o.join(",")).join(" ");return t[15]=n,t}function bn(e){let t,n,o,i,r,s=e[2]&&En(e);return{c(){t=C("polygon"),o=C("polygon"),s&&s.c(),r=pe(),c(t,"class","a9s-outer"),c(t,"points",n=e[15]),c(o,"class","a9s-inner"),c(o,"points",i=e[15])},m(l,a){I(l,t,a),I(l,o,a),s&&s.m(l,a),I(l,r,a)},p(l,a){a&7&&n!==(n=l[15])&&c(t,"points",n),a&7&&i!==(i=l[15])&&c(o,"points",i),l[2]?s?s.p(l,a):(s=En(l),s.c(),s.m(r.parentNode,r)):s&&(s.d(1),s=null)},d(l){l&&k(t),l&&k(o),s&&s.d(l),l&&k(r)}}}function En(e){let t,n,o;return{c(){t=C("rect"),c(t,"class","a9s-corner-handle"),c(t,"x",n=e[0][0][0]-e[3]/2),c(t,"y",o=e[0][0][1]-e[3]/2),c(t,"height",e[3]),c(t,"width",e[3])},m(i,r){I(i,t,r)},p(i,r){r&9&&n!==(n=i[0][0][0]-i[3]/2)&&c(t,"x",n),r&9&&o!==(o=i[0][0][1]-i[3]/2)&&c(t,"y",o),r&8&&c(t,"height",i[3]),r&8&&c(t,"width",i[3])},d(i){i&&k(t)}}}function vi(e){let t,n=e[1]&&bn(yt(e));return{c(){t=C("g"),n&&n.c(),c(t,"class","a9s-annotation a9s-rubberband")},m(o,i){I(o,t,i),n&&n.m(t,null)},p(o,[i]){o[1]?n?n.p(yt(o),i):(n=bn(yt(o)),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:j,o:j,d(o){o&&k(t),n&&n.d()}}}const Oi=20;function ki(e,t,n){let o;const i=Ee();let{addEventListener:r}=t,{drawingMode:s}=t,{transform:l}=t,{viewportScale:a=1}=t,d,h=[],f=null,m=!1;const u=p=>{const{timeStamp:b,offsetX:T,offsetY:M}=p;if(d={timeStamp:b,offsetX:T,offsetY:M},s==="drag"&&h.length===0){const D=l.elementToImage(p.offsetX,p.offsetY);h.push(D),n(1,f=D)}},g=p=>{if(h.length>0&&(n(1,f=l.elementToImage(p.offsetX,p.offsetY)),h.length>2)){const b=ot(f,h[0])*a;n(2,m=b<Oi)}},w=p=>{if(s==="click"){const b=p.timeStamp-d.timeStamp,T=ot([d.offsetX,d.offsetY],[p.offsetX,p.offsetY]);if(b>300||T>15)return;if(m)E();else if(h.length===0){const M=l.elementToImage(p.offsetX,p.offsetY);h.push(M),n(1,f=M)}else h.push(f)}else{if(h.length===1&&ot(h[0],f)<=4){n(0,h=[]),n(1,f=null);return}p.stopImmediatePropagation(),m?E():h.push(f)}},S=()=>{const p=[...h,f],b={type:K.POLYGON,geometry:{bounds:Ae(p),points:p}};tt(b)>4&&(n(0,h=[]),n(1,f=null),i("create",b))},E=()=>{const p={type:K.POLYGON,geometry:{bounds:Ae(h),points:[...h]}};n(0,h=[]),n(1,f=null),i("create",p)};return Te(()=>{r("pointerdown",u,!0),r("pointermove",g),r("pointerup",w,!0),r("dblclick",S,!0)}),e.$$set=p=>{"addEventListener"in p&&n(4,r=p.addEventListener),"drawingMode"in p&&n(5,s=p.drawingMode),"transform"in p&&n(6,l=p.transform),"viewportScale"in p&&n(7,a=p.viewportScale)},e.$$.update=()=>{e.$$.dirty&128&&n(3,o=10/a)},[h,f,m,o,r,s,l,a]}class Ii extends ie{constructor(t){super(),oe(this,t,ki,vi,$,{addEventListener:4,drawingMode:5,transform:6,viewportScale:7})}}function An(e){let t,n,o,i,r,s,l,a,d,h;return{c(){t=C("ellipse"),s=C("ellipse"),c(t,"class","a9s-outer"),c(t,"cx",n=e[2]+e[4]/2),c(t,"cy",o=e[3]+e[5]/2),c(t,"rx",i=e[4]/2),c(t,"ry",r=e[5]/2),c(s,"class","a9s-inner"),c(s,"cx",l=e[2]+e[4]/2),c(s,"cy",a=e[3]+e[5]/2),c(s,"rx",d=e[4]/2),c(s,"ry",h=e[5]/2)},m(f,m){I(f,t,m),I(f,s,m)},p(f,m){m&20&&n!==(n=f[2]+f[4]/2)&&c(t,"cx",n),m&40&&o!==(o=f[3]+f[5]/2)&&c(t,"cy",o),m&16&&i!==(i=f[4]/2)&&c(t,"rx",i),m&32&&r!==(r=f[5]/2)&&c(t,"ry",r),m&20&&l!==(l=f[2]+f[4]/2)&&c(s,"cx",l),m&40&&a!==(a=f[3]+f[5]/2)&&c(s,"cy",a),m&16&&d!==(d=f[4]/2)&&c(s,"rx",d),m&32&&h!==(h=f[5]/2)&&c(s,"ry",h)},d(f){f&&k(t),f&&k(s)}}}function Pi(e){let t,n=e[1]&&An(e);return{c(){t=C("g"),n&&n.c(),c(t,"class","a9s-annotation a9s-rubberband")},m(o,i){I(o,t,i),n&&n.m(t,null),e[9](t)},p(o,[i]){o[1]?n?n.p(o,i):(n=An(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:j,o:j,d(o){o&&k(t),n&&n.d(),e[9](null)}}}function Bi(e,t,n){const o=Ee();let{addEventListener:i}=t,{drawingMode:r}=t,{transform:s}=t,l,a,d,h,f,m,u,g=!1,w=!1,S,E;const p=_=>{S=performance.now(),r==="drag"&&(n(1,a=s.elementToImage(_.offsetX,_.offsetY)),d=a,n(2,h=a[0]),n(3,f=a[1]),n(4,m=1),n(5,u=1))},b=_=>{const A=_||E;if(a)if(d=s.elementToImage(A.offsetX,A.offsetY),w){const L=2*Math.abs(d[0]-a[0]),P=2*Math.abs(d[1]-a[1]);n(4,m=g?Math.max(L,P):L),n(5,u=g?m:P),n(2,h=Math.min(d[0],a[0]-m/2)),n(3,f=Math.min(d[1],a[1]-u/2))}else{const L=Math.abs(d[0]-a[0]),P=Math.abs(d[1]-a[1]);n(4,m=g?Math.max(L,P):L),n(5,u=g?m:P),n(2,h=Math.min(d[0],a[0])),n(3,f=Math.min(d[1],a[1]))}_&&(E=_)},T=_=>{r==="click"&&_.stopImmediatePropagation();const A=performance.now()-S;if(r==="click"){if(A>300)return;_.stopPropagation(),a?M():(n(1,a=s.elementToImage(_.offsetX,_.offsetY)),d=a,n(2,h=a[0]),n(3,f=a[1]),n(4,m=1),n(5,u=1))}else a&&(A>300||m*u>100?(_.stopPropagation(),M()):(n(1,a=null),d=null,E=void 0))},M=()=>{if(m*u>15){const _={type:K.ELLIPSE,geometry:{bounds:{minX:h,minY:f,maxX:h+m,maxY:f+u},cx:h+m/2,cy:f+u/2,rx:m/2,ry:u/2}};o("create",_)}n(1,a=null),d=null,E=void 0},D=_=>{_.key==="Shift"&&(g=!0,b()),_.key==="Control"&&(w=!0,b())},V=_=>{_.key==="Shift"&&(g=!1,b()),_.key==="Control"&&(w=!1,b())};Te(()=>(document.addEventListener("keyup",V),document.addEventListener("keydown",D),i("pointerdown",p),i("pointermove",b),i("pointerup",T),()=>{document.removeEventListener("keyup",V),document.removeEventListener("keydown",D)}));function y(_){He[_?"unshift":"push"](()=>{l=_,n(0,l)})}return e.$$set=_=>{"addEventListener"in _&&n(6,i=_.addEventListener),"drawingMode"in _&&n(7,r=_.drawingMode),"transform"in _&&n(8,s=_.transform)},[l,a,h,f,m,u,i,r,s,y]}class Di extends ie{constructor(t){super(),oe(this,t,Bi,Pi,$,{addEventListener:6,drawingMode:7,transform:8})}}function Sn(e){let t;return{c(){t=C("path"),c(t,"class","a9s-inner"),c(t,"style",e[2]),c(t,"d",e[0])},m(n,o){I(n,t,o)},p(n,o){o&4&&c(t,"style",n[2]),o&1&&c(t,"d",n[0])},d(n){n&&k(t)}}}function Yi(e){let t,n=e[1]&&Sn(e);return{c(){t=C("g"),n&&n.c(),c(t,"class","a9s-annotation a9s-rubberband")},m(o,i){I(o,t,i),n&&n.m(t,null)},p(o,[i]){o[1]?n?n.p(o,i):(n=Sn(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:j,o:j,d(o){o&&k(t),n&&n.d()}}}function Ri(e,t,n){let o;const i=Ee();let{addEventListener:r}=t,{drawingMode:s}=t,{annotation:l}=t,{transform:a}=t,{viewportScale:d=1}=t,{style:h=void 0}=t,f={fillOpacity:1},m=[],u="",g=!1;const w=b=>{if(s==="drag"&&m.length===0){n(1,g=!0);const T=a.elementToImage(b.offsetX,b.offsetY);m.push([...T,b.pressure]),n(0,u=Ze(m,qe))}},S=b=>{if(g){const T=a.elementToImage(b.offsetX,b.offsetY);m.push([...T,b.pressure]),n(0,u=Ze(m,qe))}},E=b=>{g&&p()},p=()=>{const b={type:K.FREEHAND,geometry:{bounds:Ae(m.map(T=>[T[0],T[1]])),points:m}};n(1,g=!1),m=[],i("create",b)};return Te(()=>{r("pointerdown",w,!0),r("pointermove",S),r("pointerup",E,!0)}),e.$$set=b=>{"addEventListener"in b&&n(3,r=b.addEventListener),"drawingMode"in b&&n(4,s=b.drawingMode),"annotation"in b&&n(5,l=b.annotation),"transform"in b&&n(6,a=b.transform),"viewportScale"in b&&n(7,d=b.viewportScale),"style"in b&&n(8,h=b.style)},e.$$.update=()=>{e.$$.dirty&128,e.$$.dirty&288&&n(2,o=De(l,h,f))},[u,g,o,r,s,l,a,d,h]}class Xi extends ie{constructor(t){super(),oe(this,t,Ri,Yi,$,{addEventListener:3,drawingMode:4,annotation:5,transform:6,viewportScale:7,style:8})}}const _t=new Map([["rectangle",{tool:_n}],["polygon",{tool:Ii}],["ellipse",{tool:Di}],["freehand",{tool:Xi}]]),it=()=>[..._t.keys()],wt=e=>_t.get(e),Tn=(e,t,n)=>_t.set(e,{tool:t,opts:n});function Ci(e){let t,n,o,i,r;return{c(){t=C("g"),n=C("ellipse"),i=C("ellipse"),c(n,"class","a9s-outer"),c(n,"style",o=e[1]?"display:none;":void 0),c(n,"cx",e[2]),c(n,"cy",e[3]),c(n,"rx",e[4]),c(n,"ry",e[5]),c(i,"class","a9s-inner"),c(i,"style",e[1]),c(i,"cx",e[2]),c(i,"cy",e[3]),c(i,"rx",e[4]),c(i,"ry",e[5]),c(t,"data-id",r=e[0].id)},m(s,l){I(s,t,l),ge(t,n),ge(t,i)},p(s,[l]){l&2&&o!==(o=s[1]?"display:none;":void 0)&&c(n,"style",o),l&2&&c(i,"style",s[1]),l&1&&r!==(r=s[0].id)&&c(t,"data-id",r)},i:j,o:j,d(s){s&&k(t)}}}function Ui(e,t,n){let o,{annotation:i}=t,{geom:r}=t,{style:s=void 0}=t;const{cx:l,cy:a,rx:d,ry:h}=r;return e.$$set=f=>{"annotation"in f&&n(0,i=f.annotation),"geom"in f&&n(6,r=f.geom),"style"in f&&n(7,s=f.style)},e.$$.update=()=>{e.$$.dirty&129&&n(1,o=De(i,s))},[i,o,l,a,d,h,r,s]}class Ni extends ie{constructor(t){super(),oe(this,t,Ui,Ci,$,{annotation:0,geom:6,style:7})}}function Vi(e){let t,n,o,i,r;return{c(){t=C("g"),n=C("polygon"),i=C("polygon"),c(n,"class","a9s-outer"),c(n,"style",o=e[1]?"display:none;":void 0),c(n,"points",e[2].map(Gi).join(" ")),c(i,"class","a9s-inner"),c(i,"style",e[1]),c(i,"points",e[2].map(Fi).join(" ")),c(t,"data-id",r=e[0].id)},m(s,l){I(s,t,l),ge(t,n),ge(t,i)},p(s,[l]){l&2&&o!==(o=s[1]?"display:none;":void 0)&&c(n,"style",o),l&2&&c(i,"style",s[1]),l&1&&r!==(r=s[0].id)&&c(t,"data-id",r)},i:j,o:j,d(s){s&&k(t)}}}const Gi=e=>e.join(","),Fi=e=>e.join(",");function Hi(e,t,n){let o,{annotation:i}=t,{geom:r}=t,{style:s=void 0}=t;const{points:l}=r;return e.$$set=a=>{"annotation"in a&&n(0,i=a.annotation),"geom"in a&&n(3,r=a.geom),"style"in a&&n(4,s=a.style)},e.$$.update=()=>{e.$$.dirty&17&&n(1,o=De(i,s))},[i,o,l,r,s]}class zi extends ie{constructor(t){super(),oe(this,t,Hi,Vi,$,{annotation:0,geom:3,style:4})}}function ji(e){let t,n,o,i,r;return{c(){t=C("g"),n=C("rect"),i=C("rect"),c(n,"class","a9s-outer"),c(n,"style",o=e[5]?"display:none;":void 0),c(n,"x",e[4]),c(n,"y",e[3]),c(n,"width",e[2]),c(n,"height",e[1]),c(i,"class","a9s-inner"),c(i,"style",e[5]),c(i,"x",e[4]),c(i,"y",e[3]),c(i,"width",e[2]),c(i,"height",e[1]),c(t,"data-id",r=e[0].id)},m(s,l){I(s,t,l),ge(t,n),ge(t,i)},p(s,[l]){l&32&&o!==(o=s[5]?"display:none;":void 0)&&c(n,"style",o),l&16&&c(n,"x",s[4]),l&8&&c(n,"y",s[3]),l&4&&c(n,"width",s[2]),l&2&&c(n,"height",s[1]),l&32&&c(i,"style",s[5]),l&16&&c(i,"x",s[4]),l&8&&c(i,"y",s[3]),l&4&&c(i,"width",s[2]),l&2&&c(i,"height",s[1]),l&1&&r!==(r=s[0].id)&&c(t,"data-id",r)},i:j,o:j,d(s){s&&k(t)}}}function Wi(e,t,n){let o,i,r,s,l,{annotation:a}=t,{geom:d}=t,{style:h=void 0}=t;return e.$$set=f=>{"annotation"in f&&n(0,a=f.annotation),"geom"in f&&n(6,d=f.geom),"style"in f&&n(7,h=f.style)},e.$$.update=()=>{e.$$.dirty&129&&n(5,o=De(a,h)),e.$$.dirty&64&&n(4,{x:i,y:r,w:s,h:l}=d,i,(n(3,r),n(6,d)),(n(2,s),n(6,d)),(n(1,l),n(6,d)))},[a,l,s,r,i,o,d,h]}class Ki extends ie{constructor(t){super(),oe(this,t,Wi,ji,$,{annotation:0,geom:6,style:7})}}function qi(e){let t,n,o;return{c(){t=C("g"),n=C("path"),c(n,"class","a9s-outer"),c(n,"style",e[2]),c(n,"d",e[1]),c(t,"data-id",o=e[0].id)},m(i,r){I(i,t,r),ge(t,n)},p(i,[r]){r&4&&c(n,"style",i[2]),r&2&&c(n,"d",i[1]),r&1&&o!==(o=i[0].id)&&c(t,"data-id",o)},i:j,o:j,d(i){i&&k(t)}}}function Zi(e,t,n){let o,i,{annotation:r}=t,{geom:s}=t,{style:l=void 0}=t,a={fillOpacity:1};const{points:d}=s;return e.$$set=h=>{"annotation"in h&&n(0,r=h.annotation),"geom"in h&&n(3,s=h.geom),"style"in h&&n(4,l=h.style)},e.$$.update=()=>{e.$$.dirty&17&&n(2,o=De(r,l,a))},n(1,i=Ze(d,qe)),[r,i,o,s,l]}class Ji extends ie{constructor(t){super(),oe(this,t,Zi,qi,$,{annotation:0,geom:3,style:4})}}const Qi={elementToImage:(e,t)=>[e,t]},Mn=e=>({elementToImage:(t,n)=>{const o=e.getBoundingClientRect(),i=e.createSVGPoint();i.x=t+o.x,i.y=n+o.y;const{x:r,y:s}=i.matrixTransform(e.getScreenCTM().inverse());return[r,s]}}),xi=250,Ln=(e,t)=>{const n=Ee();let o;return{onPointerDown:()=>o=performance.now(),onPointerUp:s=>{if(performance.now()-o<xi){const{x:a,y:d}=$i(s,e),h=t.getAt(a,d);h?n("click",{originalEvent:s,annotation:h}):n("click",{originalEvent:s})}}}},$i=(e,t)=>{const n=t.createSVGPoint(),o=t.getBoundingClientRect(),i=e.clientX-o.x,r=e.clientY-o.y,{left:s,top:l}=t.getBoundingClientRect();return n.x=i+s,n.y=r+l,n.matrixTransform(t.getScreenCTM().inverse())};function vn(e,t,n){const o=e.slice();return o[29]=t[n],o}function On(e,t,n){const o=e.slice();return o[32]=t[n],o}function bt(e){const t=e.slice(),n=t[32].target.selector;return t[35]=n,t}function kn(e){let t=e[32].id,n,o,i=In(e);return{c(){i.c(),n=pe()},m(r,s){i.m(r,s),I(r,n,s),o=!0},p(r,s){s[0]&8192&&$(t,t=r[32].id)?(ye(),W(i,1,1,j),_e(),i=In(r),i.c(),z(i,1),i.m(n.parentNode,n)):i.p(r,s)},i(r){o||(z(i),o=!0)},o(r){W(i),o=!1},d(r){r&&k(n),i.d(r)}}}function er(e){let t,n;return t=new Ji({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){me(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function tr(e){let t,n;return t=new zi({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){me(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function nr(e){let t,n;return t=new Ki({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){me(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function or(e){let t,n;return t=new Ni({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){me(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function In(e){let t,n,o,i;const r=[or,nr,tr,er],s=[];function l(a,d){return a[35].type===K.ELLIPSE?0:a[35].type===K.RECTANGLE?1:a[35].type===K.POLYGON?2:a[35].type===K.FREEHAND?3:-1}return~(t=l(e))&&(n=s[t]=r[t](e)),{c(){n&&n.c(),o=pe()},m(a,d){~t&&s[t].m(a,d),I(a,o,d),i=!0},p(a,d){let h=t;t=l(a),t===h?~t&&s[t].p(a,d):(n&&(ye(),W(s[h],1,1,()=>{s[h]=null}),_e()),~t?(n=s[t],n?n.p(a,d):(n=s[t]=r[t](a),n.c()),z(n,1),n.m(o.parentNode,o)):n=null)},i(a){i||(z(n),i=!0)},o(a){W(n),i=!1},d(a){~t&&s[t].d(a),a&&k(o)}}}function Pn(e){let t=!e[7](e[32]),n,o,i=t&&kn(bt(e));return{c(){i&&i.c(),n=pe()},m(r,s){i&&i.m(r,s),I(r,n,s),o=!0},p(r,s){s[0]&8320&&(t=!r[7](r[32])),t?i?(i.p(bt(r),s),s[0]&8320&&z(i,1)):(i=kn(bt(r)),i.c(),z(i,1),i.m(n.parentNode,n)):i&&(ye(),W(i,1,1,()=>{i=null}),_e())},i(r){o||(z(i),o=!0)},o(r){W(i),o=!1},d(r){i&&i.d(r),r&&k(n)}}}function Bn(e){let t,n,o,i;const r=[rr,ir],s=[];function l(a,d){return a[6]?0:a[12]&&a[0]?1:-1}return~(t=l(e))&&(n=s[t]=r[t](e)),{c(){n&&n.c(),o=pe()},m(a,d){~t&&s[t].m(a,d),I(a,o,d),i=!0},p(a,d){let h=t;t=l(a),t===h?~t&&s[t].p(a,d):(n&&(ye(),W(s[h],1,1,()=>{s[h]=null}),_e()),~t?(n=s[t],n?n.p(a,d):(n=s[t]=r[t](a),n.c()),z(n,1),n.m(o.parentNode,o)):n=null)},i(a){i||(z(n),i=!0)},o(a){W(n),i=!1},d(a){~t&&s[t].d(a),a&&k(o)}}}function ir(e){let t=e[2],n,o,i=Dn(e);return{c(){i.c(),n=pe()},m(r,s){i.m(r,s),I(r,n,s),o=!0},p(r,s){s[0]&4&&$(t,t=r[2])?(ye(),W(i,1,1,j),_e(),i=Dn(r),i.c(),z(i,1),i.m(n.parentNode,n)):i.p(r,s)},i(r){o||(z(i),o=!0)},o(r){W(i),o=!1},d(r){r&&k(n),i.d(r)}}}function rr(e){let t,n,o=e[6],i=[];for(let s=0;s<o.length;s+=1)i[s]=Rn(vn(e,o,s));const r=s=>W(i[s],1,1,()=>{i[s]=null});return{c(){for(let s=0;s<i.length;s+=1)i[s].c();t=pe()},m(s,l){for(let a=0;a<i.length;a+=1)i[a]&&i[a].m(s,l);I(s,t,l),n=!0},p(s,l){if(l[0]&279634){o=s[6];let a;for(a=0;a<o.length;a+=1){const d=vn(s,o,a);i[a]?(i[a].p(d,l),z(i[a],1)):(i[a]=Rn(d),i[a].c(),z(i[a],1),i[a].m(t.parentNode,t))}for(ye(),a=o.length;a<i.length;a+=1)r(a);_e()}},i(s){if(!n){for(let l=0;l<o.length;l+=1)z(i[l]);n=!0}},o(s){i=i.filter(Boolean);for(let l=0;l<i.length;l+=1)W(i[l]);n=!1},d(s){lt(i,s),s&&k(t)}}}function Dn(e){let t,n;return t=new pn({props:{target:e[4],tool:e[12],drawingMode:e[11],transform:e[10],viewportScale:e[14]}}),t.$on("create",e[17]),{c(){me(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,i){const r={};i[0]&16&&(r.target=o[4]),i[0]&4096&&(r.tool=o[12]),i[0]&2048&&(r.drawingMode=o[11]),i[0]&1024&&(r.transform=o[10]),i[0]&16384&&(r.viewportScale=o[14]),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function Yn(e){let t,n;return t=new gn({props:{target:e[4],editor:pt(e[29].target.selector),annotation:e[29],style:e[1],transform:e[10],viewportScale:e[14]}}),t.$on("change",function(){q(e[18](e[29]))&&e[18](e[29]).apply(this,arguments)}),{c(){me(t.$$.fragment)},m(o,i){le(t,o,i),n=!0},p(o,i){e=o;const r={};i[0]&16&&(r.target=e[4]),i[0]&64&&(r.editor=pt(e[29].target.selector)),i[0]&64&&(r.annotation=e[29]),i[0]&2&&(r.style=e[1]),i[0]&1024&&(r.transform=e[10]),i[0]&16384&&(r.viewportScale=e[14]),t.$set(r)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){W(t.$$.fragment,o),n=!1},d(o){ae(t,o)}}}function Rn(e){let t=e[29].id,n,o,i=Yn(e);return{c(){i.c(),n=pe()},m(r,s){i.m(r,s),I(r,n,s),o=!0},p(r,s){s[0]&64&&$(t,t=r[29].id)?(ye(),W(i,1,1,j),_e(),i=Yn(r),i.c(),z(i,1),i.m(n.parentNode,n)):i.p(r,s)},i(r){o||(z(i),o=!0)},o(r){W(i),o=!1},d(r){r&&k(n),i.d(r)}}}function sr(e){let t,n,o,i,r,s,l=e[13],a=[];for(let f=0;f<l.length;f+=1)a[f]=Pn(On(e,l,f));const d=f=>W(a[f],1,1,()=>{a[f]=null});let h=e[4]&&Bn(e);return{c(){t=C("svg"),n=C("g");for(let f=0;f<a.length;f+=1)a[f].c();o=C("g"),h&&h.c(),c(o,"class","drawing"),c(t,"class","a9s-annotationlayer"),Pt(t,"drawing",e[12])},m(f,m){I(f,t,m),ge(t,n);for(let u=0;u<a.length;u+=1)a[u]&&a[u].m(n,null);ge(t,o),h&&h.m(o,null),e[25](o),e[26](t),i=!0,r||(s=[J(t,"pointerup",function(){q(e[8])&&e[8].apply(this,arguments)}),J(t,"pointerdown",function(){q(e[9])&&e[9].apply(this,arguments)})],r=!0)},p(f,m){if(e=f,m[0]&8322){l=e[13];let u;for(u=0;u<l.length;u+=1){const g=On(e,l,u);a[u]?(a[u].p(g,m),z(a[u],1)):(a[u]=Pn(g),a[u].c(),z(a[u],1),a[u].m(n,null))}for(ye(),u=l.length;u<a.length;u+=1)d(u);_e()}e[4]?h?(h.p(e,m),m[0]&16&&z(h,1)):(h=Bn(e),h.c(),z(h,1),h.m(o,null)):h&&(ye(),W(h,1,1,()=>{h=null}),_e()),(!i||m[0]&4096)&&Pt(t,"drawing",e[12])},i(f){if(!i){for(let m=0;m<l.length;m+=1)z(a[m]);z(h),i=!0}},o(f){a=a.filter(Boolean);for(let m=0;m<a.length;m+=1)W(a[m]);W(h),i=!1},d(f){f&&k(t),lt(a,f),h&&h.d(),e[25](null),e[26](null),r=!1,he(s)}}}function lr(e,t,n){let o,i,r,s,l,a,d,h,f,m,u=j,g=()=>(u(),u=vt(y,O=>n(14,m=O)),y);e.$$.on_destroy.push(()=>u());let{drawingEnabled:w}=t,{image:S}=t,{preferredDrawingMode:E}=t,{state:p}=t,{style:b=void 0}=t,{toolName:T=it().length>0?it()[0]:void 0}=t,{user:M}=t,D,V,y;Te(()=>g(n(5,y=wn(S,V))));const{selection:_,store:A}=p;Ot(e,_,O=>n(24,h=O)),Ot(e,A,O=>n(13,f=O));let L=null,P=null;const Y=O=>{A.unobserve(L);const G=O.filter(({editable:N})=>N).map(({id:N})=>N);G.length>0?(n(6,P=G.map(N=>A.getAnnotation(N))),L=N=>{const{updated:de}=N.changes;n(6,P=de.map(Z=>Z.newValue))},A.observe(L,{annotations:G})):n(6,P=null)},R=O=>{const G=Jt(),N={id:G,bodies:[],target:{annotation:G,selector:O.detail,creator:M,created:new Date}};A.addAnnotation(N),_.setSelected(N.id)},U=O=>G=>{var we;const{target:N}=O,de=10*60*1e3,Z=((we=N.creator)==null?void 0:we.id)!==M.id||!N.created||new Date().getTime()-N.created.getTime()>de;A.updateTarget({...N,selector:G.detail,created:Z?N.created:new Date,updated:Z?new Date:null,updatedBy:Z?M:null})};function ue(O){He[O?"unshift":"push"](()=>{D=O,n(4,D)})}function H(O){He[O?"unshift":"push"](()=>{V=O,n(3,V)})}return e.$$set=O=>{"drawingEnabled"in O&&n(0,w=O.drawingEnabled),"image"in O&&n(19,S=O.image),"preferredDrawingMode"in O&&n(20,E=O.preferredDrawingMode),"state"in O&&n(21,p=O.state),"style"in O&&n(1,b=O.style),"toolName"in O&&n(2,T=O.toolName),"user"in O&&n(22,M=O.user)},e.$$.update=()=>{e.$$.dirty[0]&4&&n(12,{tool:o,opts:i}=wt(T),o,(n(23,i),n(2,T))),e.$$.dirty[0]&9437184&&n(11,r=(i==null?void 0:i.drawingMode)||E),e.$$.dirty[0]&8&&n(10,s=Mn(V)),e.$$.dirty[0]&8&&n(9,{onPointerDown:l,onPointerUp:a}=Ln(V,A),l,(n(8,a),n(3,V))),e.$$.dirty[0]&16777216&&n(7,d=O=>h.selected.find(G=>G.id===O.id&&G.editable)),e.$$.dirty[0]&16777216&&Y(h.selected)},[w,b,T,V,D,y,P,d,a,l,s,r,o,f,m,_,A,R,U,S,E,p,M,i,h,ue,H]}class Xn extends ie{constructor(t){super(),oe(this,t,lr,sr,$,{drawingEnabled:0,image:19,preferredDrawingMode:20,state:21,style:1,toolName:2,user:22},null,[-1,-1])}}function ar(e,t,n,o,i){Cn(e,t,n||0,o||e.length-1,i||cr)}function Cn(e,t,n,o,i){for(;o>n;){if(o-n>600){var r=o-n+1,s=t-n+1,l=Math.log(r),a=.5*Math.exp(2*l/3),d=.5*Math.sqrt(l*a*(r-a)/r)*(s-r/2<0?-1:1),h=Math.max(n,Math.floor(t-s*a/r+d)),f=Math.min(o,Math.floor(t+(r-s)*a/r+d));Cn(e,t,h,f,i)}var m=e[t],u=n,g=o;for(Qe(e,n,t),i(e[o],m)>0&&Qe(e,n,o);u<g;){for(Qe(e,u,g),u++,g--;i(e[u],m)<0;)u++;for(;i(e[g],m)>0;)g--}i(e[n],m)===0?Qe(e,n,g):(g++,Qe(e,g,o)),g<=t&&(n=g+1),t<=g&&(o=g-1)}}function Qe(e,t,n){var o=e[t];e[t]=e[n],e[n]=o}function cr(e,t){return e<t?-1:e>t?1:0}class fr{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let n=this.data;const o=[];if(!st(t,n))return o;const i=this.toBBox,r=[];for(;n;){for(let s=0;s<n.children.length;s++){const l=n.children[s],a=n.leaf?i(l):l;st(t,a)&&(n.leaf?o.push(l):At(t,a)?this._all(l,o):r.push(l))}n=r.pop()}return o}collides(t){let n=this.data;if(!st(t,n))return!1;const o=[];for(;n;){for(let i=0;i<n.children.length;i++){const r=n.children[i],s=n.leaf?this.toBBox(r):r;if(st(t,s)){if(n.leaf||At(t,s))return!0;o.push(r)}}n=o.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let o=0;o<t.length;o++)this.insert(t[o]);return this}let n=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=n;else if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const o=this.data;this.data=n,n=o}this._insert(n,this.data.height-n.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=Xe([]),this}remove(t,n){if(!t)return this;let o=this.data;const i=this.toBBox(t),r=[],s=[];let l,a,d;for(;o||r.length;){if(o||(o=r.pop(),a=r[r.length-1],l=s.pop(),d=!0),o.leaf){const h=ur(t,o.children,n);if(h!==-1)return o.children.splice(h,1),r.push(o),this._condense(r),this}!d&&!o.leaf&&At(o,i)?(r.push(o),s.push(l),l=0,a=o,o=o.children[0]):a?(l++,o=a.children[l],d=!1):o=null}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,n){const o=[];for(;t;)t.leaf?n.push(...t.children):o.push(...t.children),t=o.pop();return n}_build(t,n,o,i){const r=o-n+1;let s=this._maxEntries,l;if(r<=s)return l=Xe(t.slice(n,o+1)),Re(l,this.toBBox),l;i||(i=Math.ceil(Math.log(r)/Math.log(s)),s=Math.ceil(r/Math.pow(s,i-1))),l=Xe([]),l.leaf=!1,l.height=i;const a=Math.ceil(r/s),d=a*Math.ceil(Math.sqrt(s));Un(t,n,o,d,this.compareMinX);for(let h=n;h<=o;h+=d){const f=Math.min(h+d-1,o);Un(t,h,f,a,this.compareMinY);for(let m=h;m<=f;m+=a){const u=Math.min(m+a-1,f);l.children.push(this._build(t,m,u,i-1))}}return Re(l,this.toBBox),l}_chooseSubtree(t,n,o,i){for(;i.push(n),!(n.leaf||i.length-1===o);){let r=1/0,s=1/0,l;for(let a=0;a<n.children.length;a++){const d=n.children[a],h=Et(d),f=mr(t,d)-h;f<s?(s=f,r=h<r?h:r,l=d):f===s&&h<r&&(r=h,l=d)}n=l||n.children[0]}return n}_insert(t,n,o){const i=o?t:this.toBBox(t),r=[],s=this._chooseSubtree(i,this.data,n,r);for(s.children.push(t),$e(s,i);n>=0&&r[n].children.length>this._maxEntries;)this._split(r,n),n--;this._adjustParentBBoxes(i,r,n)}_split(t,n){const o=t[n],i=o.children.length,r=this._minEntries;this._chooseSplitAxis(o,r,i);const s=this._chooseSplitIndex(o,r,i),l=Xe(o.children.splice(s,o.children.length-s));l.height=o.height,l.leaf=o.leaf,Re(o,this.toBBox),Re(l,this.toBBox),n?t[n-1].children.push(l):this._splitRoot(o,l)}_splitRoot(t,n){this.data=Xe([t,n]),this.data.height=t.height+1,this.data.leaf=!1,Re(this.data,this.toBBox)}_chooseSplitIndex(t,n,o){let i,r=1/0,s=1/0;for(let l=n;l<=o-n;l++){const a=xe(t,0,l,this.toBBox),d=xe(t,l,o,this.toBBox),h=gr(a,d),f=Et(a)+Et(d);h<r?(r=h,i=l,s=f<s?f:s):h===r&&f<s&&(s=f,i=l)}return i||o-n}_chooseSplitAxis(t,n,o){const i=t.leaf?this.compareMinX:dr,r=t.leaf?this.compareMinY:hr,s=this._allDistMargin(t,n,o,i),l=this._allDistMargin(t,n,o,r);s<l&&t.children.sort(i)}_allDistMargin(t,n,o,i){t.children.sort(i);const r=this.toBBox,s=xe(t,0,n,r),l=xe(t,o-n,o,r);let a=rt(s)+rt(l);for(let d=n;d<o-n;d++){const h=t.children[d];$e(s,t.leaf?r(h):h),a+=rt(s)}for(let d=o-n-1;d>=n;d--){const h=t.children[d];$e(l,t.leaf?r(h):h),a+=rt(l)}return a}_adjustParentBBoxes(t,n,o){for(let i=o;i>=0;i--)$e(n[i],t)}_condense(t){for(let n=t.length-1,o;n>=0;n--)t[n].children.length===0?n>0?(o=t[n-1].children,o.splice(o.indexOf(t[n]),1)):this.clear():Re(t[n],this.toBBox)}}function ur(e,t,n){if(!n)return t.indexOf(e);for(let o=0;o<t.length;o++)if(n(e,t[o]))return o;return-1}function Re(e,t){xe(e,0,e.children.length,t,e)}function xe(e,t,n,o,i){i||(i=Xe(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let r=t;r<n;r++){const s=e.children[r];$e(i,e.leaf?o(s):s)}return i}function $e(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function dr(e,t){return e.minX-t.minX}function hr(e,t){return e.minY-t.minY}function Et(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function rt(e){return e.maxX-e.minX+(e.maxY-e.minY)}function mr(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function gr(e,t){const n=Math.max(e.minX,t.minX),o=Math.max(e.minY,t.minY),i=Math.min(e.maxX,t.maxX),r=Math.min(e.maxY,t.maxY);return Math.max(0,i-n)*Math.max(0,r-o)}function At(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function st(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function Xe(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Un(e,t,n,o,i){const r=[t,n];for(;r.length;){if(n=r.pop(),t=r.pop(),n-t<=o)continue;const s=t+Math.ceil((n-t)/o/2)*o;ar(e,s,t,n,i),r.push(t,s,s,n)}}const pr=()=>{const e=new fr,t=new Map,n=()=>[...t.values()],o=()=>{e.clear(),t.clear()},i=f=>{const{minX:m,minY:u,maxX:g,maxY:w}=f.selector.geometry.bounds,S={minX:m,minY:u,maxX:g,maxY:w,target:f};e.insert(S),t.set(f.annotation,S)},r=f=>{const m=t.get(f.annotation);e.remove(m),t.delete(f.annotation)};return{all:n,clear:o,getAt:(f,m)=>{const g=e.search({minX:f,minY:m,maxX:f,maxY:m}).map(w=>w.target).filter(w=>w.selector.type===K.RECTANGLE||Rt(w.selector,f,m));if(g.length>0)return g.sort((w,S)=>tt(w.selector)-tt(S.selector)),g[0]},getIntersecting:(f,m,u,g)=>e.search({minX:f,minY:m,maxX:f+u,maxY:m+g}).map(w=>w.target),insert:i,remove:r,set:(f,m=!0)=>{m&&o();const u=f.map(g=>{const{minX:w,minY:S,maxX:E,maxY:p}=g.selector.geometry.bounds;return{minX:w,minY:S,maxX:E,maxY:p,target:g}});u.forEach(g=>t.set(g.target.annotation,g)),e.load(u)},size:()=>e.all().length,update:(f,m)=>{r(f),i(m)}}},Nn=e=>{const t=Go(),n=pr(),o=Po(t,e.pointerSelectAction),i=Io(t),r=Wo();return t.observe(({changes:a})=>{n.set(a.created.map(d=>d.target),!1),a.deleted.forEach(d=>n.remove(d.target)),a.updated.forEach(({oldValue:d,newValue:h})=>n.update(d.target,h.target))}),{store:{...t,getAt:(a,d)=>{const h=n.getAt(a,d);return h?t.getAnnotation(h.annotation):void 0},getIntersecting:(a,d,h,f)=>n.getIntersecting(a,d,h,f).map(m=>t.getAnnotation(m.annotation))},selection:o,hover:i,viewport:r}},Vn=e=>{const t=Nn(e);return{...t,store:Fo(t.store)}},Gn=e=>{let t,n;if(e.nodeName==="CANVAS")t=e,n=t.getContext("2d",{willReadFrequently:!0});else{const i=e;t=document.createElement("canvas"),t.width=i.width,t.height=i.height,n=t.getContext("2d",{willReadFrequently:!0}),n.drawImage(i,0,0,i.width,i.height)}let o=0;for(let i=1;i<10;i++)for(let r=1;r<10;r++){const s=Math.round(r*t.width/10),l=Math.round(i*t.height/10),a=n.getImageData(s,l,1,1).data,d=(.299*a[0]+.587*a[1]+.114*a[2])/255;o+=d}return o/81},Fn=e=>{const t=Gn(e),n=t>.6?"dark":"light";return console.log(`[Annotorious] Image brightness: ${t.toFixed(1)}. Setting ${n} theme.`),n},St=(e,t,n)=>t.setAttribute("data-theme",n==="auto"?Fn(e):n),Hn=(e,t)=>({...e,drawingEnabled:e.drawingEnabled===void 0?t.drawingEnabled:e.drawingEnabled,drawingMode:e.drawingMode||t.drawingMode,pointerSelectAction:e.pointerSelectAction||t.pointerSelectAction,theme:e.theme||t.theme}),zn=navigator.userAgent.indexOf("Mac OS X")!==-1,jn=(e,t)=>{const n=t||document,o=s=>{s.key==="Z"&&s.ctrlKey?e.undo():s.key==="Y"&&s.ctrlKey&&e.redo()},i=s=>{s.key==="z"&&s.metaKey&&(s.shiftKey?e.redo():e.undo())},r=()=>{zn?n.removeEventListener("keydown",i):n.removeEventListener("keydown",o)};return zn?n.addEventListener("keydown",i):n.addEventListener("keydown",o),{destroy:r}},wr="",br="",Er="",yr=(e,t={})=>{if(!e)throw"Missing argument: image";const n=typeof e=="string"?document.getElementById(e):e,o=Hn(t,{drawingEnabled:!0,drawingMode:"drag",pointerSelectAction:xt.EDIT,theme:"light"}),i=Vn(o),{selection:r,store:s}=i,l=jo(s),a=Ko(i,l,o.adapter,o.autoSave),d=document.createElement("DIV");d.style.position="relative",d.style.display="inline-block",n.style.display="block",n.parentNode.insertBefore(d,n),d.appendChild(n);const h=jn(l);let f=ei();St(n,d,o.theme);const m=new Xn({target:d,props:{drawingEnabled:o.drawingEnabled,image:n,preferredDrawingMode:o.drawingMode,state:i,style:o.style,user:f}});m.$on("click",y=>{const{originalEvent:_,annotation:A}=y.detail;A?r.clickSelect(A.id,_):r.isEmpty()||r.clear()});const u=Zo(i,l,o.adapter),g=()=>{m.$destroy(),d.parentNode.insertBefore(n,d),d.parentNode.removeChild(d),h.destroy(),l.destroy()},w=()=>f,S=(y,_,A)=>Tn(y,_,A),E=(y,_)=>hn(y,_),p=y=>{if(!wt(y))throw`No drawing tool named ${y}`;m.$set({toolName:y})},b=y=>m.$set({drawingEnabled:y}),T=y=>{console.warn("Filter not implemented yet")},M=y=>m.$set({style:y}),D=y=>St(n,d,y),V=y=>{f=y,m.$set({user:y})};return{...u,destroy:g,getUser:w,listDrawingTools:it,on:a.on,off:a.off,registerDrawingTool:S,registerShapeEditor:E,setDrawingEnabled:b,setDrawingTool:p,setFilter:T,setStyle:M,setTheme:D,setUser:V,state:i}};X.Editor=Je,X.EditorMount=gn,X.EllipseEditor=fn,X.FreehandEditor=un,X.Handle=v,X.IdentityTransform=Qi,X.PolygonEditor=an,X.RectangleEditor=cn,X.RectangleUtil=Xt,X.RubberbandRectangle=_n,X.SVGAnnotationLayer=Xn,X.ShapeType=K,X.ToolMount=pn,X.W3CImageFormat=ii,X.addEventListeners=Ln,X.boundsFromPoints=Ae,X.computeArea=tt,X.createImageAnnotator=yr,X.createImageAnnotatorState=Nn,X.createSVGTransform=Mn,X.createSvelteImageAnnotatorState=Vn,X.detectTheme=Fn,X.distance=ot,X.enableResponsive=wn,X.fillDefaults=Hn,X.getEditor=pt,X.getTool=wt,X.initKeyboardCommands=jn,X.intersects=Rt,X.isTouch=Li,X.listDrawingTools=it,X.parseFragmentSelector=Ct,X.parseSVGSelector=Kt,X.parseW3CImageAnnotation=tn,X.registerEditor=hn,X.registerShapeUtil=ze,X.registerTool=Tn,X.sampleBrightness=Gn,X.serializeFragmentSelector=Ut,X.serializeSVGSelector=qt,X.serializeW3CImageAnnotation=nn,X.setTheme=St,Object.defineProperty(X,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=annotorious.js.map
