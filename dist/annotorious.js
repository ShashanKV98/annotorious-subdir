(function(D,H){typeof exports=="object"&&typeof module<"u"?H(exports):typeof define=="function"&&define.amd?define(["exports"],H):(D=typeof globalThis<"u"?globalThis:D||self,H(D.Annotorious={}))})(this,function(D){"use strict";function H(){}function vn(e,t){for(const n in t)e[n]=t[n];return e}function gt(e){return e()}function pt(){return Object.create(null)}function ie(e){e.forEach(gt)}function z(e){return typeof e=="function"}function Z(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function In(e){return Object.keys(e).length===0}function yt(e,...t){if(e==null)return H;const n=e.subscribe(...t);return n.unsubscribe?()=>n.unsubscribe():n}function _t(e,t,n){e.$$.on_destroy.push(yt(t,n))}function Pn(e,t,n,o){if(e){const i=wt(e,t,n,o);return e[0](i)}}function wt(e,t,n,o){return e[1]&&o?vn(n.ctx.slice(),e[1](o(t))):n.ctx}function Bn(e,t,n,o){if(e[2]&&o){const i=e[2](o(n));if(t.dirty===void 0)return i;if(typeof i=="object"){const s=[],r=Math.max(t.dirty.length,i.length);for(let a=0;a<r;a+=1)s[a]=t.dirty[a]|i[a];return s}return t.dirty|i}return t.dirty}function Yn(e,t,n,o,i,s){if(i){const r=wt(t,n,o,s);e.p(r,i)}}function Dn(e){if(e.ctx.length>32){const t=[],n=e.ctx.length/32;for(let o=0;o<n;o++)t[o]=-1;return t}return-1}function ue(e,t){e.appendChild(t)}function v(e,t,n){e.insertBefore(t,n||null)}function k(e){e.parentNode&&e.parentNode.removeChild(e)}function Ze(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function X(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function bt(e){return document.createTextNode(e)}function x(){return bt(" ")}function se(){return bt("")}function j(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)}function c(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function Rn(e){return Array.from(e.childNodes)}function Et(e,t,n){e.classList[n?"add":"remove"](t)}function Xn(e,t,{bubbles:n=!1,cancelable:o=!1}={}){const i=document.createEvent("CustomEvent");return i.initCustomEvent(e,n,o,t),i}let Oe;function ke(e){Oe=e}function At(){if(!Oe)throw new Error("Function called outside component initialization");return Oe}function _e(e){At().$$.on_mount.push(e)}function he(){const e=At();return(t,n,{cancelable:o=!1}={})=>{const i=e.$$.callbacks[t];if(i){const s=Xn(t,n,{cancelable:o});return i.slice().forEach(r=>{r.call(e,s)}),!s.defaultPrevented}return!0}}function re(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach(o=>o.call(this,t))}const we=[],ve=[];let be=[];const Tt=[],Cn=Promise.resolve();let Qe=!1;function Un(){Qe||(Qe=!0,Cn.then(St))}function xe(e){be.push(e)}const $e=new Set;let Ee=0;function St(){if(Ee!==0)return;const e=Oe;do{try{for(;Ee<we.length;){const t=we[Ee];Ee++,ke(t),Nn(t.$$)}}catch(t){throw we.length=0,Ee=0,t}for(ke(null),we.length=0,Ee=0;ve.length;)ve.pop()();for(let t=0;t<be.length;t+=1){const n=be[t];$e.has(n)||($e.add(n),n())}be.length=0}while(we.length);for(;Tt.length;)Tt.pop()();Qe=!1,$e.clear(),ke(e)}function Nn(e){if(e.fragment!==null){e.update(),ie(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(xe)}}function Vn(e){const t=[],n=[];be.forEach(o=>e.indexOf(o)===-1?t.push(o):n.push(o)),n.forEach(o=>o()),be=t}const Re=new Set;let me;function le(){me={r:0,c:[],p:me}}function ae(){me.r||ie(me.c),me=me.p}function G(e,t){e&&e.i&&(Re.delete(e),e.i(t))}function F(e,t,n,o){if(e&&e.o){if(Re.has(e))return;Re.add(e),me.c.push(()=>{Re.delete(e),o&&(n&&e.d(1),o())}),e.o(t)}else o&&o()}function de(e){e&&e.c()}function ce(e,t,n,o){const{fragment:i,after_update:s}=e.$$;i&&i.m(t,n),o||xe(()=>{const r=e.$$.on_mount.map(gt).filter(z);e.$$.on_destroy?e.$$.on_destroy.push(...r):ie(r),e.$$.on_mount=[]}),s.forEach(xe)}function fe(e,t){const n=e.$$;n.fragment!==null&&(Vn(n.after_update),ie(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function Gn(e,t){e.$$.dirty[0]===-1&&(we.push(e),Un(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function ee(e,t,n,o,i,s,r,a=[-1]){const l=Oe;ke(e);const u=e.$$={fragment:null,ctx:[],props:s,update:H,not_equal:i,bound:pt(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(l?l.$$.context:[])),callbacks:pt(),dirty:a,skip_bound:!1,root:t.target||l.$$.root};r&&r(u.root);let m=!1;if(u.ctx=n?n(e,t.props||{},(f,h,...d)=>{const g=d.length?d[0]:h;return u.ctx&&i(u.ctx[f],u.ctx[f]=g)&&(!u.skip_bound&&u.bound[f]&&u.bound[f](g),m&&Gn(e,f)),h}):[],u.update(),m=!0,ie(u.before_update),u.fragment=o?o(u.ctx):!1,t.target){if(t.hydrate){const f=Rn(t.target);u.fragment&&u.fragment.l(f),f.forEach(k)}else u.fragment&&u.fragment.c();t.intro&&G(e.$$.fragment),ce(e,t.target,t.anchor,t.customElement),St()}ke(l)}class te{$destroy(){fe(this,1),this.$destroy=H}$on(t,n){if(!z(n))return H;const o=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return o.push(n),()=>{const i=o.indexOf(n);i!==-1&&o.splice(i,1)}}$set(t){this.$$set&&!In(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}var K=(e=>(e.ELLIPSE="ELLIPSE",e.POLYGON="POLYGON",e.RECTANGLE="RECTANGLE",e.FREEHAND="FREEHAND",e))(K||{});const et={},Xe=(e,t)=>et[e]=t,Ce=e=>et[e.type].area(e),Mt=(e,t,n)=>et[e.type].intersects(e,t,n),Ie=e=>{let t=1/0,n=1/0,o=-1/0,i=-1/0;return e.forEach(([s,r])=>{t=Math.min(t,s),n=Math.min(n,r),o=Math.max(o,s),i=Math.max(i,r)}),{minX:t,minY:n,maxX:o,maxY:i}},Hn={area:e=>Math.PI*e.geometry.rx*e.geometry.ry,intersects:(e,t,n)=>{const{cx:o,cy:i,rx:s,ry:r}=e.geometry,a=0,l=Math.cos(a),u=Math.sin(a),m=t-o,f=n-i,h=l*m+u*f,d=u*m-l*f;return h*h/(s*s)+d*d/(r*r)<=1}};Xe(K.ELLIPSE,Hn);const Fn={area:e=>{const{points:t}=e.geometry;let n=0,o=t.length-1;for(let i=0;i<t.length;i++)n+=(t[o][0]+t[i][0])*(t[o][1]-t[i][1]),o=i;return Math.abs(.5*n)},intersects:(e,t,n)=>{const{points:o}=e.geometry;let i=!1;for(let s=0,r=o.length-1;s<o.length;r=s++){const a=o[s][0],l=o[s][1],u=o[r][0],m=o[r][1];l>n!=m>n&&t<(u-a)*(n-l)/(m-l)+a&&(i=!i)}return i}};Xe(K.POLYGON,Fn);const Lt={area:e=>e.geometry.w*e.geometry.h,intersects:(e,t,n)=>t>=e.geometry.x&&t<=e.geometry.x+e.geometry.w&&n>=e.geometry.y&&n<=e.geometry.y+e.geometry.h};Xe(K.RECTANGLE,Lt);const Ot=(e,t=!1)=>{const n=typeof e=="string"?e:e.value,o=/^(xywh)=(pixel|percent)?:?(.+?),(.+?),(.+?),(.+)*/g,i=[...n.matchAll(o)][0],[s,r,a,l,u,m,f]=i;if(r!=="xywh")throw new Error("Unsupported MediaFragment: "+n);if(a&&a!=="pixel")throw new Error(`Unsupported MediaFragment unit: ${a}`);const[h,d,g,b]=[l,u,m,f].map(parseFloat);return{type:K.RECTANGLE,geometry:{x:h,y:d,w:g,h:b,bounds:{minX:h,minY:t?d-b:d,maxX:h+g,maxY:t?d:d+b}}}},kt=e=>{const{x:t,y:n,w:o,h:i}=e;return{type:"FragmentSelector",conformsTo:"http://www.w3.org/TR/media-frags/",value:`xywh=pixel:${t},${n},${o},${i}`}},vt="http://www.w3.org/2000/svg",It=e=>{const t=o=>{Array.from(o.attributes).forEach(i=>{i.name.startsWith("on")&&o.removeAttribute(i.name)})},n=e.getElementsByTagName("script");return Array.from(n).reverse().forEach(o=>o.parentNode.removeChild(o)),Array.from(e.querySelectorAll("*")).forEach(t),e},zn=e=>{const o=new XMLSerializer().serializeToString(e.documentElement).replace("<svg>",`<svg xmlns="${vt}">`);return new DOMParser().parseFromString(o,"image/svg+xml").documentElement},jn=e=>{const n=new DOMParser().parseFromString(e,"image/svg+xml"),o=n.lookupPrefix(vt),i=n.lookupNamespaceURI(null);return o||i?It(n).firstChild:It(zn(n)).firstChild},Kn=e=>{const[t,n,o]=e.match(/(<polygon points=["|'])([^("|')]*)/)||[];if(!o)return;const i=o.split(" ").map(s=>s.split(",").map(parseFloat));return{type:K.POLYGON,geometry:{points:i,bounds:Ie(i)}}},Wn=e=>{const t=jn(e),n=parseFloat(t.getAttribute("cx")),o=parseFloat(t.getAttribute("cy")),i=parseFloat(t.getAttribute("rx")),s=parseFloat(t.getAttribute("ry")),r={minX:n-i,minY:o-s,maxX:n+i,maxY:o+s};return{type:K.ELLIPSE,geometry:{cx:n,cy:o,rx:i,ry:s,bounds:r}}},Pt=e=>{const t=typeof e=="string"?e:e.value;if(t.includes("<polygon points="))return Kn(t);if(t.includes("<ellipse "))return Wn(t)},Bt=e=>{let t;if(e.type===K.POLYGON){const n=e.geometry,{points:o}=n;t=`<svg><polygon points="${o.map(i=>i.join(",")).join(" ")}" /></svg>`}else if(e.type===K.ELLIPSE){const n=e.geometry;t=`<svg><ellipse cx="${n.cx}" cy="${n.cy}" rx="${n.rx}" ry="${n.ry}" /></svg>`}if(t)return{type:"SvgSelector",value:t};throw`Unsupported shape type: ${e.type}`};let Ue;const qn=new Uint8Array(16);function Jn(){if(!Ue&&(Ue=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Ue))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ue(qn)}const Q=[];for(let e=0;e<256;++e)Q.push((e+256).toString(16).slice(1));function Zn(e,t=0){return Q[e[t+0]]+Q[e[t+1]]+Q[e[t+2]]+Q[e[t+3]]+"-"+Q[e[t+4]]+Q[e[t+5]]+"-"+Q[e[t+6]]+Q[e[t+7]]+"-"+Q[e[t+8]]+Q[e[t+9]]+"-"+Q[e[t+10]]+Q[e[t+11]]+Q[e[t+12]]+Q[e[t+13]]+Q[e[t+14]]+Q[e[t+15]]}const Yt={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Dt(e,t,n){if(Yt.randomUUID&&!t&&!e)return Yt.randomUUID();e=e||{};const o=e.random||(e.rng||Jn)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,t){n=n||0;for(let i=0;i<16;++i)t[n+i]=o[i];return t}return Zn(o)}var Rt=Object.prototype.hasOwnProperty;function ge(e,t){var n,o;if(e===t)return!0;if(e&&t&&(n=e.constructor)===t.constructor){if(n===Date)return e.getTime()===t.getTime();if(n===RegExp)return e.toString()===t.toString();if(n===Array){if((o=e.length)===t.length)for(;o--&&ge(e[o],t[o]););return o===-1}if(!n||typeof e=="object"){o=0;for(n in e)if(Rt.call(e,n)&&++o&&!Rt.call(t,n)||!(n in t)||!ge(e[n],t[n]))return!1;return Object.keys(t).length===o}}return e!==e&&t!==t}function tt(){}function Qn(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}const Ae=[];function nt(e,t=tt){let n;const o=new Set;function i(a){if(Qn(e,a)&&(e=a,n)){const l=!Ae.length;for(const u of o)u[1](),Ae.push(u,e);if(l){for(let u=0;u<Ae.length;u+=2)Ae[u][0](Ae[u+1]);Ae.length=0}}}function s(a){i(a(e))}function r(a,l=tt){const u=[a,l];return o.add(u),o.size===1&&(n=t(i)||tt),a(e),()=>{o.delete(u),o.size===0&&n&&(n(),n=null)}}return{set:i,update:s,subscribe:r}}const xn=e=>{const{subscribe:t,set:n}=nt(null);let o=null;return t(i=>o=i),e.observe(({changes:i})=>{if(o){i.deleted.some(r=>r.id===o)&&n(null);const s=i.updated.find(({oldValue:r})=>r.id===o);s&&n(s.newValue.id)}}),{get current(){return o},subscribe:t,set:n}};var Xt=(e=>(e.EDIT="EDIT",e.SELECT="SELECT",e.NONE="NONE",e))(Xt||{});const ot={selected:[]},$n=(e,t="EDIT")=>{const{subscribe:n,set:o}=nt(ot);let i=ot;n(f=>i=f);const s=()=>o(ot),r=()=>{var f;return((f=i.selected)==null?void 0:f.length)===0},a=f=>{if(i.selected.length===0)return!1;const h=typeof f=="string"?f:f.id;return i.selected.some(d=>d.id===h)},l=(f,h)=>{const d=e.getAnnotation(f);if(d){const g=eo(d,t);o(g==="EDIT"?{selected:[{id:f,editable:!0}],pointerEvent:h}:g==="SELECT"?{selected:[{id:f}],pointerEvent:h}:{selected:[],pointerEvent:h})}else console.warn("Invalid selection: "+f)},u=(f,h=!0)=>{const d=Array.isArray(f)?f:[f],g=d.map(b=>e.getAnnotation(b)).filter(b=>b);o({selected:g.map(({id:b})=>({id:b,editable:h}))}),g.length!==d.length&&console.warn("Invalid selection",f)},m=f=>{if(i.selected.length===0)return!1;const{selected:h}=i;h.filter(({id:d})=>f.includes(d)).length>0&&o({selected:h.filter(({id:d})=>!f.includes(d))})};return e.observe(({changes:f})=>m(f.deleted.map(h=>h.id))),{clear:s,clickSelect:l,get selected(){return i?[...i.selected]:null},get pointerEvent(){return i?i.pointerEvent:null},isEmpty:r,isSelected:a,setSelected:u,subscribe:n}},eo=(e,t)=>typeof t=="function"?t(e)||"EDIT":t||"EDIT",to=[];for(let e=0;e<256;++e)to.push((e+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const no=(e,t)=>{const n=new Set(e.bodies.map(o=>o.id));return t.bodies.filter(o=>!n.has(o.id))},oo=(e,t)=>{const n=new Set(t.bodies.map(o=>o.id));return e.bodies.filter(o=>!n.has(o.id))},io=(e,t)=>t.bodies.map(n=>{const o=e.bodies.find(i=>i.id===n.id);return{newBody:n,oldBody:o&&!ge(o,n)?o:void 0}}).filter(({oldBody:n})=>n),so=(e,t)=>!ge(e.target,t.target),Ct=(e,t)=>{const n=no(e,t),o=oo(e,t),i=io(e,t);return{oldValue:e,newValue:t,bodiesCreated:n.length>0?n:void 0,bodiesDeleted:o.length>0?o:void 0,bodiesUpdated:i.length>0?i:void 0,targetUpdated:so(e,t)?{oldTarget:e.target,newTarget:t.target}:void 0}};var W=(e=>(e.LOCAL="LOCAL",e.REMOTE="REMOTE",e))(W||{});const ro=(e,t)=>{var n,o;const{changes:i,origin:s}=t;if(!(!e.options.origin||e.options.origin===s))return!1;if(e.options.ignore){const{ignore:r}=e.options,a=l=>(l==null?void 0:l.length)>0;if(!(a(i.created)||a(i.deleted))){const l=(n=i.updated)==null?void 0:n.some(m=>a(m.bodiesCreated)||a(m.bodiesDeleted)||a(m.bodiesUpdated)),u=(o=i.updated)==null?void 0:o.some(m=>m.targetUpdated);if(r==="BODY_ONLY"&&l&&!u||r==="TARGET_ONLY"&&u&&!l)return!1}}if(e.options.annotations){const r=new Set([...i.created.map(a=>a.id),...i.deleted.map(a=>a.id),...i.updated.map(({oldValue:a})=>a.id)]);return!!(Array.isArray(e.options.annotations)?e.options.annotations:[e.options.annotations]).find(a=>r.has(a))}else return!0},lo=(e,t)=>{const n=new Set((e.created||[]).map(f=>f.id)),o=new Set((e.updated||[]).map(({newValue:f})=>f.id)),i=new Set((t.created||[]).map(f=>f.id)),s=new Set((t.deleted||[]).map(f=>f.id)),r=new Set((t.updated||[]).map(({oldValue:f})=>f.id)),a=new Set((t.updated||[]).filter(({oldValue:f})=>n.has(f.id)||o.has(f.id)).map(({oldValue:f})=>f.id)),l=[...(e.created||[]).filter(f=>!s.has(f.id)).map(f=>r.has(f.id)?t.updated.find(({oldValue:h})=>h.id===f.id).newValue:f),...t.created||[]],u=[...(e.deleted||[]).filter(f=>!i.has(f.id)),...(t.deleted||[]).filter(f=>!n.has(f.id))],m=[...(e.updated||[]).filter(({newValue:f})=>!s.has(f.id)).map(f=>{const{oldValue:h,newValue:d}=f;if(r.has(d.id)){const g=t.updated.find(b=>b.oldValue.id===d.id).newValue;return Ct(h,g)}else return f}),...(t.updated||[]).filter(({oldValue:f})=>!a.has(f.id))];return{created:l,deleted:u,updated:m}},ao=e=>e.id!==void 0,co=()=>{const e=new Map,t=new Map,n=[],o=(p,y={})=>n.push({onChange:p,options:y}),i=p=>{const y=n.findIndex(E=>E.onChange==p);y>-1&&n.splice(y,1)},s=(p,y)=>{const E={origin:p,changes:{created:y.created||[],updated:y.updated||[],deleted:y.deleted||[]},state:[...e.values()]};n.forEach(L=>{ro(L,E)&&L.onChange(E)})},r=(p,y=W.LOCAL)=>{if(e.get(p.id))throw Error(`Cannot add annotation ${p.id} - exists already`);e.set(p.id,p),p.bodies.forEach(E=>t.set(E.id,p.id)),s(y,{created:[p]})},a=(p,y)=>{const E=typeof p=="string"?y:p,L=typeof p=="string"?p:p.id,P=e.get(L);if(P){const U=Ct(P,E);return L===E.id?e.set(L,E):(e.delete(L),e.set(E.id,E)),P.bodies.forEach(N=>t.delete(N.id)),E.bodies.forEach(N=>t.set(N.id,E.id)),U}else console.warn(`Cannot update annotation ${L} - does not exist`)},l=(p,y=W.LOCAL,E=W.LOCAL)=>{const L=ao(y)?E:y,P=a(p,y);P&&s(L,{updated:[P]})},u=(p,y=W.LOCAL)=>{const E=p.reduce((L,P)=>{const U=a(P);return U?[...L,U]:L},[]);E.length>0&&s(y,{updated:E})},m=(p,y=W.LOCAL)=>{const E=e.get(p.annotation);if(E){const L={...E,bodies:[...E.bodies,p]};e.set(E.id,L),t.set(p.id,L.id),s(y,{updated:[{oldValue:E,newValue:L,bodiesCreated:[p]}]})}else console.warn(`Attempt to add body to missing annotation: ${p.annotation}`)},f=()=>[...e.values()],h=(p=W.LOCAL)=>{const y=[...e.values()];e.clear(),t.clear(),s(p,{deleted:y})},d=(p,y=!0,E=W.LOCAL)=>{if(y){const L=[...e.values()];e.clear(),t.clear(),p.forEach(P=>{e.set(P.id,P),P.bodies.forEach(U=>t.set(U.id,P.id))}),s(E,{created:p,deleted:L})}else{const L=p.reduce((P,U)=>{const N=e.get(U.id);return N?[...P,N]:P},[]);if(L.length>0)throw Error(`Bulk insert would overwrite the following annotations: ${L.map(P=>P.id).join(", ")}`);p.forEach(P=>{e.set(P.id,P),P.bodies.forEach(U=>t.set(U.id,P.id))}),s(E,{created:p})}},g=p=>{const y=typeof p=="string"?p:p.id,E=e.get(y);if(E)return e.delete(y),E.bodies.forEach(L=>t.delete(L.id)),E;console.warn(`Attempt to delete missing annotation: ${y}`)},b=(p,y=W.LOCAL)=>{const E=g(p);E&&s(y,{deleted:[E]})},T=(p,y=W.LOCAL)=>{const E=p.reduce((L,P)=>{const U=g(P);return U?[...L,U]:L},[]);E.length>0&&s(y,{deleted:E})},w=(p,y=W.LOCAL)=>{const E=e.get(p.annotation);if(E){const L=E.bodies.find(P=>P.id===p.id);if(L){t.delete(L.id);const P={...E,bodies:E.bodies.filter(U=>U.id!==p.id)};e.set(E.id,P),s(y,{updated:[{oldValue:E,newValue:P,bodiesDeleted:[L]}]})}else console.warn(`Attempt to delete missing body ${p.id} from annotation ${p.annotation}`)}else console.warn(`Attempt to delete body from missing annotation ${p.annotation}`)},_=p=>{const y=e.get(p);return y?{...y}:void 0},A=p=>{const y=t.get(p);if(y){const E=_(y).bodies.find(L=>L.id===p);if(E)return E;console.error(`Store integrity error: body ${p} in index, but not in annotation`)}else console.warn(`Attempt to retrieve missing body: ${p}`)},S=(p,y)=>{if(p.annotation!==y.annotation)throw"Annotation integrity violation: annotation ID must be the same when updating bodies";const E=e.get(p.annotation);if(E){const L=E.bodies.find(U=>U.id===p.id),P={...E,bodies:E.bodies.map(U=>U.id===L.id?y:U)};return e.set(E.id,P),L.id!==y.id&&(t.delete(L.id),t.set(y.id,P.id)),{oldValue:E,newValue:P,bodiesUpdated:[{oldBody:L,newBody:y}]}}else console.warn(`Attempt to add body to missing annotation ${p.annotation}`)},O=(p,y,E=W.LOCAL)=>{const L=S(p,y);s(E,{updated:[L]})},Y=(p,y=W.LOCAL)=>{const E=p.map(L=>S({id:L.id,annotation:L.annotation},L));s(y,{updated:E})},V=p=>{const y=e.get(p.annotation);if(y){const E={...y,target:{...y.target,...p}};return e.set(y.id,E),{oldValue:y,newValue:E,targetUpdated:{oldTarget:y.target,newTarget:p}}}else console.warn(`Attempt to update target on missing annotation: ${p.annotation}`)};return{addAnnotation:r,addBody:m,all:f,bulkAddAnnotation:d,bulkDeleteAnnotation:T,bulkUpdateAnnotation:u,bulkUpdateBodies:Y,bulkUpdateTargets:(p,y=W.LOCAL)=>{const E=p.map(V).filter(L=>L);E.length>0&&s(y,{updated:E})},clear:h,deleteAnnotation:b,deleteBody:w,getAnnotation:_,getBody:A,observe:o,unobserve:i,updateAnnotation:l,updateBody:O,updateTarget:(p,y=W.LOCAL)=>{const E=V(p);E&&s(y,{updated:[E]})}}},fo=e=>({...e,subscribe:t=>{const n=o=>t(o.state);return e.observe(n),t(e.all()),()=>e.unobserve(n)}});let uo=()=>({emit(e,...t){let n=this.events[e]||[];for(let o=0,i=n.length;o<i;o++)n[o](...t)},events:{},on(e,t){var n;return(n=this.events[e])!=null&&n.push(t)||(this.events[e]=[t]),()=>{var o;this.events[e]=(o=this.events[e])==null?void 0:o.filter(i=>t!==i)}}});const ho=250,mo=e=>{const t=uo(),n=[];let o=-1,i=!1,s=0;const r=d=>{if(!i){const{changes:g}=d,b=performance.now();if(b-s>ho)n.splice(o+1),n.push(g),o=n.length-1;else{const T=n.length-1;n[T]=lo(n[T],g)}s=b}i=!1};e.observe(r,{origin:W.LOCAL});const a=d=>(d==null?void 0:d.length)>0&&e.bulkDeleteAnnotation(d),l=d=>(d==null?void 0:d.length)>0&&e.bulkAddAnnotation(d,!1),u=d=>(d==null?void 0:d.length)>0&&e.bulkUpdateAnnotation(d.map(({oldValue:g})=>g)),m=d=>(d==null?void 0:d.length)>0&&e.bulkUpdateAnnotation(d.map(({newValue:g})=>g)),f=d=>(d==null?void 0:d.length)>0&&e.bulkAddAnnotation(d,!1),h=d=>(d==null?void 0:d.length)>0&&e.bulkDeleteAnnotation(d);return{canRedo:()=>n.length-1>o,canUndo:()=>o>-1,destroy:()=>e.unobserve(r),on:(d,g)=>t.on(d,g),redo:()=>{if(n.length-1>o){i=!0;const{created:d,updated:g,deleted:b}=n[o+1];l(d),m(g),h(b),t.emit("redo",n[o+1]),o+=1}},undo:()=>{if(o>-1){i=!0;const{created:d,updated:g,deleted:b}=n[o];a(d),u(g),f(b),t.emit("undo",n[o]),o-=1}}}},go=()=>{const{subscribe:e,set:t}=nt([]);return{subscribe:e,set:t}},po=(e,t,n,o)=>{const{store:i,selection:s,hover:r,viewport:a}=e,l=new Map;let u=[],m,f;const h=(w,_)=>{l.has(w)?l.get(w).push(_):l.set(w,[_])},d=(w,_)=>{const A=l.get(w);A&&A.indexOf(_)>0&&A.splice(A.indexOf(_),1)},g=(w,_,A)=>{l.has(w)&&setTimeout(()=>{l.get(w).forEach(S=>{if(n){const O=Array.isArray(_)?_.map(V=>n.serialize(V)):n.serialize(_),Y=A?A instanceof PointerEvent?A:n.serialize(A):void 0;S(O,Y)}else S(_,A)})},1)},b=()=>{const{selected:w}=s,_=w.map(({id:A})=>i.getAnnotation(A));_.forEach(A=>{const S=u.find(O=>O.id===A.id);(!S||!ge(S,A))&&g("updateAnnotation",A,S)}),u=u.map(A=>_.find(({id:O})=>O===A.id)||A)};s.subscribe(({selected:w})=>{if(!(u.length===0&&w.length===0)){if(u.length===0&&w.length>0)u=w.map(({id:_})=>i.getAnnotation(_));else if(u.length>0&&w.length===0)u.forEach(_=>{const A=i.getAnnotation(_.id);A&&!ge(A,_)&&g("updateAnnotation",A,_)}),u=[];else{const _=new Set(u.map(S=>S.id)),A=new Set(w.map(({id:S})=>S));u.filter(S=>!A.has(S.id)).forEach(S=>{const O=i.getAnnotation(S.id);O&&!ge(O,S)&&g("updateAnnotation",O,S)}),u=[...u.filter(S=>A.has(S.id)),...w.filter(({id:S})=>!_.has(S)).map(({id:S})=>i.getAnnotation(S))]}g("selectionChanged",u)}}),r.subscribe(w=>{!m&&w?g("mouseEnterAnnotation",i.getAnnotation(w)):m&&!w?g("mouseLeaveAnnotation",i.getAnnotation(m)):m&&w&&(g("mouseLeaveAnnotation",i.getAnnotation(m)),g("mouseEnterAnnotation",i.getAnnotation(w))),m=w}),a==null||a.subscribe(w=>g("viewportIntersect",w.map(i.getAnnotation))),i.observe(w=>{o&&(f&&clearTimeout(f),f=setTimeout(b,1e3));const{created:_,deleted:A}=w.changes;_.forEach(S=>g("createAnnotation",S)),A.forEach(S=>g("deleteAnnotation",S)),w.changes.updated.filter(S=>[...S.bodiesCreated||[],...S.bodiesDeleted||[],...S.bodiesUpdated||[]].length>0).forEach(({oldValue:S,newValue:O})=>{const Y=u.find(V=>V.id===S.id)||S;u=u.map(V=>V.id===S.id?O:V),g("updateAnnotation",O,Y)})},{origin:W.LOCAL}),i.observe(w=>{if(u){const _=new Set(u.map(S=>S.id)),A=w.changes.updated.filter(({newValue:S})=>_.has(S.id)).map(({newValue:S})=>S);A.length>0&&(u=u.map(S=>A.find(Y=>Y.id===S.id)||S))}},{origin:W.REMOTE});const T=w=>_=>{const{created:A,deleted:S,updated:O}=_;A.forEach(Y=>g("createAnnotation",Y)),S.forEach(Y=>g("deleteAnnotation",Y)),w?O.forEach(Y=>g("updateAnnotation",Y.oldValue,Y.newValue)):O.forEach(Y=>g("updateAnnotation",Y.newValue,Y.oldValue))};return t.on("undo",T(!0)),t.on("redo",T(!1)),{on:h,off:d,emit:g}},yo=e=>t=>t.reduce((n,o)=>{const{parsed:i,error:s}=e.parse(o);return s?{parsed:n.parsed,failed:[...n.failed,o]}:{parsed:[...n.parsed,i],failed:n.failed}},{parsed:[],failed:[]}),_o=(e,t,n)=>{const{store:o,selection:i}=e,s=T=>{if(n){const{parsed:w,error:_}=n.parse(T);w?o.addAnnotation(w,W.REMOTE):console.error(_)}else o.addAnnotation(T,W.REMOTE)},r=()=>i.clear(),a=()=>o.clear(),l=T=>{const w=o.getAnnotation(T);return n&&w?n.serialize(w):w},u=()=>n?o.all().map(n.serialize):o.all(),m=()=>{var T;const w=(((T=i.selected)==null?void 0:T.map(_=>_.id))||[]).map(_=>o.getAnnotation(_));return n?w.map(n.serialize):w},f=T=>fetch(T).then(w=>w.json()).then(w=>(d(w),w)),h=T=>{if(typeof T=="string"){const w=o.getAnnotation(T);return o.deleteAnnotation(T),n?n.serialize(w):w}else{const w=n?n.parse(T).parsed:T;return o.deleteAnnotation(w),T}},d=T=>{if(n){const{parsed:w,failed:_}=yo(n)(T);_.length>0&&console.warn(`Discarded ${_.length} invalid annotations`,_),o.bulkAddAnnotation(w,!0,W.REMOTE)}else o.bulkAddAnnotation(T,!0,W.REMOTE)},g=T=>{T?i.setSelected(T):i.clear()},b=T=>{if(n){const w=n.parse(T).parsed,_=n.serialize(o.getAnnotation(w.id));return o.updateAnnotation(w),_}else{const w=o.getAnnotation(T.id);return o.updateAnnotation(T),w}};return{addAnnotation:s,cancelSelected:r,canRedo:t.canRedo,canUndo:t.canUndo,clearAnnotations:a,getAnnotationById:l,getAnnotations:u,getSelected:m,loadAnnotations:f,redo:t.redo,removeAnnotation:h,setAnnotations:d,setSelected:g,undo:t.undo,updateAnnotation:b}};let wo=e=>crypto.getRandomValues(new Uint8Array(e)),bo=(e,t,n)=>{let o=(2<<Math.log(e.length-1)/Math.LN2)-1,i=-~(1.6*o*t/e.length);return(s=t)=>{let r="";for(;;){let a=n(i),l=i;for(;l--;)if(r+=e[a[l]&o]||"",r.length===s)return r}}},Eo=(e,t=21)=>bo(e,t,wo),Ao=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((t,n)=>(n&=63,n<36?t+=n.toString(36):n<62?t+=(n-26).toString(36).toUpperCase():n>62?t+="-":t+="_",t),"");const To=()=>({isGuest:!0,id:Eo("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",20)()}),So=e=>{const t=JSON.stringify(e);let n=0;for(let o=0,i=t.length;o<i;o++){let s=t.charCodeAt(o);n=(n<<5)-n+s,n|=0}return`${n}`},Ut=e=>e?typeof e=="object"?{...e}:e:void 0,Mo=(e,t)=>(Array.isArray(e)?e:[e]).map(n=>{const{id:o,type:i,purpose:s,value:r,created:a,creator:l,...u}=n;return{id:o||`temp-${So(n)}`,annotation:t,type:i,purpose:s,value:r,created:a?new Date(a):void 0,creator:Ut(l),...u}}),Lo=e=>e.map(t=>{var n;const o={...t};return delete o.annotation,(n=o.id)!=null&&n.startsWith("temp-")&&delete o.id,o});Ao();const Oo=(e,t=!1)=>({parse:i=>Nt(i,t),serialize:i=>Vt(i,e)}),Nt=(e,t=!1)=>{const n=e.id||Dt(),{creator:o,created:i,updatedBy:s,updated:r,body:a,...l}=e,u=Mo(a,n),m=Array.isArray(e.target)?e.target[0]:e.target,f=Array.isArray(m.selector)?m.selector[0]:m.selector,h=f.type==="FragmentSelector"?Ot(f,t):f.type==="SvgSelector"?Pt(f):void 0;return h?{parsed:{...l,id:n,bodies:u,target:{created:i?new Date(i):void 0,creator:Ut(o),...l.target,annotation:n,selector:h}}}:{error:Error(`Unknown selector type: ${f.type}`)}},Vt=(e,t)=>{const{selector:n,creator:o,created:i,updated:s,updatedBy:r,...a}=e.target,l=n.type==K.RECTANGLE?kt(n.geometry):Bt(n);return{...e,"@context":"http://www.w3.org/ns/anno.jsonld",id:e.id,type:"Annotation",body:Lo(e.bodies),creator:o,created:i==null?void 0:i.toISOString(),target:{...a,source:t,selector:l}}};function Gt(e,t,n){const o=e.slice();return o[11]=t[n],o[13]=n,o}function Ht(e){let t,n,o,i,s;return{c(){t=X("rect"),c(t,"class","a9s-corner-handle"),c(t,"x",n=e[11][0]-e[3]/2),c(t,"y",o=e[11][1]-e[3]/2),c(t,"height",e[3]),c(t,"width",e[3])},m(r,a){v(r,t,a),i||(s=j(t,"pointerdown",function(){z(e[10](M(e[13])))&&e[10](M(e[13])).apply(this,arguments)}),i=!0)},p(r,a){e=r,a&24&&n!==(n=e[11][0]-e[3]/2)&&c(t,"x",n),a&24&&o!==(o=e[11][1]-e[3]/2)&&c(t,"y",o),a&8&&c(t,"height",e[3]),a&8&&c(t,"width",e[3])},d(r){r&&k(t),i=!1,s()}}}function ko(e){let t,n,o,i,s,r,a,l,u,m,f=e[4].points,h=[];for(let d=0;d<f.length;d+=1)h[d]=Ht(Gt(e,f,d));return{c(){t=X("polygon"),i=x(),s=X("polygon"),a=x();for(let d=0;d<h.length;d+=1)h[d].c();l=se(),c(t,"class","a9s-outer"),c(t,"style",n=e[1]?"display:none;":void 0),c(t,"points",o=e[4].points.map(Ft).join(" ")),c(s,"class","a9s-inner a9s-shape-handle"),c(s,"style",e[1]),c(s,"points",r=e[4].points.map(zt).join(" "))},m(d,g){v(d,t,g),v(d,i,g),v(d,s,g),v(d,a,g);for(let b=0;b<h.length;b+=1)h[b]&&h[b].m(d,g);v(d,l,g),u||(m=[j(t,"pointerdown",function(){z(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)}),j(s,"pointerdown",function(){z(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)})],u=!0)},p(d,g){if(e=d,g&2&&n!==(n=e[1]?"display:none;":void 0)&&c(t,"style",n),g&16&&o!==(o=e[4].points.map(Ft).join(" "))&&c(t,"points",o),g&2&&c(s,"style",e[1]),g&16&&r!==(r=e[4].points.map(zt).join(" "))&&c(s,"points",r),g&1048){f=e[4].points;let b;for(b=0;b<f.length;b+=1){const T=Gt(e,f,b);h[b]?h[b].p(T,g):(h[b]=Ht(T),h[b].c(),h[b].m(l.parentNode,l))}for(;b<h.length;b+=1)h[b].d(1);h.length=f.length}},d(d){d&&k(t),d&&k(i),d&&k(s),d&&k(a),Ze(h,d),d&&k(l),u=!1,ie(m)}}}function vo(e){let t,n;return t=new Ne({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[ko,({grab:o})=>({10:o}),({grab:o})=>o?1024:0]},$$scope:{ctx:e}}}),t.$on("change",e[7]),t.$on("grab",e[8]),t.$on("release",e[9]),{c(){de(t.$$.fragment)},m(o,i){ce(t,o,i),n=!0},p(o,[i]){const s={};i&1&&(s.shape=o[0]),i&4&&(s.transform=o[2]),i&17434&&(s.$$scope={dirty:i,ctx:o}),t.$set(s)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){F(t.$$.fragment,o),n=!1},d(o){fe(t,o)}}}const Ft=e=>e.join(","),zt=e=>e.join(",");function Io(e,t,n){let o,i,{shape:s}=t,{computedStyle:r=void 0}=t,{transform:a}=t,{viewportScale:l=1}=t;const u=(d,g,b)=>{let T;g===M.SHAPE?T=d.geometry.points.map(([_,A])=>[_+b[0],A+b[1]]):T=d.geometry.points.map(([_,A],S)=>g===M(S)?[_+b[0],A+b[1]]:[_,A]);const w=Ie(T);return{...d,geometry:{points:T,bounds:w}}};function m(d){re.call(this,e,d)}function f(d){re.call(this,e,d)}function h(d){re.call(this,e,d)}return e.$$set=d=>{"shape"in d&&n(0,s=d.shape),"computedStyle"in d&&n(1,r=d.computedStyle),"transform"in d&&n(2,a=d.transform),"viewportScale"in d&&n(6,l=d.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=s.geometry),e.$$.dirty&64&&n(3,i=10/l)},[s,r,a,i,o,u,l,m,f,h]}class jt extends te{constructor(t){super(),ee(this,t,Io,vo,Z,{shape:0,computedStyle:1,transform:2,viewportScale:6})}}function Po(e){let t,n,o,i,s,r,a,l,u,m,f,h,d,g,b,T,w,_,A,S,O,Y,V,p,y,E,L,P,U,N,R,Le,De,B,$,q,pe,J,ye,je,dt,ne,Ke,We,ht,oe,qe,Je,mt,kn;return{c(){t=X("rect"),a=x(),l=X("rect"),d=x(),g=X("rect"),_=x(),A=X("rect"),V=x(),p=X("rect"),P=x(),U=X("rect"),De=x(),B=X("rect"),pe=x(),J=X("rect"),dt=x(),ne=X("rect"),ht=x(),oe=X("rect"),c(t,"class","a9s-outer"),c(t,"style",n=e[1]?"display:none;":void 0),c(t,"x",o=e[4].x),c(t,"y",i=e[4].y),c(t,"width",s=e[4].w),c(t,"height",r=e[4].h),c(l,"class","a9s-inner a9s-shape-handle"),c(l,"style",e[1]),c(l,"x",u=e[4].x),c(l,"y",m=e[4].y),c(l,"width",f=e[4].w),c(l,"height",h=e[4].h),c(g,"class","a9s-edge-handle a9s-edge-handle-top"),c(g,"x",b=e[4].x),c(g,"y",T=e[4].y),c(g,"height",1),c(g,"width",w=e[4].w),c(A,"class","a9s-edge-handle a9s-edge-handle-right"),c(A,"x",S=e[4].x+e[4].w),c(A,"y",O=e[4].y),c(A,"height",Y=e[4].h),c(A,"width",1),c(p,"class","a9s-edge-handle a9s-edge-handle-bottom"),c(p,"x",y=e[4].x),c(p,"y",E=e[4].y+e[4].h),c(p,"height",1),c(p,"width",L=e[4].w),c(U,"class","a9s-edge-handle a9s-edge-handle-left"),c(U,"x",N=e[4].x),c(U,"y",R=e[4].y),c(U,"height",Le=e[4].h),c(U,"width",1),c(B,"class","a9s-corner-handle a9s-corner-handle-topleft"),c(B,"x",$=e[4].x-e[3]/2),c(B,"y",q=e[4].y-e[3]/2),c(B,"height",e[3]),c(B,"width",e[3]),c(J,"class","a9s-corner-handle a9s-corner-handle-topright"),c(J,"x",ye=e[4].x+e[4].w-e[3]/2),c(J,"y",je=e[4].y-e[3]/2),c(J,"height",e[3]),c(J,"width",e[3]),c(ne,"class","a9s-corner-handle a9s-corner-handle-bottomright"),c(ne,"x",Ke=e[4].x+e[4].w-e[3]/2),c(ne,"y",We=e[4].y+e[4].h-e[3]/2),c(ne,"height",e[3]),c(ne,"width",e[3]),c(oe,"class","a9s-corner-handle a9s-corner-handle-bottomleft"),c(oe,"x",qe=e[4].x-e[3]/2),c(oe,"y",Je=e[4].y+e[4].h-e[3]/2),c(oe,"height",e[3]),c(oe,"width",e[3])},m(C,I){v(C,t,I),v(C,a,I),v(C,l,I),v(C,d,I),v(C,g,I),v(C,_,I),v(C,A,I),v(C,V,I),v(C,p,I),v(C,P,I),v(C,U,I),v(C,De,I),v(C,B,I),v(C,pe,I),v(C,J,I),v(C,dt,I),v(C,ne,I),v(C,ht,I),v(C,oe,I),mt||(kn=[j(t,"pointerdown",function(){z(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)}),j(l,"pointerdown",function(){z(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)}),j(g,"pointerdown",function(){z(e[10](M.TOP))&&e[10](M.TOP).apply(this,arguments)}),j(A,"pointerdown",function(){z(e[10](M.RIGHT))&&e[10](M.RIGHT).apply(this,arguments)}),j(p,"pointerdown",function(){z(e[10](M.BOTTOM))&&e[10](M.BOTTOM).apply(this,arguments)}),j(U,"pointerdown",function(){z(e[10](M.LEFT))&&e[10](M.LEFT).apply(this,arguments)}),j(B,"pointerdown",function(){z(e[10](M.TOP_LEFT))&&e[10](M.TOP_LEFT).apply(this,arguments)}),j(J,"pointerdown",function(){z(e[10](M.TOP_RIGHT))&&e[10](M.TOP_RIGHT).apply(this,arguments)}),j(ne,"pointerdown",function(){z(e[10](M.BOTTOM_RIGHT))&&e[10](M.BOTTOM_RIGHT).apply(this,arguments)}),j(oe,"pointerdown",function(){z(e[10](M.BOTTOM_LEFT))&&e[10](M.BOTTOM_LEFT).apply(this,arguments)})],mt=!0)},p(C,I){e=C,I&2&&n!==(n=e[1]?"display:none;":void 0)&&c(t,"style",n),I&16&&o!==(o=e[4].x)&&c(t,"x",o),I&16&&i!==(i=e[4].y)&&c(t,"y",i),I&16&&s!==(s=e[4].w)&&c(t,"width",s),I&16&&r!==(r=e[4].h)&&c(t,"height",r),I&2&&c(l,"style",e[1]),I&16&&u!==(u=e[4].x)&&c(l,"x",u),I&16&&m!==(m=e[4].y)&&c(l,"y",m),I&16&&f!==(f=e[4].w)&&c(l,"width",f),I&16&&h!==(h=e[4].h)&&c(l,"height",h),I&16&&b!==(b=e[4].x)&&c(g,"x",b),I&16&&T!==(T=e[4].y)&&c(g,"y",T),I&16&&w!==(w=e[4].w)&&c(g,"width",w),I&16&&S!==(S=e[4].x+e[4].w)&&c(A,"x",S),I&16&&O!==(O=e[4].y)&&c(A,"y",O),I&16&&Y!==(Y=e[4].h)&&c(A,"height",Y),I&16&&y!==(y=e[4].x)&&c(p,"x",y),I&16&&E!==(E=e[4].y+e[4].h)&&c(p,"y",E),I&16&&L!==(L=e[4].w)&&c(p,"width",L),I&16&&N!==(N=e[4].x)&&c(U,"x",N),I&16&&R!==(R=e[4].y)&&c(U,"y",R),I&16&&Le!==(Le=e[4].h)&&c(U,"height",Le),I&24&&$!==($=e[4].x-e[3]/2)&&c(B,"x",$),I&24&&q!==(q=e[4].y-e[3]/2)&&c(B,"y",q),I&8&&c(B,"height",e[3]),I&8&&c(B,"width",e[3]),I&24&&ye!==(ye=e[4].x+e[4].w-e[3]/2)&&c(J,"x",ye),I&24&&je!==(je=e[4].y-e[3]/2)&&c(J,"y",je),I&8&&c(J,"height",e[3]),I&8&&c(J,"width",e[3]),I&24&&Ke!==(Ke=e[4].x+e[4].w-e[3]/2)&&c(ne,"x",Ke),I&24&&We!==(We=e[4].y+e[4].h-e[3]/2)&&c(ne,"y",We),I&8&&c(ne,"height",e[3]),I&8&&c(ne,"width",e[3]),I&24&&qe!==(qe=e[4].x-e[3]/2)&&c(oe,"x",qe),I&24&&Je!==(Je=e[4].y+e[4].h-e[3]/2)&&c(oe,"y",Je),I&8&&c(oe,"height",e[3]),I&8&&c(oe,"width",e[3])},d(C){C&&k(t),C&&k(a),C&&k(l),C&&k(d),C&&k(g),C&&k(_),C&&k(A),C&&k(V),C&&k(p),C&&k(P),C&&k(U),C&&k(De),C&&k(B),C&&k(pe),C&&k(J),C&&k(dt),C&&k(ne),C&&k(ht),C&&k(oe),mt=!1,ie(kn)}}}function Bo(e){let t,n;return t=new Ne({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[Po,({grab:o})=>({10:o}),({grab:o})=>o?1024:0]},$$scope:{ctx:e}}}),t.$on("grab",e[7]),t.$on("change",e[8]),t.$on("release",e[9]),{c(){de(t.$$.fragment)},m(o,i){ce(t,o,i),n=!0},p(o,[i]){const s={};i&1&&(s.shape=o[0]),i&4&&(s.transform=o[2]),i&3098&&(s.$$scope={dirty:i,ctx:o}),t.$set(s)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){F(t.$$.fragment,o),n=!1},d(o){fe(t,o)}}}function Yo(e,t,n){let o,i,{shape:s}=t,{computedStyle:r=void 0}=t,{transform:a}=t,{viewportScale:l=1}=t;const u=(d,g,b)=>{const T=d.geometry.bounds;let[w,_]=[T.minX,T.minY],[A,S]=[T.maxX,T.maxY];const[O,Y]=b;if(g===M.SHAPE)w+=O,A+=O,_+=Y,S+=Y;else{switch(g){case M.TOP:case M.TOP_LEFT:case M.TOP_RIGHT:{_+=Y;break}case M.BOTTOM:case M.BOTTOM_LEFT:case M.BOTTOM_RIGHT:{S+=Y;break}}switch(g){case M.LEFT:case M.TOP_LEFT:case M.BOTTOM_LEFT:{w+=O;break}case M.RIGHT:case M.TOP_RIGHT:case M.BOTTOM_RIGHT:{A+=O;break}}}const V=Math.min(w,A),p=Math.min(_,S),y=Math.abs(A-w),E=Math.abs(S-_);return{...d,geometry:{x:V,y:p,w:y,h:E,bounds:{minX:V,minY:p,maxX:V+y,maxY:p+E}}}};function m(d){re.call(this,e,d)}function f(d){re.call(this,e,d)}function h(d){re.call(this,e,d)}return e.$$set=d=>{"shape"in d&&n(0,s=d.shape),"computedStyle"in d&&n(1,r=d.computedStyle),"transform"in d&&n(2,a=d.transform),"viewportScale"in d&&n(6,l=d.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=s.geometry),e.$$.dirty&64&&n(3,i=10/l)},[s,r,a,i,o,u,l,m,f,h]}class Kt extends te{constructor(t){super(),ee(this,t,Yo,Bo,Z,{shape:0,computedStyle:1,transform:2,viewportScale:6})}}function Do(e){let t,n,o,i,s,r,a,l,u,m,f,h,d,g,b,T,w,_,A,S,O,Y,V,p,y,E,L,P,U;return{c(){t=X("ellipse"),r=x(),a=X("ellipse"),h=x(),d=X("rect"),T=x(),w=X("rect"),S=x(),O=X("rect"),p=x(),y=X("rect"),c(t,"class","a9s-outer"),c(t,"cx",n=e[3].cx),c(t,"cy",o=e[3].cy),c(t,"rx",i=e[3].rx),c(t,"ry",s=e[3].ry),c(a,"class","a9s-inner a9s-shape-handle"),c(a,"cx",l=e[3].cx),c(a,"cy",u=e[3].cy),c(a,"rx",m=e[3].rx),c(a,"ry",f=e[3].ry),c(d,"class","a9s-corner-handle a9s-corner-top"),c(d,"x",g=e[3].cx-e[2]/2),c(d,"y",b=e[3].cy-e[2]/2-e[3].ry),c(d,"height",e[2]),c(d,"width",e[2]),c(w,"class","a9s-corner-handle a9s-corner-handle-right"),c(w,"x",_=e[3].cx+e[3].rx-e[2]/2),c(w,"y",A=e[3].cy-e[2]/2),c(w,"height",e[2]),c(w,"width",e[2]),c(O,"class","a9s-corner-handle a9s-corner-handle-bottom"),c(O,"x",Y=e[3].cx-e[2]/2),c(O,"y",V=e[3].cy+e[3].ry-e[2]/2),c(O,"height",e[2]),c(O,"width",e[2]),c(y,"class","a9s-corner-handle a9s-corner-handle-left"),c(y,"x",E=e[3].cx-e[3].rx-e[2]/2),c(y,"y",L=e[3].cy-e[2]/2),c(y,"height",e[2]),c(y,"width",e[2])},m(N,R){v(N,t,R),v(N,r,R),v(N,a,R),v(N,h,R),v(N,d,R),v(N,T,R),v(N,w,R),v(N,S,R),v(N,O,R),v(N,p,R),v(N,y,R),P||(U=[j(t,"pointerdown",function(){z(e[9](M.SHAPE))&&e[9](M.SHAPE).apply(this,arguments)}),j(a,"pointerdown",function(){z(e[9](M.SHAPE))&&e[9](M.SHAPE).apply(this,arguments)}),j(d,"pointerdown",function(){z(e[9](M.TOP))&&e[9](M.TOP).apply(this,arguments)}),j(w,"pointerdown",function(){z(e[9](M.RIGHT))&&e[9](M.RIGHT).apply(this,arguments)}),j(O,"pointerdown",function(){z(e[9](M.BOTTOM))&&e[9](M.BOTTOM).apply(this,arguments)}),j(y,"pointerdown",function(){z(e[9](M.LEFT))&&e[9](M.LEFT).apply(this,arguments)})],P=!0)},p(N,R){e=N,R&8&&n!==(n=e[3].cx)&&c(t,"cx",n),R&8&&o!==(o=e[3].cy)&&c(t,"cy",o),R&8&&i!==(i=e[3].rx)&&c(t,"rx",i),R&8&&s!==(s=e[3].ry)&&c(t,"ry",s),R&8&&l!==(l=e[3].cx)&&c(a,"cx",l),R&8&&u!==(u=e[3].cy)&&c(a,"cy",u),R&8&&m!==(m=e[3].rx)&&c(a,"rx",m),R&8&&f!==(f=e[3].ry)&&c(a,"ry",f),R&12&&g!==(g=e[3].cx-e[2]/2)&&c(d,"x",g),R&12&&b!==(b=e[3].cy-e[2]/2-e[3].ry)&&c(d,"y",b),R&4&&c(d,"height",e[2]),R&4&&c(d,"width",e[2]),R&12&&_!==(_=e[3].cx+e[3].rx-e[2]/2)&&c(w,"x",_),R&12&&A!==(A=e[3].cy-e[2]/2)&&c(w,"y",A),R&4&&c(w,"height",e[2]),R&4&&c(w,"width",e[2]),R&12&&Y!==(Y=e[3].cx-e[2]/2)&&c(O,"x",Y),R&12&&V!==(V=e[3].cy+e[3].ry-e[2]/2)&&c(O,"y",V),R&4&&c(O,"height",e[2]),R&4&&c(O,"width",e[2]),R&12&&E!==(E=e[3].cx-e[3].rx-e[2]/2)&&c(y,"x",E),R&12&&L!==(L=e[3].cy-e[2]/2)&&c(y,"y",L),R&4&&c(y,"height",e[2]),R&4&&c(y,"width",e[2])},d(N){N&&k(t),N&&k(r),N&&k(a),N&&k(h),N&&k(d),N&&k(T),N&&k(w),N&&k(S),N&&k(O),N&&k(p),N&&k(y),P=!1,ie(U)}}}function Ro(e){let t,n;return t=new Ne({props:{shape:e[0],transform:e[1],editor:e[4],$$slots:{default:[Do,({grab:o})=>({9:o}),({grab:o})=>o?512:0]},$$scope:{ctx:e}}}),t.$on("grab",e[6]),t.$on("change",e[7]),t.$on("release",e[8]),{c(){de(t.$$.fragment)},m(o,i){ce(t,o,i),n=!0},p(o,[i]){const s={};i&1&&(s.shape=o[0]),i&2&&(s.transform=o[1]),i&1548&&(s.$$scope={dirty:i,ctx:o}),t.$set(s)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){F(t.$$.fragment,o),n=!1},d(o){fe(t,o)}}}function Xo(e,t,n){let o,i,{shape:s}=t,{transform:r}=t,{viewportScale:a=1}=t;const l=(h,d,g)=>{const b=h.geometry.bounds;let[T,w]=[b.minX,b.minY],[_,A]=[b.maxX,b.maxY];const[S,O]=g;if(d===M.SHAPE)T+=S,_+=S,w+=O,A+=O;else switch(d){case M.TOP:{w+=O;break}case M.BOTTOM:{A+=O;break}case M.LEFT:{T+=S;break}case M.RIGHT:{_+=S;break}}const Y=Math.min(T,_),V=Math.min(w,A),p=Math.abs(_-T),y=Math.abs(A-w),E=(T+_)/2,L=(w+A)/2,P=p/2,U=y/2;return{...h,geometry:{...h.geometry,cx:E,cy:L,rx:P,ry:U,bounds:{minX:Y,minY:V,maxX:Y+p,maxY:V+y}}}};function u(h){re.call(this,e,h)}function m(h){re.call(this,e,h)}function f(h){re.call(this,e,h)}return e.$$set=h=>{"shape"in h&&n(0,s=h.shape),"transform"in h&&n(1,r=h.transform),"viewportScale"in h&&n(5,a=h.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(3,o=s.geometry),e.$$.dirty&32&&n(2,i=10/a)},[s,r,i,o,l,a,u,m,f]}class Wt extends te{constructor(t){super(),ee(this,t,Xo,Ro,Z,{shape:0,transform:1,viewportScale:5})}}const qt=new Map([[K.RECTANGLE,Kt],[K.POLYGON,jt],[K.ELLIPSE,Wt]]),it=e=>qt.get(e.type),Jt=(e,t)=>qt.set(e,t),M=e=>`HANDLE-${e}`;M.SHAPE="SHAPE",M.TOP="TOP",M.RIGHT="RIGHT",M.BOTTOM="BOTTOM",M.LEFT="LEFT",M.TOP_LEFT="TOP_LEFT",M.TOP_RIGHT="TOP_RIGHT",M.BOTTOM_RIGHT="BOTTOM_RIGHT",M.BOTTOM_LEFT="BOTTOM_LEFT";const Co=e=>({}),Zt=e=>({grab:e[0]});function Uo(e){let t,n,o,i;const s=e[7].default,r=Pn(s,e,e[6],Zt);return{c(){t=X("g"),r&&r.c(),c(t,"class","a9s-annotation selected")},m(a,l){v(a,t,l),r&&r.m(t,null),n=!0,o||(i=[j(t,"pointerup",e[2]),j(t,"pointermove",e[1])],o=!0)},p(a,[l]){r&&r.p&&(!n||l&64)&&Yn(r,s,a,a[6],n?Bn(s,a[6],l,Co):Dn(a[6]),Zt)},i(a){n||(G(r,a),n=!0)},o(a){F(r,a),n=!1},d(a){a&&k(t),r&&r.d(a),o=!1,ie(i)}}}function No(e,t,n){let{$$slots:o={},$$scope:i}=t;const s=he();let{shape:r}=t,{editor:a}=t,{transform:l}=t,u=null,m,f=null;const h=b=>T=>{u=b,m=l.elementToImage(T.offsetX,T.offsetY),f=r,T.target.setPointerCapture(T.pointerId),s("grab")},d=b=>{if(u){const[T,w]=l.elementToImage(b.offsetX,b.offsetY),_=[T-m[0],w-m[1]];n(3,r=a(f,u,_)),s("change",r)}},g=b=>{b.target.releasePointerCapture(b.pointerId),u=null,f=r,s("release")};return e.$$set=b=>{"shape"in b&&n(3,r=b.shape),"editor"in b&&n(4,a=b.editor),"transform"in b&&n(5,l=b.transform),"$$scope"in b&&n(6,i=b.$$scope)},[h,d,g,r,a,l,i,o]}class Ne extends te{constructor(t){super(),ee(this,t,No,Uo,Z,{shape:3,editor:4,transform:5})}}const Ve=(e,t)=>{const n=typeof t=="function"?t(e):t;if(n){const{fill:o,fillOpacity:i}=n;let s="";return o&&(s+=`fill:${o};stroke:${o};`),s+=`fill-opacity:${i||"0.25"};`,s}};function Vo(e,t,n){let o;const i=he();let{annotation:s}=t,{editor:r}=t,{style:a=void 0}=t,{target:l}=t,{transform:u}=t,{viewportScale:m}=t,f;return _e(()=>(n(6,f=new r({target:l,props:{shape:s.target.selector,computedStyle:o,transform:u,viewportScale:m}})),f.$on("change",h=>{f.$$set({shape:h.detail}),i("change",h.detail)}),f.$on("grab",h=>i("grab",h.detail)),f.$on("release",h=>i("release",h.detail)),()=>{f.$destroy()})),e.$$set=h=>{"annotation"in h&&n(0,s=h.annotation),"editor"in h&&n(1,r=h.editor),"style"in h&&n(2,a=h.style),"target"in h&&n(3,l=h.target),"transform"in h&&n(4,u=h.transform),"viewportScale"in h&&n(5,m=h.viewportScale)},e.$$.update=()=>{e.$$.dirty&5&&(o=Ve(s,a)),e.$$.dirty&65&&s&&(f==null||f.$set({shape:s.target.selector})),e.$$.dirty&80&&f&&f.$set({transform:u}),e.$$.dirty&96&&f&&f.$set({viewportScale:m})},[s,r,a,l,u,m,f]}class Qt extends te{constructor(t){super(),ee(this,t,Vo,null,Z,{annotation:0,editor:1,style:2,target:3,transform:4,viewportScale:5})}}function Go(e,t,n){const o=he();let{drawingMode:i}=t,{target:s}=t,{tool:r}=t,{transform:a}=t,{viewportScale:l}=t,u;return _e(()=>{const m=s.closest("svg"),f=[],h=(d,g,b)=>{m.addEventListener(d,g,b),f.push(()=>m.removeEventListener(d,g,b))};return n(5,u=new r({target:s,props:{addEventListener:h,drawingMode:i,transform:a,viewportScale:l}})),u.$on("create",d=>o("create",d.detail)),()=>{f.forEach(d=>d()),u.$destroy()}}),e.$$set=m=>{"drawingMode"in m&&n(0,i=m.drawingMode),"target"in m&&n(1,s=m.target),"tool"in m&&n(2,r=m.tool),"transform"in m&&n(3,a=m.transform),"viewportScale"in m&&n(4,l=m.viewportScale)},e.$$.update=()=>{e.$$.dirty&40&&u&&u.$set({transform:a}),e.$$.dirty&48&&u&&u.$set({viewportScale:l})},[i,s,r,a,l,u]}class xt extends te{constructor(t){super(),ee(this,t,Go,null,Z,{drawingMode:0,target:1,tool:2,transform:3,viewportScale:4})}}function $t(e){let t,n;return{c(){t=X("rect"),n=X("rect"),c(t,"class","a9s-outer"),c(t,"x",e[1]),c(t,"y",e[2]),c(t,"width",e[3]),c(t,"height",e[4]),c(n,"class","a9s-inner"),c(n,"x",e[1]),c(n,"y",e[2]),c(n,"width",e[3]),c(n,"height",e[4])},m(o,i){v(o,t,i),v(o,n,i)},p(o,i){i&2&&c(t,"x",o[1]),i&4&&c(t,"y",o[2]),i&8&&c(t,"width",o[3]),i&16&&c(t,"height",o[4]),i&2&&c(n,"x",o[1]),i&4&&c(n,"y",o[2]),i&8&&c(n,"width",o[3]),i&16&&c(n,"height",o[4])},d(o){o&&k(t),o&&k(n)}}}function Ho(e){let t,n=e[0]&&$t(e);return{c(){t=X("g"),n&&n.c(),c(t,"class","a9s-annotation a9s-rubberband")},m(o,i){v(o,t,i),n&&n.m(t,null)},p(o,[i]){o[0]?n?n.p(o,i):(n=$t(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:H,o:H,d(o){o&&k(t),n&&n.d()}}}function Fo(e,t,n){const o=he();let{addEventListener:i}=t,{drawingMode:s}=t,{transform:r}=t,a,l,u,m,f,h,d;const g=_=>{a=performance.now(),s==="drag"&&(n(0,l=r.elementToImage(_.offsetX,_.offsetY)),u=l,n(1,m=l[0]),n(2,f=l[1]),n(3,h=1),n(4,d=1))},b=_=>{l&&(u=r.elementToImage(_.offsetX,_.offsetY),n(1,m=Math.min(u[0],l[0])),n(2,f=Math.min(u[1],l[1])),n(3,h=Math.abs(u[0]-l[0])),n(4,d=Math.abs(u[1]-l[1])))},T=_=>{const A=performance.now()-a;if(s==="click"){if(A>300)return;_.stopPropagation(),l?w():(n(0,l=r.elementToImage(_.offsetX,_.offsetY)),u=l,n(1,m=l[0]),n(2,f=l[1]),n(3,h=1),n(4,d=1))}else l&&(A>300||h*d>100?(_.stopPropagation(),w()):(n(0,l=null),u=null))},w=()=>{if(h*d>15){const _={type:K.RECTANGLE,geometry:{bounds:{minX:m,minY:f,maxX:m+h,maxY:f+d},x:m,y:f,w:h,h:d}};o("create",_)}n(0,l=null),u=null};return _e(()=>{i("pointerdown",g),i("pointermove",b),i("pointerup",T,!0)}),e.$$set=_=>{"addEventListener"in _&&n(5,i=_.addEventListener),"drawingMode"in _&&n(6,s=_.drawingMode),"transform"in _&&n(7,r=_.transform)},[l,m,f,h,d,i,s,r]}class en extends te{constructor(t){super(),ee(this,t,Fo,Ho,Z,{addEventListener:5,drawingMode:6,transform:7})}}const Ge=(e,t)=>{const n=Math.abs(t[0]-e[0]),o=Math.abs(t[1]-e[1]);return Math.sqrt(Math.pow(n,2)+Math.pow(o,2))},Te=[];function zo(e,t=H){let n;const o=new Set;function i(a){if(Z(e,a)&&(e=a,n)){const l=!Te.length;for(const u of o)u[1](),Te.push(u,e);if(l){for(let u=0;u<Te.length;u+=2)Te[u][0](Te[u+1]);Te.length=0}}}function s(a){i(a(e))}function r(a,l=H){const u=[a,l];return o.add(u),o.size===1&&(n=t(i)||H),a(e),()=>{o.delete(u),o.size===0&&n&&(n(),n=null)}}return{set:i,update:s,subscribe:r}}const jo=(e,t)=>{const{naturalWidth:n,naturalHeight:o}=e;if(!n&&!o){const{width:i,height:s}=e;t.setAttribute("viewBox",`0 0 ${i} ${s}`),e.addEventListener("load",r=>{const a=r.target;t.setAttribute("viewBox",`0 0 ${a.naturalWidth} ${a.naturalHeight}`)})}else t.setAttribute("viewBox",`0 0 ${n} ${o}`)},tn=(e,t)=>{jo(e,t);const{subscribe:n,set:o}=zo(1);let i;return window.ResizeObserver&&(i=new ResizeObserver(()=>{const r=t.getBoundingClientRect(),{width:a,height:l}=t.viewBox.baseVal,u=Math.max(r.width/a,r.height/l);o(u)}),i.observe(t.parentElement)),{destroy:()=>{i&&i.disconnect()},subscribe:n}},Ko="ontouchstart"in window||navigator.maxTouchPoints>0;function st(e){const t=e.slice(),n=(t[2]?t[0]:[...t[0],t[1]]).map(o=>o.join(",")).join(" ");return t[15]=n,t}function nn(e){let t,n,o,i,s,r=e[2]&&on(e);return{c(){t=X("polygon"),o=X("polygon"),r&&r.c(),s=se(),c(t,"class","a9s-outer"),c(t,"points",n=e[15]),c(o,"class","a9s-inner"),c(o,"points",i=e[15])},m(a,l){v(a,t,l),v(a,o,l),r&&r.m(a,l),v(a,s,l)},p(a,l){l&7&&n!==(n=a[15])&&c(t,"points",n),l&7&&i!==(i=a[15])&&c(o,"points",i),a[2]?r?r.p(a,l):(r=on(a),r.c(),r.m(s.parentNode,s)):r&&(r.d(1),r=null)},d(a){a&&k(t),a&&k(o),r&&r.d(a),a&&k(s)}}}function on(e){let t,n,o;return{c(){t=X("rect"),c(t,"class","a9s-corner-handle"),c(t,"x",n=e[0][0][0]-e[3]/2),c(t,"y",o=e[0][0][1]-e[3]/2),c(t,"height",e[3]),c(t,"width",e[3])},m(i,s){v(i,t,s)},p(i,s){s&9&&n!==(n=i[0][0][0]-i[3]/2)&&c(t,"x",n),s&9&&o!==(o=i[0][0][1]-i[3]/2)&&c(t,"y",o),s&8&&c(t,"height",i[3]),s&8&&c(t,"width",i[3])},d(i){i&&k(t)}}}function Wo(e){let t,n=e[1]&&nn(st(e));return{c(){t=X("g"),n&&n.c(),c(t,"class","a9s-annotation a9s-rubberband")},m(o,i){v(o,t,i),n&&n.m(t,null)},p(o,[i]){o[1]?n?n.p(st(o),i):(n=nn(st(o)),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:H,o:H,d(o){o&&k(t),n&&n.d()}}}const qo=20;function Jo(e,t,n){let o;const i=he();let{addEventListener:s}=t,{drawingMode:r}=t,{transform:a}=t,{viewportScale:l=1}=t,u,m=[],f=null,h=!1;const d=_=>{const{timeStamp:A,offsetX:S,offsetY:O}=_;if(u={timeStamp:A,offsetX:S,offsetY:O},r==="drag"&&m.length===0){const Y=a.elementToImage(_.offsetX,_.offsetY);m.push(Y),n(1,f=Y)}},g=_=>{if(m.length>0&&(n(1,f=a.elementToImage(_.offsetX,_.offsetY)),m.length>2)){const A=Ge(f,m[0])*l;n(2,h=A<qo)}},b=_=>{if(r==="click"){const A=_.timeStamp-u.timeStamp,S=Ge([u.offsetX,u.offsetY],[_.offsetX,_.offsetY]);if(A>300||S>15)return;if(h)w();else if(m.length===0){const O=a.elementToImage(_.offsetX,_.offsetY);m.push(O),n(1,f=O)}else m.push(f)}else{if(m.length===1&&Ge(m[0],f)<=4){n(0,m=[]),n(1,f=null);return}_.stopImmediatePropagation(),h?w():m.push(f)}},T=()=>{const _=[...m,f],A={type:K.POLYGON,geometry:{bounds:Ie(_),points:_}};Ce(A)>4&&(n(0,m=[]),n(1,f=null),i("create",A))},w=()=>{const _={type:K.POLYGON,geometry:{bounds:Ie(m),points:[...m]}};n(0,m=[]),n(1,f=null),i("create",_)};return _e(()=>{s("pointerdown",d,!0),s("pointermove",g),s("pointerup",b,!0),s("dblclick",T,!0)}),e.$$set=_=>{"addEventListener"in _&&n(4,s=_.addEventListener),"drawingMode"in _&&n(5,r=_.drawingMode),"transform"in _&&n(6,a=_.transform),"viewportScale"in _&&n(7,l=_.viewportScale)},e.$$.update=()=>{e.$$.dirty&128&&n(3,o=10/l)},[m,f,h,o,s,r,a,l]}class Zo extends te{constructor(t){super(),ee(this,t,Jo,Wo,Z,{addEventListener:4,drawingMode:5,transform:6,viewportScale:7})}}function sn(e){let t,n,o,i,s,r,a,l,u,m;return{c(){t=X("ellipse"),r=X("ellipse"),c(t,"class","a9s-outer"),c(t,"cx",n=e[2]+e[4]/2),c(t,"cy",o=e[3]+e[5]/2),c(t,"rx",i=e[4]/2),c(t,"ry",s=e[5]/2),c(r,"class","a9s-inner"),c(r,"cx",a=e[2]+e[4]/2),c(r,"cy",l=e[3]+e[5]/2),c(r,"rx",u=e[4]/2),c(r,"ry",m=e[5]/2)},m(f,h){v(f,t,h),v(f,r,h)},p(f,h){h&20&&n!==(n=f[2]+f[4]/2)&&c(t,"cx",n),h&40&&o!==(o=f[3]+f[5]/2)&&c(t,"cy",o),h&16&&i!==(i=f[4]/2)&&c(t,"rx",i),h&32&&s!==(s=f[5]/2)&&c(t,"ry",s),h&20&&a!==(a=f[2]+f[4]/2)&&c(r,"cx",a),h&40&&l!==(l=f[3]+f[5]/2)&&c(r,"cy",l),h&16&&u!==(u=f[4]/2)&&c(r,"rx",u),h&32&&m!==(m=f[5]/2)&&c(r,"ry",m)},d(f){f&&k(t),f&&k(r)}}}function Qo(e){let t,n=e[1]&&sn(e);return{c(){t=X("g"),n&&n.c(),c(t,"class","a9s-annotation a9s-rubberband")},m(o,i){v(o,t,i),n&&n.m(t,null),e[9](t)},p(o,[i]){o[1]?n?n.p(o,i):(n=sn(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:H,o:H,d(o){o&&k(t),n&&n.d(),e[9](null)}}}function xo(e,t,n){const o=he();let{addEventListener:i}=t,{drawingMode:s}=t,{transform:r}=t,a,l,u,m,f,h,d,g=!1,b=!1,T,w;const _=y=>{T=performance.now(),s==="drag"&&(n(1,l=r.elementToImage(y.offsetX,y.offsetY)),u=l,n(2,m=l[0]),n(3,f=l[1]),n(4,h=1),n(5,d=1))},A=y=>{const E=y||w;if(l)if(u=r.elementToImage(E.offsetX,E.offsetY),b){const L=2*Math.abs(u[0]-l[0]),P=2*Math.abs(u[1]-l[1]);n(4,h=g?Math.max(L,P):L),n(5,d=g?h:P),n(2,m=Math.min(u[0],l[0]-h/2)),n(3,f=Math.min(u[1],l[1]-d/2))}else{const L=Math.abs(u[0]-l[0]),P=Math.abs(u[1]-l[1]);n(4,h=g?Math.max(L,P):L),n(5,d=g?h:P),n(2,m=Math.min(u[0],l[0])),n(3,f=Math.min(u[1],l[1]))}y&&(w=y)},S=y=>{s==="click"&&y.stopImmediatePropagation();const E=performance.now()-T;if(s==="click"){if(E>300)return;y.stopPropagation(),l?O():(n(1,l=r.elementToImage(y.offsetX,y.offsetY)),u=l,n(2,m=l[0]),n(3,f=l[1]),n(4,h=1),n(5,d=1))}else l&&(E>300||h*d>100?(y.stopPropagation(),O()):(n(1,l=null),u=null,w=void 0))},O=()=>{if(h*d>15){const y={type:K.ELLIPSE,geometry:{bounds:{minX:m,minY:f,maxX:m+h,maxY:f+d},cx:m+h/2,cy:f+d/2,rx:h/2,ry:d/2}};o("create",y)}n(1,l=null),u=null,w=void 0},Y=y=>{y.key==="Shift"&&(g=!0,A()),y.key==="Control"&&(b=!0,A())},V=y=>{y.key==="Shift"&&(g=!1,A()),y.key==="Control"&&(b=!1,A())};_e(()=>(document.addEventListener("keyup",V),document.addEventListener("keydown",Y),i("pointerdown",_),i("pointermove",A),i("pointerup",S),()=>{document.removeEventListener("keyup",V),document.removeEventListener("keydown",Y)}));function p(y){ve[y?"unshift":"push"](()=>{a=y,n(0,a)})}return e.$$set=y=>{"addEventListener"in y&&n(6,i=y.addEventListener),"drawingMode"in y&&n(7,s=y.drawingMode),"transform"in y&&n(8,r=y.transform)},[a,l,m,f,h,d,i,s,r,p]}class $o extends te{constructor(t){super(),ee(this,t,xo,Qo,Z,{addEventListener:6,drawingMode:7,transform:8})}}const rt=new Map([["rectangle",{tool:en}],["polygon",{tool:Zo}],["ellipse",{tool:$o}]]),He=()=>[...rt.keys()],lt=e=>rt.get(e),rn=(e,t,n)=>rt.set(e,{tool:t,opts:n});function ei(e){let t,n,o,i,s;return{c(){t=X("g"),n=X("ellipse"),i=X("ellipse"),c(n,"class","a9s-outer"),c(n,"style",o=e[1]?"display:none;":void 0),c(n,"cx",e[2]),c(n,"cy",e[3]),c(n,"rx",e[4]),c(n,"ry",e[5]),c(i,"class","a9s-inner"),c(i,"style",e[1]),c(i,"cx",e[2]),c(i,"cy",e[3]),c(i,"rx",e[4]),c(i,"ry",e[5]),c(t,"data-id",s=e[0].id)},m(r,a){v(r,t,a),ue(t,n),ue(t,i)},p(r,[a]){a&2&&o!==(o=r[1]?"display:none;":void 0)&&c(n,"style",o),a&2&&c(i,"style",r[1]),a&1&&s!==(s=r[0].id)&&c(t,"data-id",s)},i:H,o:H,d(r){r&&k(t)}}}function ti(e,t,n){let o,{annotation:i}=t,{geom:s}=t,{style:r=void 0}=t;const{cx:a,cy:l,rx:u,ry:m}=s;return e.$$set=f=>{"annotation"in f&&n(0,i=f.annotation),"geom"in f&&n(6,s=f.geom),"style"in f&&n(7,r=f.style)},e.$$.update=()=>{e.$$.dirty&129&&n(1,o=Ve(i,r))},[i,o,a,l,u,m,s,r]}class ni extends te{constructor(t){super(),ee(this,t,ti,ei,Z,{annotation:0,geom:6,style:7})}}function oi(e){let t,n,o,i,s;return{c(){t=X("g"),n=X("polygon"),i=X("polygon"),c(n,"class","a9s-outer"),c(n,"style",o=e[1]?"display:none;":void 0),c(n,"points",e[2].map(ii).join(" ")),c(i,"class","a9s-inner"),c(i,"style",e[1]),c(i,"points",e[2].map(si).join(" ")),c(t,"data-id",s=e[0].id)},m(r,a){v(r,t,a),ue(t,n),ue(t,i)},p(r,[a]){a&2&&o!==(o=r[1]?"display:none;":void 0)&&c(n,"style",o),a&2&&c(i,"style",r[1]),a&1&&s!==(s=r[0].id)&&c(t,"data-id",s)},i:H,o:H,d(r){r&&k(t)}}}const ii=e=>e.join(","),si=e=>e.join(",");function ri(e,t,n){let o,{annotation:i}=t,{geom:s}=t,{style:r=void 0}=t;const{points:a}=s;return e.$$set=l=>{"annotation"in l&&n(0,i=l.annotation),"geom"in l&&n(3,s=l.geom),"style"in l&&n(4,r=l.style)},e.$$.update=()=>{e.$$.dirty&17&&n(1,o=Ve(i,r))},[i,o,a,s,r]}class li extends te{constructor(t){super(),ee(this,t,ri,oi,Z,{annotation:0,geom:3,style:4})}}function ai(e){let t,n,o,i,s;return{c(){t=X("g"),n=X("rect"),i=X("rect"),c(n,"class","a9s-outer"),c(n,"style",o=e[5]?"display:none;":void 0),c(n,"x",e[4]),c(n,"y",e[3]),c(n,"width",e[2]),c(n,"height",e[1]),c(i,"class","a9s-inner"),c(i,"style",e[5]),c(i,"x",e[4]),c(i,"y",e[3]),c(i,"width",e[2]),c(i,"height",e[1]),c(t,"data-id",s=e[0].id)},m(r,a){v(r,t,a),ue(t,n),ue(t,i)},p(r,[a]){a&32&&o!==(o=r[5]?"display:none;":void 0)&&c(n,"style",o),a&16&&c(n,"x",r[4]),a&8&&c(n,"y",r[3]),a&4&&c(n,"width",r[2]),a&2&&c(n,"height",r[1]),a&32&&c(i,"style",r[5]),a&16&&c(i,"x",r[4]),a&8&&c(i,"y",r[3]),a&4&&c(i,"width",r[2]),a&2&&c(i,"height",r[1]),a&1&&s!==(s=r[0].id)&&c(t,"data-id",s)},i:H,o:H,d(r){r&&k(t)}}}function ci(e,t,n){let o,i,s,r,a,{annotation:l}=t,{geom:u}=t,{style:m=void 0}=t;return e.$$set=f=>{"annotation"in f&&n(0,l=f.annotation),"geom"in f&&n(6,u=f.geom),"style"in f&&n(7,m=f.style)},e.$$.update=()=>{e.$$.dirty&129&&n(5,o=Ve(l,m)),e.$$.dirty&64&&n(4,{x:i,y:s,w:r,h:a}=u,i,(n(3,s),n(6,u)),(n(2,r),n(6,u)),(n(1,a),n(6,u)))},[l,a,r,s,i,o,u,m]}class fi extends te{constructor(t){super(),ee(this,t,ci,ai,Z,{annotation:0,geom:6,style:7})}}const ui={elementToImage:(e,t)=>[e,t]},ln=e=>({elementToImage:(t,n)=>{const o=e.getBoundingClientRect(),i=e.createSVGPoint();i.x=t+o.x,i.y=n+o.y;const{x:s,y:r}=i.matrixTransform(e.getScreenCTM().inverse());return[s,r]}}),di=250,an=(e,t)=>{const n=he();let o;return{onPointerDown:()=>o=performance.now(),onPointerUp:r=>{if(performance.now()-o<di){const{x:l,y:u}=hi(r,e),m=t.getAt(l,u);m?n("click",{originalEvent:r,annotation:m}):n("click",{originalEvent:r})}}}},hi=(e,t)=>{const n=t.createSVGPoint(),o=t.getBoundingClientRect(),i=e.clientX-o.x,s=e.clientY-o.y,{left:r,top:a}=t.getBoundingClientRect();return n.x=i+r,n.y=s+a,n.matrixTransform(t.getScreenCTM().inverse())};function cn(e,t,n){const o=e.slice();return o[29]=t[n],o}function fn(e,t,n){const o=e.slice();return o[32]=t[n],o}function at(e){const t=e.slice(),n=t[32].target.selector;return t[35]=n,t}function un(e){let t=e[32].id,n,o,i=dn(e);return{c(){i.c(),n=se()},m(s,r){i.m(s,r),v(s,n,r),o=!0},p(s,r){r[0]&8192&&Z(t,t=s[32].id)?(le(),F(i,1,1,H),ae(),i=dn(s),i.c(),G(i,1),i.m(n.parentNode,n)):i.p(s,r)},i(s){o||(G(i),o=!0)},o(s){F(i),o=!1},d(s){s&&k(n),i.d(s)}}}function mi(e){let t,n;return t=new li({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){de(t.$$.fragment)},m(o,i){ce(t,o,i),n=!0},p(o,i){const s={};i[0]&8192&&(s.annotation=o[32]),i[0]&8192&&(s.geom=o[35].geometry),i[0]&2&&(s.style=o[1]),t.$set(s)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){F(t.$$.fragment,o),n=!1},d(o){fe(t,o)}}}function gi(e){let t,n;return t=new fi({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){de(t.$$.fragment)},m(o,i){ce(t,o,i),n=!0},p(o,i){const s={};i[0]&8192&&(s.annotation=o[32]),i[0]&8192&&(s.geom=o[35].geometry),i[0]&2&&(s.style=o[1]),t.$set(s)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){F(t.$$.fragment,o),n=!1},d(o){fe(t,o)}}}function pi(e){let t,n;return t=new ni({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){de(t.$$.fragment)},m(o,i){ce(t,o,i),n=!0},p(o,i){const s={};i[0]&8192&&(s.annotation=o[32]),i[0]&8192&&(s.geom=o[35].geometry),i[0]&2&&(s.style=o[1]),t.$set(s)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){F(t.$$.fragment,o),n=!1},d(o){fe(t,o)}}}function dn(e){let t,n,o,i;const s=[pi,gi,mi],r=[];function a(l,u){return l[35].type===K.ELLIPSE?0:l[35].type===K.RECTANGLE?1:l[35].type===K.POLYGON?2:-1}return~(t=a(e))&&(n=r[t]=s[t](e)),{c(){n&&n.c(),o=se()},m(l,u){~t&&r[t].m(l,u),v(l,o,u),i=!0},p(l,u){let m=t;t=a(l),t===m?~t&&r[t].p(l,u):(n&&(le(),F(r[m],1,1,()=>{r[m]=null}),ae()),~t?(n=r[t],n?n.p(l,u):(n=r[t]=s[t](l),n.c()),G(n,1),n.m(o.parentNode,o)):n=null)},i(l){i||(G(n),i=!0)},o(l){F(n),i=!1},d(l){~t&&r[t].d(l),l&&k(o)}}}function hn(e){let t=!e[7](e[32]),n,o,i=t&&un(at(e));return{c(){i&&i.c(),n=se()},m(s,r){i&&i.m(s,r),v(s,n,r),o=!0},p(s,r){r[0]&8320&&(t=!s[7](s[32])),t?i?(i.p(at(s),r),r[0]&8320&&G(i,1)):(i=un(at(s)),i.c(),G(i,1),i.m(n.parentNode,n)):i&&(le(),F(i,1,1,()=>{i=null}),ae())},i(s){o||(G(i),o=!0)},o(s){F(i),o=!1},d(s){i&&i.d(s),s&&k(n)}}}function mn(e){let t,n,o,i;const s=[_i,yi],r=[];function a(l,u){return l[6]?0:l[12]&&l[0]?1:-1}return~(t=a(e))&&(n=r[t]=s[t](e)),{c(){n&&n.c(),o=se()},m(l,u){~t&&r[t].m(l,u),v(l,o,u),i=!0},p(l,u){let m=t;t=a(l),t===m?~t&&r[t].p(l,u):(n&&(le(),F(r[m],1,1,()=>{r[m]=null}),ae()),~t?(n=r[t],n?n.p(l,u):(n=r[t]=s[t](l),n.c()),G(n,1),n.m(o.parentNode,o)):n=null)},i(l){i||(G(n),i=!0)},o(l){F(n),i=!1},d(l){~t&&r[t].d(l),l&&k(o)}}}function yi(e){let t=e[2],n,o,i=gn(e);return{c(){i.c(),n=se()},m(s,r){i.m(s,r),v(s,n,r),o=!0},p(s,r){r[0]&4&&Z(t,t=s[2])?(le(),F(i,1,1,H),ae(),i=gn(s),i.c(),G(i,1),i.m(n.parentNode,n)):i.p(s,r)},i(s){o||(G(i),o=!0)},o(s){F(i),o=!1},d(s){s&&k(n),i.d(s)}}}function _i(e){let t,n,o=e[6],i=[];for(let r=0;r<o.length;r+=1)i[r]=yn(cn(e,o,r));const s=r=>F(i[r],1,1,()=>{i[r]=null});return{c(){for(let r=0;r<i.length;r+=1)i[r].c();t=se()},m(r,a){for(let l=0;l<i.length;l+=1)i[l]&&i[l].m(r,a);v(r,t,a),n=!0},p(r,a){if(a[0]&279634){o=r[6];let l;for(l=0;l<o.length;l+=1){const u=cn(r,o,l);i[l]?(i[l].p(u,a),G(i[l],1)):(i[l]=yn(u),i[l].c(),G(i[l],1),i[l].m(t.parentNode,t))}for(le(),l=o.length;l<i.length;l+=1)s(l);ae()}},i(r){if(!n){for(let a=0;a<o.length;a+=1)G(i[a]);n=!0}},o(r){i=i.filter(Boolean);for(let a=0;a<i.length;a+=1)F(i[a]);n=!1},d(r){Ze(i,r),r&&k(t)}}}function gn(e){let t,n;return t=new xt({props:{target:e[4],tool:e[12],drawingMode:e[11],transform:e[10],viewportScale:e[14]}}),t.$on("create",e[17]),{c(){de(t.$$.fragment)},m(o,i){ce(t,o,i),n=!0},p(o,i){const s={};i[0]&16&&(s.target=o[4]),i[0]&4096&&(s.tool=o[12]),i[0]&2048&&(s.drawingMode=o[11]),i[0]&1024&&(s.transform=o[10]),i[0]&16384&&(s.viewportScale=o[14]),t.$set(s)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){F(t.$$.fragment,o),n=!1},d(o){fe(t,o)}}}function pn(e){let t,n;return t=new Qt({props:{target:e[4],editor:it(e[29].target.selector),annotation:e[29],style:e[1],transform:e[10],viewportScale:e[14]}}),t.$on("change",function(){z(e[18](e[29]))&&e[18](e[29]).apply(this,arguments)}),{c(){de(t.$$.fragment)},m(o,i){ce(t,o,i),n=!0},p(o,i){e=o;const s={};i[0]&16&&(s.target=e[4]),i[0]&64&&(s.editor=it(e[29].target.selector)),i[0]&64&&(s.annotation=e[29]),i[0]&2&&(s.style=e[1]),i[0]&1024&&(s.transform=e[10]),i[0]&16384&&(s.viewportScale=e[14]),t.$set(s)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){F(t.$$.fragment,o),n=!1},d(o){fe(t,o)}}}function yn(e){let t=e[29].id,n,o,i=pn(e);return{c(){i.c(),n=se()},m(s,r){i.m(s,r),v(s,n,r),o=!0},p(s,r){r[0]&64&&Z(t,t=s[29].id)?(le(),F(i,1,1,H),ae(),i=pn(s),i.c(),G(i,1),i.m(n.parentNode,n)):i.p(s,r)},i(s){o||(G(i),o=!0)},o(s){F(i),o=!1},d(s){s&&k(n),i.d(s)}}}function wi(e){let t,n,o,i,s,r,a=e[13],l=[];for(let f=0;f<a.length;f+=1)l[f]=hn(fn(e,a,f));const u=f=>F(l[f],1,1,()=>{l[f]=null});let m=e[4]&&mn(e);return{c(){t=X("svg"),n=X("g");for(let f=0;f<l.length;f+=1)l[f].c();o=X("g"),m&&m.c(),c(o,"class","drawing"),c(t,"class","a9s-annotationlayer"),Et(t,"drawing",e[12])},m(f,h){v(f,t,h),ue(t,n);for(let d=0;d<l.length;d+=1)l[d]&&l[d].m(n,null);ue(t,o),m&&m.m(o,null),e[25](o),e[26](t),i=!0,s||(r=[j(t,"pointerup",function(){z(e[8])&&e[8].apply(this,arguments)}),j(t,"pointerdown",function(){z(e[9])&&e[9].apply(this,arguments)})],s=!0)},p(f,h){if(e=f,h[0]&8322){a=e[13];let d;for(d=0;d<a.length;d+=1){const g=fn(e,a,d);l[d]?(l[d].p(g,h),G(l[d],1)):(l[d]=hn(g),l[d].c(),G(l[d],1),l[d].m(n,null))}for(le(),d=a.length;d<l.length;d+=1)u(d);ae()}e[4]?m?(m.p(e,h),h[0]&16&&G(m,1)):(m=mn(e),m.c(),G(m,1),m.m(o,null)):m&&(le(),F(m,1,1,()=>{m=null}),ae()),(!i||h[0]&4096)&&Et(t,"drawing",e[12])},i(f){if(!i){for(let h=0;h<a.length;h+=1)G(l[h]);G(m),i=!0}},o(f){l=l.filter(Boolean);for(let h=0;h<l.length;h+=1)F(l[h]);F(m),i=!1},d(f){f&&k(t),Ze(l,f),m&&m.d(),e[25](null),e[26](null),s=!1,ie(r)}}}function bi(e,t,n){let o,i,s,r,a,l,u,m,f,h,d=H,g=()=>(d(),d=yt(p,B=>n(14,h=B)),p);e.$$.on_destroy.push(()=>d());let{drawingEnabled:b}=t,{image:T}=t,{preferredDrawingMode:w}=t,{state:_}=t,{style:A=void 0}=t,{toolName:S=He().length>0?He()[0]:void 0}=t,{user:O}=t,Y,V,p;_e(()=>g(n(5,p=tn(T,V))));const{selection:y,store:E}=_;_t(e,y,B=>n(24,m=B)),_t(e,E,B=>n(13,f=B));let L=null,P=null;const U=B=>{E.unobserve(L);const $=B.filter(({editable:q})=>q).map(({id:q})=>q);$.length>0?(n(6,P=$.map(q=>E.getAnnotation(q))),L=q=>{const{updated:pe}=q.changes;n(6,P=pe.map(J=>J.newValue))},E.observe(L,{annotations:$})):n(6,P=null)},N=B=>{const $=Dt(),q={id:$,bodies:[],target:{annotation:$,selector:B.detail,creator:O,created:new Date}};E.addAnnotation(q),y.setSelected(q.id)},R=B=>$=>{var ye;const{target:q}=B,pe=10*60*1e3,J=((ye=q.creator)==null?void 0:ye.id)!==O.id||!q.created||new Date().getTime()-q.created.getTime()>pe;E.updateTarget({...q,selector:$.detail,created:J?q.created:new Date,updated:J?new Date:null,updatedBy:J?O:null})};function Le(B){ve[B?"unshift":"push"](()=>{Y=B,n(4,Y)})}function De(B){ve[B?"unshift":"push"](()=>{V=B,n(3,V)})}return e.$$set=B=>{"drawingEnabled"in B&&n(0,b=B.drawingEnabled),"image"in B&&n(19,T=B.image),"preferredDrawingMode"in B&&n(20,w=B.preferredDrawingMode),"state"in B&&n(21,_=B.state),"style"in B&&n(1,A=B.style),"toolName"in B&&n(2,S=B.toolName),"user"in B&&n(22,O=B.user)},e.$$.update=()=>{e.$$.dirty[0]&4&&n(12,{tool:o,opts:i}=lt(S),o,(n(23,i),n(2,S))),e.$$.dirty[0]&9437184&&n(11,s=(i==null?void 0:i.drawingMode)||w),e.$$.dirty[0]&8&&n(10,r=ln(V)),e.$$.dirty[0]&8&&n(9,{onPointerDown:a,onPointerUp:l}=an(V,E),a,(n(8,l),n(3,V))),e.$$.dirty[0]&16777216&&n(7,u=B=>m.selected.find($=>$.id===B.id&&$.editable)),e.$$.dirty[0]&16777216&&U(m.selected)},[b,A,S,V,Y,p,P,u,l,a,r,s,o,f,h,y,E,N,R,T,w,_,O,i,m,Le,De]}class _n extends te{constructor(t){super(),ee(this,t,bi,wi,Z,{drawingEnabled:0,image:19,preferredDrawingMode:20,state:21,style:1,toolName:2,user:22},null,[-1,-1])}}function Ei(e,t,n,o,i){wn(e,t,n||0,o||e.length-1,i||Ai)}function wn(e,t,n,o,i){for(;o>n;){if(o-n>600){var s=o-n+1,r=t-n+1,a=Math.log(s),l=.5*Math.exp(2*a/3),u=.5*Math.sqrt(a*l*(s-l)/s)*(r-s/2<0?-1:1),m=Math.max(n,Math.floor(t-r*l/s+u)),f=Math.min(o,Math.floor(t+(s-r)*l/s+u));wn(e,t,m,f,i)}var h=e[t],d=n,g=o;for(Pe(e,n,t),i(e[o],h)>0&&Pe(e,n,o);d<g;){for(Pe(e,d,g),d++,g--;i(e[d],h)<0;)d++;for(;i(e[g],h)>0;)g--}i(e[n],h)===0?Pe(e,n,g):(g++,Pe(e,g,o)),g<=t&&(n=g+1),t<=g&&(o=g-1)}}function Pe(e,t,n){var o=e[t];e[t]=e[n],e[n]=o}function Ai(e,t){return e<t?-1:e>t?1:0}class Ti{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let n=this.data;const o=[];if(!ze(t,n))return o;const i=this.toBBox,s=[];for(;n;){for(let r=0;r<n.children.length;r++){const a=n.children[r],l=n.leaf?i(a):a;ze(t,l)&&(n.leaf?o.push(a):ft(t,l)?this._all(a,o):s.push(a))}n=s.pop()}return o}collides(t){let n=this.data;if(!ze(t,n))return!1;const o=[];for(;n;){for(let i=0;i<n.children.length;i++){const s=n.children[i],r=n.leaf?this.toBBox(s):s;if(ze(t,r)){if(n.leaf||ft(t,r))return!0;o.push(s)}}n=o.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let o=0;o<t.length;o++)this.insert(t[o]);return this}let n=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=n;else if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const o=this.data;this.data=n,n=o}this._insert(n,this.data.height-n.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=Me([]),this}remove(t,n){if(!t)return this;let o=this.data;const i=this.toBBox(t),s=[],r=[];let a,l,u;for(;o||s.length;){if(o||(o=s.pop(),l=s[s.length-1],a=r.pop(),u=!0),o.leaf){const m=Si(t,o.children,n);if(m!==-1)return o.children.splice(m,1),s.push(o),this._condense(s),this}!u&&!o.leaf&&ft(o,i)?(s.push(o),r.push(a),a=0,l=o,o=o.children[0]):l?(a++,o=l.children[a],u=!1):o=null}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,n){const o=[];for(;t;)t.leaf?n.push(...t.children):o.push(...t.children),t=o.pop();return n}_build(t,n,o,i){const s=o-n+1;let r=this._maxEntries,a;if(s<=r)return a=Me(t.slice(n,o+1)),Se(a,this.toBBox),a;i||(i=Math.ceil(Math.log(s)/Math.log(r)),r=Math.ceil(s/Math.pow(r,i-1))),a=Me([]),a.leaf=!1,a.height=i;const l=Math.ceil(s/r),u=l*Math.ceil(Math.sqrt(r));bn(t,n,o,u,this.compareMinX);for(let m=n;m<=o;m+=u){const f=Math.min(m+u-1,o);bn(t,m,f,l,this.compareMinY);for(let h=m;h<=f;h+=l){const d=Math.min(h+l-1,f);a.children.push(this._build(t,h,d,i-1))}}return Se(a,this.toBBox),a}_chooseSubtree(t,n,o,i){for(;i.push(n),!(n.leaf||i.length-1===o);){let s=1/0,r=1/0,a;for(let l=0;l<n.children.length;l++){const u=n.children[l],m=ct(u),f=Oi(t,u)-m;f<r?(r=f,s=m<s?m:s,a=u):f===r&&m<s&&(s=m,a=u)}n=a||n.children[0]}return n}_insert(t,n,o){const i=o?t:this.toBBox(t),s=[],r=this._chooseSubtree(i,this.data,n,s);for(r.children.push(t),Ye(r,i);n>=0&&s[n].children.length>this._maxEntries;)this._split(s,n),n--;this._adjustParentBBoxes(i,s,n)}_split(t,n){const o=t[n],i=o.children.length,s=this._minEntries;this._chooseSplitAxis(o,s,i);const r=this._chooseSplitIndex(o,s,i),a=Me(o.children.splice(r,o.children.length-r));a.height=o.height,a.leaf=o.leaf,Se(o,this.toBBox),Se(a,this.toBBox),n?t[n-1].children.push(a):this._splitRoot(o,a)}_splitRoot(t,n){this.data=Me([t,n]),this.data.height=t.height+1,this.data.leaf=!1,Se(this.data,this.toBBox)}_chooseSplitIndex(t,n,o){let i,s=1/0,r=1/0;for(let a=n;a<=o-n;a++){const l=Be(t,0,a,this.toBBox),u=Be(t,a,o,this.toBBox),m=ki(l,u),f=ct(l)+ct(u);m<s?(s=m,i=a,r=f<r?f:r):m===s&&f<r&&(r=f,i=a)}return i||o-n}_chooseSplitAxis(t,n,o){const i=t.leaf?this.compareMinX:Mi,s=t.leaf?this.compareMinY:Li,r=this._allDistMargin(t,n,o,i),a=this._allDistMargin(t,n,o,s);r<a&&t.children.sort(i)}_allDistMargin(t,n,o,i){t.children.sort(i);const s=this.toBBox,r=Be(t,0,n,s),a=Be(t,o-n,o,s);let l=Fe(r)+Fe(a);for(let u=n;u<o-n;u++){const m=t.children[u];Ye(r,t.leaf?s(m):m),l+=Fe(r)}for(let u=o-n-1;u>=n;u--){const m=t.children[u];Ye(a,t.leaf?s(m):m),l+=Fe(a)}return l}_adjustParentBBoxes(t,n,o){for(let i=o;i>=0;i--)Ye(n[i],t)}_condense(t){for(let n=t.length-1,o;n>=0;n--)t[n].children.length===0?n>0?(o=t[n-1].children,o.splice(o.indexOf(t[n]),1)):this.clear():Se(t[n],this.toBBox)}}function Si(e,t,n){if(!n)return t.indexOf(e);for(let o=0;o<t.length;o++)if(n(e,t[o]))return o;return-1}function Se(e,t){Be(e,0,e.children.length,t,e)}function Be(e,t,n,o,i){i||(i=Me(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let s=t;s<n;s++){const r=e.children[s];Ye(i,e.leaf?o(r):r)}return i}function Ye(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function Mi(e,t){return e.minX-t.minX}function Li(e,t){return e.minY-t.minY}function ct(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function Fe(e){return e.maxX-e.minX+(e.maxY-e.minY)}function Oi(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function ki(e,t){const n=Math.max(e.minX,t.minX),o=Math.max(e.minY,t.minY),i=Math.min(e.maxX,t.maxX),s=Math.min(e.maxY,t.maxY);return Math.max(0,i-n)*Math.max(0,s-o)}function ft(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function ze(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function Me(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function bn(e,t,n,o,i){const s=[t,n];for(;s.length;){if(n=s.pop(),t=s.pop(),n-t<=o)continue;const r=t+Math.ceil((n-t)/o/2)*o;Ei(e,r,t,n,i),s.push(t,r,r,n)}}const vi=()=>{const e=new Ti,t=new Map,n=()=>[...t.values()],o=()=>{e.clear(),t.clear()},i=f=>{const{minX:h,minY:d,maxX:g,maxY:b}=f.selector.geometry.bounds,T={minX:h,minY:d,maxX:g,maxY:b,target:f};e.insert(T),t.set(f.annotation,T)},s=f=>{const h=t.get(f.annotation);e.remove(h),t.delete(f.annotation)};return{all:n,clear:o,getAt:(f,h)=>{const g=e.search({minX:f,minY:h,maxX:f,maxY:h}).map(b=>b.target).filter(b=>b.selector.type===K.RECTANGLE||Mt(b.selector,f,h));if(g.length>0)return g.sort((b,T)=>Ce(b.selector)-Ce(T.selector)),g[0]},getIntersecting:(f,h,d,g)=>e.search({minX:f,minY:h,maxX:f+d,maxY:h+g}).map(b=>b.target),insert:i,remove:s,set:(f,h=!0)=>{h&&o();const d=f.map(g=>{const{minX:b,minY:T,maxX:w,maxY:_}=g.selector.geometry.bounds;return{minX:b,minY:T,maxX:w,maxY:_,target:g}});d.forEach(g=>t.set(g.target.annotation,g)),e.load(d)},size:()=>e.all().length,update:(f,h)=>{s(f),i(h)}}},En=e=>{const t=co(),n=vi(),o=$n(t,e.pointerSelectAction),i=xn(t),s=go();return t.observe(({changes:l})=>{n.set(l.created.map(u=>u.target),!1),l.deleted.forEach(u=>n.remove(u.target)),l.updated.forEach(({oldValue:u,newValue:m})=>n.update(u.target,m.target))}),{store:{...t,getAt:(l,u)=>{const m=n.getAt(l,u);return m?t.getAnnotation(m.annotation):void 0},getIntersecting:(l,u,m,f)=>n.getIntersecting(l,u,m,f).map(h=>t.getAnnotation(h.annotation))},selection:o,hover:i,viewport:s}},An=e=>{const t=En(e);return{...t,store:fo(t.store)}},Tn=e=>{let t,n;if(e.nodeName==="CANVAS")t=e,n=t.getContext("2d",{willReadFrequently:!0});else{const i=e;t=document.createElement("canvas"),t.width=i.width,t.height=i.height,n=t.getContext("2d",{willReadFrequently:!0}),n.drawImage(i,0,0,i.width,i.height)}let o=0;for(let i=1;i<10;i++)for(let s=1;s<10;s++){const r=Math.round(s*t.width/10),a=Math.round(i*t.height/10),l=n.getImageData(r,a,1,1).data,u=(.299*l[0]+.587*l[1]+.114*l[2])/255;o+=u}return o/81},Sn=e=>{const t=Tn(e),n=t>.6?"dark":"light";return console.log(`[Annotorious] Image brightness: ${t.toFixed(1)}. Setting ${n} theme.`),n},ut=(e,t,n)=>t.setAttribute("data-theme",n==="auto"?Sn(e):n),Mn=(e,t)=>({...e,drawingEnabled:e.drawingEnabled===void 0?t.drawingEnabled:e.drawingEnabled,drawingMode:e.drawingMode||t.drawingMode,pointerSelectAction:e.pointerSelectAction||t.pointerSelectAction,theme:e.theme||t.theme}),Ln=navigator.userAgent.indexOf("Mac OS X")!==-1,On=(e,t)=>{const n=t||document,o=r=>{r.key==="Z"&&r.ctrlKey?e.undo():r.key==="Y"&&r.ctrlKey&&e.redo()},i=r=>{r.key==="z"&&r.metaKey&&(r.shiftKey?e.redo():e.undo())},s=()=>{Ln?n.removeEventListener("keydown",i):n.removeEventListener("keydown",o)};return Ln?n.addEventListener("keydown",i):n.addEventListener("keydown",o),{destroy:s}},Bi="",Yi="",Di="",Ii=(e,t={})=>{if(!e)throw"Missing argument: image";const n=typeof e=="string"?document.getElementById(e):e,o=Mn(t,{drawingEnabled:!0,drawingMode:"drag",pointerSelectAction:Xt.EDIT,theme:"light"}),i=An(o),{selection:s,store:r}=i,a=mo(r),l=po(i,a,o.adapter,o.autoSave),u=document.createElement("DIV");u.style.position="relative",u.style.display="inline-block",n.style.display="block",n.parentNode.insertBefore(u,n),u.appendChild(n);const m=On(a);let f=To();ut(n,u,o.theme);const h=new _n({target:u,props:{drawingEnabled:o.drawingEnabled,image:n,preferredDrawingMode:o.drawingMode,state:i,style:o.style,user:f}});h.$on("click",p=>{const{originalEvent:y,annotation:E}=p.detail;E?s.clickSelect(E.id,y):s.isEmpty()||s.clear()});const d=_o(i,a,o.adapter),g=()=>{h.$destroy(),u.parentNode.insertBefore(n,u),u.parentNode.removeChild(u),m.destroy(),a.destroy()},b=()=>f,T=(p,y,E)=>rn(p,y,E),w=(p,y)=>Jt(p,y),_=p=>{if(!lt(p))throw`No drawing tool named ${p}`;h.$set({toolName:p})},A=p=>h.$set({drawingEnabled:p}),S=p=>{console.warn("Filter not implemented yet")},O=p=>h.$set({style:p}),Y=p=>ut(n,u,p),V=p=>{f=p,h.$set({user:p})};return{...d,destroy:g,getUser:b,listDrawingTools:He,on:l.on,off:l.off,registerDrawingTool:T,registerShapeEditor:w,setDrawingEnabled:A,setDrawingTool:_,setFilter:S,setStyle:O,setTheme:Y,setUser:V,state:i}};D.Editor=Ne,D.EditorMount=Qt,D.EllipseEditor=Wt,D.Handle=M,D.IdentityTransform=ui,D.PolygonEditor=jt,D.RectangleEditor=Kt,D.RectangleUtil=Lt,D.RubberbandRectangle=en,D.SVGAnnotationLayer=_n,D.ShapeType=K,D.ToolMount=xt,D.W3CImageFormat=Oo,D.addEventListeners=an,D.boundsFromPoints=Ie,D.computeArea=Ce,D.createImageAnnotator=Ii,D.createImageAnnotatorState=En,D.createSVGTransform=ln,D.createSvelteImageAnnotatorState=An,D.detectTheme=Sn,D.distance=Ge,D.enableResponsive=tn,D.fillDefaults=Mn,D.getEditor=it,D.getTool=lt,D.initKeyboardCommands=On,D.intersects=Mt,D.isTouch=Ko,D.listDrawingTools=He,D.parseFragmentSelector=Ot,D.parseSVGSelector=Pt,D.parseW3CImageAnnotation=Nt,D.registerEditor=Jt,D.registerShapeUtil=Xe,D.registerTool=rn,D.sampleBrightness=Tn,D.serializeFragmentSelector=kt,D.serializeSVGSelector=Bt,D.serializeW3CImageAnnotation=Vt,D.setTheme=ut,Object.defineProperty(D,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=annotorious.js.map
