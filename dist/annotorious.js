(function(R,H){typeof exports=="object"&&typeof module<"u"?H(exports):typeof define=="function"&&define.amd?define(["exports"],H):(R=typeof globalThis<"u"?globalThis:R||self,H(R.Annotorious={}))})(this,function(R){"use strict";function H(){}function Cn(e,t){for(const n in t)e[n]=t[n];return e}function _t(e){return e()}function wt(){return Object.create(null)}function le(e){e.forEach(_t)}function j(e){return typeof e=="function"}function K(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function Un(e){return Object.keys(e).length===0}function bt(e,...t){if(e==null)return H;const n=e.subscribe(...t);return n.unsubscribe?()=>n.unsubscribe():n}function Et(e,t,n){e.$$.on_destroy.push(bt(t,n))}function Fn(e,t,n,o){if(e){const i=St(e,t,n,o);return e[0](i)}}function St(e,t,n,o){return e[1]&&o?Cn(n.ctx.slice(),e[1](o(t))):n.ctx}function Gn(e,t,n,o){if(e[2]&&o){const i=e[2](o(n));if(t.dirty===void 0)return i;if(typeof i=="object"){const r=[],s=Math.max(t.dirty.length,i.length);for(let f=0;f<s;f+=1)r[f]=t.dirty[f]|i[f];return r}return t.dirty|i}return t.dirty}function Hn(e,t,n,o,i,r){if(i){const s=St(t,n,o,r);e.p(s,i)}}function Vn(e){if(e.ctx.length>32){const t=[],n=e.ctx.length/32;for(let o=0;o<n;o++)t[o]=-1;return t}return-1}function fe(e,t){e.appendChild(t)}function O(e,t,n){e.insertBefore(t,n||null)}function I(e){e.parentNode&&e.parentNode.removeChild(e)}function Qe(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function Y(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function At(e){return document.createTextNode(e)}function J(){return At(" ")}function ue(){return At("")}function q(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)}function a(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function zn(e){return Array.from(e.childNodes)}function Mt(e,t,n){e.classList[n?"add":"remove"](t)}function jn(e,t,{bubbles:n=!1,cancelable:o=!1}={}){const i=document.createEvent("CustomEvent");return i.initCustomEvent(e,n,o,t),i}let ve;function De(e){ve=e}function Tt(){if(!ve)throw new Error("Function called outside component initialization");return ve}function me(e){Tt().$$.on_mount.push(e)}function ce(){const e=Tt();return(t,n,{cancelable:o=!1}={})=>{const i=e.$$.callbacks[t];if(i){const r=jn(t,n,{cancelable:o});return i.slice().forEach(s=>{s.call(e,r)}),!r.defaultPrevented}return!0}}function ne(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach(o=>o.call(this,t))}const Ee=[],Be=[];let Se=[];const Lt=[],qn=Promise.resolve();let xe=!1;function Kn(){xe||(xe=!0,qn.then(It))}function $e(e){Se.push(e)}const et=new Set;let Ae=0;function It(){if(Ae!==0)return;const e=ve;do{try{for(;Ae<Ee.length;){const t=Ee[Ae];Ae++,De(t),Wn(t.$$)}}catch(t){throw Ee.length=0,Ae=0,t}for(De(null),Ee.length=0,Ae=0;Be.length;)Be.pop()();for(let t=0;t<Se.length;t+=1){const n=Se[t];et.has(n)||(et.add(n),n())}Se.length=0}while(Ee.length);for(;Lt.length;)Lt.pop()();xe=!1,et.clear(),De(e)}function Wn(e){if(e.fragment!==null){e.update(),le(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach($e)}}function Zn(e){const t=[],n=[];Se.forEach(o=>e.indexOf(o)===-1?t.push(o):n.push(o)),n.forEach(o=>o()),Se=t}const Ue=new Set;let pe;function de(){pe={r:0,c:[],p:pe}}function he(){pe.r||le(pe.c),pe=pe.p}function G(e,t){e&&e.i&&(Ue.delete(e),e.i(t))}function z(e,t,n,o){if(e&&e.o){if(Ue.has(e))return;Ue.add(e),pe.c.push(()=>{Ue.delete(e),o&&(n&&e.d(1),o())}),e.o(t)}else o&&o()}function ae(e){e&&e.c()}function re(e,t,n,o){const{fragment:i,after_update:r}=e.$$;i&&i.m(t,n),o||$e(()=>{const s=e.$$.on_mount.map(_t).filter(j);e.$$.on_destroy?e.$$.on_destroy.push(...s):le(s),e.$$.on_mount=[]}),r.forEach($e)}function se(e,t){const n=e.$$;n.fragment!==null&&(Zn(n.after_update),le(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function Jn(e,t){e.$$.dirty[0]===-1&&(Ee.push(e),Kn(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function x(e,t,n,o,i,r,s,f=[-1]){const l=ve;De(e);const c=e.$$={fragment:null,ctx:[],props:r,update:H,not_equal:i,bound:wt(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(l?l.$$.context:[])),callbacks:wt(),dirty:f,skip_bound:!1,root:t.target||l.$$.root};s&&s(c.root);let h=!1;if(c.ctx=n?n(e,t.props||{},(u,m,...d)=>{const p=d.length?d[0]:m;return c.ctx&&i(c.ctx[u],c.ctx[u]=p)&&(!c.skip_bound&&c.bound[u]&&c.bound[u](p),h&&Jn(e,u)),m}):[],c.update(),h=!0,le(c.before_update),c.fragment=o?o(c.ctx):!1,t.target){if(t.hydrate){const u=zn(t.target);c.fragment&&c.fragment.l(u),u.forEach(I)}else c.fragment&&c.fragment.c();t.intro&&G(e.$$.fragment),re(e,t.target,t.anchor,t.customElement),It()}De(l)}class ${$destroy(){se(this,1),this.$destroy=H}$on(t,n){if(!j(n))return H;const o=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return o.push(n),()=>{const i=o.indexOf(n);i!==-1&&o.splice(i,1)}}$set(t){this.$$set&&!Un(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}var V=(e=>(e.ELLIPSE="ELLIPSE",e.POLYGON="POLYGON",e.RECTANGLE="RECTANGLE",e.FREEHAND="FREEHAND",e.LINE="LINE",e))(V||{});const tt={},Me=(e,t)=>tt[e]=t,Fe=e=>tt[e.type].area(e),Ot=(e,t,n)=>tt[e.type].intersects(e,t,n),ge=e=>{let t=1/0,n=1/0,o=-1/0,i=-1/0;return e.forEach(([r,s])=>{t=Math.min(t,r),n=Math.min(n,s),o=Math.max(o,r),i=Math.max(i,s)}),{minX:t,minY:n,maxX:o,maxY:i}},Qn={area:e=>Math.PI*e.geometry.rx*e.geometry.ry,intersects:(e,t,n)=>{const{cx:o,cy:i,rx:r,ry:s}=e.geometry,f=0,l=Math.cos(f),c=Math.sin(f),h=t-o,u=n-i,m=l*h+c*u,d=c*h-l*u;return m*m/(r*r)+d*d/(s*s)<=1}};Me(V.ELLIPSE,Qn);const xn={area:e=>{const{points:t}=e.geometry;let n=0,o=t.length-1;for(let i=0;i<t.length;i++)n+=(t[o][0]+t[i][0])*(t[o][1]-t[i][1]),o=i;return Math.abs(.5*n)},intersects:(e,t,n)=>{const{points:o}=e.geometry;let i=!1;for(let r=0,s=o.length-1;r<o.length;s=r++){const f=o[r][0],l=o[r][1],c=o[s][0],h=o[s][1];l>n!=h>n&&t<(c-f)*(n-l)/(h-l)+f&&(i=!i)}return i}};Me(V.POLYGON,xn);const Pt={area:e=>e.geometry.w*e.geometry.h,intersects:(e,t,n)=>t>=e.geometry.x&&t<=e.geometry.x+e.geometry.w&&n>=e.geometry.y&&n<=e.geometry.y+e.geometry.h};Me(V.RECTANGLE,Pt);const $n={area:e=>{const{points:t}=e.geometry;let n=0,o=t.length-1;for(let i=0;i<t.length;i++)n+=(t[o][0]+t[i][0])*(t[o][1]-t[i][1]),o=i;return Math.abs(.5*n)},intersects:(e,t,n)=>{const{points:o}=e.geometry;let i=!1;for(let r=0,s=o.length-1;r<o.length;s=r++){const f=o[r][0],l=o[r][1],c=o[s][0],h=o[s][1];l>n!=h>n&&t<(c-f)*(n-l)/(h-l)+f&&(i=!i)}return i}};Me(V.FREEHAND,$n);const kt={area:e=>0,intersects:(e,t,n)=>t>=e.geometry.x1&&t<=e.geometry.x2&&n>=e.geometry.y1&&n<=e.geometry.y2};Me(V.LINE,kt);const vt=(e,t=!1)=>{const n=typeof e=="string"?e:e.value,o=/^(xywh)=(pixel|percent)?:?(.+?),(.+?),(.+?),(.+)*/g,i=[...n.matchAll(o)][0],[r,s,f,l,c,h,u]=i;if(s!=="xywh")throw new Error("Unsupported MediaFragment: "+n);if(f&&f!=="pixel")throw new Error(`Unsupported MediaFragment unit: ${f}`);const[m,d,p,S]=[l,c,h,u].map(parseFloat);return{type:V.RECTANGLE,geometry:{x:m,y:d,w:p,h:S,bounds:{minX:m,minY:t?d-S:d,maxX:m+p,maxY:t?d:d+S}}}},Dt=e=>{const{x:t,y:n,w:o,h:i}=e;return{type:"FragmentSelector",conformsTo:"http://www.w3.org/TR/media-frags/",value:`xywh=pixel:${t},${n},${o},${i}`}},Bt="http://www.w3.org/2000/svg",Yt=e=>{const t=o=>{Array.from(o.attributes).forEach(i=>{i.name.startsWith("on")&&o.removeAttribute(i.name)})},n=e.getElementsByTagName("script");return Array.from(n).reverse().forEach(o=>o.parentNode.removeChild(o)),Array.from(e.querySelectorAll("*")).forEach(t),e},eo=e=>{const o=new XMLSerializer().serializeToString(e.documentElement).replace("<svg>",`<svg xmlns="${Bt}">`);return new DOMParser().parseFromString(o,"image/svg+xml").documentElement};function to(e,t){var n=e[0]-t[0],o=e[1]-t[1];return n*n+o*o}function no(e,t,n){var o=t[0],i=t[1],r=n[0]-o,s=n[1]-i;if(r!==0||s!==0){var f=((e[0]-o)*r+(e[1]-i)*s)/(r*r+s*s);f>1?(o=n[0],i=n[1]):f>0&&(o+=r*f,i+=s*f)}return r=e[0]-o,s=e[1]-i,r*r+s*s}function oo(e,t){for(var n=e[0],o=[n],i,r=1,s=e.length;r<s;r++)i=e[r],to(i,n)>t&&(o.push(i),n=i);return n!==i&&o.push(i),o}function nt(e,t,n,o,i){for(var r=o,s,f=t+1;f<n;f++){var l=no(e[f],e[t],e[n]);l>r&&(s=f,r=l)}r>o&&(s-t>1&&nt(e,t,s,o,i),i.push(e[s]),n-s>1&&nt(e,s,n,o,i))}function io(e,t){var n=e.length-1,o=[e[0]];return nt(e,0,n,t,o),o.push(e[n]),o}function ro(e,t,n){if(e.length<=2)return e;var o=t!==void 0?t*t:1;return e=n?e:oo(e,o),e=io(e,o),e}const ot={size:4,thinning:.3,smoothing:.5,streamline:.5,easing:e=>e,start:{taper:0,easing:e=>e,cap:!0},end:{taper:0,easing:e=>e,cap:!0}};function so(e){if(!e.length)return"";const t=e.reduce((n,[o,i],r,s)=>{const[f,l]=s[(r+1)%s.length];return n.push(o,i,(o+f)/2,(i+l)/2),n},["M",...e[0],"Q"]);return t.push("Z"),t.join(" ")}function Ye(e,t,n=!1){return so(n?ro(e,1):e)}const Rt=e=>{const n=new DOMParser().parseFromString(e,"image/svg+xml"),o=n.lookupPrefix(Bt),i=n.lookupNamespaceURI(null);return o||i?Yt(n).firstChild:Yt(eo(n)).firstChild},lo=e=>{const[t,n,o]=e.match(/(<path d=["|'])([^("|')]*)/)||[];if(!o)return;const i=/([MQZT])([^MQZT]*)/g,s=Array.from(o.matchAll(i)).map(f=>(f[1],f[2].trim().split(/\s+/).map(parseFloat)));return{type:V.FREEHAND,geometry:{points:s,bounds:ge(s)}}},ao=e=>{const[t,n,o]=e.match(/(<polygon points=["|'])([^("|')]*)/)||[];if(!o)return;const i=o.split(" ").map(r=>r.split(",").map(parseFloat));return{type:V.POLYGON,geometry:{points:i,bounds:ge(i)}}},fo=e=>{const t=Rt(e),n=parseFloat(t.getAttribute("cx")),o=parseFloat(t.getAttribute("cy")),i=parseFloat(t.getAttribute("rx")),r=parseFloat(t.getAttribute("ry")),s={minX:n-i,minY:o-r,maxX:n+i,maxY:o+r};return{type:V.ELLIPSE,geometry:{cx:n,cy:o,rx:i,ry:r,bounds:s}}},uo=e=>{const t=Rt(e),n=parseFloat(t.getAttribute("x1")),o=parseFloat(t.getAttribute("x2")),i=parseFloat(t.getAttribute("y1")),r=parseFloat(t.getAttribute("y2")),s={minX:Math.min(n,o),minY:Math.min(i,r),maxX:Math.max(n,o),maxY:Math.max(i,r)};return{type:V.LINE,geometry:{x1:n,x2:o,y1:i,y2:r,bounds:s}}},Xt=e=>{const t=typeof e=="string"?e:e.value;if(t.includes("<polygon points="))return ao(t);if(t.includes("<path d="))return lo(t);if(t.includes("<ellipse "))return fo(t);if(t.includes("<line "))return uo(t)},Nt=e=>{let t;if(e.type===V.POLYGON){const n=e.geometry,{points:o}=n;t=`<svg><polygon points="${o.map(i=>i.join(",")).join(" ")}" /></svg>`}else if(e.type===V.FREEHAND){const n=e.geometry;t=`<svg><path d="${Ye(n.points)}"/></svg>`}else if(e.type===V.ELLIPSE){const n=e.geometry;t=`<svg><ellipse cx="${n.cx}" cy="${n.cy}" rx="${n.rx}" ry="${n.ry}" /></svg>`}else if(e.type===V.LINE){const n=e.geometry;t=`<svg><line x1="${n.x1}" x2="${n.x2}" y1="${n.y1}" y2="${n.y2}" /></svg>`}if(t)return{type:"SvgSelector",value:t};throw`Unsupported shape type: ${e.type}`};let Ge;const co=new Uint8Array(16);function ho(){if(!Ge&&(Ge=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Ge))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ge(co)}const ee=[];for(let e=0;e<256;++e)ee.push((e+256).toString(16).slice(1));function mo(e,t=0){return ee[e[t+0]]+ee[e[t+1]]+ee[e[t+2]]+ee[e[t+3]]+"-"+ee[e[t+4]]+ee[e[t+5]]+"-"+ee[e[t+6]]+ee[e[t+7]]+"-"+ee[e[t+8]]+ee[e[t+9]]+"-"+ee[e[t+10]]+ee[e[t+11]]+ee[e[t+12]]+ee[e[t+13]]+ee[e[t+14]]+ee[e[t+15]]}const Ct={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Ut(e,t,n){if(Ct.randomUUID&&!t&&!e)return Ct.randomUUID();e=e||{};const o=e.random||(e.rng||ho)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,t){n=n||0;for(let i=0;i<16;++i)t[n+i]=o[i];return t}return mo(o)}var Ft=Object.prototype.hasOwnProperty;function ye(e,t){var n,o;if(e===t)return!0;if(e&&t&&(n=e.constructor)===t.constructor){if(n===Date)return e.getTime()===t.getTime();if(n===RegExp)return e.toString()===t.toString();if(n===Array){if((o=e.length)===t.length)for(;o--&&ye(e[o],t[o]););return o===-1}if(!n||typeof e=="object"){o=0;for(n in e)if(Ft.call(e,n)&&++o&&!Ft.call(t,n)||!(n in t)||!ye(e[n],t[n]))return!1;return Object.keys(t).length===o}}return e!==e&&t!==t}function it(){}function go(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}const Te=[];function rt(e,t=it){let n;const o=new Set;function i(f){if(go(e,f)&&(e=f,n)){const l=!Te.length;for(const c of o)c[1](),Te.push(c,e);if(l){for(let c=0;c<Te.length;c+=2)Te[c][0](Te[c+1]);Te.length=0}}}function r(f){i(f(e))}function s(f,l=it){const c=[f,l];return o.add(c),o.size===1&&(n=t(i)||it),f(e),()=>{o.delete(c),o.size===0&&n&&(n(),n=null)}}return{set:i,update:r,subscribe:s}}const po=e=>{const{subscribe:t,set:n}=rt(null);let o=null;return t(i=>o=i),e.observe(({changes:i})=>{if(o){i.deleted.some(s=>s.id===o)&&n(null);const r=i.updated.find(({oldValue:s})=>s.id===o);r&&n(r.newValue.id)}}),{get current(){return o},subscribe:t,set:n}};var Gt=(e=>(e.EDIT="EDIT",e.SELECT="SELECT",e.NONE="NONE",e))(Gt||{});const st={selected:[]},yo=(e,t="EDIT")=>{const{subscribe:n,set:o}=rt(st);let i=st;n(u=>i=u);const r=()=>o(st),s=()=>{var u;return((u=i.selected)==null?void 0:u.length)===0},f=u=>{if(i.selected.length===0)return!1;const m=typeof u=="string"?u:u.id;return i.selected.some(d=>d.id===m)},l=(u,m)=>{const d=e.getAnnotation(u);if(d){const p=_o(d,t);o(p==="EDIT"?{selected:[{id:u,editable:!0}],pointerEvent:m}:p==="SELECT"?{selected:[{id:u}],pointerEvent:m}:{selected:[],pointerEvent:m})}else console.warn("Invalid selection: "+u)},c=(u,m=!0)=>{const d=Array.isArray(u)?u:[u],p=d.map(S=>e.getAnnotation(S)).filter(S=>S);o({selected:p.map(({id:S})=>({id:S,editable:m}))}),p.length!==d.length&&console.warn("Invalid selection",u)},h=u=>{if(i.selected.length===0)return!1;const{selected:m}=i;m.filter(({id:d})=>u.includes(d)).length>0&&o({selected:m.filter(({id:d})=>!u.includes(d))})};return e.observe(({changes:u})=>h(u.deleted.map(m=>m.id))),{clear:r,clickSelect:l,get selected(){return i?[...i.selected]:null},get pointerEvent(){return i?i.pointerEvent:null},isEmpty:s,isSelected:f,setSelected:c,subscribe:n}},_o=(e,t)=>typeof t=="function"?t(e)||"EDIT":t||"EDIT",wo=[];for(let e=0;e<256;++e)wo.push((e+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const bo=(e,t)=>{const n=new Set(e.bodies.map(o=>o.id));return t.bodies.filter(o=>!n.has(o.id))},Eo=(e,t)=>{const n=new Set(t.bodies.map(o=>o.id));return e.bodies.filter(o=>!n.has(o.id))},So=(e,t)=>t.bodies.map(n=>{const o=e.bodies.find(i=>i.id===n.id);return{newBody:n,oldBody:o&&!ye(o,n)?o:void 0}}).filter(({oldBody:n})=>n),Ao=(e,t)=>!ye(e.target,t.target),Ht=(e,t)=>{const n=bo(e,t),o=Eo(e,t),i=So(e,t);return{oldValue:e,newValue:t,bodiesCreated:n.length>0?n:void 0,bodiesDeleted:o.length>0?o:void 0,bodiesUpdated:i.length>0?i:void 0,targetUpdated:Ao(e,t)?{oldTarget:e.target,newTarget:t.target}:void 0}};var W=(e=>(e.LOCAL="LOCAL",e.REMOTE="REMOTE",e))(W||{});const Mo=(e,t)=>{var n,o;const{changes:i,origin:r}=t;if(!(!e.options.origin||e.options.origin===r))return!1;if(e.options.ignore){const{ignore:s}=e.options,f=l=>(l==null?void 0:l.length)>0;if(!(f(i.created)||f(i.deleted))){const l=(n=i.updated)==null?void 0:n.some(h=>f(h.bodiesCreated)||f(h.bodiesDeleted)||f(h.bodiesUpdated)),c=(o=i.updated)==null?void 0:o.some(h=>h.targetUpdated);if(s==="BODY_ONLY"&&l&&!c||s==="TARGET_ONLY"&&c&&!l)return!1}}if(e.options.annotations){const s=new Set([...i.created.map(f=>f.id),...i.deleted.map(f=>f.id),...i.updated.map(({oldValue:f})=>f.id)]);return!!(Array.isArray(e.options.annotations)?e.options.annotations:[e.options.annotations]).find(f=>s.has(f))}else return!0},To=(e,t)=>{const n=new Set((e.created||[]).map(u=>u.id)),o=new Set((e.updated||[]).map(({newValue:u})=>u.id)),i=new Set((t.created||[]).map(u=>u.id)),r=new Set((t.deleted||[]).map(u=>u.id)),s=new Set((t.updated||[]).map(({oldValue:u})=>u.id)),f=new Set((t.updated||[]).filter(({oldValue:u})=>n.has(u.id)||o.has(u.id)).map(({oldValue:u})=>u.id)),l=[...(e.created||[]).filter(u=>!r.has(u.id)).map(u=>s.has(u.id)?t.updated.find(({oldValue:m})=>m.id===u.id).newValue:u),...t.created||[]],c=[...(e.deleted||[]).filter(u=>!i.has(u.id)),...(t.deleted||[]).filter(u=>!n.has(u.id))],h=[...(e.updated||[]).filter(({newValue:u})=>!r.has(u.id)).map(u=>{const{oldValue:m,newValue:d}=u;if(s.has(d.id)){const p=t.updated.find(S=>S.oldValue.id===d.id).newValue;return Ht(m,p)}else return u}),...(t.updated||[]).filter(({oldValue:u})=>!f.has(u.id))];return{created:l,deleted:c,updated:h}},Lo=e=>e.id!==void 0,Io=()=>{const e=new Map,t=new Map,n=[],o=(y,b={})=>n.push({onChange:y,options:b}),i=y=>{const b=n.findIndex(A=>A.onChange==y);b>-1&&n.splice(b,1)},r=(y,b)=>{const A={origin:y,changes:{created:b.created||[],updated:b.updated||[],deleted:b.deleted||[]},state:[...e.values()]};n.forEach(P=>{Mo(P,A)&&P.onChange(A)})},s=(y,b=W.LOCAL)=>{if(e.get(y.id))throw Error(`Cannot add annotation ${y.id} - exists already`);e.set(y.id,y),y.bodies.forEach(A=>t.set(A.id,y.id)),r(b,{created:[y]})},f=(y,b)=>{const A=typeof y=="string"?b:y,P=typeof y=="string"?y:y.id,B=e.get(P);if(B){const U=Ht(B,A);return P===A.id?e.set(P,A):(e.delete(P),e.set(A.id,A)),B.bodies.forEach(F=>t.delete(F.id)),A.bodies.forEach(F=>t.set(F.id,A.id)),U}else console.warn(`Cannot update annotation ${P} - does not exist`)},l=(y,b=W.LOCAL,A=W.LOCAL)=>{const P=Lo(b)?A:b,B=f(y,b);B&&r(P,{updated:[B]})},c=(y,b=W.LOCAL)=>{const A=y.reduce((P,B)=>{const U=f(B);return U?[...P,U]:P},[]);A.length>0&&r(b,{updated:A})},h=(y,b=W.LOCAL)=>{const A=e.get(y.annotation);if(A){const P={...A,bodies:[...A.bodies,y]};e.set(A.id,P),t.set(y.id,P.id),r(b,{updated:[{oldValue:A,newValue:P,bodiesCreated:[y]}]})}else console.warn(`Attempt to add body to missing annotation: ${y.annotation}`)},u=()=>[...e.values()],m=(y=W.LOCAL)=>{const b=[...e.values()];e.clear(),t.clear(),r(y,{deleted:b})},d=(y,b=!0,A=W.LOCAL)=>{if(b){const P=[...e.values()];e.clear(),t.clear(),y.forEach(B=>{e.set(B.id,B),B.bodies.forEach(U=>t.set(U.id,B.id))}),r(A,{created:y,deleted:P})}else{const P=y.reduce((B,U)=>{const F=e.get(U.id);return F?[...B,F]:B},[]);if(P.length>0)throw Error(`Bulk insert would overwrite the following annotations: ${P.map(B=>B.id).join(", ")}`);y.forEach(B=>{e.set(B.id,B),B.bodies.forEach(U=>t.set(U.id,B.id))}),r(A,{created:y})}},p=y=>{const b=typeof y=="string"?y:y.id,A=e.get(b);if(A)return e.delete(b),A.bodies.forEach(P=>t.delete(P.id)),A;console.warn(`Attempt to delete missing annotation: ${b}`)},S=(y,b=W.LOCAL)=>{const A=p(y);A&&r(b,{deleted:[A]})},E=(y,b=W.LOCAL)=>{const A=y.reduce((P,B)=>{const U=p(B);return U?[...P,U]:P},[]);A.length>0&&r(b,{deleted:A})},w=(y,b=W.LOCAL)=>{const A=e.get(y.annotation);if(A){const P=A.bodies.find(B=>B.id===y.id);if(P){t.delete(P.id);const B={...A,bodies:A.bodies.filter(U=>U.id!==y.id)};e.set(A.id,B),r(b,{updated:[{oldValue:A,newValue:B,bodiesDeleted:[P]}]})}else console.warn(`Attempt to delete missing body ${y.id} from annotation ${y.annotation}`)}else console.warn(`Attempt to delete body from missing annotation ${y.annotation}`)},g=y=>{const b=e.get(y);return b?{...b}:void 0},_=y=>{const b=t.get(y);if(b){const A=g(b).bodies.find(P=>P.id===y);if(A)return A;console.error(`Store integrity error: body ${y} in index, but not in annotation`)}else console.warn(`Attempt to retrieve missing body: ${y}`)},M=(y,b)=>{if(y.annotation!==b.annotation)throw"Annotation integrity violation: annotation ID must be the same when updating bodies";const A=e.get(y.annotation);if(A){const P=A.bodies.find(U=>U.id===y.id),B={...A,bodies:A.bodies.map(U=>U.id===P.id?b:U)};return e.set(A.id,B),P.id!==b.id&&(t.delete(P.id),t.set(b.id,B.id)),{oldValue:A,newValue:B,bodiesUpdated:[{oldBody:P,newBody:b}]}}else console.warn(`Attempt to add body to missing annotation ${y.annotation}`)},L=(y,b,A=W.LOCAL)=>{const P=M(y,b);r(A,{updated:[P]})},D=(y,b=W.LOCAL)=>{const A=y.map(P=>M({id:P.id,annotation:P.annotation},P));r(b,{updated:A})},k=y=>{const b=e.get(y.annotation);if(b){const A={...b,target:{...b.target,...y}};return e.set(b.id,A),{oldValue:b,newValue:A,targetUpdated:{oldTarget:b.target,newTarget:y}}}else console.warn(`Attempt to update target on missing annotation: ${y.annotation}`)};return{addAnnotation:s,addBody:h,all:u,bulkAddAnnotation:d,bulkDeleteAnnotation:E,bulkUpdateAnnotation:c,bulkUpdateBodies:D,bulkUpdateTargets:(y,b=W.LOCAL)=>{const A=y.map(k).filter(P=>P);A.length>0&&r(b,{updated:A})},clear:m,deleteAnnotation:S,deleteBody:w,getAnnotation:g,getBody:_,observe:o,unobserve:i,updateAnnotation:l,updateBody:L,updateTarget:(y,b=W.LOCAL)=>{const A=k(y);A&&r(b,{updated:[A]})}}},Oo=e=>({...e,subscribe:t=>{const n=o=>t(o.state);return e.observe(n),t(e.all()),()=>e.unobserve(n)}});let Po=()=>({emit(e,...t){let n=this.events[e]||[];for(let o=0,i=n.length;o<i;o++)n[o](...t)},events:{},on(e,t){var n;return(n=this.events[e])!=null&&n.push(t)||(this.events[e]=[t]),()=>{var o;this.events[e]=(o=this.events[e])==null?void 0:o.filter(i=>t!==i)}}});const ko=250,vo=e=>{const t=Po(),n=[];let o=-1,i=!1,r=0;const s=d=>{if(!i){const{changes:p}=d,S=performance.now();if(S-r>ko)n.splice(o+1),n.push(p),o=n.length-1;else{const E=n.length-1;n[E]=To(n[E],p)}r=S}i=!1};e.observe(s,{origin:W.LOCAL});const f=d=>(d==null?void 0:d.length)>0&&e.bulkDeleteAnnotation(d),l=d=>(d==null?void 0:d.length)>0&&e.bulkAddAnnotation(d,!1),c=d=>(d==null?void 0:d.length)>0&&e.bulkUpdateAnnotation(d.map(({oldValue:p})=>p)),h=d=>(d==null?void 0:d.length)>0&&e.bulkUpdateAnnotation(d.map(({newValue:p})=>p)),u=d=>(d==null?void 0:d.length)>0&&e.bulkAddAnnotation(d,!1),m=d=>(d==null?void 0:d.length)>0&&e.bulkDeleteAnnotation(d);return{canRedo:()=>n.length-1>o,canUndo:()=>o>-1,destroy:()=>e.unobserve(s),on:(d,p)=>t.on(d,p),redo:()=>{if(n.length-1>o){i=!0;const{created:d,updated:p,deleted:S}=n[o+1];l(d),h(p),m(S),t.emit("redo",n[o+1]),o+=1}},undo:()=>{if(o>-1){i=!0;const{created:d,updated:p,deleted:S}=n[o];f(d),c(p),u(S),t.emit("undo",n[o]),o-=1}}}},Do=()=>{const{subscribe:e,set:t}=rt([]);return{subscribe:e,set:t}},Bo=(e,t,n,o)=>{const{store:i,selection:r,hover:s,viewport:f}=e,l=new Map;let c=[],h,u;const m=(w,g)=>{l.has(w)?l.get(w).push(g):l.set(w,[g])},d=(w,g)=>{const _=l.get(w);_&&_.indexOf(g)>0&&_.splice(_.indexOf(g),1)},p=(w,g,_)=>{l.has(w)&&setTimeout(()=>{l.get(w).forEach(M=>{if(n){const L=Array.isArray(g)?g.map(k=>n.serialize(k)):n.serialize(g),D=_?_ instanceof PointerEvent?_:n.serialize(_):void 0;M(L,D)}else M(g,_)})},1)},S=()=>{const{selected:w}=r,g=w.map(({id:_})=>i.getAnnotation(_));g.forEach(_=>{const M=c.find(L=>L.id===_.id);(!M||!ye(M,_))&&p("updateAnnotation",_,M)}),c=c.map(_=>g.find(({id:L})=>L===_.id)||_)};r.subscribe(({selected:w})=>{if(!(c.length===0&&w.length===0)){if(c.length===0&&w.length>0)c=w.map(({id:g})=>i.getAnnotation(g));else if(c.length>0&&w.length===0)c.forEach(g=>{const _=i.getAnnotation(g.id);_&&!ye(_,g)&&p("updateAnnotation",_,g)}),c=[];else{const g=new Set(c.map(M=>M.id)),_=new Set(w.map(({id:M})=>M));c.filter(M=>!_.has(M.id)).forEach(M=>{const L=i.getAnnotation(M.id);L&&!ye(L,M)&&p("updateAnnotation",L,M)}),c=[...c.filter(M=>_.has(M.id)),...w.filter(({id:M})=>!g.has(M)).map(({id:M})=>i.getAnnotation(M))]}p("selectionChanged",c)}}),s.subscribe(w=>{!h&&w?p("mouseEnterAnnotation",i.getAnnotation(w)):h&&!w?p("mouseLeaveAnnotation",i.getAnnotation(h)):h&&w&&(p("mouseLeaveAnnotation",i.getAnnotation(h)),p("mouseEnterAnnotation",i.getAnnotation(w))),h=w}),f==null||f.subscribe(w=>p("viewportIntersect",w.map(i.getAnnotation))),i.observe(w=>{o&&(u&&clearTimeout(u),u=setTimeout(S,1e3));const{created:g,deleted:_}=w.changes;g.forEach(M=>p("createAnnotation",M)),_.forEach(M=>p("deleteAnnotation",M)),w.changes.updated.filter(M=>[...M.bodiesCreated||[],...M.bodiesDeleted||[],...M.bodiesUpdated||[]].length>0).forEach(({oldValue:M,newValue:L})=>{const D=c.find(k=>k.id===M.id)||M;c=c.map(k=>k.id===M.id?L:k),p("updateAnnotation",L,D)})},{origin:W.LOCAL}),i.observe(w=>{if(c){const g=new Set(c.map(M=>M.id)),_=w.changes.updated.filter(({newValue:M})=>g.has(M.id)).map(({newValue:M})=>M);_.length>0&&(c=c.map(M=>_.find(D=>D.id===M.id)||M))}},{origin:W.REMOTE});const E=w=>g=>{const{created:_,deleted:M,updated:L}=g;_.forEach(D=>p("createAnnotation",D)),M.forEach(D=>p("deleteAnnotation",D)),w?L.forEach(D=>p("updateAnnotation",D.oldValue,D.newValue)):L.forEach(D=>p("updateAnnotation",D.newValue,D.oldValue))};return t.on("undo",E(!0)),t.on("redo",E(!1)),{on:m,off:d,emit:p}},Yo=e=>t=>t.reduce((n,o)=>{const{parsed:i,error:r}=e.parse(o);return r?{parsed:n.parsed,failed:[...n.failed,o]}:{parsed:[...n.parsed,i],failed:n.failed}},{parsed:[],failed:[]}),Ro=(e,t,n)=>{const{store:o,selection:i}=e,r=E=>{if(n){const{parsed:w,error:g}=n.parse(E);w?o.addAnnotation(w,W.REMOTE):console.error(g)}else o.addAnnotation(E,W.REMOTE)},s=()=>i.clear(),f=()=>o.clear(),l=E=>{const w=o.getAnnotation(E);return n&&w?n.serialize(w):w},c=()=>n?o.all().map(n.serialize):o.all(),h=()=>{var E;const w=(((E=i.selected)==null?void 0:E.map(g=>g.id))||[]).map(g=>o.getAnnotation(g));return n?w.map(n.serialize):w},u=E=>fetch(E).then(w=>w.json()).then(w=>(d(w),w)),m=E=>{if(typeof E=="string"){const w=o.getAnnotation(E);return o.deleteAnnotation(E),n?n.serialize(w):w}else{const w=n?n.parse(E).parsed:E;return o.deleteAnnotation(w),E}},d=E=>{if(n){const{parsed:w,failed:g}=Yo(n)(E);g.length>0&&console.warn(`Discarded ${g.length} invalid annotations`,g),o.bulkAddAnnotation(w,!0,W.REMOTE)}else o.bulkAddAnnotation(E,!0,W.REMOTE)},p=E=>{E?i.setSelected(E):i.clear()},S=E=>{if(n){const w=n.parse(E).parsed,g=n.serialize(o.getAnnotation(w.id));return o.updateAnnotation(w),g}else{const w=o.getAnnotation(E.id);return o.updateAnnotation(E),w}};return{addAnnotation:r,cancelSelected:s,canRedo:t.canRedo,canUndo:t.canUndo,clearAnnotations:f,getAnnotationById:l,getAnnotations:c,getSelected:h,loadAnnotations:u,redo:t.redo,removeAnnotation:m,setAnnotations:d,setSelected:p,undo:t.undo,updateAnnotation:S}};let Xo=e=>crypto.getRandomValues(new Uint8Array(e)),No=(e,t,n)=>{let o=(2<<Math.log(e.length-1)/Math.LN2)-1,i=-~(1.6*o*t/e.length);return(r=t)=>{let s="";for(;;){let f=n(i),l=i;for(;l--;)if(s+=e[f[l]&o]||"",s.length===r)return s}}},Co=(e,t=21)=>No(e,t,Xo),Uo=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((t,n)=>(n&=63,n<36?t+=n.toString(36):n<62?t+=(n-26).toString(36).toUpperCase():n>62?t+="-":t+="_",t),"");const Fo=()=>({isGuest:!0,id:Co("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",20)()}),Go=e=>{const t=JSON.stringify(e);let n=0;for(let o=0,i=t.length;o<i;o++){let r=t.charCodeAt(o);n=(n<<5)-n+r,n|=0}return`${n}`},Vt=e=>e?typeof e=="object"?{...e}:e:void 0,Ho=(e,t)=>(Array.isArray(e)?e:[e]).map(n=>{const{id:o,type:i,purpose:r,value:s,created:f,creator:l,...c}=n;return{id:o||`temp-${Go(n)}`,annotation:t,type:i,purpose:r,value:s,created:f?new Date(f):void 0,creator:Vt(l),...c}}),Vo=e=>e.map(t=>{var n;const o={...t};return delete o.annotation,(n=o.id)!=null&&n.startsWith("temp-")&&delete o.id,o});Uo();const zo=(e,t=!1)=>({parse:i=>zt(i,t),serialize:i=>jt(i,e)}),zt=(e,t=!1)=>{const n=e.id||Ut(),{creator:o,created:i,updatedBy:r,updated:s,body:f,...l}=e,c=Ho(f,n),h=Array.isArray(e.target)?e.target[0]:e.target,u=Array.isArray(h.selector)?h.selector[0]:h.selector,m=u.type==="FragmentSelector"?vt(u,t):u.type==="SvgSelector"?Xt(u):void 0;return m?{parsed:{...l,id:n,bodies:c,target:{created:i?new Date(i):void 0,creator:Vt(o),...l.target,annotation:n,selector:m}}}:{error:Error(`Unknown selector type: ${u.type}`)}},jt=(e,t)=>{const{selector:n,creator:o,created:i,updated:r,updatedBy:s,...f}=e.target,l=n.type==V.RECTANGLE?Dt(n.geometry):Nt(n);return{...e,"@context":"http://www.w3.org/ns/anno.jsonld",id:e.id,type:"Annotation",body:Vo(e.bodies),creator:o,created:i==null?void 0:i.toISOString(),target:{...f,source:t,selector:l}}};function qt(e,t,n){const o=e.slice();return o[11]=t[n],o[13]=n,o}function Kt(e){let t,n,o,i,r;return{c(){t=Y("rect"),a(t,"class","a9s-corner-handle"),a(t,"x",n=e[11][0]-e[3]/2),a(t,"y",o=e[11][1]-e[3]/2),a(t,"height",e[3]),a(t,"width",e[3])},m(s,f){O(s,t,f),i||(r=q(t,"pointerdown",function(){j(e[10](T(e[13])))&&e[10](T(e[13])).apply(this,arguments)}),i=!0)},p(s,f){e=s,f&24&&n!==(n=e[11][0]-e[3]/2)&&a(t,"x",n),f&24&&o!==(o=e[11][1]-e[3]/2)&&a(t,"y",o),f&8&&a(t,"height",e[3]),f&8&&a(t,"width",e[3])},d(s){s&&I(t),i=!1,r()}}}function jo(e){let t,n,o,i,r,s,f,l,c,h,u=e[4].points,m=[];for(let d=0;d<u.length;d+=1)m[d]=Kt(qt(e,u,d));return{c(){t=Y("polygon"),i=J(),r=Y("polygon"),f=J();for(let d=0;d<m.length;d+=1)m[d].c();l=ue(),a(t,"class","a9s-outer"),a(t,"style",n=e[1]?"display:none;":void 0),a(t,"points",o=e[4].points.map(Wt).join(" ")),a(r,"class","a9s-inner a9s-shape-handle"),a(r,"style",e[1]),a(r,"points",s=e[4].points.map(Zt).join(" "))},m(d,p){O(d,t,p),O(d,i,p),O(d,r,p),O(d,f,p);for(let S=0;S<m.length;S+=1)m[S]&&m[S].m(d,p);O(d,l,p),c||(h=[q(t,"pointerdown",function(){j(e[10](T.SHAPE))&&e[10](T.SHAPE).apply(this,arguments)}),q(r,"pointerdown",function(){j(e[10](T.SHAPE))&&e[10](T.SHAPE).apply(this,arguments)})],c=!0)},p(d,p){if(e=d,p&2&&n!==(n=e[1]?"display:none;":void 0)&&a(t,"style",n),p&16&&o!==(o=e[4].points.map(Wt).join(" "))&&a(t,"points",o),p&2&&a(r,"style",e[1]),p&16&&s!==(s=e[4].points.map(Zt).join(" "))&&a(r,"points",s),p&1048){u=e[4].points;let S;for(S=0;S<u.length;S+=1){const E=qt(e,u,S);m[S]?m[S].p(E,p):(m[S]=Kt(E),m[S].c(),m[S].m(l.parentNode,l))}for(;S<m.length;S+=1)m[S].d(1);m.length=u.length}},d(d){d&&I(t),d&&I(i),d&&I(r),d&&I(f),Qe(m,d),d&&I(l),c=!1,le(h)}}}function qo(e){let t,n;return t=new Le({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[jo,({grab:o})=>({10:o}),({grab:o})=>o?1024:0]},$$scope:{ctx:e}}}),t.$on("change",e[7]),t.$on("grab",e[8]),t.$on("release",e[9]),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&4&&(r.transform=o[2]),i&17434&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){z(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}const Wt=e=>e.join(","),Zt=e=>e.join(",");function Ko(e,t,n){let o,i,{shape:r}=t,{computedStyle:s=void 0}=t,{transform:f}=t,{viewportScale:l=1}=t;const c=(d,p,S)=>{let E;p===T.SHAPE?E=d.geometry.points.map(([g,_])=>[g+S[0],_+S[1]]):E=d.geometry.points.map(([g,_],M)=>p===T(M)?[g+S[0],_+S[1]]:[g,_]);const w=ge(E);return{...d,geometry:{points:E,bounds:w}}};function h(d){ne.call(this,e,d)}function u(d){ne.call(this,e,d)}function m(d){ne.call(this,e,d)}return e.$$set=d=>{"shape"in d&&n(0,r=d.shape),"computedStyle"in d&&n(1,s=d.computedStyle),"transform"in d&&n(2,f=d.transform),"viewportScale"in d&&n(6,l=d.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=r.geometry),e.$$.dirty&64&&n(3,i=10/l)},[r,s,f,i,o,c,l,h,u,m]}class Jt extends ${constructor(t){super(),x(this,t,Ko,qo,K,{shape:0,computedStyle:1,transform:2,viewportScale:6})}}function Wo(e){let t,n,o,i,r,s,f,l,c,h,u,m,d,p,S,E,w,g,_,M,L,D,k,y,b,A,P,B,U,F,N,ke,Ce,X,te,Z,we,Q,be,qe,gt,oe,Ke,We,pt,ie,Ze,Je,yt,Nn;return{c(){t=Y("rect"),f=J(),l=Y("rect"),d=J(),p=Y("rect"),g=J(),_=Y("rect"),k=J(),y=Y("rect"),B=J(),U=Y("rect"),Ce=J(),X=Y("rect"),we=J(),Q=Y("rect"),gt=J(),oe=Y("rect"),pt=J(),ie=Y("rect"),a(t,"class","a9s-outer"),a(t,"style",n=e[1]?"display:none;":void 0),a(t,"x",o=e[4].x),a(t,"y",i=e[4].y),a(t,"width",r=e[4].w),a(t,"height",s=e[4].h),a(l,"class","a9s-inner a9s-shape-handle"),a(l,"style",e[1]),a(l,"x",c=e[4].x),a(l,"y",h=e[4].y),a(l,"width",u=e[4].w),a(l,"height",m=e[4].h),a(p,"class","a9s-edge-handle a9s-edge-handle-top"),a(p,"x",S=e[4].x),a(p,"y",E=e[4].y),a(p,"height",1),a(p,"width",w=e[4].w),a(_,"class","a9s-edge-handle a9s-edge-handle-right"),a(_,"x",M=e[4].x+e[4].w),a(_,"y",L=e[4].y),a(_,"height",D=e[4].h),a(_,"width",1),a(y,"class","a9s-edge-handle a9s-edge-handle-bottom"),a(y,"x",b=e[4].x),a(y,"y",A=e[4].y+e[4].h),a(y,"height",1),a(y,"width",P=e[4].w),a(U,"class","a9s-edge-handle a9s-edge-handle-left"),a(U,"x",F=e[4].x),a(U,"y",N=e[4].y),a(U,"height",ke=e[4].h),a(U,"width",1),a(X,"class","a9s-corner-handle a9s-corner-handle-topleft"),a(X,"x",te=e[4].x-e[3]/2),a(X,"y",Z=e[4].y-e[3]/2),a(X,"height",e[3]),a(X,"width",e[3]),a(Q,"class","a9s-corner-handle a9s-corner-handle-topright"),a(Q,"x",be=e[4].x+e[4].w-e[3]/2),a(Q,"y",qe=e[4].y-e[3]/2),a(Q,"height",e[3]),a(Q,"width",e[3]),a(oe,"class","a9s-corner-handle a9s-corner-handle-bottomright"),a(oe,"x",Ke=e[4].x+e[4].w-e[3]/2),a(oe,"y",We=e[4].y+e[4].h-e[3]/2),a(oe,"height",e[3]),a(oe,"width",e[3]),a(ie,"class","a9s-corner-handle a9s-corner-handle-bottomleft"),a(ie,"x",Ze=e[4].x-e[3]/2),a(ie,"y",Je=e[4].y+e[4].h-e[3]/2),a(ie,"height",e[3]),a(ie,"width",e[3])},m(C,v){O(C,t,v),O(C,f,v),O(C,l,v),O(C,d,v),O(C,p,v),O(C,g,v),O(C,_,v),O(C,k,v),O(C,y,v),O(C,B,v),O(C,U,v),O(C,Ce,v),O(C,X,v),O(C,we,v),O(C,Q,v),O(C,gt,v),O(C,oe,v),O(C,pt,v),O(C,ie,v),yt||(Nn=[q(t,"pointerdown",function(){j(e[10](T.SHAPE))&&e[10](T.SHAPE).apply(this,arguments)}),q(l,"pointerdown",function(){j(e[10](T.SHAPE))&&e[10](T.SHAPE).apply(this,arguments)}),q(p,"pointerdown",function(){j(e[10](T.TOP))&&e[10](T.TOP).apply(this,arguments)}),q(_,"pointerdown",function(){j(e[10](T.RIGHT))&&e[10](T.RIGHT).apply(this,arguments)}),q(y,"pointerdown",function(){j(e[10](T.BOTTOM))&&e[10](T.BOTTOM).apply(this,arguments)}),q(U,"pointerdown",function(){j(e[10](T.LEFT))&&e[10](T.LEFT).apply(this,arguments)}),q(X,"pointerdown",function(){j(e[10](T.TOP_LEFT))&&e[10](T.TOP_LEFT).apply(this,arguments)}),q(Q,"pointerdown",function(){j(e[10](T.TOP_RIGHT))&&e[10](T.TOP_RIGHT).apply(this,arguments)}),q(oe,"pointerdown",function(){j(e[10](T.BOTTOM_RIGHT))&&e[10](T.BOTTOM_RIGHT).apply(this,arguments)}),q(ie,"pointerdown",function(){j(e[10](T.BOTTOM_LEFT))&&e[10](T.BOTTOM_LEFT).apply(this,arguments)})],yt=!0)},p(C,v){e=C,v&2&&n!==(n=e[1]?"display:none;":void 0)&&a(t,"style",n),v&16&&o!==(o=e[4].x)&&a(t,"x",o),v&16&&i!==(i=e[4].y)&&a(t,"y",i),v&16&&r!==(r=e[4].w)&&a(t,"width",r),v&16&&s!==(s=e[4].h)&&a(t,"height",s),v&2&&a(l,"style",e[1]),v&16&&c!==(c=e[4].x)&&a(l,"x",c),v&16&&h!==(h=e[4].y)&&a(l,"y",h),v&16&&u!==(u=e[4].w)&&a(l,"width",u),v&16&&m!==(m=e[4].h)&&a(l,"height",m),v&16&&S!==(S=e[4].x)&&a(p,"x",S),v&16&&E!==(E=e[4].y)&&a(p,"y",E),v&16&&w!==(w=e[4].w)&&a(p,"width",w),v&16&&M!==(M=e[4].x+e[4].w)&&a(_,"x",M),v&16&&L!==(L=e[4].y)&&a(_,"y",L),v&16&&D!==(D=e[4].h)&&a(_,"height",D),v&16&&b!==(b=e[4].x)&&a(y,"x",b),v&16&&A!==(A=e[4].y+e[4].h)&&a(y,"y",A),v&16&&P!==(P=e[4].w)&&a(y,"width",P),v&16&&F!==(F=e[4].x)&&a(U,"x",F),v&16&&N!==(N=e[4].y)&&a(U,"y",N),v&16&&ke!==(ke=e[4].h)&&a(U,"height",ke),v&24&&te!==(te=e[4].x-e[3]/2)&&a(X,"x",te),v&24&&Z!==(Z=e[4].y-e[3]/2)&&a(X,"y",Z),v&8&&a(X,"height",e[3]),v&8&&a(X,"width",e[3]),v&24&&be!==(be=e[4].x+e[4].w-e[3]/2)&&a(Q,"x",be),v&24&&qe!==(qe=e[4].y-e[3]/2)&&a(Q,"y",qe),v&8&&a(Q,"height",e[3]),v&8&&a(Q,"width",e[3]),v&24&&Ke!==(Ke=e[4].x+e[4].w-e[3]/2)&&a(oe,"x",Ke),v&24&&We!==(We=e[4].y+e[4].h-e[3]/2)&&a(oe,"y",We),v&8&&a(oe,"height",e[3]),v&8&&a(oe,"width",e[3]),v&24&&Ze!==(Ze=e[4].x-e[3]/2)&&a(ie,"x",Ze),v&24&&Je!==(Je=e[4].y+e[4].h-e[3]/2)&&a(ie,"y",Je),v&8&&a(ie,"height",e[3]),v&8&&a(ie,"width",e[3])},d(C){C&&I(t),C&&I(f),C&&I(l),C&&I(d),C&&I(p),C&&I(g),C&&I(_),C&&I(k),C&&I(y),C&&I(B),C&&I(U),C&&I(Ce),C&&I(X),C&&I(we),C&&I(Q),C&&I(gt),C&&I(oe),C&&I(pt),C&&I(ie),yt=!1,le(Nn)}}}function Zo(e){let t,n;return t=new Le({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[Wo,({grab:o})=>({10:o}),({grab:o})=>o?1024:0]},$$scope:{ctx:e}}}),t.$on("grab",e[7]),t.$on("change",e[8]),t.$on("release",e[9]),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&4&&(r.transform=o[2]),i&3098&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){z(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function Jo(e,t,n){let o,i,{shape:r}=t,{computedStyle:s=void 0}=t,{transform:f}=t,{viewportScale:l=1}=t;const c=(d,p,S)=>{const E=d.geometry.bounds;let[w,g]=[E.minX,E.minY],[_,M]=[E.maxX,E.maxY];const[L,D]=S;if(p===T.SHAPE)w+=L,_+=L,g+=D,M+=D;else{switch(p){case T.TOP:case T.TOP_LEFT:case T.TOP_RIGHT:{g+=D;break}case T.BOTTOM:case T.BOTTOM_LEFT:case T.BOTTOM_RIGHT:{M+=D;break}}switch(p){case T.LEFT:case T.TOP_LEFT:case T.BOTTOM_LEFT:{w+=L;break}case T.RIGHT:case T.TOP_RIGHT:case T.BOTTOM_RIGHT:{_+=L;break}}}const k=Math.min(w,_),y=Math.min(g,M),b=Math.abs(_-w),A=Math.abs(M-g);return{...d,geometry:{x:k,y,w:b,h:A,bounds:{minX:k,minY:y,maxX:k+b,maxY:y+A}}}};function h(d){ne.call(this,e,d)}function u(d){ne.call(this,e,d)}function m(d){ne.call(this,e,d)}return e.$$set=d=>{"shape"in d&&n(0,r=d.shape),"computedStyle"in d&&n(1,s=d.computedStyle),"transform"in d&&n(2,f=d.transform),"viewportScale"in d&&n(6,l=d.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=r.geometry),e.$$.dirty&64&&n(3,i=10/l)},[r,s,f,i,o,c,l,h,u,m]}class Qt extends ${constructor(t){super(),x(this,t,Jo,Zo,K,{shape:0,computedStyle:1,transform:2,viewportScale:6})}}function Qo(e){let t,n,o,i,r,s,f,l,c,h,u,m,d,p,S,E,w,g,_,M,L,D,k,y,b,A,P,B,U;return{c(){t=Y("ellipse"),s=J(),f=Y("ellipse"),m=J(),d=Y("rect"),E=J(),w=Y("rect"),M=J(),L=Y("rect"),y=J(),b=Y("rect"),a(t,"class","a9s-outer"),a(t,"cx",n=e[3].cx),a(t,"cy",o=e[3].cy),a(t,"rx",i=e[3].rx),a(t,"ry",r=e[3].ry),a(f,"class","a9s-inner a9s-shape-handle"),a(f,"cx",l=e[3].cx),a(f,"cy",c=e[3].cy),a(f,"rx",h=e[3].rx),a(f,"ry",u=e[3].ry),a(d,"class","a9s-corner-handle a9s-corner-top"),a(d,"x",p=e[3].cx-e[2]/2),a(d,"y",S=e[3].cy-e[2]/2-e[3].ry),a(d,"height",e[2]),a(d,"width",e[2]),a(w,"class","a9s-corner-handle a9s-corner-handle-right"),a(w,"x",g=e[3].cx+e[3].rx-e[2]/2),a(w,"y",_=e[3].cy-e[2]/2),a(w,"height",e[2]),a(w,"width",e[2]),a(L,"class","a9s-corner-handle a9s-corner-handle-bottom"),a(L,"x",D=e[3].cx-e[2]/2),a(L,"y",k=e[3].cy+e[3].ry-e[2]/2),a(L,"height",e[2]),a(L,"width",e[2]),a(b,"class","a9s-corner-handle a9s-corner-handle-left"),a(b,"x",A=e[3].cx-e[3].rx-e[2]/2),a(b,"y",P=e[3].cy-e[2]/2),a(b,"height",e[2]),a(b,"width",e[2])},m(F,N){O(F,t,N),O(F,s,N),O(F,f,N),O(F,m,N),O(F,d,N),O(F,E,N),O(F,w,N),O(F,M,N),O(F,L,N),O(F,y,N),O(F,b,N),B||(U=[q(t,"pointerdown",function(){j(e[9](T.SHAPE))&&e[9](T.SHAPE).apply(this,arguments)}),q(f,"pointerdown",function(){j(e[9](T.SHAPE))&&e[9](T.SHAPE).apply(this,arguments)}),q(d,"pointerdown",function(){j(e[9](T.TOP))&&e[9](T.TOP).apply(this,arguments)}),q(w,"pointerdown",function(){j(e[9](T.RIGHT))&&e[9](T.RIGHT).apply(this,arguments)}),q(L,"pointerdown",function(){j(e[9](T.BOTTOM))&&e[9](T.BOTTOM).apply(this,arguments)}),q(b,"pointerdown",function(){j(e[9](T.LEFT))&&e[9](T.LEFT).apply(this,arguments)})],B=!0)},p(F,N){e=F,N&8&&n!==(n=e[3].cx)&&a(t,"cx",n),N&8&&o!==(o=e[3].cy)&&a(t,"cy",o),N&8&&i!==(i=e[3].rx)&&a(t,"rx",i),N&8&&r!==(r=e[3].ry)&&a(t,"ry",r),N&8&&l!==(l=e[3].cx)&&a(f,"cx",l),N&8&&c!==(c=e[3].cy)&&a(f,"cy",c),N&8&&h!==(h=e[3].rx)&&a(f,"rx",h),N&8&&u!==(u=e[3].ry)&&a(f,"ry",u),N&12&&p!==(p=e[3].cx-e[2]/2)&&a(d,"x",p),N&12&&S!==(S=e[3].cy-e[2]/2-e[3].ry)&&a(d,"y",S),N&4&&a(d,"height",e[2]),N&4&&a(d,"width",e[2]),N&12&&g!==(g=e[3].cx+e[3].rx-e[2]/2)&&a(w,"x",g),N&12&&_!==(_=e[3].cy-e[2]/2)&&a(w,"y",_),N&4&&a(w,"height",e[2]),N&4&&a(w,"width",e[2]),N&12&&D!==(D=e[3].cx-e[2]/2)&&a(L,"x",D),N&12&&k!==(k=e[3].cy+e[3].ry-e[2]/2)&&a(L,"y",k),N&4&&a(L,"height",e[2]),N&4&&a(L,"width",e[2]),N&12&&A!==(A=e[3].cx-e[3].rx-e[2]/2)&&a(b,"x",A),N&12&&P!==(P=e[3].cy-e[2]/2)&&a(b,"y",P),N&4&&a(b,"height",e[2]),N&4&&a(b,"width",e[2])},d(F){F&&I(t),F&&I(s),F&&I(f),F&&I(m),F&&I(d),F&&I(E),F&&I(w),F&&I(M),F&&I(L),F&&I(y),F&&I(b),B=!1,le(U)}}}function xo(e){let t,n;return t=new Le({props:{shape:e[0],transform:e[1],editor:e[4],$$slots:{default:[Qo,({grab:o})=>({9:o}),({grab:o})=>o?512:0]},$$scope:{ctx:e}}}),t.$on("grab",e[6]),t.$on("change",e[7]),t.$on("release",e[8]),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&2&&(r.transform=o[1]),i&1548&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){z(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function $o(e,t,n){let o,i,{shape:r}=t,{transform:s}=t,{viewportScale:f=1}=t;const l=(m,d,p)=>{const S=m.geometry.bounds;let[E,w]=[S.minX,S.minY],[g,_]=[S.maxX,S.maxY];const[M,L]=p;if(d===T.SHAPE)E+=M,g+=M,w+=L,_+=L;else switch(d){case T.TOP:{w+=L;break}case T.BOTTOM:{_+=L;break}case T.LEFT:{E+=M;break}case T.RIGHT:{g+=M;break}}const D=Math.min(E,g),k=Math.min(w,_),y=Math.abs(g-E),b=Math.abs(_-w),A=(E+g)/2,P=(w+_)/2,B=y/2,U=b/2;return{...m,geometry:{...m.geometry,cx:A,cy:P,rx:B,ry:U,bounds:{minX:D,minY:k,maxX:D+y,maxY:k+b}}}};function c(m){ne.call(this,e,m)}function h(m){ne.call(this,e,m)}function u(m){ne.call(this,e,m)}return e.$$set=m=>{"shape"in m&&n(0,r=m.shape),"transform"in m&&n(1,s=m.transform),"viewportScale"in m&&n(5,f=m.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(3,o=r.geometry),e.$$.dirty&32&&n(2,i=10/f)},[r,s,i,o,l,f,c,h,u]}class xt extends ${constructor(t){super(),x(this,t,$o,xo,K,{shape:0,transform:1,viewportScale:5})}}const _e=(e,t,n)=>{const o=typeof t=="function"?t(e):t;if(o){const{fill:i,fillOpacity:r}=o;let s="",f;return i&&(s+=`fill:${i};stroke:${i};`),n&&(f=n.fillOpacity),s+=`fill-opacity:${f||r||"0.25"};`,s}};function ei(e){let t,n,o;return{c(){t=Y("path"),a(t,"class","a9s-shape-handle"),a(t,"style",e[3]),a(t,"d",e[2])},m(i,r){O(i,t,r),n||(o=q(t,"pointerdown",function(){j(e[14](T.SHAPE))&&e[14](T.SHAPE).apply(this,arguments)}),n=!0)},p(i,r){e=i,r&8&&a(t,"style",e[3]),r&4&&a(t,"d",e[2])},d(i){i&&I(t),n=!1,o()}}}function ti(e){let t,n;return t=new Le({props:{shape:e[0],transform:e[1],editor:e[4],$$slots:{default:[ei,({grab:o})=>({14:o}),({grab:o})=>o?16384:0]},$$scope:{ctx:e}}}),t.$on("change",e[9]),t.$on("grab",e[10]),t.$on("release",e[11]),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&2&&(r.transform=o[1]),i&49164&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){z(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function ni(e,t,n){let o,i,r,{shape:s}=t,{annotation:f}=t,{transform:l}=t,{viewportScale:c=1}=t,{style:h=void 0}=t,u={fillOpacity:1};const m=(E,w,g)=>{let _;w===T.SHAPE&&(_=E.geometry.points.map(([L,D,k])=>[L+g[0],D+g[1],k]));const M=ge(_.map(L=>[L[0],L[1]]));return{...E,geometry:{points:_,bounds:M}}};function d(E){ne.call(this,e,E)}function p(E){ne.call(this,e,E)}function S(E){ne.call(this,e,E)}return e.$$set=E=>{"shape"in E&&n(0,s=E.shape),"annotation"in E&&n(5,f=E.annotation),"transform"in E&&n(1,l=E.transform),"viewportScale"in E&&n(6,c=E.viewportScale),"style"in E&&n(7,h=E.style)},e.$$.update=()=>{e.$$.dirty&1&&n(8,o=s.geometry),e.$$.dirty&64,e.$$.dirty&160&&n(3,i=_e(f,h,u)),e.$$.dirty&256&&n(2,r=Ye(o.points,ot,!0))},[s,l,r,i,m,f,c,h,o,d,p,S]}class $t extends ${constructor(t){super(),x(this,t,ni,ti,K,{shape:0,annotation:5,transform:1,viewportScale:6,style:7})}}function oi(e){let t,n,o,i,r,s,f,l,c,h,u,m,d,p,S,E,w,g,_,M,L,D;return{c(){t=Y("line"),f=J(),l=Y("line"),d=J(),p=Y("rect"),w=J(),g=Y("rect"),a(t,"class","a9s-outer"),a(t,"style",n=e[1]?"display:none;":void 0),a(t,"x1",o=e[4].x1),a(t,"y1",i=e[4].y1),a(t,"x2",r=e[4].x2),a(t,"y2",s=e[4].y2),a(l,"class","a9s-inner a9s-shape-handle"),a(l,"style",e[1]),a(l,"x1",c=e[4].x1),a(l,"y1",h=e[4].y1),a(l,"x2",u=e[4].x2),a(l,"y2",m=e[4].y2),a(p,"class","a9s-corner-handle a9s-shape-handle"),a(p,"x",S=e[4].x1-e[3]/2),a(p,"y",E=e[4].y1-e[3]/2),a(p,"height",e[3]),a(p,"width",e[3]),a(g,"class","a9s-corner-handle a9s-shape-handle"),a(g,"x",_=e[4].x2-e[3]/2),a(g,"y",M=e[4].y2-e[3]/2),a(g,"height",e[3]),a(g,"width",e[3])},m(k,y){O(k,t,y),O(k,f,y),O(k,l,y),O(k,d,y),O(k,p,y),O(k,w,y),O(k,g,y),L||(D=[q(t,"pointerdown",function(){j(e[10](T.SHAPE))&&e[10](T.SHAPE).apply(this,arguments)}),q(l,"pointerdown",function(){j(e[10](T.SHAPE))&&e[10](T.SHAPE).apply(this,arguments)}),q(p,"pointerdown",function(){j(e[10](T.LEFT))&&e[10](T.LEFT).apply(this,arguments)}),q(g,"pointerdown",function(){j(e[10](T.RIGHT))&&e[10](T.RIGHT).apply(this,arguments)})],L=!0)},p(k,y){e=k,y&2&&n!==(n=e[1]?"display:none;":void 0)&&a(t,"style",n),y&16&&o!==(o=e[4].x1)&&a(t,"x1",o),y&16&&i!==(i=e[4].y1)&&a(t,"y1",i),y&16&&r!==(r=e[4].x2)&&a(t,"x2",r),y&16&&s!==(s=e[4].y2)&&a(t,"y2",s),y&2&&a(l,"style",e[1]),y&16&&c!==(c=e[4].x1)&&a(l,"x1",c),y&16&&h!==(h=e[4].y1)&&a(l,"y1",h),y&16&&u!==(u=e[4].x2)&&a(l,"x2",u),y&16&&m!==(m=e[4].y2)&&a(l,"y2",m),y&24&&S!==(S=e[4].x1-e[3]/2)&&a(p,"x",S),y&24&&E!==(E=e[4].y1-e[3]/2)&&a(p,"y",E),y&8&&a(p,"height",e[3]),y&8&&a(p,"width",e[3]),y&24&&_!==(_=e[4].x2-e[3]/2)&&a(g,"x",_),y&24&&M!==(M=e[4].y2-e[3]/2)&&a(g,"y",M),y&8&&a(g,"height",e[3]),y&8&&a(g,"width",e[3])},d(k){k&&I(t),k&&I(f),k&&I(l),k&&I(d),k&&I(p),k&&I(w),k&&I(g),L=!1,le(D)}}}function ii(e){let t,n;return t=new Le({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[oi,({grab:o})=>({10:o}),({grab:o})=>o?1024:0]},$$scope:{ctx:e}}}),t.$on("grab",e[7]),t.$on("change",e[8]),t.$on("release",e[9]),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&4&&(r.transform=o[2]),i&3098&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){z(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function ri(e,t,n){let o,i,{shape:r}=t,{computedStyle:s=void 0}=t,{transform:f}=t,{viewportScale:l=1}=t;const c=(d,p,S)=>{const E=d.geometry.bounds;let[w,g]=[E.minX,E.minY],[_,M]=[E.maxX,E.maxY];const[L,D]=S;if(p===T.SHAPE)w+=L,_+=L,g+=D,M+=D;else switch(p){case T.LEFT:{w+=L,g+=D;break}case T.RIGHT:{_+=L,M+=D;break}}const k=Math.min(w,_),y=Math.min(g,M),b=Math.max(w,_),A=Math.max(g,M);return{...d,geometry:{x1:k,y1:b,x2:y,y2:A,bounds:{minX:Math.min(k,y),minY:Math.min(b,A),maxX:Math.max(k,y),maxY:Math.max(b,A)}}}};function h(d){ne.call(this,e,d)}function u(d){ne.call(this,e,d)}function m(d){ne.call(this,e,d)}return e.$$set=d=>{"shape"in d&&n(0,r=d.shape),"computedStyle"in d&&n(1,s=d.computedStyle),"transform"in d&&n(2,f=d.transform),"viewportScale"in d&&n(6,l=d.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=r.geometry),e.$$.dirty&64&&n(3,i=10/l)},[r,s,f,i,o,c,l,h,u,m]}class en extends ${constructor(t){super(),x(this,t,ri,ii,K,{shape:0,computedStyle:1,transform:2,viewportScale:6})}}const tn=new Map([[V.RECTANGLE,Qt],[V.POLYGON,Jt],[V.ELLIPSE,xt],[V.FREEHAND,$t],[V.LINE,en]]),lt=e=>tn.get(e.type),nn=(e,t)=>tn.set(e,t),T=e=>`HANDLE-${e}`;T.SHAPE="SHAPE",T.TOP="TOP",T.RIGHT="RIGHT",T.BOTTOM="BOTTOM",T.LEFT="LEFT",T.TOP_LEFT="TOP_LEFT",T.TOP_RIGHT="TOP_RIGHT",T.BOTTOM_RIGHT="BOTTOM_RIGHT",T.BOTTOM_LEFT="BOTTOM_LEFT";const si=e=>({}),on=e=>({grab:e[0]});function li(e){let t,n,o,i;const r=e[7].default,s=Fn(r,e,e[6],on);return{c(){t=Y("g"),s&&s.c(),a(t,"class","a9s-annotation selected")},m(f,l){O(f,t,l),s&&s.m(t,null),n=!0,o||(i=[q(t,"pointerup",e[2]),q(t,"pointermove",e[1])],o=!0)},p(f,[l]){s&&s.p&&(!n||l&64)&&Hn(s,r,f,f[6],n?Gn(r,f[6],l,si):Vn(f[6]),on)},i(f){n||(G(s,f),n=!0)},o(f){z(s,f),n=!1},d(f){f&&I(t),s&&s.d(f),o=!1,le(i)}}}function ai(e,t,n){let{$$slots:o={},$$scope:i}=t;const r=ce();let{shape:s}=t,{editor:f}=t,{transform:l}=t,c=null,h,u=null;const m=S=>E=>{c=S,h=l.elementToImage(E.offsetX,E.offsetY),u=s,E.target.setPointerCapture(E.pointerId),r("grab")},d=S=>{if(c){const[E,w]=l.elementToImage(S.offsetX,S.offsetY),g=[E-h[0],w-h[1]];n(3,s=f(u,c,g)),r("change",s)}},p=S=>{S.target.releasePointerCapture(S.pointerId),c=null,u=s,r("release")};return e.$$set=S=>{"shape"in S&&n(3,s=S.shape),"editor"in S&&n(4,f=S.editor),"transform"in S&&n(5,l=S.transform),"$$scope"in S&&n(6,i=S.$$scope)},[m,d,p,s,f,l,i,o]}class Le extends ${constructor(t){super(),x(this,t,ai,li,K,{shape:3,editor:4,transform:5})}}function fi(e,t,n){let o;const i=ce();let{annotation:r}=t,{editor:s}=t,{style:f=void 0}=t,{target:l}=t,{transform:c}=t,{viewportScale:h}=t,u;return me(()=>(n(6,u=new s({target:l,props:{shape:r.target.selector,computedStyle:o,transform:c,viewportScale:h}})),u.$on("change",m=>{u.$$set({shape:m.detail}),i("change",m.detail)}),u.$on("grab",m=>i("grab",m.detail)),u.$on("release",m=>i("release",m.detail)),()=>{u.$destroy()})),e.$$set=m=>{"annotation"in m&&n(0,r=m.annotation),"editor"in m&&n(1,s=m.editor),"style"in m&&n(2,f=m.style),"target"in m&&n(3,l=m.target),"transform"in m&&n(4,c=m.transform),"viewportScale"in m&&n(5,h=m.viewportScale)},e.$$.update=()=>{e.$$.dirty&5&&(o=_e(r,f)),e.$$.dirty&65&&r&&(u==null||u.$set({shape:r.target.selector})),e.$$.dirty&80&&u&&u.$set({transform:c}),e.$$.dirty&96&&u&&u.$set({viewportScale:h})},[r,s,f,l,c,h,u]}class rn extends ${constructor(t){super(),x(this,t,fi,null,K,{annotation:0,editor:1,style:2,target:3,transform:4,viewportScale:5})}}function ui(e,t,n){const o=ce();let{drawingMode:i}=t,{target:r}=t,{tool:s}=t,{transform:f}=t,{viewportScale:l}=t,c;return me(()=>{const h=r.closest("svg"),u=[],m=(d,p,S)=>{h.addEventListener(d,p,S),u.push(()=>h.removeEventListener(d,p,S))};return n(5,c=new s({target:r,props:{addEventListener:m,drawingMode:i,transform:f,viewportScale:l}})),c.$on("create",d=>o("create",d.detail)),()=>{u.forEach(d=>d()),c.$destroy()}}),e.$$set=h=>{"drawingMode"in h&&n(0,i=h.drawingMode),"target"in h&&n(1,r=h.target),"tool"in h&&n(2,s=h.tool),"transform"in h&&n(3,f=h.transform),"viewportScale"in h&&n(4,l=h.viewportScale)},e.$$.update=()=>{e.$$.dirty&40&&c&&c.$set({transform:f}),e.$$.dirty&48&&c&&c.$set({viewportScale:l})},[i,r,s,f,l,c]}class sn extends ${constructor(t){super(),x(this,t,ui,null,K,{drawingMode:0,target:1,tool:2,transform:3,viewportScale:4})}}function ln(e){let t,n;return{c(){t=Y("rect"),n=Y("rect"),a(t,"class","a9s-outer"),a(t,"x",e[1]),a(t,"y",e[2]),a(t,"width",e[3]),a(t,"height",e[4]),a(n,"class","a9s-inner"),a(n,"x",e[1]),a(n,"y",e[2]),a(n,"width",e[3]),a(n,"height",e[4])},m(o,i){O(o,t,i),O(o,n,i)},p(o,i){i&2&&a(t,"x",o[1]),i&4&&a(t,"y",o[2]),i&8&&a(t,"width",o[3]),i&16&&a(t,"height",o[4]),i&2&&a(n,"x",o[1]),i&4&&a(n,"y",o[2]),i&8&&a(n,"width",o[3]),i&16&&a(n,"height",o[4])},d(o){o&&I(t),o&&I(n)}}}function ci(e){let t,n=e[0]&&ln(e);return{c(){t=Y("g"),n&&n.c(),a(t,"class","a9s-annotation a9s-rubberband")},m(o,i){O(o,t,i),n&&n.m(t,null)},p(o,[i]){o[0]?n?n.p(o,i):(n=ln(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:H,o:H,d(o){o&&I(t),n&&n.d()}}}function di(e,t,n){const o=ce();let{addEventListener:i}=t,{drawingMode:r}=t,{transform:s}=t,f,l,c,h,u,m,d;const p=g=>{f=performance.now(),r==="drag"&&(n(0,l=s.elementToImage(g.offsetX,g.offsetY)),c=l,n(1,h=l[0]),n(2,u=l[1]),n(3,m=1),n(4,d=1))},S=g=>{l&&(c=s.elementToImage(g.offsetX,g.offsetY),n(1,h=Math.min(c[0],l[0])),n(2,u=Math.min(c[1],l[1])),n(3,m=Math.abs(c[0]-l[0])),n(4,d=Math.abs(c[1]-l[1])))},E=g=>{const _=performance.now()-f;if(r==="click"){if(_>300)return;g.stopPropagation(),l?w():(n(0,l=s.elementToImage(g.offsetX,g.offsetY)),c=l,n(1,h=l[0]),n(2,u=l[1]),n(3,m=1),n(4,d=1))}else l&&(_>300||m*d>100?(g.stopPropagation(),w()):(n(0,l=null),c=null))},w=()=>{if(m*d>15){const g={type:V.RECTANGLE,geometry:{bounds:{minX:h,minY:u,maxX:h+m,maxY:u+d},x:h,y:u,w:m,h:d}};o("create",g)}n(0,l=null),c=null};return me(()=>{i("pointerdown",p),i("pointermove",S),i("pointerup",E,!0)}),e.$$set=g=>{"addEventListener"in g&&n(5,i=g.addEventListener),"drawingMode"in g&&n(6,r=g.drawingMode),"transform"in g&&n(7,s=g.transform)},[l,h,u,m,d,i,r,s]}class an extends ${constructor(t){super(),x(this,t,di,ci,K,{addEventListener:5,drawingMode:6,transform:7})}}const He=(e,t)=>{const n=Math.abs(t[0]-e[0]),o=Math.abs(t[1]-e[1]);return Math.sqrt(Math.pow(n,2)+Math.pow(o,2))},Ie=[];function hi(e,t=H){let n;const o=new Set;function i(f){if(K(e,f)&&(e=f,n)){const l=!Ie.length;for(const c of o)c[1](),Ie.push(c,e);if(l){for(let c=0;c<Ie.length;c+=2)Ie[c][0](Ie[c+1]);Ie.length=0}}}function r(f){i(f(e))}function s(f,l=H){const c=[f,l];return o.add(c),o.size===1&&(n=t(i)||H),f(e),()=>{o.delete(c),o.size===0&&n&&(n(),n=null)}}return{set:i,update:r,subscribe:s}}const mi=(e,t)=>{const{naturalWidth:n,naturalHeight:o}=e;if(!n&&!o){const{width:i,height:r}=e;t.setAttribute("viewBox",`0 0 ${i} ${r}`),e.addEventListener("load",s=>{const f=s.target;t.setAttribute("viewBox",`0 0 ${f.naturalWidth} ${f.naturalHeight}`)})}else t.setAttribute("viewBox",`0 0 ${n} ${o}`)},fn=(e,t)=>{mi(e,t);const{subscribe:n,set:o}=hi(1);let i;return window.ResizeObserver&&(i=new ResizeObserver(()=>{const s=t.getBoundingClientRect(),{width:f,height:l}=t.viewBox.baseVal,c=Math.max(s.width/f,s.height/l);o(c)}),i.observe(t.parentElement)),{destroy:()=>{i&&i.disconnect()},subscribe:n}},gi="ontouchstart"in window||navigator.maxTouchPoints>0;function at(e){const t=e.slice(),n=(t[2]?t[0]:[...t[0],t[1]]).map(o=>o.join(",")).join(" ");return t[15]=n,t}function un(e){let t,n,o,i,r,s=e[2]&&cn(e);return{c(){t=Y("polygon"),o=Y("polygon"),s&&s.c(),r=ue(),a(t,"class","a9s-outer"),a(t,"points",n=e[15]),a(o,"class","a9s-inner"),a(o,"points",i=e[15])},m(f,l){O(f,t,l),O(f,o,l),s&&s.m(f,l),O(f,r,l)},p(f,l){l&7&&n!==(n=f[15])&&a(t,"points",n),l&7&&i!==(i=f[15])&&a(o,"points",i),f[2]?s?s.p(f,l):(s=cn(f),s.c(),s.m(r.parentNode,r)):s&&(s.d(1),s=null)},d(f){f&&I(t),f&&I(o),s&&s.d(f),f&&I(r)}}}function cn(e){let t,n,o;return{c(){t=Y("rect"),a(t,"class","a9s-corner-handle"),a(t,"x",n=e[0][0][0]-e[3]/2),a(t,"y",o=e[0][0][1]-e[3]/2),a(t,"height",e[3]),a(t,"width",e[3])},m(i,r){O(i,t,r)},p(i,r){r&9&&n!==(n=i[0][0][0]-i[3]/2)&&a(t,"x",n),r&9&&o!==(o=i[0][0][1]-i[3]/2)&&a(t,"y",o),r&8&&a(t,"height",i[3]),r&8&&a(t,"width",i[3])},d(i){i&&I(t)}}}function pi(e){let t,n=e[1]&&un(at(e));return{c(){t=Y("g"),n&&n.c(),a(t,"class","a9s-annotation a9s-rubberband")},m(o,i){O(o,t,i),n&&n.m(t,null)},p(o,[i]){o[1]?n?n.p(at(o),i):(n=un(at(o)),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:H,o:H,d(o){o&&I(t),n&&n.d()}}}const yi=20;function _i(e,t,n){let o;const i=ce();let{addEventListener:r}=t,{drawingMode:s}=t,{transform:f}=t,{viewportScale:l=1}=t,c,h=[],u=null,m=!1;const d=g=>{const{timeStamp:_,offsetX:M,offsetY:L}=g;if(c={timeStamp:_,offsetX:M,offsetY:L},s==="drag"&&h.length===0){const D=f.elementToImage(g.offsetX,g.offsetY);h.push(D),n(1,u=D)}},p=g=>{if(h.length>0&&(n(1,u=f.elementToImage(g.offsetX,g.offsetY)),h.length>2)){const _=He(u,h[0])*l;n(2,m=_<yi)}},S=g=>{if(s==="click"){const _=g.timeStamp-c.timeStamp,M=He([c.offsetX,c.offsetY],[g.offsetX,g.offsetY]);if(_>300||M>15)return;if(m)w();else if(h.length===0){const L=f.elementToImage(g.offsetX,g.offsetY);h.push(L),n(1,u=L)}else h.push(u)}else{if(h.length===1&&He(h[0],u)<=4){n(0,h=[]),n(1,u=null);return}g.stopImmediatePropagation(),m?w():h.push(u)}},E=()=>{const g=[...h,u],_={type:V.POLYGON,geometry:{bounds:ge(g),points:g}};Fe(_)>4&&(n(0,h=[]),n(1,u=null),i("create",_))},w=()=>{const g={type:V.POLYGON,geometry:{bounds:ge(h),points:[...h]}};n(0,h=[]),n(1,u=null),i("create",g)};return me(()=>{r("pointerdown",d,!0),r("pointermove",p),r("pointerup",S,!0),r("dblclick",E,!0)}),e.$$set=g=>{"addEventListener"in g&&n(4,r=g.addEventListener),"drawingMode"in g&&n(5,s=g.drawingMode),"transform"in g&&n(6,f=g.transform),"viewportScale"in g&&n(7,l=g.viewportScale)},e.$$.update=()=>{e.$$.dirty&128&&n(3,o=10/l)},[h,u,m,o,r,s,f,l]}class wi extends ${constructor(t){super(),x(this,t,_i,pi,K,{addEventListener:4,drawingMode:5,transform:6,viewportScale:7})}}function dn(e){let t,n,o,i,r,s,f,l,c,h;return{c(){t=Y("ellipse"),s=Y("ellipse"),a(t,"class","a9s-outer"),a(t,"cx",n=e[2]+e[4]/2),a(t,"cy",o=e[3]+e[5]/2),a(t,"rx",i=e[4]/2),a(t,"ry",r=e[5]/2),a(s,"class","a9s-inner"),a(s,"cx",f=e[2]+e[4]/2),a(s,"cy",l=e[3]+e[5]/2),a(s,"rx",c=e[4]/2),a(s,"ry",h=e[5]/2)},m(u,m){O(u,t,m),O(u,s,m)},p(u,m){m&20&&n!==(n=u[2]+u[4]/2)&&a(t,"cx",n),m&40&&o!==(o=u[3]+u[5]/2)&&a(t,"cy",o),m&16&&i!==(i=u[4]/2)&&a(t,"rx",i),m&32&&r!==(r=u[5]/2)&&a(t,"ry",r),m&20&&f!==(f=u[2]+u[4]/2)&&a(s,"cx",f),m&40&&l!==(l=u[3]+u[5]/2)&&a(s,"cy",l),m&16&&c!==(c=u[4]/2)&&a(s,"rx",c),m&32&&h!==(h=u[5]/2)&&a(s,"ry",h)},d(u){u&&I(t),u&&I(s)}}}function bi(e){let t,n=e[1]&&dn(e);return{c(){t=Y("g"),n&&n.c(),a(t,"class","a9s-annotation a9s-rubberband")},m(o,i){O(o,t,i),n&&n.m(t,null),e[9](t)},p(o,[i]){o[1]?n?n.p(o,i):(n=dn(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:H,o:H,d(o){o&&I(t),n&&n.d(),e[9](null)}}}function Ei(e,t,n){const o=ce();let{addEventListener:i}=t,{drawingMode:r}=t,{transform:s}=t,f,l,c,h,u,m,d,p=!1,S=!1,E,w;const g=b=>{E=performance.now(),r==="drag"&&(n(1,l=s.elementToImage(b.offsetX,b.offsetY)),c=l,n(2,h=l[0]),n(3,u=l[1]),n(4,m=1),n(5,d=1))},_=b=>{const A=b||w;if(l)if(c=s.elementToImage(A.offsetX,A.offsetY),S){const P=2*Math.abs(c[0]-l[0]),B=2*Math.abs(c[1]-l[1]);n(4,m=p?Math.max(P,B):P),n(5,d=p?m:B),n(2,h=Math.min(c[0],l[0]-m/2)),n(3,u=Math.min(c[1],l[1]-d/2))}else{const P=Math.abs(c[0]-l[0]),B=Math.abs(c[1]-l[1]);n(4,m=p?Math.max(P,B):P),n(5,d=p?m:B),n(2,h=Math.min(c[0],l[0])),n(3,u=Math.min(c[1],l[1]))}b&&(w=b)},M=b=>{r==="click"&&b.stopImmediatePropagation();const A=performance.now()-E;if(r==="click"){if(A>300)return;b.stopPropagation(),l?L():(n(1,l=s.elementToImage(b.offsetX,b.offsetY)),c=l,n(2,h=l[0]),n(3,u=l[1]),n(4,m=1),n(5,d=1))}else l&&(A>300||m*d>100?(b.stopPropagation(),L()):(n(1,l=null),c=null,w=void 0))},L=()=>{if(m*d>15){const b={type:V.ELLIPSE,geometry:{bounds:{minX:h,minY:u,maxX:h+m,maxY:u+d},cx:h+m/2,cy:u+d/2,rx:m/2,ry:d/2}};o("create",b)}n(1,l=null),c=null,w=void 0},D=b=>{b.key==="Shift"&&(p=!0,_()),b.key==="Control"&&(S=!0,_())},k=b=>{b.key==="Shift"&&(p=!1,_()),b.key==="Control"&&(S=!1,_())};me(()=>(document.addEventListener("keyup",k),document.addEventListener("keydown",D),i("pointerdown",g),i("pointermove",_),i("pointerup",M),()=>{document.removeEventListener("keyup",k),document.removeEventListener("keydown",D)}));function y(b){Be[b?"unshift":"push"](()=>{f=b,n(0,f)})}return e.$$set=b=>{"addEventListener"in b&&n(6,i=b.addEventListener),"drawingMode"in b&&n(7,r=b.drawingMode),"transform"in b&&n(8,s=b.transform)},[f,l,h,u,m,d,i,r,s,y]}class Si extends ${constructor(t){super(),x(this,t,Ei,bi,K,{addEventListener:6,drawingMode:7,transform:8})}}function hn(e){let t;return{c(){t=Y("path"),a(t,"style",e[2]),a(t,"d",e[0])},m(n,o){O(n,t,o)},p(n,o){o&4&&a(t,"style",n[2]),o&1&&a(t,"d",n[0])},d(n){n&&I(t)}}}function Ai(e){let t,n=e[1]&&hn(e);return{c(){t=Y("g"),n&&n.c(),a(t,"class","a9s-annotation a9s-rubberband")},m(o,i){O(o,t,i),n&&n.m(t,null)},p(o,[i]){o[1]?n?n.p(o,i):(n=hn(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:H,o:H,d(o){o&&I(t),n&&n.d()}}}function Mi(e,t,n){let o;const i=ce();let{addEventListener:r}=t,{drawingMode:s}=t,{annotation:f}=t,{transform:l}=t,{viewportScale:c=1}=t,{style:h=void 0}=t,u={fillOpacity:1},m=[],d="",p=!1;const S=_=>{if(s==="drag"&&m.length===0){n(1,p=!0);const M=l.elementToImage(_.offsetX,_.offsetY);m.push([...M,_.pressure]),n(0,d=Ye(m))}},E=_=>{if(p){const M=l.elementToImage(_.offsetX,_.offsetY);m.push([...M,_.pressure]),n(0,d=Ye(m,ot,!0))}},w=_=>{p&&g()},g=()=>{const _={type:V.FREEHAND,geometry:{bounds:ge(m.map(M=>[M[0],M[1]])),points:m}};n(1,p=!1),m=[],i("create",_)};return me(()=>{r("pointerdown",S,!0),r("pointermove",E),r("pointerup",w,!0)}),e.$$set=_=>{"addEventListener"in _&&n(3,r=_.addEventListener),"drawingMode"in _&&n(4,s=_.drawingMode),"annotation"in _&&n(5,f=_.annotation),"transform"in _&&n(6,l=_.transform),"viewportScale"in _&&n(7,c=_.viewportScale),"style"in _&&n(8,h=_.style)},e.$$.update=()=>{e.$$.dirty&128,e.$$.dirty&288&&n(2,o=_e(f,h,u))},[d,p,o,r,s,f,l,c,h]}class Ti extends ${constructor(t){super(),x(this,t,Mi,Ai,K,{addEventListener:3,drawingMode:4,annotation:5,transform:6,viewportScale:7,style:8})}}function mn(e){let t,n;return{c(){t=Y("line"),n=Y("line"),a(t,"class","a9s-outer"),a(t,"x1",e[1]),a(t,"y1",e[2]),a(t,"x2",e[3]),a(t,"y2",e[4]),a(n,"class","a9s-inner"),a(n,"x1",e[1]),a(n,"y1",e[2]),a(n,"x2",e[3]),a(n,"y2",e[4])},m(o,i){O(o,t,i),O(o,n,i)},p(o,i){i&2&&a(t,"x1",o[1]),i&4&&a(t,"y1",o[2]),i&8&&a(t,"x2",o[3]),i&16&&a(t,"y2",o[4]),i&2&&a(n,"x1",o[1]),i&4&&a(n,"y1",o[2]),i&8&&a(n,"x2",o[3]),i&16&&a(n,"y2",o[4])},d(o){o&&I(t),o&&I(n)}}}function Li(e){let t,n=e[0]&&mn(e);return{c(){t=Y("g"),n&&n.c(),a(t,"class","a9s-annotation a9s-rubberband")},m(o,i){O(o,t,i),n&&n.m(t,null)},p(o,[i]){o[0]?n?n.p(o,i):(n=mn(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:H,o:H,d(o){o&&I(t),n&&n.d()}}}function Ii(e,t,n){const o=ce();let{addEventListener:i}=t,{drawingMode:r}=t,{transform:s}=t,f,l,c,h,u,m,d;const p=g=>{f=performance.now(),r==="drag"&&(n(0,l=s.elementToImage(g.offsetX,g.offsetY)),c=l,n(1,h=l[0]),n(2,u=l[1]),n(3,m=l[0]+1),n(4,d=l[1]+1))},S=g=>{l&&(c=s.elementToImage(g.offsetX,g.offsetY),n(1,h=Math.min(c[0],l[0])),n(2,u=Math.min(c[1],l[1])),n(3,m=Math.max(c[0],l[0])),n(4,d=Math.max(c[1],l[1])))},E=g=>{const _=performance.now()-f;if(r==="click"){if(_>300)return;g.stopPropagation(),l?w():(n(0,l=s.elementToImage(g.offsetX,g.offsetY)),c=l,n(1,h=l[0]),n(2,u=l[1]),n(3,m=l[0]+1),n(4,d=l[1]+1))}else l&&(_>300||Math.sqrt(Math.pow(m-h,2)+Math.pow(d-u,2))>8?(g.stopPropagation(),w()):(n(0,l=null),c=null))},w=()=>{if(Math.sqrt(Math.pow(m-h,2)+Math.pow(d-u,2))>8){const g={type:V.LINE,geometry:{bounds:{minX:Math.min(h,m),minY:Math.min(u,d),maxX:Math.max(h,m),maxY:Math.max(u,d)},x1:h,y1:u,x2:m,y2:d}};o("create",g)}n(0,l=null),c=null};return me(()=>{i("pointerdown",p),i("pointermove",S),i("pointerup",E,!0)}),e.$$set=g=>{"addEventListener"in g&&n(5,i=g.addEventListener),"drawingMode"in g&&n(6,r=g.drawingMode),"transform"in g&&n(7,s=g.transform)},[l,h,u,m,d,i,r,s]}class Oi extends ${constructor(t){super(),x(this,t,Ii,Li,K,{addEventListener:5,drawingMode:6,transform:7})}}const ft=new Map([["rectangle",{tool:an}],["polygon",{tool:wi}],["ellipse",{tool:Si}],["freehand",{tool:Ti}],["line",{tool:Oi}]]),Ve=()=>[...ft.keys()],ut=e=>ft.get(e),gn=(e,t,n)=>ft.set(e,{tool:t,opts:n});function Pi(e){let t,n,o,i,r;return{c(){t=Y("g"),n=Y("ellipse"),i=Y("ellipse"),a(n,"class","a9s-outer"),a(n,"style",o=e[1]?"display:none;":void 0),a(n,"cx",e[2]),a(n,"cy",e[3]),a(n,"rx",e[4]),a(n,"ry",e[5]),a(i,"class","a9s-inner"),a(i,"style",e[1]),a(i,"cx",e[2]),a(i,"cy",e[3]),a(i,"rx",e[4]),a(i,"ry",e[5]),a(t,"data-id",r=e[0].id)},m(s,f){O(s,t,f),fe(t,n),fe(t,i)},p(s,[f]){f&2&&o!==(o=s[1]?"display:none;":void 0)&&a(n,"style",o),f&2&&a(i,"style",s[1]),f&1&&r!==(r=s[0].id)&&a(t,"data-id",r)},i:H,o:H,d(s){s&&I(t)}}}function ki(e,t,n){let o,{annotation:i}=t,{geom:r}=t,{style:s=void 0}=t;const{cx:f,cy:l,rx:c,ry:h}=r;return e.$$set=u=>{"annotation"in u&&n(0,i=u.annotation),"geom"in u&&n(6,r=u.geom),"style"in u&&n(7,s=u.style)},e.$$.update=()=>{e.$$.dirty&129&&n(1,o=_e(i,s))},[i,o,f,l,c,h,r,s]}class vi extends ${constructor(t){super(),x(this,t,ki,Pi,K,{annotation:0,geom:6,style:7})}}function Di(e){let t,n,o,i,r;return{c(){t=Y("g"),n=Y("polygon"),i=Y("polygon"),a(n,"class","a9s-outer"),a(n,"style",o=e[1]?"display:none;":void 0),a(n,"points",e[2].map(Bi).join(" ")),a(i,"class","a9s-inner"),a(i,"style",e[1]),a(i,"points",e[2].map(Yi).join(" ")),a(t,"data-id",r=e[0].id)},m(s,f){O(s,t,f),fe(t,n),fe(t,i)},p(s,[f]){f&2&&o!==(o=s[1]?"display:none;":void 0)&&a(n,"style",o),f&2&&a(i,"style",s[1]),f&1&&r!==(r=s[0].id)&&a(t,"data-id",r)},i:H,o:H,d(s){s&&I(t)}}}const Bi=e=>e.join(","),Yi=e=>e.join(",");function Ri(e,t,n){let o,{annotation:i}=t,{geom:r}=t,{style:s=void 0}=t;const{points:f}=r;return e.$$set=l=>{"annotation"in l&&n(0,i=l.annotation),"geom"in l&&n(3,r=l.geom),"style"in l&&n(4,s=l.style)},e.$$.update=()=>{e.$$.dirty&17&&n(1,o=_e(i,s))},[i,o,f,r,s]}class Xi extends ${constructor(t){super(),x(this,t,Ri,Di,K,{annotation:0,geom:3,style:4})}}function Ni(e){let t,n,o,i,r;return{c(){t=Y("g"),n=Y("rect"),i=Y("rect"),a(n,"class","a9s-outer"),a(n,"style",o=e[5]?"display:none;":void 0),a(n,"x",e[4]),a(n,"y",e[3]),a(n,"width",e[2]),a(n,"height",e[1]),a(i,"class","a9s-inner"),a(i,"style",e[5]),a(i,"x",e[4]),a(i,"y",e[3]),a(i,"width",e[2]),a(i,"height",e[1]),a(t,"data-id",r=e[0].id)},m(s,f){O(s,t,f),fe(t,n),fe(t,i)},p(s,[f]){f&32&&o!==(o=s[5]?"display:none;":void 0)&&a(n,"style",o),f&16&&a(n,"x",s[4]),f&8&&a(n,"y",s[3]),f&4&&a(n,"width",s[2]),f&2&&a(n,"height",s[1]),f&32&&a(i,"style",s[5]),f&16&&a(i,"x",s[4]),f&8&&a(i,"y",s[3]),f&4&&a(i,"width",s[2]),f&2&&a(i,"height",s[1]),f&1&&r!==(r=s[0].id)&&a(t,"data-id",r)},i:H,o:H,d(s){s&&I(t)}}}function Ci(e,t,n){let o,i,r,s,f,{annotation:l}=t,{geom:c}=t,{style:h=void 0}=t;return e.$$set=u=>{"annotation"in u&&n(0,l=u.annotation),"geom"in u&&n(6,c=u.geom),"style"in u&&n(7,h=u.style)},e.$$.update=()=>{e.$$.dirty&129&&n(5,o=_e(l,h)),e.$$.dirty&64&&n(4,{x:i,y:r,w:s,h:f}=c,i,(n(3,r),n(6,c)),(n(2,s),n(6,c)),(n(1,f),n(6,c)))},[l,f,s,r,i,o,c,h]}class Ui extends ${constructor(t){super(),x(this,t,Ci,Ni,K,{annotation:0,geom:6,style:7})}}function Fi(e){let t,n,o;return{c(){t=Y("g"),n=Y("path"),a(n,"style",e[2]),a(n,"d",e[1]),a(t,"data-id",o=e[0].id)},m(i,r){O(i,t,r),fe(t,n)},p(i,[r]){r&4&&a(n,"style",i[2]),r&2&&a(n,"d",i[1]),r&1&&o!==(o=i[0].id)&&a(t,"data-id",o)},i:H,o:H,d(i){i&&I(t)}}}function Gi(e,t,n){let o,i,{annotation:r}=t,{geom:s}=t,{style:f=void 0}=t,l={fillOpacity:1};const{points:c}=s;return e.$$set=h=>{"annotation"in h&&n(0,r=h.annotation),"geom"in h&&n(3,s=h.geom),"style"in h&&n(4,f=h.style)},e.$$.update=()=>{e.$$.dirty&17&&n(2,o=_e(r,f,l))},n(1,i=Ye(c,ot,!0)),[r,i,o,s,f]}class Hi extends ${constructor(t){super(),x(this,t,Gi,Fi,K,{annotation:0,geom:3,style:4})}}const Vi={elementToImage:(e,t)=>[e,t]},pn=e=>({elementToImage:(t,n)=>{const o=e.getBoundingClientRect(),i=e.createSVGPoint();i.x=t+o.x,i.y=n+o.y;const{x:r,y:s}=i.matrixTransform(e.getScreenCTM().inverse());return[r,s]}}),zi=250,yn=(e,t)=>{const n=ce();let o;return{onPointerDown:()=>o=performance.now(),onPointerUp:s=>{if(performance.now()-o<zi){const{x:l,y:c}=ji(s,e),h=t.getAt(l,c);h?n("click",{originalEvent:s,annotation:h}):n("click",{originalEvent:s})}}}},ji=(e,t)=>{const n=t.createSVGPoint(),o=t.getBoundingClientRect(),i=e.clientX-o.x,r=e.clientY-o.y,{left:s,top:f}=t.getBoundingClientRect();return n.x=i+s,n.y=r+f,n.matrixTransform(t.getScreenCTM().inverse())};function _n(e,t,n){const o=e.slice();return o[29]=t[n],o}function wn(e,t,n){const o=e.slice();return o[32]=t[n],o}function ct(e){const t=e.slice(),n=t[32].target.selector;return t[35]=n,t}function bn(e){let t=e[32].id,n,o,i=En(e);return{c(){i.c(),n=ue()},m(r,s){i.m(r,s),O(r,n,s),o=!0},p(r,s){s[0]&8192&&K(t,t=r[32].id)?(de(),z(i,1,1,H),he(),i=En(r),i.c(),G(i,1),i.m(n.parentNode,n)):i.p(r,s)},i(r){o||(G(i),o=!0)},o(r){z(i),o=!1},d(r){r&&I(n),i.d(r)}}}function qi(e){let t,n;return t=new Hi({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){z(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function Ki(e){let t,n;return t=new Xi({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){z(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function Wi(e){let t,n;return t=new Ui({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){z(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function Zi(e){let t,n;return t=new vi({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){z(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function En(e){let t,n,o,i;const r=[Zi,Wi,Ki,qi],s=[];function f(l,c){return l[35].type===V.ELLIPSE?0:l[35].type===V.RECTANGLE?1:l[35].type===V.POLYGON?2:l[35].type===V.FREEHAND?3:-1}return~(t=f(e))&&(n=s[t]=r[t](e)),{c(){n&&n.c(),o=ue()},m(l,c){~t&&s[t].m(l,c),O(l,o,c),i=!0},p(l,c){let h=t;t=f(l),t===h?~t&&s[t].p(l,c):(n&&(de(),z(s[h],1,1,()=>{s[h]=null}),he()),~t?(n=s[t],n?n.p(l,c):(n=s[t]=r[t](l),n.c()),G(n,1),n.m(o.parentNode,o)):n=null)},i(l){i||(G(n),i=!0)},o(l){z(n),i=!1},d(l){~t&&s[t].d(l),l&&I(o)}}}function Sn(e){let t=!e[7](e[32]),n,o,i=t&&bn(ct(e));return{c(){i&&i.c(),n=ue()},m(r,s){i&&i.m(r,s),O(r,n,s),o=!0},p(r,s){s[0]&8320&&(t=!r[7](r[32])),t?i?(i.p(ct(r),s),s[0]&8320&&G(i,1)):(i=bn(ct(r)),i.c(),G(i,1),i.m(n.parentNode,n)):i&&(de(),z(i,1,1,()=>{i=null}),he())},i(r){o||(G(i),o=!0)},o(r){z(i),o=!1},d(r){i&&i.d(r),r&&I(n)}}}function An(e){let t,n,o,i;const r=[Qi,Ji],s=[];function f(l,c){return l[6]?0:l[12]&&l[0]?1:-1}return~(t=f(e))&&(n=s[t]=r[t](e)),{c(){n&&n.c(),o=ue()},m(l,c){~t&&s[t].m(l,c),O(l,o,c),i=!0},p(l,c){let h=t;t=f(l),t===h?~t&&s[t].p(l,c):(n&&(de(),z(s[h],1,1,()=>{s[h]=null}),he()),~t?(n=s[t],n?n.p(l,c):(n=s[t]=r[t](l),n.c()),G(n,1),n.m(o.parentNode,o)):n=null)},i(l){i||(G(n),i=!0)},o(l){z(n),i=!1},d(l){~t&&s[t].d(l),l&&I(o)}}}function Ji(e){let t=e[2],n,o,i=Mn(e);return{c(){i.c(),n=ue()},m(r,s){i.m(r,s),O(r,n,s),o=!0},p(r,s){s[0]&4&&K(t,t=r[2])?(de(),z(i,1,1,H),he(),i=Mn(r),i.c(),G(i,1),i.m(n.parentNode,n)):i.p(r,s)},i(r){o||(G(i),o=!0)},o(r){z(i),o=!1},d(r){r&&I(n),i.d(r)}}}function Qi(e){let t,n,o=e[6],i=[];for(let s=0;s<o.length;s+=1)i[s]=Ln(_n(e,o,s));const r=s=>z(i[s],1,1,()=>{i[s]=null});return{c(){for(let s=0;s<i.length;s+=1)i[s].c();t=ue()},m(s,f){for(let l=0;l<i.length;l+=1)i[l]&&i[l].m(s,f);O(s,t,f),n=!0},p(s,f){if(f[0]&279634){o=s[6];let l;for(l=0;l<o.length;l+=1){const c=_n(s,o,l);i[l]?(i[l].p(c,f),G(i[l],1)):(i[l]=Ln(c),i[l].c(),G(i[l],1),i[l].m(t.parentNode,t))}for(de(),l=o.length;l<i.length;l+=1)r(l);he()}},i(s){if(!n){for(let f=0;f<o.length;f+=1)G(i[f]);n=!0}},o(s){i=i.filter(Boolean);for(let f=0;f<i.length;f+=1)z(i[f]);n=!1},d(s){Qe(i,s),s&&I(t)}}}function Mn(e){let t,n;return t=new sn({props:{target:e[4],tool:e[12],drawingMode:e[11],transform:e[10],viewportScale:e[14]}}),t.$on("create",e[17]),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,i){const r={};i[0]&16&&(r.target=o[4]),i[0]&4096&&(r.tool=o[12]),i[0]&2048&&(r.drawingMode=o[11]),i[0]&1024&&(r.transform=o[10]),i[0]&16384&&(r.viewportScale=o[14]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){z(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function Tn(e){let t,n;return t=new rn({props:{target:e[4],editor:lt(e[29].target.selector),annotation:e[29],style:e[1],transform:e[10],viewportScale:e[14]}}),t.$on("change",function(){j(e[18](e[29]))&&e[18](e[29]).apply(this,arguments)}),{c(){ae(t.$$.fragment)},m(o,i){re(t,o,i),n=!0},p(o,i){e=o;const r={};i[0]&16&&(r.target=e[4]),i[0]&64&&(r.editor=lt(e[29].target.selector)),i[0]&64&&(r.annotation=e[29]),i[0]&2&&(r.style=e[1]),i[0]&1024&&(r.transform=e[10]),i[0]&16384&&(r.viewportScale=e[14]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){z(t.$$.fragment,o),n=!1},d(o){se(t,o)}}}function Ln(e){let t=e[29].id,n,o,i=Tn(e);return{c(){i.c(),n=ue()},m(r,s){i.m(r,s),O(r,n,s),o=!0},p(r,s){s[0]&64&&K(t,t=r[29].id)?(de(),z(i,1,1,H),he(),i=Tn(r),i.c(),G(i,1),i.m(n.parentNode,n)):i.p(r,s)},i(r){o||(G(i),o=!0)},o(r){z(i),o=!1},d(r){r&&I(n),i.d(r)}}}function xi(e){let t,n,o,i,r,s,f=e[13],l=[];for(let u=0;u<f.length;u+=1)l[u]=Sn(wn(e,f,u));const c=u=>z(l[u],1,1,()=>{l[u]=null});let h=e[4]&&An(e);return{c(){t=Y("svg"),n=Y("g");for(let u=0;u<l.length;u+=1)l[u].c();o=Y("g"),h&&h.c(),a(o,"class","drawing"),a(t,"class","a9s-annotationlayer"),Mt(t,"drawing",e[12])},m(u,m){O(u,t,m),fe(t,n);for(let d=0;d<l.length;d+=1)l[d]&&l[d].m(n,null);fe(t,o),h&&h.m(o,null),e[25](o),e[26](t),i=!0,r||(s=[q(t,"pointerup",function(){j(e[8])&&e[8].apply(this,arguments)}),q(t,"pointerdown",function(){j(e[9])&&e[9].apply(this,arguments)})],r=!0)},p(u,m){if(e=u,m[0]&8322){f=e[13];let d;for(d=0;d<f.length;d+=1){const p=wn(e,f,d);l[d]?(l[d].p(p,m),G(l[d],1)):(l[d]=Sn(p),l[d].c(),G(l[d],1),l[d].m(n,null))}for(de(),d=f.length;d<l.length;d+=1)c(d);he()}e[4]?h?(h.p(e,m),m[0]&16&&G(h,1)):(h=An(e),h.c(),G(h,1),h.m(o,null)):h&&(de(),z(h,1,1,()=>{h=null}),he()),(!i||m[0]&4096)&&Mt(t,"drawing",e[12])},i(u){if(!i){for(let m=0;m<f.length;m+=1)G(l[m]);G(h),i=!0}},o(u){l=l.filter(Boolean);for(let m=0;m<l.length;m+=1)z(l[m]);z(h),i=!1},d(u){u&&I(t),Qe(l,u),h&&h.d(),e[25](null),e[26](null),r=!1,le(s)}}}function $i(e,t,n){let o,i,r,s,f,l,c,h,u,m,d=H,p=()=>(d(),d=bt(y,X=>n(14,m=X)),y);e.$$.on_destroy.push(()=>d());let{drawingEnabled:S}=t,{image:E}=t,{preferredDrawingMode:w}=t,{state:g}=t,{style:_=void 0}=t,{toolName:M=Ve().length>0?Ve()[0]:void 0}=t,{user:L}=t,D,k,y;me(()=>p(n(5,y=fn(E,k))));const{selection:b,store:A}=g;Et(e,b,X=>n(24,h=X)),Et(e,A,X=>n(13,u=X));let P=null,B=null;const U=X=>{A.unobserve(P);const te=X.filter(({editable:Z})=>Z).map(({id:Z})=>Z);te.length>0?(n(6,B=te.map(Z=>A.getAnnotation(Z))),P=Z=>{const{updated:we}=Z.changes;n(6,B=we.map(Q=>Q.newValue))},A.observe(P,{annotations:te})):n(6,B=null)},F=X=>{const te=Ut(),Z={id:te,bodies:[],target:{annotation:te,selector:X.detail,creator:L,created:new Date}};A.addAnnotation(Z),b.setSelected(Z.id)},N=X=>te=>{var be;const{target:Z}=X,we=10*60*1e3,Q=((be=Z.creator)==null?void 0:be.id)!==L.id||!Z.created||new Date().getTime()-Z.created.getTime()>we;A.updateTarget({...Z,selector:te.detail,created:Q?Z.created:new Date,updated:Q?new Date:null,updatedBy:Q?L:null})};function ke(X){Be[X?"unshift":"push"](()=>{D=X,n(4,D)})}function Ce(X){Be[X?"unshift":"push"](()=>{k=X,n(3,k)})}return e.$$set=X=>{"drawingEnabled"in X&&n(0,S=X.drawingEnabled),"image"in X&&n(19,E=X.image),"preferredDrawingMode"in X&&n(20,w=X.preferredDrawingMode),"state"in X&&n(21,g=X.state),"style"in X&&n(1,_=X.style),"toolName"in X&&n(2,M=X.toolName),"user"in X&&n(22,L=X.user)},e.$$.update=()=>{e.$$.dirty[0]&4&&n(12,{tool:o,opts:i}=ut(M),o,(n(23,i),n(2,M))),e.$$.dirty[0]&9437184&&n(11,r=(i==null?void 0:i.drawingMode)||w),e.$$.dirty[0]&8&&n(10,s=pn(k)),e.$$.dirty[0]&8&&n(9,{onPointerDown:f,onPointerUp:l}=yn(k,A),f,(n(8,l),n(3,k))),e.$$.dirty[0]&16777216&&n(7,c=X=>h.selected.find(te=>te.id===X.id&&te.editable)),e.$$.dirty[0]&16777216&&U(h.selected)},[S,_,M,k,D,y,B,c,l,f,s,r,o,u,m,b,A,F,N,E,w,g,L,i,h,ke,Ce]}class In extends ${constructor(t){super(),x(this,t,$i,xi,K,{drawingEnabled:0,image:19,preferredDrawingMode:20,state:21,style:1,toolName:2,user:22},null,[-1,-1])}}function er(e,t,n,o,i){On(e,t,n||0,o||e.length-1,i||tr)}function On(e,t,n,o,i){for(;o>n;){if(o-n>600){var r=o-n+1,s=t-n+1,f=Math.log(r),l=.5*Math.exp(2*f/3),c=.5*Math.sqrt(f*l*(r-l)/r)*(s-r/2<0?-1:1),h=Math.max(n,Math.floor(t-s*l/r+c)),u=Math.min(o,Math.floor(t+(r-s)*l/r+c));On(e,t,h,u,i)}var m=e[t],d=n,p=o;for(Re(e,n,t),i(e[o],m)>0&&Re(e,n,o);d<p;){for(Re(e,d,p),d++,p--;i(e[d],m)<0;)d++;for(;i(e[p],m)>0;)p--}i(e[n],m)===0?Re(e,n,p):(p++,Re(e,p,o)),p<=t&&(n=p+1),t<=p&&(o=p-1)}}function Re(e,t,n){var o=e[t];e[t]=e[n],e[n]=o}function tr(e,t){return e<t?-1:e>t?1:0}class nr{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let n=this.data;const o=[];if(!je(t,n))return o;const i=this.toBBox,r=[];for(;n;){for(let s=0;s<n.children.length;s++){const f=n.children[s],l=n.leaf?i(f):f;je(t,l)&&(n.leaf?o.push(f):ht(t,l)?this._all(f,o):r.push(f))}n=r.pop()}return o}collides(t){let n=this.data;if(!je(t,n))return!1;const o=[];for(;n;){for(let i=0;i<n.children.length;i++){const r=n.children[i],s=n.leaf?this.toBBox(r):r;if(je(t,s)){if(n.leaf||ht(t,s))return!0;o.push(r)}}n=o.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let o=0;o<t.length;o++)this.insert(t[o]);return this}let n=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=n;else if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const o=this.data;this.data=n,n=o}this._insert(n,this.data.height-n.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=Pe([]),this}remove(t,n){if(!t)return this;let o=this.data;const i=this.toBBox(t),r=[],s=[];let f,l,c;for(;o||r.length;){if(o||(o=r.pop(),l=r[r.length-1],f=s.pop(),c=!0),o.leaf){const h=or(t,o.children,n);if(h!==-1)return o.children.splice(h,1),r.push(o),this._condense(r),this}!c&&!o.leaf&&ht(o,i)?(r.push(o),s.push(f),f=0,l=o,o=o.children[0]):l?(f++,o=l.children[f],c=!1):o=null}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,n){const o=[];for(;t;)t.leaf?n.push(...t.children):o.push(...t.children),t=o.pop();return n}_build(t,n,o,i){const r=o-n+1;let s=this._maxEntries,f;if(r<=s)return f=Pe(t.slice(n,o+1)),Oe(f,this.toBBox),f;i||(i=Math.ceil(Math.log(r)/Math.log(s)),s=Math.ceil(r/Math.pow(s,i-1))),f=Pe([]),f.leaf=!1,f.height=i;const l=Math.ceil(r/s),c=l*Math.ceil(Math.sqrt(s));Pn(t,n,o,c,this.compareMinX);for(let h=n;h<=o;h+=c){const u=Math.min(h+c-1,o);Pn(t,h,u,l,this.compareMinY);for(let m=h;m<=u;m+=l){const d=Math.min(m+l-1,u);f.children.push(this._build(t,m,d,i-1))}}return Oe(f,this.toBBox),f}_chooseSubtree(t,n,o,i){for(;i.push(n),!(n.leaf||i.length-1===o);){let r=1/0,s=1/0,f;for(let l=0;l<n.children.length;l++){const c=n.children[l],h=dt(c),u=sr(t,c)-h;u<s?(s=u,r=h<r?h:r,f=c):u===s&&h<r&&(r=h,f=c)}n=f||n.children[0]}return n}_insert(t,n,o){const i=o?t:this.toBBox(t),r=[],s=this._chooseSubtree(i,this.data,n,r);for(s.children.push(t),Ne(s,i);n>=0&&r[n].children.length>this._maxEntries;)this._split(r,n),n--;this._adjustParentBBoxes(i,r,n)}_split(t,n){const o=t[n],i=o.children.length,r=this._minEntries;this._chooseSplitAxis(o,r,i);const s=this._chooseSplitIndex(o,r,i),f=Pe(o.children.splice(s,o.children.length-s));f.height=o.height,f.leaf=o.leaf,Oe(o,this.toBBox),Oe(f,this.toBBox),n?t[n-1].children.push(f):this._splitRoot(o,f)}_splitRoot(t,n){this.data=Pe([t,n]),this.data.height=t.height+1,this.data.leaf=!1,Oe(this.data,this.toBBox)}_chooseSplitIndex(t,n,o){let i,r=1/0,s=1/0;for(let f=n;f<=o-n;f++){const l=Xe(t,0,f,this.toBBox),c=Xe(t,f,o,this.toBBox),h=lr(l,c),u=dt(l)+dt(c);h<r?(r=h,i=f,s=u<s?u:s):h===r&&u<s&&(s=u,i=f)}return i||o-n}_chooseSplitAxis(t,n,o){const i=t.leaf?this.compareMinX:ir,r=t.leaf?this.compareMinY:rr,s=this._allDistMargin(t,n,o,i),f=this._allDistMargin(t,n,o,r);s<f&&t.children.sort(i)}_allDistMargin(t,n,o,i){t.children.sort(i);const r=this.toBBox,s=Xe(t,0,n,r),f=Xe(t,o-n,o,r);let l=ze(s)+ze(f);for(let c=n;c<o-n;c++){const h=t.children[c];Ne(s,t.leaf?r(h):h),l+=ze(s)}for(let c=o-n-1;c>=n;c--){const h=t.children[c];Ne(f,t.leaf?r(h):h),l+=ze(f)}return l}_adjustParentBBoxes(t,n,o){for(let i=o;i>=0;i--)Ne(n[i],t)}_condense(t){for(let n=t.length-1,o;n>=0;n--)t[n].children.length===0?n>0?(o=t[n-1].children,o.splice(o.indexOf(t[n]),1)):this.clear():Oe(t[n],this.toBBox)}}function or(e,t,n){if(!n)return t.indexOf(e);for(let o=0;o<t.length;o++)if(n(e,t[o]))return o;return-1}function Oe(e,t){Xe(e,0,e.children.length,t,e)}function Xe(e,t,n,o,i){i||(i=Pe(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let r=t;r<n;r++){const s=e.children[r];Ne(i,e.leaf?o(s):s)}return i}function Ne(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function ir(e,t){return e.minX-t.minX}function rr(e,t){return e.minY-t.minY}function dt(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function ze(e){return e.maxX-e.minX+(e.maxY-e.minY)}function sr(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function lr(e,t){const n=Math.max(e.minX,t.minX),o=Math.max(e.minY,t.minY),i=Math.min(e.maxX,t.maxX),r=Math.min(e.maxY,t.maxY);return Math.max(0,i-n)*Math.max(0,r-o)}function ht(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function je(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function Pe(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Pn(e,t,n,o,i){const r=[t,n];for(;r.length;){if(n=r.pop(),t=r.pop(),n-t<=o)continue;const s=t+Math.ceil((n-t)/o/2)*o;er(e,s,t,n,i),r.push(t,s,s,n)}}const ar=()=>{const e=new nr,t=new Map,n=()=>[...t.values()],o=()=>{e.clear(),t.clear()},i=u=>{const{minX:m,minY:d,maxX:p,maxY:S}=u.selector.geometry.bounds,E={minX:m,minY:d,maxX:p,maxY:S,target:u};e.insert(E),t.set(u.annotation,E)},r=u=>{const m=t.get(u.annotation);e.remove(m),t.delete(u.annotation)};return{all:n,clear:o,getAt:(u,m)=>{const p=e.search({minX:u,minY:m,maxX:u,maxY:m}).map(S=>S.target).filter(S=>S.selector.type===V.RECTANGLE||Ot(S.selector,u,m));if(p.length>0)return p.sort((S,E)=>Fe(S.selector)-Fe(E.selector)),p[0]},getIntersecting:(u,m,d,p)=>e.search({minX:u,minY:m,maxX:u+d,maxY:m+p}).map(S=>S.target),insert:i,remove:r,set:(u,m=!0)=>{m&&o();const d=u.map(p=>{const{minX:S,minY:E,maxX:w,maxY:g}=p.selector.geometry.bounds;return{minX:S,minY:E,maxX:w,maxY:g,target:p}});d.forEach(p=>t.set(p.target.annotation,p)),e.load(d)},size:()=>e.all().length,update:(u,m)=>{r(u),i(m)}}},kn=e=>{const t=Io(),n=ar(),o=yo(t,e.pointerSelectAction),i=po(t),r=Do();return t.observe(({changes:l})=>{n.set(l.created.map(c=>c.target),!1),l.deleted.forEach(c=>n.remove(c.target)),l.updated.forEach(({oldValue:c,newValue:h})=>n.update(c.target,h.target))}),{store:{...t,getAt:(l,c)=>{const h=n.getAt(l,c);return h?t.getAnnotation(h.annotation):void 0},getIntersecting:(l,c,h,u)=>n.getIntersecting(l,c,h,u).map(m=>t.getAnnotation(m.annotation))},selection:o,hover:i,viewport:r}},vn=e=>{const t=kn(e);return{...t,store:Oo(t.store)}},Dn=e=>{let t,n;if(e.nodeName==="CANVAS")t=e,n=t.getContext("2d",{willReadFrequently:!0});else{const i=e;t=document.createElement("canvas"),t.width=i.width,t.height=i.height,n=t.getContext("2d",{willReadFrequently:!0}),n.drawImage(i,0,0,i.width,i.height)}let o=0;for(let i=1;i<10;i++)for(let r=1;r<10;r++){const s=Math.round(r*t.width/10),f=Math.round(i*t.height/10),l=n.getImageData(s,f,1,1).data,c=(.299*l[0]+.587*l[1]+.114*l[2])/255;o+=c}return o/81},Bn=e=>{const t=Dn(e),n=t>.6?"dark":"light";return console.log(`[Annotorious] Image brightness: ${t.toFixed(1)}. Setting ${n} theme.`),n},mt=(e,t,n)=>t.setAttribute("data-theme",n==="auto"?Bn(e):n),Yn=(e,t)=>({...e,drawingEnabled:e.drawingEnabled===void 0?t.drawingEnabled:e.drawingEnabled,drawingMode:e.drawingMode||t.drawingMode,pointerSelectAction:e.pointerSelectAction||t.pointerSelectAction,theme:e.theme||t.theme}),Rn=navigator.userAgent.indexOf("Mac OS X")!==-1,Xn=(e,t)=>{const n=t||document,o=s=>{s.key==="Z"&&s.ctrlKey?e.undo():s.key==="Y"&&s.ctrlKey&&e.redo()},i=s=>{s.key==="z"&&s.metaKey&&(s.shiftKey?e.redo():e.undo())},r=()=>{Rn?n.removeEventListener("keydown",i):n.removeEventListener("keydown",o)};return Rn?n.addEventListener("keydown",i):n.addEventListener("keydown",o),{destroy:r}},cr="",dr="",hr="",fr=(e,t={})=>{if(!e)throw"Missing argument: image";const n=typeof e=="string"?document.getElementById(e):e,o=Yn(t,{drawingEnabled:!0,drawingMode:"drag",pointerSelectAction:Gt.EDIT,theme:"light"}),i=vn(o),{selection:r,store:s}=i,f=vo(s),l=Bo(i,f,o.adapter,o.autoSave),c=document.createElement("DIV");c.style.position="relative",c.style.display="inline-block",n.style.display="block",n.parentNode.insertBefore(c,n),c.appendChild(n);const h=Xn(f);let u=Fo();mt(n,c,o.theme);const m=new In({target:c,props:{drawingEnabled:o.drawingEnabled,image:n,preferredDrawingMode:o.drawingMode,state:i,style:o.style,user:u}});m.$on("click",y=>{const{originalEvent:b,annotation:A}=y.detail;A?r.clickSelect(A.id,b):r.isEmpty()||r.clear()});const d=Ro(i,f,o.adapter),p=()=>{m.$destroy(),c.parentNode.insertBefore(n,c),c.parentNode.removeChild(c),h.destroy(),f.destroy()},S=()=>u,E=(y,b,A)=>gn(y,b,A),w=(y,b)=>nn(y,b),g=y=>{if(!ut(y))throw`No drawing tool named ${y}`;m.$set({toolName:y})},_=y=>m.$set({drawingEnabled:y}),M=y=>{console.warn("Filter not implemented yet")},L=y=>m.$set({style:y}),D=y=>mt(n,c,y),k=y=>{u=y,m.$set({user:y})};return{...d,destroy:p,getUser:S,listDrawingTools:Ve,on:l.on,off:l.off,registerDrawingTool:E,registerShapeEditor:w,setDrawingEnabled:_,setDrawingTool:g,setFilter:M,setStyle:L,setTheme:D,setUser:k,state:i}};R.Editor=Le,R.EditorMount=rn,R.EllipseEditor=xt,R.FreehandEditor=$t,R.Handle=T,R.IdentityTransform=Vi,R.LineEditor=en,R.LineUtil=kt,R.PolygonEditor=Jt,R.RectangleEditor=Qt,R.RectangleUtil=Pt,R.RubberbandRectangle=an,R.SVGAnnotationLayer=In,R.ShapeType=V,R.ToolMount=sn,R.W3CImageFormat=zo,R.addEventListeners=yn,R.boundsFromPoints=ge,R.computeArea=Fe,R.createImageAnnotator=fr,R.createImageAnnotatorState=kn,R.createSVGTransform=pn,R.createSvelteImageAnnotatorState=vn,R.detectTheme=Bn,R.distance=He,R.enableResponsive=fn,R.fillDefaults=Yn,R.getEditor=lt,R.getTool=ut,R.initKeyboardCommands=Xn,R.intersects=Ot,R.isTouch=gi,R.listDrawingTools=Ve,R.parseFragmentSelector=vt,R.parseSVGSelector=Xt,R.parseW3CImageAnnotation=zt,R.registerEditor=nn,R.registerShapeUtil=Me,R.registerTool=gn,R.sampleBrightness=Dn,R.serializeFragmentSelector=Dt,R.serializeSVGSelector=Nt,R.serializeW3CImageAnnotation=jt,R.setTheme=mt,Object.defineProperty(R,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=annotorious.js.map
