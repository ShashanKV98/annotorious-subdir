(function(X,V){typeof exports=="object"&&typeof module<"u"?V(exports):typeof define=="function"&&define.amd?define(["exports"],V):(X=typeof globalThis<"u"?globalThis:X||self,V(X.Annotorious={}))})(this,function(X){"use strict";function V(){}function Gn(e,t){for(const n in t)e[n]=t[n];return e}function St(e){return e()}function At(){return Object.create(null)}function le(e){e.forEach(St)}function q(e){return typeof e=="function"}function K(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function Vn(e){return Object.keys(e).length===0}function Tt(e,...t){if(e==null)return V;const n=e.subscribe(...t);return n.unsubscribe?()=>n.unsubscribe():n}function Mt(e,t,n){e.$$.on_destroy.push(Tt(t,n))}function zn(e,t,n,o){if(e){const i=Lt(e,t,n,o);return e[0](i)}}function Lt(e,t,n,o){return e[1]&&o?Gn(n.ctx.slice(),e[1](o(t))):n.ctx}function jn(e,t,n,o){if(e[2]&&o){const i=e[2](o(n));if(t.dirty===void 0)return i;if(typeof i=="object"){const r=[],s=Math.max(t.dirty.length,i.length);for(let f=0;f<s;f+=1)r[f]=t.dirty[f]|i[f];return r}return t.dirty|i}return t.dirty}function qn(e,t,n,o,i,r){if(i){const s=Lt(t,n,o,r);e.p(s,i)}}function Wn(e){if(e.ctx.length>32){const t=[],n=e.ctx.length/32;for(let o=0;o<n;o++)t[o]=-1;return t}return-1}function oe(e,t){e.appendChild(t)}function v(e,t,n){e.insertBefore(t,n||null)}function k(e){e.parentNode&&e.parentNode.removeChild(e)}function tt(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function D(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function kt(e){return document.createTextNode(e)}function Q(){return kt(" ")}function ue(){return kt("")}function W(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)}function l(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function Kn(e){return Array.from(e.childNodes)}function vt(e,t,n){e.classList[n?"add":"remove"](t)}function Zn(e,t,{bubbles:n=!1,cancelable:o=!1}={}){const i=document.createEvent("CustomEvent");return i.initCustomEvent(e,n,o,t),i}let De;function Be(e){De=e}function It(){if(!De)throw new Error("Function called outside component initialization");return De}function pe(e){It().$$.on_mount.push(e)}function de(){const e=It();return(t,n,{cancelable:o=!1}={})=>{const i=e.$$.callbacks[t];if(i){const r=Zn(t,n,{cancelable:o});return i.slice().forEach(s=>{s.call(e,r)}),!r.defaultPrevented}return!0}}function te(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach(o=>o.call(this,t))}const Ae=[],Ye=[];let Te=[];const Ot=[],Jn=Promise.resolve();let nt=!1;function Qn(){nt||(nt=!0,Jn.then(Pt))}function ot(e){Te.push(e)}const it=new Set;let Me=0;function Pt(){if(Me!==0)return;const e=De;do{try{for(;Me<Ae.length;){const t=Ae[Me];Me++,Be(t),xn(t.$$)}}catch(t){throw Ae.length=0,Me=0,t}for(Be(null),Ae.length=0,Me=0;Ye.length;)Ye.pop()();for(let t=0;t<Te.length;t+=1){const n=Te[t];it.has(n)||(it.add(n),n())}Te.length=0}while(Ae.length);for(;Ot.length;)Ot.pop()();nt=!1,it.clear(),Be(e)}function xn(e){if(e.fragment!==null){e.update(),le(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(ot)}}function $n(e){const t=[],n=[];Te.forEach(o=>e.indexOf(o)===-1?t.push(o):n.push(o)),n.forEach(o=>o()),Te=t}const Ue=new Set;let Ee;function me(){Ee={r:0,c:[],p:Ee}}function he(){Ee.r||le(Ee.c),Ee=Ee.p}function G(e,t){e&&e.i&&(Ue.delete(e),e.i(t))}function j(e,t,n,o){if(e&&e.o){if(Ue.has(e))return;Ue.add(e),Ee.c.push(()=>{Ue.delete(e),o&&(n&&e.d(1),o())}),e.o(t)}else o&&o()}function se(e){e&&e.c()}function ie(e,t,n,o){const{fragment:i,after_update:r}=e.$$;i&&i.m(t,n),o||ot(()=>{const s=e.$$.on_mount.map(St).filter(q);e.$$.on_destroy?e.$$.on_destroy.push(...s):le(s),e.$$.on_mount=[]}),r.forEach(ot)}function re(e,t){const n=e.$$;n.fragment!==null&&($n(n.after_update),le(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function eo(e,t){e.$$.dirty[0]===-1&&(Ae.push(e),Qn(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function x(e,t,n,o,i,r,s,f=[-1]){const a=De;Be(e);const u=e.$$={fragment:null,ctx:[],props:r,update:V,not_equal:i,bound:At(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(a?a.$$.context:[])),callbacks:At(),dirty:f,skip_bound:!1,root:t.target||a.$$.root};s&&s(u.root);let m=!1;if(u.ctx=n?n(e,t.props||{},(c,h,...d)=>{const p=d.length?d[0]:h;return u.ctx&&i(u.ctx[c],u.ctx[c]=p)&&(!u.skip_bound&&u.bound[c]&&u.bound[c](p),m&&eo(e,c)),h}):[],u.update(),m=!0,le(u.before_update),u.fragment=o?o(u.ctx):!1,t.target){if(t.hydrate){const c=Kn(t.target);u.fragment&&u.fragment.l(c),c.forEach(k)}else u.fragment&&u.fragment.c();t.intro&&G(e.$$.fragment),ie(e,t.target,t.anchor,t.customElement),Pt()}Be(a)}class ${$destroy(){re(this,1),this.$destroy=V}$on(t,n){if(!q(n))return V;const o=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return o.push(n),()=>{const i=o.indexOf(n);i!==-1&&o.splice(i,1)}}$set(t){this.$$set&&!Vn(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}var z=(e=>(e.ELLIPSE="ELLIPSE",e.POLYGON="POLYGON",e.RECTANGLE="RECTANGLE",e.FREEHAND="FREEHAND",e.LINE="LINE",e))(z||{});const rt={},Le=(e,t)=>rt[e]=t,He=e=>rt[e.type].area(e),Dt=(e,t,n)=>rt[e.type].intersects(e,t,n),ye=e=>{let t=1/0,n=1/0,o=-1/0,i=-1/0;return e.forEach(([r,s])=>{t=Math.min(t,r),n=Math.min(n,s),o=Math.max(o,r),i=Math.max(i,s)}),{minX:t,minY:n,maxX:o,maxY:i}},to={area:e=>Math.PI*e.geometry.rx*e.geometry.ry,intersects:(e,t,n)=>{const{cx:o,cy:i,rx:r,ry:s}=e.geometry,f=0,a=Math.cos(f),u=Math.sin(f),m=t-o,c=n-i,h=a*m+u*c,d=u*m-a*c;return h*h/(r*r)+d*d/(s*s)<=1}};Le(z.ELLIPSE,to);const no={area:e=>{const{points:t}=e.geometry;let n=0,o=t.length-1;for(let i=0;i<t.length;i++)n+=(t[o][0]+t[i][0])*(t[o][1]-t[i][1]),o=i;return Math.abs(.5*n)},intersects:(e,t,n)=>{const{points:o}=e.geometry;let i=!1;for(let r=0,s=o.length-1;r<o.length;s=r++){const f=o[r][0],a=o[r][1],u=o[s][0],m=o[s][1];a>n!=m>n&&t<(u-f)*(n-a)/(m-a)+f&&(i=!i)}return i}};Le(z.POLYGON,no);const Bt={area:e=>e.geometry.w*e.geometry.h,intersects:(e,t,n)=>t>=e.geometry.x&&t<=e.geometry.x+e.geometry.w&&n>=e.geometry.y&&n<=e.geometry.y+e.geometry.h};Le(z.RECTANGLE,Bt);const oo={area:e=>{const{points:t}=e.geometry;let n=0,o=t.length-1;for(let i=0;i<t.length;i++)n+=(t[o][0]+t[i][0])*(t[o][1]-t[i][1]),o=i;return Math.abs(.5*n)},intersects:(e,t,n)=>{const{points:o}=e.geometry;let i=!1;for(let r=0,s=o.length-1;r<o.length;s=r++){const f=o[r][0],a=o[r][1],u=o[s][0],m=o[s][1];a>n!=m>n&&t<(u-f)*(n-a)/(m-a)+f&&(i=!i)}return i}};Le(z.FREEHAND,oo);const Yt={area:e=>0,intersects:(e,t,n)=>{const o=e.geometry.x1,i=e.geometry.x2,r=e.geometry.y1,s=e.geometry.y2;var f=Math.sqrt(Math.pow(t-o,2)+Math.pow(n-r,2)),a=Math.sqrt(Math.pow(t-i,2)+Math.pow(n-s,2)),u=Math.sqrt(Math.pow(i-o,2)+Math.pow(s-r,2)),m=f+a;return Math.abs(m-u)<=.1}};Le(z.LINE,Yt);const Rt=(e,t=!1)=>{const n=typeof e=="string"?e:e.value,o=/^(xywh)=(pixel|percent)?:?(.+?),(.+?),(.+?),(.+)*/g,i=[...n.matchAll(o)][0],[r,s,f,a,u,m,c]=i;if(s!=="xywh")throw new Error("Unsupported MediaFragment: "+n);if(f&&f!=="pixel")throw new Error(`Unsupported MediaFragment unit: ${f}`);const[h,d,p,S]=[a,u,m,c].map(parseFloat);return{type:z.RECTANGLE,geometry:{x:h,y:d,w:p,h:S,bounds:{minX:h,minY:t?d-S:d,maxX:h+p,maxY:t?d:d+S}}}},Xt=e=>{const{x:t,y:n,w:o,h:i}=e;return{type:"FragmentSelector",conformsTo:"http://www.w3.org/TR/media-frags/",value:`xywh=pixel:${t},${n},${o},${i}`}},Nt="http://www.w3.org/2000/svg",Ct=e=>{const t=o=>{Array.from(o.attributes).forEach(i=>{i.name.startsWith("on")&&o.removeAttribute(i.name)})},n=e.getElementsByTagName("script");return Array.from(n).reverse().forEach(o=>o.parentNode.removeChild(o)),Array.from(e.querySelectorAll("*")).forEach(t),e},io=e=>{const o=new XMLSerializer().serializeToString(e.documentElement).replace("<svg>",`<svg xmlns="${Nt}">`);return new DOMParser().parseFromString(o,"image/svg+xml").documentElement};function ro(e,t){var n=e[0]-t[0],o=e[1]-t[1];return n*n+o*o}function so(e,t,n){var o=t[0],i=t[1],r=n[0]-o,s=n[1]-i;if(r!==0||s!==0){var f=((e[0]-o)*r+(e[1]-i)*s)/(r*r+s*s);f>1?(o=n[0],i=n[1]):f>0&&(o+=r*f,i+=s*f)}return r=e[0]-o,s=e[1]-i,r*r+s*s}function lo(e,t){for(var n=e[0],o=[n],i,r=1,s=e.length;r<s;r++)i=e[r],ro(i,n)>t&&(o.push(i),n=i);return n!==i&&o.push(i),o}function st(e,t,n,o,i){for(var r=o,s,f=t+1;f<n;f++){var a=so(e[f],e[t],e[n]);a>r&&(s=f,r=a)}r>o&&(s-t>1&&st(e,t,s,o,i),i.push(e[s]),n-s>1&&st(e,s,n,o,i))}function ao(e,t){var n=e.length-1,o=[e[0]];return st(e,0,n,t,o),o.push(e[n]),o}function fo(e,t,n){if(e.length<=2)return e;var o=t!==void 0?t*t:1;return e=n?e:lo(e,o),e=ao(e,o),e}const lt={size:4,thinning:.3,smoothing:.5,streamline:.5,easing:e=>e,start:{taper:0,easing:e=>e,cap:!0},end:{taper:0,easing:e=>e,cap:!0}};function co(e){if(!e.length)return"";const t=e.reduce((n,[o,i],r,s)=>{const[f,a]=s[(r+1)%s.length];return n.push(o,i,(o+f)/2,(i+a)/2),n},["M",...e[0],"Q"]);return t.push("Z"),t.join(" ")}function Re(e,t,n=!1){return co(n?fo(e,1):e)}const Ut=e=>{const n=new DOMParser().parseFromString(e,"image/svg+xml"),o=n.lookupPrefix(Nt),i=n.lookupNamespaceURI(null);return o||i?Ct(n).firstChild:Ct(io(n)).firstChild},uo=e=>{const[t,n,o]=e.match(/(<path d=["|'])([^("|')]*)/)||[];if(!o)return;const i=/([MQZT])([^MQZT]*)/g,s=Array.from(o.matchAll(i)).map(f=>(f[1],f[2].trim().split(/\s+/).map(parseFloat)));return{type:z.FREEHAND,geometry:{points:s,bounds:ye(s)}}},mo=e=>{const[t,n,o]=e.match(/(<polygon points=["|'])([^("|')]*)/)||[];if(!o)return;const i=o.split(" ").map(r=>r.split(",").map(parseFloat));return{type:z.POLYGON,geometry:{points:i,bounds:ye(i)}}},ho=e=>{const t=Ut(e),n=parseFloat(t.getAttribute("cx")),o=parseFloat(t.getAttribute("cy")),i=parseFloat(t.getAttribute("rx")),r=parseFloat(t.getAttribute("ry")),s={minX:n-i,minY:o-r,maxX:n+i,maxY:o+r};return{type:z.ELLIPSE,geometry:{cx:n,cy:o,rx:i,ry:r,bounds:s}}},go=e=>{const t=Ut(e),n=parseFloat(t.getAttribute("x1")),o=parseFloat(t.getAttribute("x2")),i=parseFloat(t.getAttribute("y1")),r=parseFloat(t.getAttribute("y2")),s={minX:Math.min(n,o),minY:Math.min(i,r),maxX:Math.max(n,o),maxY:Math.max(i,r)};return{type:z.LINE,geometry:{x1:n,x2:o,y1:i,y2:r,bounds:s}}},Ht=e=>{const t=typeof e=="string"?e:e.value;if(t.includes("<polygon points="))return mo(t);if(t.includes("<path d="))return uo(t);if(t.includes("<ellipse "))return ho(t);if(t.includes("<line "))return go(t)},Ft=e=>{let t;if(e.type===z.POLYGON){const n=e.geometry,{points:o}=n;t=`<svg><polygon points="${o.map(i=>i.join(",")).join(" ")}" /></svg>`}else if(e.type===z.FREEHAND){const n=e.geometry;t=`<svg><path d="${Re(n.points)}"/></svg>`}else if(e.type===z.ELLIPSE){const n=e.geometry;t=`<svg><ellipse cx="${n.cx}" cy="${n.cy}" rx="${n.rx}" ry="${n.ry}" /></svg>`}else if(e.type===z.LINE){const n=e.geometry;t=`<svg><line x1="${n.x1}" x2="${n.x2}" y1="${n.y1}" y2="${n.y2}" /></svg>`}if(t)return{type:"SvgSelector",value:t};throw`Unsupported shape type: ${e.type}`};let Fe;const po=new Uint8Array(16);function yo(){if(!Fe&&(Fe=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Fe))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Fe(po)}const ee=[];for(let e=0;e<256;++e)ee.push((e+256).toString(16).slice(1));function _o(e,t=0){return ee[e[t+0]]+ee[e[t+1]]+ee[e[t+2]]+ee[e[t+3]]+"-"+ee[e[t+4]]+ee[e[t+5]]+"-"+ee[e[t+6]]+ee[e[t+7]]+"-"+ee[e[t+8]]+ee[e[t+9]]+"-"+ee[e[t+10]]+ee[e[t+11]]+ee[e[t+12]]+ee[e[t+13]]+ee[e[t+14]]+ee[e[t+15]]}const Gt={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Vt(e,t,n){if(Gt.randomUUID&&!t&&!e)return Gt.randomUUID();e=e||{};const o=e.random||(e.rng||yo)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,t){n=n||0;for(let i=0;i<16;++i)t[n+i]=o[i];return t}return _o(o)}var zt=Object.prototype.hasOwnProperty;function Se(e,t){var n,o;if(e===t)return!0;if(e&&t&&(n=e.constructor)===t.constructor){if(n===Date)return e.getTime()===t.getTime();if(n===RegExp)return e.toString()===t.toString();if(n===Array){if((o=e.length)===t.length)for(;o--&&Se(e[o],t[o]););return o===-1}if(!n||typeof e=="object"){o=0;for(n in e)if(zt.call(e,n)&&++o&&!zt.call(t,n)||!(n in t)||!Se(e[n],t[n]))return!1;return Object.keys(t).length===o}}return e!==e&&t!==t}function at(){}function wo(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}const ke=[];function ft(e,t=at){let n;const o=new Set;function i(f){if(wo(e,f)&&(e=f,n)){const a=!ke.length;for(const u of o)u[1](),ke.push(u,e);if(a){for(let u=0;u<ke.length;u+=2)ke[u][0](ke[u+1]);ke.length=0}}}function r(f){i(f(e))}function s(f,a=at){const u=[f,a];return o.add(u),o.size===1&&(n=t(i)||at),f(e),()=>{o.delete(u),o.size===0&&n&&(n(),n=null)}}return{set:i,update:r,subscribe:s}}const bo=e=>{const{subscribe:t,set:n}=ft(null);let o=null;return t(i=>o=i),e.observe(({changes:i})=>{if(o){i.deleted.some(s=>s.id===o)&&n(null);const r=i.updated.find(({oldValue:s})=>s.id===o);r&&n(r.newValue.id)}}),{get current(){return o},subscribe:t,set:n}};var jt=(e=>(e.EDIT="EDIT",e.SELECT="SELECT",e.NONE="NONE",e))(jt||{});const ct={selected:[]},Eo=(e,t="EDIT")=>{const{subscribe:n,set:o}=ft(ct);let i=ct;n(c=>i=c);const r=()=>o(ct),s=()=>{var c;return((c=i.selected)==null?void 0:c.length)===0},f=c=>{if(i.selected.length===0)return!1;const h=typeof c=="string"?c:c.id;return i.selected.some(d=>d.id===h)},a=(c,h)=>{const d=e.getAnnotation(c);if(d){const p=So(d,t);o(p==="EDIT"?{selected:[{id:c,editable:!0}],pointerEvent:h}:p==="SELECT"?{selected:[{id:c}],pointerEvent:h}:{selected:[],pointerEvent:h})}else console.warn("Invalid selection: "+c)},u=(c,h=!0)=>{const d=Array.isArray(c)?c:[c],p=d.map(S=>e.getAnnotation(S)).filter(S=>S);o({selected:p.map(({id:S})=>({id:S,editable:h}))}),p.length!==d.length&&console.warn("Invalid selection",c)},m=c=>{if(i.selected.length===0)return!1;const{selected:h}=i;h.filter(({id:d})=>c.includes(d)).length>0&&o({selected:h.filter(({id:d})=>!c.includes(d))})};return e.observe(({changes:c})=>m(c.deleted.map(h=>h.id))),{clear:r,clickSelect:a,get selected(){return i?[...i.selected]:null},get pointerEvent(){return i?i.pointerEvent:null},isEmpty:s,isSelected:f,setSelected:u,subscribe:n}},So=(e,t)=>typeof t=="function"?t(e)||"EDIT":t||"EDIT",Ao=[];for(let e=0;e<256;++e)Ao.push((e+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const To=(e,t)=>{const n=new Set(e.bodies.map(o=>o.id));return t.bodies.filter(o=>!n.has(o.id))},Mo=(e,t)=>{const n=new Set(t.bodies.map(o=>o.id));return e.bodies.filter(o=>!n.has(o.id))},Lo=(e,t)=>t.bodies.map(n=>{const o=e.bodies.find(i=>i.id===n.id);return{newBody:n,oldBody:o&&!Se(o,n)?o:void 0}}).filter(({oldBody:n})=>n),ko=(e,t)=>!Se(e.target,t.target),qt=(e,t)=>{const n=To(e,t),o=Mo(e,t),i=Lo(e,t);return{oldValue:e,newValue:t,bodiesCreated:n.length>0?n:void 0,bodiesDeleted:o.length>0?o:void 0,bodiesUpdated:i.length>0?i:void 0,targetUpdated:ko(e,t)?{oldTarget:e.target,newTarget:t.target}:void 0}};var Z=(e=>(e.LOCAL="LOCAL",e.REMOTE="REMOTE",e))(Z||{});const vo=(e,t)=>{var n,o;const{changes:i,origin:r}=t;if(!(!e.options.origin||e.options.origin===r))return!1;if(e.options.ignore){const{ignore:s}=e.options,f=a=>(a==null?void 0:a.length)>0;if(!(f(i.created)||f(i.deleted))){const a=(n=i.updated)==null?void 0:n.some(m=>f(m.bodiesCreated)||f(m.bodiesDeleted)||f(m.bodiesUpdated)),u=(o=i.updated)==null?void 0:o.some(m=>m.targetUpdated);if(s==="BODY_ONLY"&&a&&!u||s==="TARGET_ONLY"&&u&&!a)return!1}}if(e.options.annotations){const s=new Set([...i.created.map(f=>f.id),...i.deleted.map(f=>f.id),...i.updated.map(({oldValue:f})=>f.id)]);return!!(Array.isArray(e.options.annotations)?e.options.annotations:[e.options.annotations]).find(f=>s.has(f))}else return!0},Io=(e,t)=>{const n=new Set((e.created||[]).map(c=>c.id)),o=new Set((e.updated||[]).map(({newValue:c})=>c.id)),i=new Set((t.created||[]).map(c=>c.id)),r=new Set((t.deleted||[]).map(c=>c.id)),s=new Set((t.updated||[]).map(({oldValue:c})=>c.id)),f=new Set((t.updated||[]).filter(({oldValue:c})=>n.has(c.id)||o.has(c.id)).map(({oldValue:c})=>c.id)),a=[...(e.created||[]).filter(c=>!r.has(c.id)).map(c=>s.has(c.id)?t.updated.find(({oldValue:h})=>h.id===c.id).newValue:c),...t.created||[]],u=[...(e.deleted||[]).filter(c=>!i.has(c.id)),...(t.deleted||[]).filter(c=>!n.has(c.id))],m=[...(e.updated||[]).filter(({newValue:c})=>!r.has(c.id)).map(c=>{const{oldValue:h,newValue:d}=c;if(s.has(d.id)){const p=t.updated.find(S=>S.oldValue.id===d.id).newValue;return qt(h,p)}else return c}),...(t.updated||[]).filter(({oldValue:c})=>!f.has(c.id))];return{created:a,deleted:u,updated:m}},Oo=e=>e.id!==void 0,Po=()=>{const e=new Map,t=new Map,n=[],o=(w,b={})=>n.push({onChange:w,options:b}),i=w=>{const b=n.findIndex(A=>A.onChange==w);b>-1&&n.splice(b,1)},r=(w,b)=>{const A={origin:w,changes:{created:b.created||[],updated:b.updated||[],deleted:b.deleted||[]},state:[...e.values()]};n.forEach(I=>{vo(I,A)&&I.onChange(A)})},s=(w,b=Z.LOCAL)=>{if(e.get(w.id))throw Error(`Cannot add annotation ${w.id} - exists already`);e.set(w.id,w),w.bodies.forEach(A=>t.set(A.id,w.id)),r(b,{created:[w]})},f=(w,b)=>{const A=typeof w=="string"?b:w,I=typeof w=="string"?w:w.id,P=e.get(I);if(P){const U=qt(P,A);return I===A.id?e.set(I,A):(e.delete(I),e.set(A.id,A)),P.bodies.forEach(H=>t.delete(H.id)),A.bodies.forEach(H=>t.set(H.id,A.id)),U}else console.warn(`Cannot update annotation ${I} - does not exist`)},a=(w,b=Z.LOCAL,A=Z.LOCAL)=>{const I=Oo(b)?A:b,P=f(w,b);P&&r(I,{updated:[P]})},u=(w,b=Z.LOCAL)=>{const A=w.reduce((I,P)=>{const U=f(P);return U?[...I,U]:I},[]);A.length>0&&r(b,{updated:A})},m=(w,b=Z.LOCAL)=>{const A=e.get(w.annotation);if(A){const I={...A,bodies:[...A.bodies,w]};e.set(A.id,I),t.set(w.id,I.id),r(b,{updated:[{oldValue:A,newValue:I,bodiesCreated:[w]}]})}else console.warn(`Attempt to add body to missing annotation: ${w.annotation}`)},c=()=>[...e.values()],h=(w=Z.LOCAL)=>{const b=[...e.values()];e.clear(),t.clear(),r(w,{deleted:b})},d=(w,b=!0,A=Z.LOCAL)=>{if(b){const I=[...e.values()];e.clear(),t.clear(),w.forEach(P=>{e.set(P.id,P),P.bodies.forEach(U=>t.set(U.id,P.id))}),r(A,{created:w,deleted:I})}else{const I=w.reduce((P,U)=>{const H=e.get(U.id);return H?[...P,H]:P},[]);if(I.length>0)throw Error(`Bulk insert would overwrite the following annotations: ${I.map(P=>P.id).join(", ")}`);w.forEach(P=>{e.set(P.id,P),P.bodies.forEach(U=>t.set(U.id,P.id))}),r(A,{created:w})}},p=w=>{const b=typeof w=="string"?w:w.id,A=e.get(b);if(A)return e.delete(b),A.bodies.forEach(I=>t.delete(I.id)),A;console.warn(`Attempt to delete missing annotation: ${b}`)},S=(w,b=Z.LOCAL)=>{const A=p(w);A&&r(b,{deleted:[A]})},E=(w,b=Z.LOCAL)=>{const A=w.reduce((I,P)=>{const U=p(P);return U?[...I,U]:I},[]);A.length>0&&r(b,{deleted:A})},y=(w,b=Z.LOCAL)=>{const A=e.get(w.annotation);if(A){const I=A.bodies.find(P=>P.id===w.id);if(I){t.delete(I.id);const P={...A,bodies:A.bodies.filter(U=>U.id!==w.id)};e.set(A.id,P),r(b,{updated:[{oldValue:A,newValue:P,bodiesDeleted:[I]}]})}else console.warn(`Attempt to delete missing body ${w.id} from annotation ${w.annotation}`)}else console.warn(`Attempt to delete body from missing annotation ${w.annotation}`)},g=w=>{const b=e.get(w);return b?{...b}:void 0},_=w=>{const b=t.get(w);if(b){const A=g(b).bodies.find(I=>I.id===w);if(A)return A;console.error(`Store integrity error: body ${w} in index, but not in annotation`)}else console.warn(`Attempt to retrieve missing body: ${w}`)},T=(w,b)=>{if(w.annotation!==b.annotation)throw"Annotation integrity violation: annotation ID must be the same when updating bodies";const A=e.get(w.annotation);if(A){const I=A.bodies.find(U=>U.id===w.id),P={...A,bodies:A.bodies.map(U=>U.id===I.id?b:U)};return e.set(A.id,P),I.id!==b.id&&(t.delete(I.id),t.set(b.id,P.id)),{oldValue:A,newValue:P,bodiesUpdated:[{oldBody:I,newBody:b}]}}else console.warn(`Attempt to add body to missing annotation ${w.annotation}`)},L=(w,b,A=Z.LOCAL)=>{const I=T(w,b);r(A,{updated:[I]})},Y=(w,b=Z.LOCAL)=>{const A=w.map(I=>T({id:I.id,annotation:I.annotation},I));r(b,{updated:A})},R=w=>{const b=e.get(w.annotation);if(b){const A={...b,target:{...b.target,...w}};return e.set(b.id,A),{oldValue:b,newValue:A,targetUpdated:{oldTarget:b.target,newTarget:w}}}else console.warn(`Attempt to update target on missing annotation: ${w.annotation}`)};return{addAnnotation:s,addBody:m,all:c,bulkAddAnnotation:d,bulkDeleteAnnotation:E,bulkUpdateAnnotation:u,bulkUpdateBodies:Y,bulkUpdateTargets:(w,b=Z.LOCAL)=>{const A=w.map(R).filter(I=>I);A.length>0&&r(b,{updated:A})},clear:h,deleteAnnotation:S,deleteBody:y,getAnnotation:g,getBody:_,observe:o,unobserve:i,updateAnnotation:a,updateBody:L,updateTarget:(w,b=Z.LOCAL)=>{const A=R(w);A&&r(b,{updated:[A]})}}},Do=e=>({...e,subscribe:t=>{const n=o=>t(o.state);return e.observe(n),t(e.all()),()=>e.unobserve(n)}});let Bo=()=>({emit(e,...t){let n=this.events[e]||[];for(let o=0,i=n.length;o<i;o++)n[o](...t)},events:{},on(e,t){var n;return(n=this.events[e])!=null&&n.push(t)||(this.events[e]=[t]),()=>{var o;this.events[e]=(o=this.events[e])==null?void 0:o.filter(i=>t!==i)}}});const Yo=250,Ro=e=>{const t=Bo(),n=[];let o=-1,i=!1,r=0;const s=d=>{if(!i){const{changes:p}=d,S=performance.now();if(S-r>Yo)n.splice(o+1),n.push(p),o=n.length-1;else{const E=n.length-1;n[E]=Io(n[E],p)}r=S}i=!1};e.observe(s,{origin:Z.LOCAL});const f=d=>(d==null?void 0:d.length)>0&&e.bulkDeleteAnnotation(d),a=d=>(d==null?void 0:d.length)>0&&e.bulkAddAnnotation(d,!1),u=d=>(d==null?void 0:d.length)>0&&e.bulkUpdateAnnotation(d.map(({oldValue:p})=>p)),m=d=>(d==null?void 0:d.length)>0&&e.bulkUpdateAnnotation(d.map(({newValue:p})=>p)),c=d=>(d==null?void 0:d.length)>0&&e.bulkAddAnnotation(d,!1),h=d=>(d==null?void 0:d.length)>0&&e.bulkDeleteAnnotation(d);return{canRedo:()=>n.length-1>o,canUndo:()=>o>-1,destroy:()=>e.unobserve(s),on:(d,p)=>t.on(d,p),redo:()=>{if(n.length-1>o){i=!0;const{created:d,updated:p,deleted:S}=n[o+1];a(d),m(p),h(S),t.emit("redo",n[o+1]),o+=1}},undo:()=>{if(o>-1){i=!0;const{created:d,updated:p,deleted:S}=n[o];f(d),u(p),c(S),t.emit("undo",n[o]),o-=1}}}},Xo=()=>{const{subscribe:e,set:t}=ft([]);return{subscribe:e,set:t}},No=(e,t,n,o)=>{const{store:i,selection:r,hover:s,viewport:f}=e,a=new Map;let u=[],m,c;const h=(y,g)=>{a.has(y)?a.get(y).push(g):a.set(y,[g])},d=(y,g)=>{const _=a.get(y);_&&_.indexOf(g)>0&&_.splice(_.indexOf(g),1)},p=(y,g,_)=>{a.has(y)&&setTimeout(()=>{a.get(y).forEach(T=>{if(n){const L=Array.isArray(g)?g.map(R=>n.serialize(R)):n.serialize(g),Y=_?_ instanceof PointerEvent?_:n.serialize(_):void 0;T(L,Y)}else T(g,_)})},1)},S=()=>{const{selected:y}=r,g=y.map(({id:_})=>i.getAnnotation(_));g.forEach(_=>{const T=u.find(L=>L.id===_.id);(!T||!Se(T,_))&&p("updateAnnotation",_,T)}),u=u.map(_=>g.find(({id:L})=>L===_.id)||_)};r.subscribe(({selected:y})=>{if(!(u.length===0&&y.length===0)){if(u.length===0&&y.length>0)u=y.map(({id:g})=>i.getAnnotation(g));else if(u.length>0&&y.length===0)u.forEach(g=>{const _=i.getAnnotation(g.id);_&&!Se(_,g)&&p("updateAnnotation",_,g)}),u=[];else{const g=new Set(u.map(T=>T.id)),_=new Set(y.map(({id:T})=>T));u.filter(T=>!_.has(T.id)).forEach(T=>{const L=i.getAnnotation(T.id);L&&!Se(L,T)&&p("updateAnnotation",L,T)}),u=[...u.filter(T=>_.has(T.id)),...y.filter(({id:T})=>!g.has(T)).map(({id:T})=>i.getAnnotation(T))]}p("selectionChanged",u)}}),s.subscribe(y=>{!m&&y?p("mouseEnterAnnotation",i.getAnnotation(y)):m&&!y?p("mouseLeaveAnnotation",i.getAnnotation(m)):m&&y&&(p("mouseLeaveAnnotation",i.getAnnotation(m)),p("mouseEnterAnnotation",i.getAnnotation(y))),m=y}),f==null||f.subscribe(y=>p("viewportIntersect",y.map(i.getAnnotation))),i.observe(y=>{o&&(c&&clearTimeout(c),c=setTimeout(S,1e3));const{created:g,deleted:_}=y.changes;g.forEach(T=>p("createAnnotation",T)),_.forEach(T=>p("deleteAnnotation",T)),y.changes.updated.filter(T=>[...T.bodiesCreated||[],...T.bodiesDeleted||[],...T.bodiesUpdated||[]].length>0).forEach(({oldValue:T,newValue:L})=>{const Y=u.find(R=>R.id===T.id)||T;u=u.map(R=>R.id===T.id?L:R),p("updateAnnotation",L,Y)})},{origin:Z.LOCAL}),i.observe(y=>{if(u){const g=new Set(u.map(T=>T.id)),_=y.changes.updated.filter(({newValue:T})=>g.has(T.id)).map(({newValue:T})=>T);_.length>0&&(u=u.map(T=>_.find(Y=>Y.id===T.id)||T))}},{origin:Z.REMOTE});const E=y=>g=>{const{created:_,deleted:T,updated:L}=g;_.forEach(Y=>p("createAnnotation",Y)),T.forEach(Y=>p("deleteAnnotation",Y)),y?L.forEach(Y=>p("updateAnnotation",Y.oldValue,Y.newValue)):L.forEach(Y=>p("updateAnnotation",Y.newValue,Y.oldValue))};return t.on("undo",E(!0)),t.on("redo",E(!1)),{on:h,off:d,emit:p}},Co=e=>t=>t.reduce((n,o)=>{const{parsed:i,error:r}=e.parse(o);return r?{parsed:n.parsed,failed:[...n.failed,o]}:{parsed:[...n.parsed,i],failed:n.failed}},{parsed:[],failed:[]}),Uo=(e,t,n)=>{const{store:o,selection:i}=e,r=E=>{if(n){const{parsed:y,error:g}=n.parse(E);y?o.addAnnotation(y,Z.REMOTE):console.error(g)}else o.addAnnotation(E,Z.REMOTE)},s=()=>i.clear(),f=()=>o.clear(),a=E=>{const y=o.getAnnotation(E);return n&&y?n.serialize(y):y},u=()=>n?o.all().map(n.serialize):o.all(),m=()=>{var E;const y=(((E=i.selected)==null?void 0:E.map(g=>g.id))||[]).map(g=>o.getAnnotation(g));return n?y.map(n.serialize):y},c=E=>fetch(E).then(y=>y.json()).then(y=>(d(y),y)),h=E=>{if(typeof E=="string"){const y=o.getAnnotation(E);return o.deleteAnnotation(E),n?n.serialize(y):y}else{const y=n?n.parse(E).parsed:E;return o.deleteAnnotation(y),E}},d=E=>{if(n){const{parsed:y,failed:g}=Co(n)(E);g.length>0&&console.warn(`Discarded ${g.length} invalid annotations`,g),o.bulkAddAnnotation(y,!0,Z.REMOTE)}else o.bulkAddAnnotation(E,!0,Z.REMOTE)},p=E=>{E?i.setSelected(E):i.clear()},S=E=>{if(n){const y=n.parse(E).parsed,g=n.serialize(o.getAnnotation(y.id));return o.updateAnnotation(y),g}else{const y=o.getAnnotation(E.id);return o.updateAnnotation(E),y}};return{addAnnotation:r,cancelSelected:s,canRedo:t.canRedo,canUndo:t.canUndo,clearAnnotations:f,getAnnotationById:a,getAnnotations:u,getSelected:m,loadAnnotations:c,redo:t.redo,removeAnnotation:h,setAnnotations:d,setSelected:p,undo:t.undo,updateAnnotation:S}};let Ho=e=>crypto.getRandomValues(new Uint8Array(e)),Fo=(e,t,n)=>{let o=(2<<Math.log(e.length-1)/Math.LN2)-1,i=-~(1.6*o*t/e.length);return(r=t)=>{let s="";for(;;){let f=n(i),a=i;for(;a--;)if(s+=e[f[a]&o]||"",s.length===r)return s}}},Go=(e,t=21)=>Fo(e,t,Ho),Vo=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce((t,n)=>(n&=63,n<36?t+=n.toString(36):n<62?t+=(n-26).toString(36).toUpperCase():n>62?t+="-":t+="_",t),"");const zo=()=>({isGuest:!0,id:Go("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",20)()}),jo=e=>{const t=JSON.stringify(e);let n=0;for(let o=0,i=t.length;o<i;o++){let r=t.charCodeAt(o);n=(n<<5)-n+r,n|=0}return`${n}`},Wt=e=>e?typeof e=="object"?{...e}:e:void 0,qo=(e,t)=>(Array.isArray(e)?e:[e]).map(n=>{const{id:o,type:i,purpose:r,value:s,created:f,creator:a,...u}=n;return{id:o||`temp-${jo(n)}`,annotation:t,type:i,purpose:r,value:s,created:f?new Date(f):void 0,creator:Wt(a),...u}}),Wo=e=>e.map(t=>{var n;const o={...t};return delete o.annotation,(n=o.id)!=null&&n.startsWith("temp-")&&delete o.id,o});Vo();const Ko=(e,t=!1)=>({parse:i=>Kt(i,t),serialize:i=>Zt(i,e)}),Kt=(e,t=!1)=>{const n=e.id||Vt(),{creator:o,created:i,updatedBy:r,updated:s,body:f,...a}=e,u=qo(f,n),m=Array.isArray(e.target)?e.target[0]:e.target,c=Array.isArray(m.selector)?m.selector[0]:m.selector,h=c.type==="FragmentSelector"?Rt(c,t):c.type==="SvgSelector"?Ht(c):void 0;return h?{parsed:{...a,id:n,bodies:u,target:{created:i?new Date(i):void 0,creator:Wt(o),...a.target,annotation:n,selector:h}}}:{error:Error(`Unknown selector type: ${c.type}`)}},Zt=(e,t)=>{const{selector:n,creator:o,created:i,updated:r,updatedBy:s,...f}=e.target,a=n.type==z.RECTANGLE?Xt(n.geometry):Ft(n);return{...e,"@context":"http://www.w3.org/ns/anno.jsonld",id:e.id,type:"Annotation",body:Wo(e.bodies),creator:o,created:i==null?void 0:i.toISOString(),target:{...f,source:t,selector:a}}};function Jt(e,t,n){const o=e.slice();return o[11]=t[n],o[13]=n,o}function Qt(e){let t,n,o,i,r;return{c(){t=D("rect"),l(t,"class","a9s-corner-handle"),l(t,"x",n=e[11][0]-e[3]/2),l(t,"y",o=e[11][1]-e[3]/2),l(t,"height",e[3]),l(t,"width",e[3])},m(s,f){v(s,t,f),i||(r=W(t,"pointerdown",function(){q(e[10](M(e[13])))&&e[10](M(e[13])).apply(this,arguments)}),i=!0)},p(s,f){e=s,f&24&&n!==(n=e[11][0]-e[3]/2)&&l(t,"x",n),f&24&&o!==(o=e[11][1]-e[3]/2)&&l(t,"y",o),f&8&&l(t,"height",e[3]),f&8&&l(t,"width",e[3])},d(s){s&&k(t),i=!1,r()}}}function Zo(e){let t,n,o,i,r,s,f,a,u,m,c=e[4].points,h=[];for(let d=0;d<c.length;d+=1)h[d]=Qt(Jt(e,c,d));return{c(){t=D("polygon"),i=Q(),r=D("polygon"),f=Q();for(let d=0;d<h.length;d+=1)h[d].c();a=ue(),l(t,"class","a9s-outer"),l(t,"style",n=e[1]?"display:none;":void 0),l(t,"points",o=e[4].points.map(xt).join(" ")),l(r,"class","a9s-inner a9s-shape-handle"),l(r,"style",e[1]),l(r,"points",s=e[4].points.map($t).join(" "))},m(d,p){v(d,t,p),v(d,i,p),v(d,r,p),v(d,f,p);for(let S=0;S<h.length;S+=1)h[S]&&h[S].m(d,p);v(d,a,p),u||(m=[W(t,"pointerdown",function(){q(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)}),W(r,"pointerdown",function(){q(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)})],u=!0)},p(d,p){if(e=d,p&2&&n!==(n=e[1]?"display:none;":void 0)&&l(t,"style",n),p&16&&o!==(o=e[4].points.map(xt).join(" "))&&l(t,"points",o),p&2&&l(r,"style",e[1]),p&16&&s!==(s=e[4].points.map($t).join(" "))&&l(r,"points",s),p&1048){c=e[4].points;let S;for(S=0;S<c.length;S+=1){const E=Jt(e,c,S);h[S]?h[S].p(E,p):(h[S]=Qt(E),h[S].c(),h[S].m(a.parentNode,a))}for(;S<h.length;S+=1)h[S].d(1);h.length=c.length}},d(d){d&&k(t),d&&k(i),d&&k(r),d&&k(f),tt(h,d),d&&k(a),u=!1,le(m)}}}function Jo(e){let t,n;return t=new ve({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[Zo,({grab:o})=>({10:o}),({grab:o})=>o?1024:0]},$$scope:{ctx:e}}}),t.$on("change",e[7]),t.$on("grab",e[8]),t.$on("release",e[9]),{c(){se(t.$$.fragment)},m(o,i){ie(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&4&&(r.transform=o[2]),i&17434&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){j(t.$$.fragment,o),n=!1},d(o){re(t,o)}}}const xt=e=>e.join(","),$t=e=>e.join(",");function Qo(e,t,n){let o,i,{shape:r}=t,{computedStyle:s=void 0}=t,{transform:f}=t,{viewportScale:a=1}=t;const u=(d,p,S)=>{let E;p===M.SHAPE?E=d.geometry.points.map(([g,_])=>[g+S[0],_+S[1]]):E=d.geometry.points.map(([g,_],T)=>p===M(T)?[g+S[0],_+S[1]]:[g,_]);const y=ye(E);return{...d,geometry:{points:E,bounds:y}}};function m(d){te.call(this,e,d)}function c(d){te.call(this,e,d)}function h(d){te.call(this,e,d)}return e.$$set=d=>{"shape"in d&&n(0,r=d.shape),"computedStyle"in d&&n(1,s=d.computedStyle),"transform"in d&&n(2,f=d.transform),"viewportScale"in d&&n(6,a=d.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=r.geometry),e.$$.dirty&64&&n(3,i=10/a)},[r,s,f,i,o,u,a,m,c,h]}class en extends ${constructor(t){super(),x(this,t,Qo,Jo,K,{shape:0,computedStyle:1,transform:2,viewportScale:6})}}function xo(e){let t,n,o,i,r,s,f,a,u,m,c,h,d,p,S,E,y,g,_,T,L,Y,R,w,b,A,I,P,U,H,N,ce,we,O,C,J,be,ge,ne,qe,We,Ke,wt,ae,Ze,Je,Qe,bt,fe,xe,$e,et,Et,Fn;return{c(){t=D("rect"),f=Q(),a=D("rect"),d=Q(),p=D("rect"),g=Q(),_=D("rect"),R=Q(),w=D("rect"),P=Q(),U=D("rect"),we=Q(),O=D("circle"),ge=Q(),ne=D("circle"),wt=Q(),ae=D("circle"),bt=Q(),fe=D("circle"),l(t,"class","a9s-outer"),l(t,"style",n=e[1]?"display:none;":void 0),l(t,"x",o=e[4].x),l(t,"y",i=e[4].y),l(t,"width",r=e[4].w),l(t,"height",s=e[4].h),l(a,"class","a9s-inner a9s-shape-handle"),l(a,"style",e[1]),l(a,"x",u=e[4].x),l(a,"y",m=e[4].y),l(a,"width",c=e[4].w),l(a,"height",h=e[4].h),l(p,"class","a9s-edge-handle a9s-edge-handle-top"),l(p,"x",S=e[4].x),l(p,"y",E=e[4].y),l(p,"height",1),l(p,"width",y=e[4].w),l(_,"class","a9s-edge-handle a9s-edge-handle-right"),l(_,"x",T=e[4].x+e[4].w),l(_,"y",L=e[4].y),l(_,"height",Y=e[4].h),l(_,"width",1),l(w,"class","a9s-edge-handle a9s-edge-handle-bottom"),l(w,"x",b=e[4].x),l(w,"y",A=e[4].y+e[4].h),l(w,"height",1),l(w,"width",I=e[4].w),l(U,"class","a9s-edge-handle a9s-edge-handle-left"),l(U,"x",H=e[4].x),l(U,"y",N=e[4].y),l(U,"height",ce=e[4].h),l(U,"width",1),l(O,"class","a9s-corner-handle a9s-corner-handle-topleft"),l(O,"cx",C=e[4].x),l(O,"cy",J=e[4].y),l(O,"r",be=e[3]/2),l(ne,"class","a9s-corner-handle a9s-corner-handle-topright"),l(ne,"cx",qe=e[4].x+e[4].w),l(ne,"cy",We=e[4].y),l(ne,"r",Ke=e[3]/2),l(ae,"class","a9s-corner-handle a9s-corner-handle-bottomright"),l(ae,"cx",Ze=e[4].x+e[4].w),l(ae,"cy",Je=e[4].y+e[4].h),l(ae,"r",Qe=e[3]/2),l(fe,"class","a9s-corner-handle a9s-corner-handle-bottomleft"),l(fe,"cx",xe=e[4].x),l(fe,"cy",$e=e[4].y+e[4].h),l(fe,"r",et=e[3]/2)},m(F,B){v(F,t,B),v(F,f,B),v(F,a,B),v(F,d,B),v(F,p,B),v(F,g,B),v(F,_,B),v(F,R,B),v(F,w,B),v(F,P,B),v(F,U,B),v(F,we,B),v(F,O,B),v(F,ge,B),v(F,ne,B),v(F,wt,B),v(F,ae,B),v(F,bt,B),v(F,fe,B),Et||(Fn=[W(t,"pointerdown",function(){q(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)}),W(a,"pointerdown",function(){q(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)}),W(p,"pointerdown",function(){q(e[10](M.TOP))&&e[10](M.TOP).apply(this,arguments)}),W(_,"pointerdown",function(){q(e[10](M.RIGHT))&&e[10](M.RIGHT).apply(this,arguments)}),W(w,"pointerdown",function(){q(e[10](M.BOTTOM))&&e[10](M.BOTTOM).apply(this,arguments)}),W(U,"pointerdown",function(){q(e[10](M.LEFT))&&e[10](M.LEFT).apply(this,arguments)}),W(O,"pointerdown",function(){q(e[10](M.TOP_LEFT))&&e[10](M.TOP_LEFT).apply(this,arguments)}),W(ne,"pointerdown",function(){q(e[10](M.TOP_RIGHT))&&e[10](M.TOP_RIGHT).apply(this,arguments)}),W(ae,"pointerdown",function(){q(e[10](M.BOTTOM_RIGHT))&&e[10](M.BOTTOM_RIGHT).apply(this,arguments)}),W(fe,"pointerdown",function(){q(e[10](M.BOTTOM_LEFT))&&e[10](M.BOTTOM_LEFT).apply(this,arguments)})],Et=!0)},p(F,B){e=F,B&2&&n!==(n=e[1]?"display:none;":void 0)&&l(t,"style",n),B&16&&o!==(o=e[4].x)&&l(t,"x",o),B&16&&i!==(i=e[4].y)&&l(t,"y",i),B&16&&r!==(r=e[4].w)&&l(t,"width",r),B&16&&s!==(s=e[4].h)&&l(t,"height",s),B&2&&l(a,"style",e[1]),B&16&&u!==(u=e[4].x)&&l(a,"x",u),B&16&&m!==(m=e[4].y)&&l(a,"y",m),B&16&&c!==(c=e[4].w)&&l(a,"width",c),B&16&&h!==(h=e[4].h)&&l(a,"height",h),B&16&&S!==(S=e[4].x)&&l(p,"x",S),B&16&&E!==(E=e[4].y)&&l(p,"y",E),B&16&&y!==(y=e[4].w)&&l(p,"width",y),B&16&&T!==(T=e[4].x+e[4].w)&&l(_,"x",T),B&16&&L!==(L=e[4].y)&&l(_,"y",L),B&16&&Y!==(Y=e[4].h)&&l(_,"height",Y),B&16&&b!==(b=e[4].x)&&l(w,"x",b),B&16&&A!==(A=e[4].y+e[4].h)&&l(w,"y",A),B&16&&I!==(I=e[4].w)&&l(w,"width",I),B&16&&H!==(H=e[4].x)&&l(U,"x",H),B&16&&N!==(N=e[4].y)&&l(U,"y",N),B&16&&ce!==(ce=e[4].h)&&l(U,"height",ce),B&16&&C!==(C=e[4].x)&&l(O,"cx",C),B&16&&J!==(J=e[4].y)&&l(O,"cy",J),B&8&&be!==(be=e[3]/2)&&l(O,"r",be),B&16&&qe!==(qe=e[4].x+e[4].w)&&l(ne,"cx",qe),B&16&&We!==(We=e[4].y)&&l(ne,"cy",We),B&8&&Ke!==(Ke=e[3]/2)&&l(ne,"r",Ke),B&16&&Ze!==(Ze=e[4].x+e[4].w)&&l(ae,"cx",Ze),B&16&&Je!==(Je=e[4].y+e[4].h)&&l(ae,"cy",Je),B&8&&Qe!==(Qe=e[3]/2)&&l(ae,"r",Qe),B&16&&xe!==(xe=e[4].x)&&l(fe,"cx",xe),B&16&&$e!==($e=e[4].y+e[4].h)&&l(fe,"cy",$e),B&8&&et!==(et=e[3]/2)&&l(fe,"r",et)},d(F){F&&k(t),F&&k(f),F&&k(a),F&&k(d),F&&k(p),F&&k(g),F&&k(_),F&&k(R),F&&k(w),F&&k(P),F&&k(U),F&&k(we),F&&k(O),F&&k(ge),F&&k(ne),F&&k(wt),F&&k(ae),F&&k(bt),F&&k(fe),Et=!1,le(Fn)}}}function $o(e){let t,n;return t=new ve({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[xo,({grab:o})=>({10:o}),({grab:o})=>o?1024:0]},$$scope:{ctx:e}}}),t.$on("grab",e[7]),t.$on("change",e[8]),t.$on("release",e[9]),{c(){se(t.$$.fragment)},m(o,i){ie(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&4&&(r.transform=o[2]),i&3098&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){j(t.$$.fragment,o),n=!1},d(o){re(t,o)}}}function ei(e,t,n){let o,i,{shape:r}=t,{computedStyle:s=void 0}=t,{transform:f}=t,{viewportScale:a=1}=t;const u=(d,p,S)=>{const E=d.geometry.bounds;let[y,g]=[E.minX,E.minY],[_,T]=[E.maxX,E.maxY];const[L,Y]=S;if(p===M.SHAPE)y+=L,_+=L,g+=Y,T+=Y;else{switch(p){case M.TOP:case M.TOP_LEFT:case M.TOP_RIGHT:{g+=Y;break}case M.BOTTOM:case M.BOTTOM_LEFT:case M.BOTTOM_RIGHT:{T+=Y;break}}switch(p){case M.LEFT:case M.TOP_LEFT:case M.BOTTOM_LEFT:{y+=L;break}case M.RIGHT:case M.TOP_RIGHT:case M.BOTTOM_RIGHT:{_+=L;break}}}const R=Math.min(y,_),w=Math.min(g,T),b=Math.abs(_-y),A=Math.abs(T-g);return{...d,geometry:{x:R,y:w,w:b,h:A,bounds:{minX:R,minY:w,maxX:R+b,maxY:w+A}}}};function m(d){te.call(this,e,d)}function c(d){te.call(this,e,d)}function h(d){te.call(this,e,d)}return e.$$set=d=>{"shape"in d&&n(0,r=d.shape),"computedStyle"in d&&n(1,s=d.computedStyle),"transform"in d&&n(2,f=d.transform),"viewportScale"in d&&n(6,a=d.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=r.geometry),e.$$.dirty&64&&n(3,i=10/a)},[r,s,f,i,o,u,a,m,c,h]}class tn extends ${constructor(t){super(),x(this,t,ei,$o,K,{shape:0,computedStyle:1,transform:2,viewportScale:6})}}function ti(e){let t,n,o,i,r,s,f,a,u,m,c,h,d,p,S,E,y,g,_,T,L,Y,R,w,b,A,I,P,U;return{c(){t=D("ellipse"),s=Q(),f=D("ellipse"),h=Q(),d=D("rect"),E=Q(),y=D("rect"),T=Q(),L=D("rect"),w=Q(),b=D("rect"),l(t,"class","a9s-outer"),l(t,"cx",n=e[3].cx),l(t,"cy",o=e[3].cy),l(t,"rx",i=e[3].rx),l(t,"ry",r=e[3].ry),l(f,"class","a9s-inner a9s-shape-handle"),l(f,"cx",a=e[3].cx),l(f,"cy",u=e[3].cy),l(f,"rx",m=e[3].rx),l(f,"ry",c=e[3].ry),l(d,"class","a9s-corner-handle a9s-corner-top"),l(d,"x",p=e[3].cx-e[2]/2),l(d,"y",S=e[3].cy-e[2]/2-e[3].ry),l(d,"height",e[2]),l(d,"width",e[2]),l(y,"class","a9s-corner-handle a9s-corner-handle-right"),l(y,"x",g=e[3].cx+e[3].rx-e[2]/2),l(y,"y",_=e[3].cy-e[2]/2),l(y,"height",e[2]),l(y,"width",e[2]),l(L,"class","a9s-corner-handle a9s-corner-handle-bottom"),l(L,"x",Y=e[3].cx-e[2]/2),l(L,"y",R=e[3].cy+e[3].ry-e[2]/2),l(L,"height",e[2]),l(L,"width",e[2]),l(b,"class","a9s-corner-handle a9s-corner-handle-left"),l(b,"x",A=e[3].cx-e[3].rx-e[2]/2),l(b,"y",I=e[3].cy-e[2]/2),l(b,"height",e[2]),l(b,"width",e[2])},m(H,N){v(H,t,N),v(H,s,N),v(H,f,N),v(H,h,N),v(H,d,N),v(H,E,N),v(H,y,N),v(H,T,N),v(H,L,N),v(H,w,N),v(H,b,N),P||(U=[W(t,"pointerdown",function(){q(e[9](M.SHAPE))&&e[9](M.SHAPE).apply(this,arguments)}),W(f,"pointerdown",function(){q(e[9](M.SHAPE))&&e[9](M.SHAPE).apply(this,arguments)}),W(d,"pointerdown",function(){q(e[9](M.TOP))&&e[9](M.TOP).apply(this,arguments)}),W(y,"pointerdown",function(){q(e[9](M.RIGHT))&&e[9](M.RIGHT).apply(this,arguments)}),W(L,"pointerdown",function(){q(e[9](M.BOTTOM))&&e[9](M.BOTTOM).apply(this,arguments)}),W(b,"pointerdown",function(){q(e[9](M.LEFT))&&e[9](M.LEFT).apply(this,arguments)})],P=!0)},p(H,N){e=H,N&8&&n!==(n=e[3].cx)&&l(t,"cx",n),N&8&&o!==(o=e[3].cy)&&l(t,"cy",o),N&8&&i!==(i=e[3].rx)&&l(t,"rx",i),N&8&&r!==(r=e[3].ry)&&l(t,"ry",r),N&8&&a!==(a=e[3].cx)&&l(f,"cx",a),N&8&&u!==(u=e[3].cy)&&l(f,"cy",u),N&8&&m!==(m=e[3].rx)&&l(f,"rx",m),N&8&&c!==(c=e[3].ry)&&l(f,"ry",c),N&12&&p!==(p=e[3].cx-e[2]/2)&&l(d,"x",p),N&12&&S!==(S=e[3].cy-e[2]/2-e[3].ry)&&l(d,"y",S),N&4&&l(d,"height",e[2]),N&4&&l(d,"width",e[2]),N&12&&g!==(g=e[3].cx+e[3].rx-e[2]/2)&&l(y,"x",g),N&12&&_!==(_=e[3].cy-e[2]/2)&&l(y,"y",_),N&4&&l(y,"height",e[2]),N&4&&l(y,"width",e[2]),N&12&&Y!==(Y=e[3].cx-e[2]/2)&&l(L,"x",Y),N&12&&R!==(R=e[3].cy+e[3].ry-e[2]/2)&&l(L,"y",R),N&4&&l(L,"height",e[2]),N&4&&l(L,"width",e[2]),N&12&&A!==(A=e[3].cx-e[3].rx-e[2]/2)&&l(b,"x",A),N&12&&I!==(I=e[3].cy-e[2]/2)&&l(b,"y",I),N&4&&l(b,"height",e[2]),N&4&&l(b,"width",e[2])},d(H){H&&k(t),H&&k(s),H&&k(f),H&&k(h),H&&k(d),H&&k(E),H&&k(y),H&&k(T),H&&k(L),H&&k(w),H&&k(b),P=!1,le(U)}}}function ni(e){let t,n;return t=new ve({props:{shape:e[0],transform:e[1],editor:e[4],$$slots:{default:[ti,({grab:o})=>({9:o}),({grab:o})=>o?512:0]},$$scope:{ctx:e}}}),t.$on("grab",e[6]),t.$on("change",e[7]),t.$on("release",e[8]),{c(){se(t.$$.fragment)},m(o,i){ie(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&2&&(r.transform=o[1]),i&1548&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){j(t.$$.fragment,o),n=!1},d(o){re(t,o)}}}function oi(e,t,n){let o,i,{shape:r}=t,{transform:s}=t,{viewportScale:f=1}=t;const a=(h,d,p)=>{const S=h.geometry.bounds;let[E,y]=[S.minX,S.minY],[g,_]=[S.maxX,S.maxY];const[T,L]=p;if(d===M.SHAPE)E+=T,g+=T,y+=L,_+=L;else switch(d){case M.TOP:{y+=L;break}case M.BOTTOM:{_+=L;break}case M.LEFT:{E+=T;break}case M.RIGHT:{g+=T;break}}const Y=Math.min(E,g),R=Math.min(y,_),w=Math.abs(g-E),b=Math.abs(_-y),A=(E+g)/2,I=(y+_)/2,P=w/2,U=b/2;return{...h,geometry:{...h.geometry,cx:A,cy:I,rx:P,ry:U,bounds:{minX:Y,minY:R,maxX:Y+w,maxY:R+b}}}};function u(h){te.call(this,e,h)}function m(h){te.call(this,e,h)}function c(h){te.call(this,e,h)}return e.$$set=h=>{"shape"in h&&n(0,r=h.shape),"transform"in h&&n(1,s=h.transform),"viewportScale"in h&&n(5,f=h.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(3,o=r.geometry),e.$$.dirty&32&&n(2,i=10/f)},[r,s,i,o,a,f,u,m,c]}class nn extends ${constructor(t){super(),x(this,t,oi,ni,K,{shape:0,transform:1,viewportScale:5})}}const _e=(e,t,n)=>{const o=typeof t=="function"?t(e):t;if(o){const{fill:i,fillOpacity:r}=o;let s="",f;return i&&(s+=`fill:${i};stroke:${i};`),n&&(f=n.fillOpacity),s+=`fill-opacity:${f||r||"0.25"};`,s}};function ii(e){let t,n,o;return{c(){t=D("path"),l(t,"class","a9s-shape-handle"),l(t,"style",e[3]),l(t,"d",e[2])},m(i,r){v(i,t,r),n||(o=W(t,"pointerdown",function(){q(e[14](M.SHAPE))&&e[14](M.SHAPE).apply(this,arguments)}),n=!0)},p(i,r){e=i,r&8&&l(t,"style",e[3]),r&4&&l(t,"d",e[2])},d(i){i&&k(t),n=!1,o()}}}function ri(e){let t,n;return t=new ve({props:{shape:e[0],transform:e[1],editor:e[4],$$slots:{default:[ii,({grab:o})=>({14:o}),({grab:o})=>o?16384:0]},$$scope:{ctx:e}}}),t.$on("change",e[9]),t.$on("grab",e[10]),t.$on("release",e[11]),{c(){se(t.$$.fragment)},m(o,i){ie(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&2&&(r.transform=o[1]),i&49164&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){j(t.$$.fragment,o),n=!1},d(o){re(t,o)}}}function si(e,t,n){let o,i,r,{shape:s}=t,{annotation:f}=t,{transform:a}=t,{viewportScale:u=1}=t,{style:m=void 0}=t,c={fillOpacity:1};const h=(E,y,g)=>{let _;y===M.SHAPE&&(_=E.geometry.points.map(([L,Y,R])=>[L+g[0],Y+g[1],R]));const T=ye(_.map(L=>[L[0],L[1]]));return{...E,geometry:{points:_,bounds:T}}};function d(E){te.call(this,e,E)}function p(E){te.call(this,e,E)}function S(E){te.call(this,e,E)}return e.$$set=E=>{"shape"in E&&n(0,s=E.shape),"annotation"in E&&n(5,f=E.annotation),"transform"in E&&n(1,a=E.transform),"viewportScale"in E&&n(6,u=E.viewportScale),"style"in E&&n(7,m=E.style)},e.$$.update=()=>{e.$$.dirty&1&&n(8,o=s.geometry),e.$$.dirty&64,e.$$.dirty&160&&n(3,i=_e(f,m,c)),e.$$.dirty&256&&n(2,r=Re(o.points,lt,!0))},[s,a,r,i,h,f,u,m,o,d,p,S]}class on extends ${constructor(t){super(),x(this,t,si,ri,K,{shape:0,annotation:5,transform:1,viewportScale:6,style:7})}}function li(e){let t,n,o,i,r,s,f,a,u,m,c,h,d,p,S,E,y,g,_,T,L,Y,R,w,b,A,I,P,U,H,N,ce,we;return{c(){t=D("defs"),n=D("marker"),o=D("path"),u=Q(),m=D("line"),E=Q(),y=D("line"),Y=Q(),R=D("circle"),I=Q(),P=D("circle"),l(o,"d","M 0 0 L 10 5 L 0 10 z"),l(n,"class","arrow"),l(n,"viewBox",i=`0 0 ${e[3]/2} ${e[3]/2}`),l(n,"refX",r=`${e[3]/2}`),l(n,"refY",s=`${e[3]/2}`),l(n,"markerWidth",f=`${e[3]/2}`),l(n,"markerHeight",a=`${e[3]/2}`),l(n,"orient","auto-start-reverse"),l(m,"class","a9s-outer"),l(m,"style",c=e[1]?"display:none;":void 0),l(m,"x1",h=e[4].x1),l(m,"y1",d=e[4].y1),l(m,"x2",p=e[4].x2),l(m,"y2",S=e[4].y2),l(m,"marker-end","url(.arrow)"),l(y,"class","a9s-inner a9s-shape-handle"),l(y,"style",e[1]),l(y,"x1",g=e[4].x1),l(y,"y1",_=e[4].y1),l(y,"x2",T=e[4].x2),l(y,"y2",L=e[4].y2),l(R,"class","a9s-corner-handle"),l(R,"cx",w=e[4].x1),l(R,"cy",b=e[4].y1),l(R,"r",A=e[3]/2),l(P,"class","a9s-corner-handle"),l(P,"cx",U=e[4].x2),l(P,"cy",H=e[4].y2),l(P,"r",N=e[3]/2)},m(O,C){v(O,t,C),oe(t,n),oe(n,o),v(O,u,C),v(O,m,C),v(O,E,C),v(O,y,C),v(O,Y,C),v(O,R,C),v(O,I,C),v(O,P,C),ce||(we=[W(m,"pointerdown",function(){q(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)}),W(y,"pointerdown",function(){q(e[10](M.SHAPE))&&e[10](M.SHAPE).apply(this,arguments)}),W(R,"pointerdown",function(){q(e[10](M.LEFT))&&e[10](M.LEFT).apply(this,arguments)}),W(P,"pointerdown",function(){q(e[10](M.RIGHT))&&e[10](M.RIGHT).apply(this,arguments)})],ce=!0)},p(O,C){e=O,C&8&&i!==(i=`0 0 ${e[3]/2} ${e[3]/2}`)&&l(n,"viewBox",i),C&8&&r!==(r=`${e[3]/2}`)&&l(n,"refX",r),C&8&&s!==(s=`${e[3]/2}`)&&l(n,"refY",s),C&8&&f!==(f=`${e[3]/2}`)&&l(n,"markerWidth",f),C&8&&a!==(a=`${e[3]/2}`)&&l(n,"markerHeight",a),C&2&&c!==(c=e[1]?"display:none;":void 0)&&l(m,"style",c),C&16&&h!==(h=e[4].x1)&&l(m,"x1",h),C&16&&d!==(d=e[4].y1)&&l(m,"y1",d),C&16&&p!==(p=e[4].x2)&&l(m,"x2",p),C&16&&S!==(S=e[4].y2)&&l(m,"y2",S),C&2&&l(y,"style",e[1]),C&16&&g!==(g=e[4].x1)&&l(y,"x1",g),C&16&&_!==(_=e[4].y1)&&l(y,"y1",_),C&16&&T!==(T=e[4].x2)&&l(y,"x2",T),C&16&&L!==(L=e[4].y2)&&l(y,"y2",L),C&16&&w!==(w=e[4].x1)&&l(R,"cx",w),C&16&&b!==(b=e[4].y1)&&l(R,"cy",b),C&8&&A!==(A=e[3]/2)&&l(R,"r",A),C&16&&U!==(U=e[4].x2)&&l(P,"cx",U),C&16&&H!==(H=e[4].y2)&&l(P,"cy",H),C&8&&N!==(N=e[3]/2)&&l(P,"r",N)},d(O){O&&k(t),O&&k(u),O&&k(m),O&&k(E),O&&k(y),O&&k(Y),O&&k(R),O&&k(I),O&&k(P),ce=!1,le(we)}}}function ai(e){let t,n;return t=new ve({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[li,({grab:o})=>({10:o}),({grab:o})=>o?1024:0]},$$scope:{ctx:e}}}),t.$on("grab",e[7]),t.$on("change",e[8]),t.$on("release",e[9]),{c(){se(t.$$.fragment)},m(o,i){ie(t,o,i),n=!0},p(o,[i]){const r={};i&1&&(r.shape=o[0]),i&4&&(r.transform=o[2]),i&3098&&(r.$$scope={dirty:i,ctx:o}),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){j(t.$$.fragment,o),n=!1},d(o){re(t,o)}}}function fi(e,t,n){let o,i,{shape:r}=t,{computedStyle:s=void 0}=t,{transform:f}=t,{viewportScale:a=1}=t;const u=(d,p,S)=>{d.geometry.bounds;let E=d.geometry.x1,y=d.geometry.x2,g=d.geometry.y1,_=d.geometry.y2;const[T,L]=S;if(p===M.SHAPE)E+=T,y+=T,g+=L,_+=L;else switch(p){case M.LEFT:{E+=T,g+=L;break}case M.RIGHT:{y+=T,_+=L;break}}return{...d,geometry:{x1:E,y1:g,x2:y,y2:_,bounds:{minX:Math.min(E,y),minY:Math.min(g,_),maxX:Math.max(E,y),maxY:Math.max(g,_)}}}};function m(d){te.call(this,e,d)}function c(d){te.call(this,e,d)}function h(d){te.call(this,e,d)}return e.$$set=d=>{"shape"in d&&n(0,r=d.shape),"computedStyle"in d&&n(1,s=d.computedStyle),"transform"in d&&n(2,f=d.transform),"viewportScale"in d&&n(6,a=d.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=r.geometry),e.$$.dirty&64&&n(3,i=10/a)},[r,s,f,i,o,u,a,m,c,h]}class rn extends ${constructor(t){super(),x(this,t,fi,ai,K,{shape:0,computedStyle:1,transform:2,viewportScale:6})}}const sn=new Map([[z.RECTANGLE,tn],[z.POLYGON,en],[z.ELLIPSE,nn],[z.FREEHAND,on],[z.LINE,rn]]),ut=e=>sn.get(e.type),ln=(e,t)=>sn.set(e,t),M=e=>`HANDLE-${e}`;M.SHAPE="SHAPE",M.TOP="TOP",M.RIGHT="RIGHT",M.BOTTOM="BOTTOM",M.LEFT="LEFT",M.TOP_LEFT="TOP_LEFT",M.TOP_RIGHT="TOP_RIGHT",M.BOTTOM_RIGHT="BOTTOM_RIGHT",M.BOTTOM_LEFT="BOTTOM_LEFT",M.START="START",M.END="END";const ci=e=>({}),an=e=>({grab:e[0]});function ui(e){let t,n,o,i;const r=e[7].default,s=zn(r,e,e[6],an);return{c(){t=D("g"),s&&s.c(),l(t,"class","a9s-annotation selected")},m(f,a){v(f,t,a),s&&s.m(t,null),n=!0,o||(i=[W(t,"pointerup",e[2]),W(t,"pointermove",e[1])],o=!0)},p(f,[a]){s&&s.p&&(!n||a&64)&&qn(s,r,f,f[6],n?jn(r,f[6],a,ci):Wn(f[6]),an)},i(f){n||(G(s,f),n=!0)},o(f){j(s,f),n=!1},d(f){f&&k(t),s&&s.d(f),o=!1,le(i)}}}function di(e,t,n){let{$$slots:o={},$$scope:i}=t;const r=de();let{shape:s}=t,{editor:f}=t,{transform:a}=t,u=null,m,c=null;const h=S=>E=>{u=S,m=a.elementToImage(E.offsetX,E.offsetY),c=s,E.target.setPointerCapture(E.pointerId),r("grab")},d=S=>{if(u){const[E,y]=a.elementToImage(S.offsetX,S.offsetY),g=[E-m[0],y-m[1]];n(3,s=f(c,u,g)),r("change",s)}},p=S=>{S.target.releasePointerCapture(S.pointerId),u=null,c=s,r("release")};return e.$$set=S=>{"shape"in S&&n(3,s=S.shape),"editor"in S&&n(4,f=S.editor),"transform"in S&&n(5,a=S.transform),"$$scope"in S&&n(6,i=S.$$scope)},[h,d,p,s,f,a,i,o]}class ve extends ${constructor(t){super(),x(this,t,di,ui,K,{shape:3,editor:4,transform:5})}}function mi(e,t,n){let o;const i=de();let{annotation:r}=t,{editor:s}=t,{style:f=void 0}=t,{target:a}=t,{transform:u}=t,{viewportScale:m}=t,c;return pe(()=>(n(6,c=new s({target:a,props:{shape:r.target.selector,computedStyle:o,transform:u,viewportScale:m}})),c.$on("change",h=>{c.$$set({shape:h.detail}),i("change",h.detail)}),c.$on("grab",h=>i("grab",h.detail)),c.$on("release",h=>i("release",h.detail)),()=>{c.$destroy()})),e.$$set=h=>{"annotation"in h&&n(0,r=h.annotation),"editor"in h&&n(1,s=h.editor),"style"in h&&n(2,f=h.style),"target"in h&&n(3,a=h.target),"transform"in h&&n(4,u=h.transform),"viewportScale"in h&&n(5,m=h.viewportScale)},e.$$.update=()=>{e.$$.dirty&5&&(o=_e(r,f)),e.$$.dirty&65&&r&&(c==null||c.$set({shape:r.target.selector})),e.$$.dirty&80&&c&&c.$set({transform:u}),e.$$.dirty&96&&c&&c.$set({viewportScale:m})},[r,s,f,a,u,m,c]}class fn extends ${constructor(t){super(),x(this,t,mi,null,K,{annotation:0,editor:1,style:2,target:3,transform:4,viewportScale:5})}}function hi(e,t,n){const o=de();let{drawingMode:i}=t,{target:r}=t,{tool:s}=t,{transform:f}=t,{viewportScale:a}=t,u;return pe(()=>{const m=r.closest("svg"),c=[],h=(d,p,S)=>{m.addEventListener(d,p,S),c.push(()=>m.removeEventListener(d,p,S))};return n(5,u=new s({target:r,props:{addEventListener:h,drawingMode:i,transform:f,viewportScale:a}})),u.$on("create",d=>o("create",d.detail)),()=>{c.forEach(d=>d()),u.$destroy()}}),e.$$set=m=>{"drawingMode"in m&&n(0,i=m.drawingMode),"target"in m&&n(1,r=m.target),"tool"in m&&n(2,s=m.tool),"transform"in m&&n(3,f=m.transform),"viewportScale"in m&&n(4,a=m.viewportScale)},e.$$.update=()=>{e.$$.dirty&40&&u&&u.$set({transform:f}),e.$$.dirty&48&&u&&u.$set({viewportScale:a})},[i,r,s,f,a,u]}class cn extends ${constructor(t){super(),x(this,t,hi,null,K,{drawingMode:0,target:1,tool:2,transform:3,viewportScale:4})}}function un(e){let t,n;return{c(){t=D("rect"),n=D("rect"),l(t,"class","a9s-outer"),l(t,"x",e[1]),l(t,"y",e[2]),l(t,"width",e[3]),l(t,"height",e[4]),l(n,"class","a9s-inner"),l(n,"x",e[1]),l(n,"y",e[2]),l(n,"width",e[3]),l(n,"height",e[4])},m(o,i){v(o,t,i),v(o,n,i)},p(o,i){i&2&&l(t,"x",o[1]),i&4&&l(t,"y",o[2]),i&8&&l(t,"width",o[3]),i&16&&l(t,"height",o[4]),i&2&&l(n,"x",o[1]),i&4&&l(n,"y",o[2]),i&8&&l(n,"width",o[3]),i&16&&l(n,"height",o[4])},d(o){o&&k(t),o&&k(n)}}}function gi(e){let t,n=e[0]&&un(e);return{c(){t=D("g"),n&&n.c(),l(t,"class","a9s-annotation a9s-rubberband")},m(o,i){v(o,t,i),n&&n.m(t,null)},p(o,[i]){o[0]?n?n.p(o,i):(n=un(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:V,o:V,d(o){o&&k(t),n&&n.d()}}}function pi(e,t,n){const o=de();let{addEventListener:i}=t,{drawingMode:r}=t,{transform:s}=t,f,a,u,m,c,h,d;const p=g=>{f=performance.now(),r==="drag"&&(n(0,a=s.elementToImage(g.offsetX,g.offsetY)),u=a,n(1,m=a[0]),n(2,c=a[1]),n(3,h=1),n(4,d=1))},S=g=>{a&&(u=s.elementToImage(g.offsetX,g.offsetY),n(1,m=Math.min(u[0],a[0])),n(2,c=Math.min(u[1],a[1])),n(3,h=Math.abs(u[0]-a[0])),n(4,d=Math.abs(u[1]-a[1])))},E=g=>{const _=performance.now()-f;if(r==="click"){if(_>300)return;g.stopPropagation(),a?y():(n(0,a=s.elementToImage(g.offsetX,g.offsetY)),u=a,n(1,m=a[0]),n(2,c=a[1]),n(3,h=1),n(4,d=1))}else a&&(_>300||h*d>100?(g.stopPropagation(),y()):(n(0,a=null),u=null))},y=()=>{if(h*d>15){const g={type:z.RECTANGLE,geometry:{bounds:{minX:m,minY:c,maxX:m+h,maxY:c+d},x:m,y:c,w:h,h:d}};o("create",g)}n(0,a=null),u=null};return pe(()=>{i("pointerdown",p),i("pointermove",S),i("pointerup",E,!0)}),e.$$set=g=>{"addEventListener"in g&&n(5,i=g.addEventListener),"drawingMode"in g&&n(6,r=g.drawingMode),"transform"in g&&n(7,s=g.transform)},[a,m,c,h,d,i,r,s]}class dn extends ${constructor(t){super(),x(this,t,pi,gi,K,{addEventListener:5,drawingMode:6,transform:7})}}const Ge=(e,t)=>{const n=Math.abs(t[0]-e[0]),o=Math.abs(t[1]-e[1]);return Math.sqrt(Math.pow(n,2)+Math.pow(o,2))},Ie=[];function yi(e,t=V){let n;const o=new Set;function i(f){if(K(e,f)&&(e=f,n)){const a=!Ie.length;for(const u of o)u[1](),Ie.push(u,e);if(a){for(let u=0;u<Ie.length;u+=2)Ie[u][0](Ie[u+1]);Ie.length=0}}}function r(f){i(f(e))}function s(f,a=V){const u=[f,a];return o.add(u),o.size===1&&(n=t(i)||V),f(e),()=>{o.delete(u),o.size===0&&n&&(n(),n=null)}}return{set:i,update:r,subscribe:s}}const _i=(e,t)=>{const{naturalWidth:n,naturalHeight:o}=e;if(!n&&!o){const{width:i,height:r}=e;t.setAttribute("viewBox",`0 0 ${i} ${r}`),e.addEventListener("load",s=>{const f=s.target;t.setAttribute("viewBox",`0 0 ${f.naturalWidth} ${f.naturalHeight}`)})}else t.setAttribute("viewBox",`0 0 ${n} ${o}`)},mn=(e,t)=>{_i(e,t);const{subscribe:n,set:o}=yi(1);let i;return window.ResizeObserver&&(i=new ResizeObserver(()=>{const s=t.getBoundingClientRect(),{width:f,height:a}=t.viewBox.baseVal,u=Math.max(s.width/f,s.height/a);o(u)}),i.observe(t.parentElement)),{destroy:()=>{i&&i.disconnect()},subscribe:n}},wi="ontouchstart"in window||navigator.maxTouchPoints>0;function dt(e){const t=e.slice(),n=(t[2]?t[0]:[...t[0],t[1]]).map(o=>o.join(",")).join(" ");return t[15]=n,t}function hn(e){let t,n,o,i,r,s=e[2]&&gn(e);return{c(){t=D("polygon"),o=D("polygon"),s&&s.c(),r=ue(),l(t,"class","a9s-outer"),l(t,"points",n=e[15]),l(o,"class","a9s-inner"),l(o,"points",i=e[15])},m(f,a){v(f,t,a),v(f,o,a),s&&s.m(f,a),v(f,r,a)},p(f,a){a&7&&n!==(n=f[15])&&l(t,"points",n),a&7&&i!==(i=f[15])&&l(o,"points",i),f[2]?s?s.p(f,a):(s=gn(f),s.c(),s.m(r.parentNode,r)):s&&(s.d(1),s=null)},d(f){f&&k(t),f&&k(o),s&&s.d(f),f&&k(r)}}}function gn(e){let t,n,o;return{c(){t=D("rect"),l(t,"class","a9s-corner-handle"),l(t,"x",n=e[0][0][0]-e[3]/2),l(t,"y",o=e[0][0][1]-e[3]/2),l(t,"height",e[3]),l(t,"width",e[3])},m(i,r){v(i,t,r)},p(i,r){r&9&&n!==(n=i[0][0][0]-i[3]/2)&&l(t,"x",n),r&9&&o!==(o=i[0][0][1]-i[3]/2)&&l(t,"y",o),r&8&&l(t,"height",i[3]),r&8&&l(t,"width",i[3])},d(i){i&&k(t)}}}function bi(e){let t,n=e[1]&&hn(dt(e));return{c(){t=D("g"),n&&n.c(),l(t,"class","a9s-annotation a9s-rubberband")},m(o,i){v(o,t,i),n&&n.m(t,null)},p(o,[i]){o[1]?n?n.p(dt(o),i):(n=hn(dt(o)),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:V,o:V,d(o){o&&k(t),n&&n.d()}}}const Ei=20;function Si(e,t,n){let o;const i=de();let{addEventListener:r}=t,{drawingMode:s}=t,{transform:f}=t,{viewportScale:a=1}=t,u,m=[],c=null,h=!1;const d=g=>{const{timeStamp:_,offsetX:T,offsetY:L}=g;if(u={timeStamp:_,offsetX:T,offsetY:L},s==="drag"&&m.length===0){const Y=f.elementToImage(g.offsetX,g.offsetY);m.push(Y),n(1,c=Y)}},p=g=>{if(m.length>0&&(n(1,c=f.elementToImage(g.offsetX,g.offsetY)),m.length>2)){const _=Ge(c,m[0])*a;n(2,h=_<Ei)}},S=g=>{if(s==="click"){const _=g.timeStamp-u.timeStamp,T=Ge([u.offsetX,u.offsetY],[g.offsetX,g.offsetY]);if(_>300||T>15)return;if(h)y();else if(m.length===0){const L=f.elementToImage(g.offsetX,g.offsetY);m.push(L),n(1,c=L)}else m.push(c)}else{if(m.length===1&&Ge(m[0],c)<=4){n(0,m=[]),n(1,c=null);return}g.stopImmediatePropagation(),h?y():m.push(c)}},E=()=>{const g=[...m,c],_={type:z.POLYGON,geometry:{bounds:ye(g),points:g}};He(_)>4&&(n(0,m=[]),n(1,c=null),i("create",_))},y=()=>{const g={type:z.POLYGON,geometry:{bounds:ye(m),points:[...m]}};n(0,m=[]),n(1,c=null),i("create",g)};return pe(()=>{r("pointerdown",d,!0),r("pointermove",p),r("pointerup",S,!0),r("dblclick",E,!0)}),e.$$set=g=>{"addEventListener"in g&&n(4,r=g.addEventListener),"drawingMode"in g&&n(5,s=g.drawingMode),"transform"in g&&n(6,f=g.transform),"viewportScale"in g&&n(7,a=g.viewportScale)},e.$$.update=()=>{e.$$.dirty&128&&n(3,o=10/a)},[m,c,h,o,r,s,f,a]}class Ai extends ${constructor(t){super(),x(this,t,Si,bi,K,{addEventListener:4,drawingMode:5,transform:6,viewportScale:7})}}function pn(e){let t,n,o,i,r,s,f,a,u,m;return{c(){t=D("ellipse"),s=D("ellipse"),l(t,"class","a9s-outer"),l(t,"cx",n=e[2]+e[4]/2),l(t,"cy",o=e[3]+e[5]/2),l(t,"rx",i=e[4]/2),l(t,"ry",r=e[5]/2),l(s,"class","a9s-inner"),l(s,"cx",f=e[2]+e[4]/2),l(s,"cy",a=e[3]+e[5]/2),l(s,"rx",u=e[4]/2),l(s,"ry",m=e[5]/2)},m(c,h){v(c,t,h),v(c,s,h)},p(c,h){h&20&&n!==(n=c[2]+c[4]/2)&&l(t,"cx",n),h&40&&o!==(o=c[3]+c[5]/2)&&l(t,"cy",o),h&16&&i!==(i=c[4]/2)&&l(t,"rx",i),h&32&&r!==(r=c[5]/2)&&l(t,"ry",r),h&20&&f!==(f=c[2]+c[4]/2)&&l(s,"cx",f),h&40&&a!==(a=c[3]+c[5]/2)&&l(s,"cy",a),h&16&&u!==(u=c[4]/2)&&l(s,"rx",u),h&32&&m!==(m=c[5]/2)&&l(s,"ry",m)},d(c){c&&k(t),c&&k(s)}}}function Ti(e){let t,n=e[1]&&pn(e);return{c(){t=D("g"),n&&n.c(),l(t,"class","a9s-annotation a9s-rubberband")},m(o,i){v(o,t,i),n&&n.m(t,null),e[9](t)},p(o,[i]){o[1]?n?n.p(o,i):(n=pn(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:V,o:V,d(o){o&&k(t),n&&n.d(),e[9](null)}}}function Mi(e,t,n){const o=de();let{addEventListener:i}=t,{drawingMode:r}=t,{transform:s}=t,f,a,u,m,c,h,d,p=!1,S=!1,E,y;const g=b=>{E=performance.now(),r==="drag"&&(n(1,a=s.elementToImage(b.offsetX,b.offsetY)),u=a,n(2,m=a[0]),n(3,c=a[1]),n(4,h=1),n(5,d=1))},_=b=>{const A=b||y;if(a)if(u=s.elementToImage(A.offsetX,A.offsetY),S){const I=2*Math.abs(u[0]-a[0]),P=2*Math.abs(u[1]-a[1]);n(4,h=p?Math.max(I,P):I),n(5,d=p?h:P),n(2,m=Math.min(u[0],a[0]-h/2)),n(3,c=Math.min(u[1],a[1]-d/2))}else{const I=Math.abs(u[0]-a[0]),P=Math.abs(u[1]-a[1]);n(4,h=p?Math.max(I,P):I),n(5,d=p?h:P),n(2,m=Math.min(u[0],a[0])),n(3,c=Math.min(u[1],a[1]))}b&&(y=b)},T=b=>{r==="click"&&b.stopImmediatePropagation();const A=performance.now()-E;if(r==="click"){if(A>300)return;b.stopPropagation(),a?L():(n(1,a=s.elementToImage(b.offsetX,b.offsetY)),u=a,n(2,m=a[0]),n(3,c=a[1]),n(4,h=1),n(5,d=1))}else a&&(A>300||h*d>100?(b.stopPropagation(),L()):(n(1,a=null),u=null,y=void 0))},L=()=>{if(h*d>15){const b={type:z.ELLIPSE,geometry:{bounds:{minX:m,minY:c,maxX:m+h,maxY:c+d},cx:m+h/2,cy:c+d/2,rx:h/2,ry:d/2}};o("create",b)}n(1,a=null),u=null,y=void 0},Y=b=>{b.key==="Shift"&&(p=!0,_()),b.key==="Control"&&(S=!0,_())},R=b=>{b.key==="Shift"&&(p=!1,_()),b.key==="Control"&&(S=!1,_())};pe(()=>(document.addEventListener("keyup",R),document.addEventListener("keydown",Y),i("pointerdown",g),i("pointermove",_),i("pointerup",T),()=>{document.removeEventListener("keyup",R),document.removeEventListener("keydown",Y)}));function w(b){Ye[b?"unshift":"push"](()=>{f=b,n(0,f)})}return e.$$set=b=>{"addEventListener"in b&&n(6,i=b.addEventListener),"drawingMode"in b&&n(7,r=b.drawingMode),"transform"in b&&n(8,s=b.transform)},[f,a,m,c,h,d,i,r,s,w]}class Li extends ${constructor(t){super(),x(this,t,Mi,Ti,K,{addEventListener:6,drawingMode:7,transform:8})}}function yn(e){let t;return{c(){t=D("path"),l(t,"style",e[2]),l(t,"d",e[0])},m(n,o){v(n,t,o)},p(n,o){o&4&&l(t,"style",n[2]),o&1&&l(t,"d",n[0])},d(n){n&&k(t)}}}function ki(e){let t,n=e[1]&&yn(e);return{c(){t=D("g"),n&&n.c(),l(t,"class","a9s-annotation a9s-rubberband")},m(o,i){v(o,t,i),n&&n.m(t,null)},p(o,[i]){o[1]?n?n.p(o,i):(n=yn(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:V,o:V,d(o){o&&k(t),n&&n.d()}}}function vi(e,t,n){let o;const i=de();let{addEventListener:r}=t,{drawingMode:s}=t,{annotation:f}=t,{transform:a}=t,{viewportScale:u=1}=t,{style:m=void 0}=t,c={fillOpacity:1},h=[],d="",p=!1;const S=_=>{if(s==="drag"&&h.length===0){n(1,p=!0);const T=a.elementToImage(_.offsetX,_.offsetY);h.push([...T,_.pressure]),n(0,d=Re(h))}},E=_=>{if(p){const T=a.elementToImage(_.offsetX,_.offsetY);h.push([...T,_.pressure]),n(0,d=Re(h,lt,!0))}},y=_=>{p&&g()},g=()=>{const _={type:z.FREEHAND,geometry:{bounds:ye(h.map(T=>[T[0],T[1]])),points:h}};n(1,p=!1),h=[],i("create",_)};return pe(()=>{r("pointerdown",S,!0),r("pointermove",E),r("pointerup",y,!0)}),e.$$set=_=>{"addEventListener"in _&&n(3,r=_.addEventListener),"drawingMode"in _&&n(4,s=_.drawingMode),"annotation"in _&&n(5,f=_.annotation),"transform"in _&&n(6,a=_.transform),"viewportScale"in _&&n(7,u=_.viewportScale),"style"in _&&n(8,m=_.style)},e.$$.update=()=>{e.$$.dirty&128,e.$$.dirty&288&&n(2,o=_e(f,m,c))},[d,p,o,r,s,f,a,u,m]}class Ii extends ${constructor(t){super(),x(this,t,vi,ki,K,{addEventListener:3,drawingMode:4,annotation:5,transform:6,viewportScale:7,style:8})}}function _n(e){let t,n;return{c(){t=D("line"),n=D("line"),l(t,"class","a9s-outer"),l(t,"x1",e[1]),l(t,"y1",e[2]),l(t,"x2",e[3]),l(t,"y2",e[4]),l(n,"class","a9s-inner"),l(n,"x1",e[1]),l(n,"y1",e[2]),l(n,"x2",e[3]),l(n,"y2",e[4])},m(o,i){v(o,t,i),v(o,n,i)},p(o,i){i&2&&l(t,"x1",o[1]),i&4&&l(t,"y1",o[2]),i&8&&l(t,"x2",o[3]),i&16&&l(t,"y2",o[4]),i&2&&l(n,"x1",o[1]),i&4&&l(n,"y1",o[2]),i&8&&l(n,"x2",o[3]),i&16&&l(n,"y2",o[4])},d(o){o&&k(t),o&&k(n)}}}function Oi(e){let t,n=e[0]&&_n(e);return{c(){t=D("g"),n&&n.c(),l(t,"class","a9s-annotation a9s-rubberband")},m(o,i){v(o,t,i),n&&n.m(t,null)},p(o,[i]){o[0]?n?n.p(o,i):(n=_n(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:V,o:V,d(o){o&&k(t),n&&n.d()}}}function Pi(e,t,n){const o=de();let{addEventListener:i}=t,{drawingMode:r}=t,{transform:s}=t,f,a,u,m,c,h,d;const p=g=>{f=performance.now(),r==="drag"&&(n(0,a=s.elementToImage(g.offsetX,g.offsetY)),u=a,n(1,m=a[0]),n(2,c=a[1]),n(3,h=a[0]+1),n(4,d=a[1]+1))},S=g=>{a&&(u=s.elementToImage(g.offsetX,g.offsetY),n(3,h=u[0]),n(4,d=u[1]))},E=g=>{const _=performance.now()-f;if(r==="click"){if(_>300)return;g.stopPropagation(),a?y():(n(0,a=s.elementToImage(g.offsetX,g.offsetY)),u=a,n(1,m=a[0]),n(2,c=a[1]),n(3,h=a[0]+1),n(4,d=a[1]+1))}else a&&(_>300||Math.sqrt(Math.pow(h-m,2)+Math.pow(d-c,2))>8?(g.stopPropagation(),y()):(n(0,a=null),u=null))},y=()=>{if(Math.sqrt(Math.pow(h-m,2)+Math.pow(d-c,2))>8){const g={type:z.LINE,geometry:{bounds:{minX:Math.min(m,h),minY:Math.min(c,d),maxX:Math.max(m,h),maxY:Math.max(c,d)},x1:m,y1:c,x2:h,y2:d}};o("create",g)}n(0,a=null),u=null};return pe(()=>{i("pointerdown",p),i("pointermove",S),i("pointerup",E,!0)}),e.$$set=g=>{"addEventListener"in g&&n(5,i=g.addEventListener),"drawingMode"in g&&n(6,r=g.drawingMode),"transform"in g&&n(7,s=g.transform)},[a,m,c,h,d,i,r,s]}class Di extends ${constructor(t){super(),x(this,t,Pi,Oi,K,{addEventListener:5,drawingMode:6,transform:7})}}const mt=new Map([["rectangle",{tool:dn}],["polygon",{tool:Ai}],["ellipse",{tool:Li}],["freehand",{tool:Ii}],["line",{tool:Di}]]),Ve=()=>[...mt.keys()],ht=e=>mt.get(e),wn=(e,t,n)=>mt.set(e,{tool:t,opts:n});function Bi(e){let t,n,o,i,r;return{c(){t=D("g"),n=D("ellipse"),i=D("ellipse"),l(n,"class","a9s-outer"),l(n,"style",o=e[1]?"display:none;":void 0),l(n,"cx",e[2]),l(n,"cy",e[3]),l(n,"rx",e[4]),l(n,"ry",e[5]),l(i,"class","a9s-inner"),l(i,"style",e[1]),l(i,"cx",e[2]),l(i,"cy",e[3]),l(i,"rx",e[4]),l(i,"ry",e[5]),l(t,"data-id",r=e[0].id)},m(s,f){v(s,t,f),oe(t,n),oe(t,i)},p(s,[f]){f&2&&o!==(o=s[1]?"display:none;":void 0)&&l(n,"style",o),f&2&&l(i,"style",s[1]),f&1&&r!==(r=s[0].id)&&l(t,"data-id",r)},i:V,o:V,d(s){s&&k(t)}}}function Yi(e,t,n){let o,{annotation:i}=t,{geom:r}=t,{style:s=void 0}=t;const{cx:f,cy:a,rx:u,ry:m}=r;return e.$$set=c=>{"annotation"in c&&n(0,i=c.annotation),"geom"in c&&n(6,r=c.geom),"style"in c&&n(7,s=c.style)},e.$$.update=()=>{e.$$.dirty&129&&n(1,o=_e(i,s))},[i,o,f,a,u,m,r,s]}class Ri extends ${constructor(t){super(),x(this,t,Yi,Bi,K,{annotation:0,geom:6,style:7})}}function Xi(e){let t,n,o,i,r;return{c(){t=D("g"),n=D("polygon"),i=D("polygon"),l(n,"class","a9s-outer"),l(n,"style",o=e[1]?"display:none;":void 0),l(n,"points",e[2].map(Ni).join(" ")),l(i,"class","a9s-inner"),l(i,"style",e[1]),l(i,"points",e[2].map(Ci).join(" ")),l(t,"data-id",r=e[0].id)},m(s,f){v(s,t,f),oe(t,n),oe(t,i)},p(s,[f]){f&2&&o!==(o=s[1]?"display:none;":void 0)&&l(n,"style",o),f&2&&l(i,"style",s[1]),f&1&&r!==(r=s[0].id)&&l(t,"data-id",r)},i:V,o:V,d(s){s&&k(t)}}}const Ni=e=>e.join(","),Ci=e=>e.join(",");function Ui(e,t,n){let o,{annotation:i}=t,{geom:r}=t,{style:s=void 0}=t;const{points:f}=r;return e.$$set=a=>{"annotation"in a&&n(0,i=a.annotation),"geom"in a&&n(3,r=a.geom),"style"in a&&n(4,s=a.style)},e.$$.update=()=>{e.$$.dirty&17&&n(1,o=_e(i,s))},[i,o,f,r,s]}class Hi extends ${constructor(t){super(),x(this,t,Ui,Xi,K,{annotation:0,geom:3,style:4})}}function Fi(e){let t,n,o,i,r;return{c(){t=D("g"),n=D("rect"),i=D("rect"),l(n,"class","a9s-outer"),l(n,"style",o=e[5]?"display:none;":void 0),l(n,"x",e[4]),l(n,"y",e[3]),l(n,"width",e[2]),l(n,"height",e[1]),l(i,"class","a9s-inner"),l(i,"style",e[5]),l(i,"x",e[4]),l(i,"y",e[3]),l(i,"width",e[2]),l(i,"height",e[1]),l(t,"data-id",r=e[0].id)},m(s,f){v(s,t,f),oe(t,n),oe(t,i)},p(s,[f]){f&32&&o!==(o=s[5]?"display:none;":void 0)&&l(n,"style",o),f&16&&l(n,"x",s[4]),f&8&&l(n,"y",s[3]),f&4&&l(n,"width",s[2]),f&2&&l(n,"height",s[1]),f&32&&l(i,"style",s[5]),f&16&&l(i,"x",s[4]),f&8&&l(i,"y",s[3]),f&4&&l(i,"width",s[2]),f&2&&l(i,"height",s[1]),f&1&&r!==(r=s[0].id)&&l(t,"data-id",r)},i:V,o:V,d(s){s&&k(t)}}}function Gi(e,t,n){let o,i,r,s,f,{annotation:a}=t,{geom:u}=t,{style:m=void 0}=t;return e.$$set=c=>{"annotation"in c&&n(0,a=c.annotation),"geom"in c&&n(6,u=c.geom),"style"in c&&n(7,m=c.style)},e.$$.update=()=>{e.$$.dirty&129&&n(5,o=_e(a,m)),e.$$.dirty&64&&n(4,{x:i,y:r,w:s,h:f}=u,i,(n(3,r),n(6,u)),(n(2,s),n(6,u)),(n(1,f),n(6,u)))},[a,f,s,r,i,o,u,m]}class Vi extends ${constructor(t){super(),x(this,t,Gi,Fi,K,{annotation:0,geom:6,style:7})}}function zi(e){let t,n,o;return{c(){t=D("g"),n=D("path"),l(n,"style",e[2]),l(n,"d",e[1]),l(t,"data-id",o=e[0].id)},m(i,r){v(i,t,r),oe(t,n)},p(i,[r]){r&4&&l(n,"style",i[2]),r&2&&l(n,"d",i[1]),r&1&&o!==(o=i[0].id)&&l(t,"data-id",o)},i:V,o:V,d(i){i&&k(t)}}}function ji(e,t,n){let o,i,{annotation:r}=t,{geom:s}=t,{style:f=void 0}=t,a={fillOpacity:1};const{points:u}=s;return e.$$set=m=>{"annotation"in m&&n(0,r=m.annotation),"geom"in m&&n(3,s=m.geom),"style"in m&&n(4,f=m.style)},e.$$.update=()=>{e.$$.dirty&17&&n(2,o=_e(r,f,a))},n(1,i=Re(u,lt,!0)),[r,i,o,s,f]}class qi extends ${constructor(t){super(),x(this,t,ji,zi,K,{annotation:0,geom:3,style:4})}}function Wi(e){let t,n,o,i,r;return{c(){t=D("g"),n=D("line"),i=D("line"),l(n,"class","a9s-outer"),l(n,"style",o=e[5]?"display:none;":void 0),l(n,"x1",e[4]),l(n,"y1",e[3]),l(n,"x2",e[2]),l(n,"y2",e[1]),l(i,"class","a9s-inner"),l(i,"style",e[5]),l(i,"x1",e[4]),l(i,"y1",e[3]),l(i,"x2",e[2]),l(i,"y2",e[1]),l(t,"data-id",r=e[0].id)},m(s,f){v(s,t,f),oe(t,n),oe(t,i)},p(s,[f]){f&32&&o!==(o=s[5]?"display:none;":void 0)&&l(n,"style",o),f&16&&l(n,"x1",s[4]),f&8&&l(n,"y1",s[3]),f&4&&l(n,"x2",s[2]),f&2&&l(n,"y2",s[1]),f&32&&l(i,"style",s[5]),f&16&&l(i,"x1",s[4]),f&8&&l(i,"y1",s[3]),f&4&&l(i,"x2",s[2]),f&2&&l(i,"y2",s[1]),f&1&&r!==(r=s[0].id)&&l(t,"data-id",r)},i:V,o:V,d(s){s&&k(t)}}}function Ki(e,t,n){let o,i,r,s,f,{annotation:a}=t,{geom:u}=t,{style:m=void 0}=t;return e.$$set=c=>{"annotation"in c&&n(0,a=c.annotation),"geom"in c&&n(6,u=c.geom),"style"in c&&n(7,m=c.style)},e.$$.update=()=>{e.$$.dirty&129&&n(5,o=_e(a,m)),e.$$.dirty&64&&n(4,{x1:i,y1:r,x2:s,y2:f}=u,i,(n(3,r),n(6,u)),(n(2,s),n(6,u)),(n(1,f),n(6,u)))},[a,f,s,r,i,o,u,m]}class Zi extends ${constructor(t){super(),x(this,t,Ki,Wi,K,{annotation:0,geom:6,style:7})}}const Ji={elementToImage:(e,t)=>[e,t]},bn=e=>({elementToImage:(t,n)=>{const o=e.getBoundingClientRect(),i=e.createSVGPoint();i.x=t+o.x,i.y=n+o.y;const{x:r,y:s}=i.matrixTransform(e.getScreenCTM().inverse());return[r,s]}}),Qi=250,En=(e,t)=>{const n=de();let o;return{onPointerDown:()=>o=performance.now(),onPointerUp:s=>{if(performance.now()-o<Qi){const{x:a,y:u}=xi(s,e),m=t.getAt(a,u);m?n("click",{originalEvent:s,annotation:m}):n("click",{originalEvent:s})}}}},xi=(e,t)=>{const n=t.createSVGPoint(),o=t.getBoundingClientRect(),i=e.clientX-o.x,r=e.clientY-o.y,{left:s,top:f}=t.getBoundingClientRect();return n.x=i+s,n.y=r+f,n.matrixTransform(t.getScreenCTM().inverse())};function Sn(e,t,n){const o=e.slice();return o[29]=t[n],o}function An(e,t,n){const o=e.slice();return o[32]=t[n],o}function gt(e){const t=e.slice(),n=t[32].target.selector;return t[35]=n,t}function Tn(e){let t=e[32].id,n,o,i=Mn(e);return{c(){i.c(),n=ue()},m(r,s){i.m(r,s),v(r,n,s),o=!0},p(r,s){s[0]&8192&&K(t,t=r[32].id)?(me(),j(i,1,1,V),he(),i=Mn(r),i.c(),G(i,1),i.m(n.parentNode,n)):i.p(r,s)},i(r){o||(G(i),o=!0)},o(r){j(i),o=!1},d(r){r&&k(n),i.d(r)}}}function $i(e){let t,n;return t=new Zi({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){se(t.$$.fragment)},m(o,i){ie(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){j(t.$$.fragment,o),n=!1},d(o){re(t,o)}}}function er(e){let t,n;return t=new qi({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){se(t.$$.fragment)},m(o,i){ie(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){j(t.$$.fragment,o),n=!1},d(o){re(t,o)}}}function tr(e){let t,n;return t=new Hi({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){se(t.$$.fragment)},m(o,i){ie(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){j(t.$$.fragment,o),n=!1},d(o){re(t,o)}}}function nr(e){let t,n;return t=new Vi({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){se(t.$$.fragment)},m(o,i){ie(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){j(t.$$.fragment,o),n=!1},d(o){re(t,o)}}}function or(e){let t,n;return t=new Ri({props:{annotation:e[32],geom:e[35].geometry,style:e[1]}}),{c(){se(t.$$.fragment)},m(o,i){ie(t,o,i),n=!0},p(o,i){const r={};i[0]&8192&&(r.annotation=o[32]),i[0]&8192&&(r.geom=o[35].geometry),i[0]&2&&(r.style=o[1]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){j(t.$$.fragment,o),n=!1},d(o){re(t,o)}}}function Mn(e){let t,n,o,i;const r=[or,nr,tr,er,$i],s=[];function f(a,u){return a[35].type===z.ELLIPSE?0:a[35].type===z.RECTANGLE?1:a[35].type===z.POLYGON?2:a[35].type===z.FREEHAND?3:a[35].type===z.LINE?4:-1}return~(t=f(e))&&(n=s[t]=r[t](e)),{c(){n&&n.c(),o=ue()},m(a,u){~t&&s[t].m(a,u),v(a,o,u),i=!0},p(a,u){let m=t;t=f(a),t===m?~t&&s[t].p(a,u):(n&&(me(),j(s[m],1,1,()=>{s[m]=null}),he()),~t?(n=s[t],n?n.p(a,u):(n=s[t]=r[t](a),n.c()),G(n,1),n.m(o.parentNode,o)):n=null)},i(a){i||(G(n),i=!0)},o(a){j(n),i=!1},d(a){~t&&s[t].d(a),a&&k(o)}}}function Ln(e){let t=!e[7](e[32]),n,o,i=t&&Tn(gt(e));return{c(){i&&i.c(),n=ue()},m(r,s){i&&i.m(r,s),v(r,n,s),o=!0},p(r,s){s[0]&8320&&(t=!r[7](r[32])),t?i?(i.p(gt(r),s),s[0]&8320&&G(i,1)):(i=Tn(gt(r)),i.c(),G(i,1),i.m(n.parentNode,n)):i&&(me(),j(i,1,1,()=>{i=null}),he())},i(r){o||(G(i),o=!0)},o(r){j(i),o=!1},d(r){i&&i.d(r),r&&k(n)}}}function kn(e){let t,n,o,i;const r=[rr,ir],s=[];function f(a,u){return a[6]?0:a[12]&&a[0]?1:-1}return~(t=f(e))&&(n=s[t]=r[t](e)),{c(){n&&n.c(),o=ue()},m(a,u){~t&&s[t].m(a,u),v(a,o,u),i=!0},p(a,u){let m=t;t=f(a),t===m?~t&&s[t].p(a,u):(n&&(me(),j(s[m],1,1,()=>{s[m]=null}),he()),~t?(n=s[t],n?n.p(a,u):(n=s[t]=r[t](a),n.c()),G(n,1),n.m(o.parentNode,o)):n=null)},i(a){i||(G(n),i=!0)},o(a){j(n),i=!1},d(a){~t&&s[t].d(a),a&&k(o)}}}function ir(e){let t=e[2],n,o,i=vn(e);return{c(){i.c(),n=ue()},m(r,s){i.m(r,s),v(r,n,s),o=!0},p(r,s){s[0]&4&&K(t,t=r[2])?(me(),j(i,1,1,V),he(),i=vn(r),i.c(),G(i,1),i.m(n.parentNode,n)):i.p(r,s)},i(r){o||(G(i),o=!0)},o(r){j(i),o=!1},d(r){r&&k(n),i.d(r)}}}function rr(e){let t,n,o=e[6],i=[];for(let s=0;s<o.length;s+=1)i[s]=On(Sn(e,o,s));const r=s=>j(i[s],1,1,()=>{i[s]=null});return{c(){for(let s=0;s<i.length;s+=1)i[s].c();t=ue()},m(s,f){for(let a=0;a<i.length;a+=1)i[a]&&i[a].m(s,f);v(s,t,f),n=!0},p(s,f){if(f[0]&279634){o=s[6];let a;for(a=0;a<o.length;a+=1){const u=Sn(s,o,a);i[a]?(i[a].p(u,f),G(i[a],1)):(i[a]=On(u),i[a].c(),G(i[a],1),i[a].m(t.parentNode,t))}for(me(),a=o.length;a<i.length;a+=1)r(a);he()}},i(s){if(!n){for(let f=0;f<o.length;f+=1)G(i[f]);n=!0}},o(s){i=i.filter(Boolean);for(let f=0;f<i.length;f+=1)j(i[f]);n=!1},d(s){tt(i,s),s&&k(t)}}}function vn(e){let t,n;return t=new cn({props:{target:e[4],tool:e[12],drawingMode:e[11],transform:e[10],viewportScale:e[14]}}),t.$on("create",e[17]),{c(){se(t.$$.fragment)},m(o,i){ie(t,o,i),n=!0},p(o,i){const r={};i[0]&16&&(r.target=o[4]),i[0]&4096&&(r.tool=o[12]),i[0]&2048&&(r.drawingMode=o[11]),i[0]&1024&&(r.transform=o[10]),i[0]&16384&&(r.viewportScale=o[14]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){j(t.$$.fragment,o),n=!1},d(o){re(t,o)}}}function In(e){let t,n;return t=new fn({props:{target:e[4],editor:ut(e[29].target.selector),annotation:e[29],style:e[1],transform:e[10],viewportScale:e[14]}}),t.$on("change",function(){q(e[18](e[29]))&&e[18](e[29]).apply(this,arguments)}),{c(){se(t.$$.fragment)},m(o,i){ie(t,o,i),n=!0},p(o,i){e=o;const r={};i[0]&16&&(r.target=e[4]),i[0]&64&&(r.editor=ut(e[29].target.selector)),i[0]&64&&(r.annotation=e[29]),i[0]&2&&(r.style=e[1]),i[0]&1024&&(r.transform=e[10]),i[0]&16384&&(r.viewportScale=e[14]),t.$set(r)},i(o){n||(G(t.$$.fragment,o),n=!0)},o(o){j(t.$$.fragment,o),n=!1},d(o){re(t,o)}}}function On(e){let t=e[29].id,n,o,i=In(e);return{c(){i.c(),n=ue()},m(r,s){i.m(r,s),v(r,n,s),o=!0},p(r,s){s[0]&64&&K(t,t=r[29].id)?(me(),j(i,1,1,V),he(),i=In(r),i.c(),G(i,1),i.m(n.parentNode,n)):i.p(r,s)},i(r){o||(G(i),o=!0)},o(r){j(i),o=!1},d(r){r&&k(n),i.d(r)}}}function sr(e){let t,n,o,i,r,s,f=e[13],a=[];for(let c=0;c<f.length;c+=1)a[c]=Ln(An(e,f,c));const u=c=>j(a[c],1,1,()=>{a[c]=null});let m=e[4]&&kn(e);return{c(){t=D("svg"),n=D("g");for(let c=0;c<a.length;c+=1)a[c].c();o=D("g"),m&&m.c(),l(o,"class","drawing"),l(t,"class","a9s-annotationlayer"),vt(t,"drawing",e[12])},m(c,h){v(c,t,h),oe(t,n);for(let d=0;d<a.length;d+=1)a[d]&&a[d].m(n,null);oe(t,o),m&&m.m(o,null),e[25](o),e[26](t),i=!0,r||(s=[W(t,"pointerup",function(){q(e[8])&&e[8].apply(this,arguments)}),W(t,"pointerdown",function(){q(e[9])&&e[9].apply(this,arguments)})],r=!0)},p(c,h){if(e=c,h[0]&8322){f=e[13];let d;for(d=0;d<f.length;d+=1){const p=An(e,f,d);a[d]?(a[d].p(p,h),G(a[d],1)):(a[d]=Ln(p),a[d].c(),G(a[d],1),a[d].m(n,null))}for(me(),d=f.length;d<a.length;d+=1)u(d);he()}e[4]?m?(m.p(e,h),h[0]&16&&G(m,1)):(m=kn(e),m.c(),G(m,1),m.m(o,null)):m&&(me(),j(m,1,1,()=>{m=null}),he()),(!i||h[0]&4096)&&vt(t,"drawing",e[12])},i(c){if(!i){for(let h=0;h<f.length;h+=1)G(a[h]);G(m),i=!0}},o(c){a=a.filter(Boolean);for(let h=0;h<a.length;h+=1)j(a[h]);j(m),i=!1},d(c){c&&k(t),tt(a,c),m&&m.d(),e[25](null),e[26](null),r=!1,le(s)}}}function lr(e,t,n){let o,i,r,s,f,a,u,m,c,h,d=V,p=()=>(d(),d=Tt(w,O=>n(14,h=O)),w);e.$$.on_destroy.push(()=>d());let{drawingEnabled:S}=t,{image:E}=t,{preferredDrawingMode:y}=t,{state:g}=t,{style:_=void 0}=t,{toolName:T=Ve().length>0?Ve()[0]:void 0}=t,{user:L}=t,Y,R,w;pe(()=>p(n(5,w=mn(E,R))));const{selection:b,store:A}=g;Mt(e,b,O=>n(24,m=O)),Mt(e,A,O=>n(13,c=O));let I=null,P=null;const U=O=>{A.unobserve(I);const C=O.filter(({editable:J})=>J).map(({id:J})=>J);C.length>0?(n(6,P=C.map(J=>A.getAnnotation(J))),I=J=>{const{updated:be}=J.changes;n(6,P=be.map(ge=>ge.newValue))},A.observe(I,{annotations:C})):n(6,P=null)},H=O=>{const C=Vt(),J={id:C,bodies:[],target:{annotation:C,selector:O.detail,creator:L,created:new Date}};A.addAnnotation(J),b.setSelected(J.id)},N=O=>C=>{var ne;const{target:J}=O,be=10*60*1e3,ge=((ne=J.creator)==null?void 0:ne.id)!==L.id||!J.created||new Date().getTime()-J.created.getTime()>be;A.updateTarget({...J,selector:C.detail,created:ge?J.created:new Date,updated:ge?new Date:null,updatedBy:ge?L:null})};function ce(O){Ye[O?"unshift":"push"](()=>{Y=O,n(4,Y)})}function we(O){Ye[O?"unshift":"push"](()=>{R=O,n(3,R)})}return e.$$set=O=>{"drawingEnabled"in O&&n(0,S=O.drawingEnabled),"image"in O&&n(19,E=O.image),"preferredDrawingMode"in O&&n(20,y=O.preferredDrawingMode),"state"in O&&n(21,g=O.state),"style"in O&&n(1,_=O.style),"toolName"in O&&n(2,T=O.toolName),"user"in O&&n(22,L=O.user)},e.$$.update=()=>{e.$$.dirty[0]&4&&n(12,{tool:o,opts:i}=ht(T),o,(n(23,i),n(2,T))),e.$$.dirty[0]&9437184&&n(11,r=(i==null?void 0:i.drawingMode)||y),e.$$.dirty[0]&8&&n(10,s=bn(R)),e.$$.dirty[0]&8&&n(9,{onPointerDown:f,onPointerUp:a}=En(R,A),f,(n(8,a),n(3,R))),e.$$.dirty[0]&16777216&&n(7,u=O=>m.selected.find(C=>C.id===O.id&&C.editable)),e.$$.dirty[0]&16777216&&U(m.selected)},[S,_,T,R,Y,w,P,u,a,f,s,r,o,c,h,b,A,H,N,E,y,g,L,i,m,ce,we]}class Pn extends ${constructor(t){super(),x(this,t,lr,sr,K,{drawingEnabled:0,image:19,preferredDrawingMode:20,state:21,style:1,toolName:2,user:22},null,[-1,-1])}}function ar(e,t,n,o,i){Dn(e,t,n||0,o||e.length-1,i||fr)}function Dn(e,t,n,o,i){for(;o>n;){if(o-n>600){var r=o-n+1,s=t-n+1,f=Math.log(r),a=.5*Math.exp(2*f/3),u=.5*Math.sqrt(f*a*(r-a)/r)*(s-r/2<0?-1:1),m=Math.max(n,Math.floor(t-s*a/r+u)),c=Math.min(o,Math.floor(t+(r-s)*a/r+u));Dn(e,t,m,c,i)}var h=e[t],d=n,p=o;for(Xe(e,n,t),i(e[o],h)>0&&Xe(e,n,o);d<p;){for(Xe(e,d,p),d++,p--;i(e[d],h)<0;)d++;for(;i(e[p],h)>0;)p--}i(e[n],h)===0?Xe(e,n,p):(p++,Xe(e,p,o)),p<=t&&(n=p+1),t<=p&&(o=p-1)}}function Xe(e,t,n){var o=e[t];e[t]=e[n],e[n]=o}function fr(e,t){return e<t?-1:e>t?1:0}class cr{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let n=this.data;const o=[];if(!je(t,n))return o;const i=this.toBBox,r=[];for(;n;){for(let s=0;s<n.children.length;s++){const f=n.children[s],a=n.leaf?i(f):f;je(t,a)&&(n.leaf?o.push(f):yt(t,a)?this._all(f,o):r.push(f))}n=r.pop()}return o}collides(t){let n=this.data;if(!je(t,n))return!1;const o=[];for(;n;){for(let i=0;i<n.children.length;i++){const r=n.children[i],s=n.leaf?this.toBBox(r):r;if(je(t,s)){if(n.leaf||yt(t,s))return!0;o.push(r)}}n=o.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let o=0;o<t.length;o++)this.insert(t[o]);return this}let n=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=n;else if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const o=this.data;this.data=n,n=o}this._insert(n,this.data.height-n.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=Pe([]),this}remove(t,n){if(!t)return this;let o=this.data;const i=this.toBBox(t),r=[],s=[];let f,a,u;for(;o||r.length;){if(o||(o=r.pop(),a=r[r.length-1],f=s.pop(),u=!0),o.leaf){const m=ur(t,o.children,n);if(m!==-1)return o.children.splice(m,1),r.push(o),this._condense(r),this}!u&&!o.leaf&&yt(o,i)?(r.push(o),s.push(f),f=0,a=o,o=o.children[0]):a?(f++,o=a.children[f],u=!1):o=null}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,n){const o=[];for(;t;)t.leaf?n.push(...t.children):o.push(...t.children),t=o.pop();return n}_build(t,n,o,i){const r=o-n+1;let s=this._maxEntries,f;if(r<=s)return f=Pe(t.slice(n,o+1)),Oe(f,this.toBBox),f;i||(i=Math.ceil(Math.log(r)/Math.log(s)),s=Math.ceil(r/Math.pow(s,i-1))),f=Pe([]),f.leaf=!1,f.height=i;const a=Math.ceil(r/s),u=a*Math.ceil(Math.sqrt(s));Bn(t,n,o,u,this.compareMinX);for(let m=n;m<=o;m+=u){const c=Math.min(m+u-1,o);Bn(t,m,c,a,this.compareMinY);for(let h=m;h<=c;h+=a){const d=Math.min(h+a-1,c);f.children.push(this._build(t,h,d,i-1))}}return Oe(f,this.toBBox),f}_chooseSubtree(t,n,o,i){for(;i.push(n),!(n.leaf||i.length-1===o);){let r=1/0,s=1/0,f;for(let a=0;a<n.children.length;a++){const u=n.children[a],m=pt(u),c=hr(t,u)-m;c<s?(s=c,r=m<r?m:r,f=u):c===s&&m<r&&(r=m,f=u)}n=f||n.children[0]}return n}_insert(t,n,o){const i=o?t:this.toBBox(t),r=[],s=this._chooseSubtree(i,this.data,n,r);for(s.children.push(t),Ce(s,i);n>=0&&r[n].children.length>this._maxEntries;)this._split(r,n),n--;this._adjustParentBBoxes(i,r,n)}_split(t,n){const o=t[n],i=o.children.length,r=this._minEntries;this._chooseSplitAxis(o,r,i);const s=this._chooseSplitIndex(o,r,i),f=Pe(o.children.splice(s,o.children.length-s));f.height=o.height,f.leaf=o.leaf,Oe(o,this.toBBox),Oe(f,this.toBBox),n?t[n-1].children.push(f):this._splitRoot(o,f)}_splitRoot(t,n){this.data=Pe([t,n]),this.data.height=t.height+1,this.data.leaf=!1,Oe(this.data,this.toBBox)}_chooseSplitIndex(t,n,o){let i,r=1/0,s=1/0;for(let f=n;f<=o-n;f++){const a=Ne(t,0,f,this.toBBox),u=Ne(t,f,o,this.toBBox),m=gr(a,u),c=pt(a)+pt(u);m<r?(r=m,i=f,s=c<s?c:s):m===r&&c<s&&(s=c,i=f)}return i||o-n}_chooseSplitAxis(t,n,o){const i=t.leaf?this.compareMinX:dr,r=t.leaf?this.compareMinY:mr,s=this._allDistMargin(t,n,o,i),f=this._allDistMargin(t,n,o,r);s<f&&t.children.sort(i)}_allDistMargin(t,n,o,i){t.children.sort(i);const r=this.toBBox,s=Ne(t,0,n,r),f=Ne(t,o-n,o,r);let a=ze(s)+ze(f);for(let u=n;u<o-n;u++){const m=t.children[u];Ce(s,t.leaf?r(m):m),a+=ze(s)}for(let u=o-n-1;u>=n;u--){const m=t.children[u];Ce(f,t.leaf?r(m):m),a+=ze(f)}return a}_adjustParentBBoxes(t,n,o){for(let i=o;i>=0;i--)Ce(n[i],t)}_condense(t){for(let n=t.length-1,o;n>=0;n--)t[n].children.length===0?n>0?(o=t[n-1].children,o.splice(o.indexOf(t[n]),1)):this.clear():Oe(t[n],this.toBBox)}}function ur(e,t,n){if(!n)return t.indexOf(e);for(let o=0;o<t.length;o++)if(n(e,t[o]))return o;return-1}function Oe(e,t){Ne(e,0,e.children.length,t,e)}function Ne(e,t,n,o,i){i||(i=Pe(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let r=t;r<n;r++){const s=e.children[r];Ce(i,e.leaf?o(s):s)}return i}function Ce(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function dr(e,t){return e.minX-t.minX}function mr(e,t){return e.minY-t.minY}function pt(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function ze(e){return e.maxX-e.minX+(e.maxY-e.minY)}function hr(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function gr(e,t){const n=Math.max(e.minX,t.minX),o=Math.max(e.minY,t.minY),i=Math.min(e.maxX,t.maxX),r=Math.min(e.maxY,t.maxY);return Math.max(0,i-n)*Math.max(0,r-o)}function yt(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function je(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function Pe(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Bn(e,t,n,o,i){const r=[t,n];for(;r.length;){if(n=r.pop(),t=r.pop(),n-t<=o)continue;const s=t+Math.ceil((n-t)/o/2)*o;ar(e,s,t,n,i),r.push(t,s,s,n)}}const pr=()=>{const e=new cr,t=new Map,n=()=>[...t.values()],o=()=>{e.clear(),t.clear()},i=c=>{const{minX:h,minY:d,maxX:p,maxY:S}=c.selector.geometry.bounds,E={minX:h,minY:d,maxX:p,maxY:S,target:c};e.insert(E),t.set(c.annotation,E)},r=c=>{const h=t.get(c.annotation);e.remove(h),t.delete(c.annotation)};return{all:n,clear:o,getAt:(c,h)=>{const p=e.search({minX:c,minY:h,maxX:c,maxY:h}).map(S=>S.target).filter(S=>S.selector.type===z.RECTANGLE||Dt(S.selector,c,h));if(p.length>0)return p.sort((S,E)=>He(S.selector)-He(E.selector)),p[0]},getIntersecting:(c,h,d,p)=>e.search({minX:c,minY:h,maxX:c+d,maxY:h+p}).map(S=>S.target),insert:i,remove:r,set:(c,h=!0)=>{h&&o();const d=c.map(p=>{const{minX:S,minY:E,maxX:y,maxY:g}=p.selector.geometry.bounds;return{minX:S,minY:E,maxX:y,maxY:g,target:p}});d.forEach(p=>t.set(p.target.annotation,p)),e.load(d)},size:()=>e.all().length,update:(c,h)=>{r(c),i(h)}}},Yn=e=>{const t=Po(),n=pr(),o=Eo(t,e.pointerSelectAction),i=bo(t),r=Xo();return t.observe(({changes:a})=>{n.set(a.created.map(u=>u.target),!1),a.deleted.forEach(u=>n.remove(u.target)),a.updated.forEach(({oldValue:u,newValue:m})=>n.update(u.target,m.target))}),{store:{...t,getAt:(a,u)=>{const m=n.getAt(a,u);return m?t.getAnnotation(m.annotation):void 0},getIntersecting:(a,u,m,c)=>n.getIntersecting(a,u,m,c).map(h=>t.getAnnotation(h.annotation))},selection:o,hover:i,viewport:r}},Rn=e=>{const t=Yn(e);return{...t,store:Do(t.store)}},Xn=e=>{let t,n;if(e.nodeName==="CANVAS")t=e,n=t.getContext("2d",{willReadFrequently:!0});else{const i=e;t=document.createElement("canvas"),t.width=i.width,t.height=i.height,n=t.getContext("2d",{willReadFrequently:!0}),n.drawImage(i,0,0,i.width,i.height)}let o=0;for(let i=1;i<10;i++)for(let r=1;r<10;r++){const s=Math.round(r*t.width/10),f=Math.round(i*t.height/10),a=n.getImageData(s,f,1,1).data,u=(.299*a[0]+.587*a[1]+.114*a[2])/255;o+=u}return o/81},Nn=e=>{const t=Xn(e),n=t>.6?"dark":"light";return console.log(`[Annotorious] Image brightness: ${t.toFixed(1)}. Setting ${n} theme.`),n},_t=(e,t,n)=>t.setAttribute("data-theme",n==="auto"?Nn(e):n),Cn=(e,t)=>({...e,drawingEnabled:e.drawingEnabled===void 0?t.drawingEnabled:e.drawingEnabled,drawingMode:e.drawingMode||t.drawingMode,pointerSelectAction:e.pointerSelectAction||t.pointerSelectAction,theme:e.theme||t.theme}),Un=navigator.userAgent.indexOf("Mac OS X")!==-1,Hn=(e,t)=>{const n=t||document,o=s=>{s.key==="Z"&&s.ctrlKey?e.undo():s.key==="Y"&&s.ctrlKey&&e.redo()},i=s=>{s.key==="z"&&s.metaKey&&(s.shiftKey?e.redo():e.undo())},r=()=>{Un?n.removeEventListener("keydown",i):n.removeEventListener("keydown",o)};return Un?n.addEventListener("keydown",i):n.addEventListener("keydown",o),{destroy:r}},wr="",br="",Er="",yr=(e,t={})=>{if(!e)throw"Missing argument: image";const n=typeof e=="string"?document.getElementById(e):e,o=Cn(t,{drawingEnabled:!0,drawingMode:"drag",pointerSelectAction:jt.EDIT,theme:"light"}),i=Rn(o),{selection:r,store:s}=i,f=Ro(s),a=No(i,f,o.adapter,o.autoSave),u=document.createElement("DIV");u.style.position="relative",u.style.display="inline-block",n.style.display="block",n.parentNode.insertBefore(u,n),u.appendChild(n);const m=Hn(f);let c=zo();_t(n,u,o.theme);const h=new Pn({target:u,props:{drawingEnabled:o.drawingEnabled,image:n,preferredDrawingMode:o.drawingMode,state:i,style:o.style,user:c}});h.$on("click",w=>{const{originalEvent:b,annotation:A}=w.detail;A?r.clickSelect(A.id,b):r.isEmpty()||r.clear()});const d=Uo(i,f,o.adapter),p=()=>{h.$destroy(),u.parentNode.insertBefore(n,u),u.parentNode.removeChild(u),m.destroy(),f.destroy()},S=()=>c,E=(w,b,A)=>wn(w,b,A),y=(w,b)=>ln(w,b),g=w=>{if(!ht(w))throw`No drawing tool named ${w}`;h.$set({toolName:w})},_=w=>h.$set({drawingEnabled:w}),T=w=>{console.warn("Filter not implemented yet")},L=w=>h.$set({style:w}),Y=w=>_t(n,u,w),R=w=>{c=w,h.$set({user:w})};return{...d,destroy:p,getUser:S,listDrawingTools:Ve,on:a.on,off:a.off,registerDrawingTool:E,registerShapeEditor:y,setDrawingEnabled:_,setDrawingTool:g,setFilter:T,setStyle:L,setTheme:Y,setUser:R,state:i}};X.Editor=ve,X.EditorMount=fn,X.EllipseEditor=nn,X.FreehandEditor=on,X.Handle=M,X.IdentityTransform=Ji,X.LineEditor=rn,X.LineUtil=Yt,X.PolygonEditor=en,X.RectangleEditor=tn,X.RectangleUtil=Bt,X.RubberbandRectangle=dn,X.SVGAnnotationLayer=Pn,X.ShapeType=z,X.ToolMount=cn,X.W3CImageFormat=Ko,X.addEventListeners=En,X.boundsFromPoints=ye,X.computeArea=He,X.createImageAnnotator=yr,X.createImageAnnotatorState=Yn,X.createSVGTransform=bn,X.createSvelteImageAnnotatorState=Rn,X.detectTheme=Nn,X.distance=Ge,X.enableResponsive=mn,X.fillDefaults=Cn,X.getEditor=ut,X.getTool=ht,X.initKeyboardCommands=Hn,X.intersects=Dt,X.isTouch=wi,X.listDrawingTools=Ve,X.parseFragmentSelector=Rt,X.parseSVGSelector=Ht,X.parseW3CImageAnnotation=Kt,X.registerEditor=ln,X.registerShapeUtil=Le,X.registerTool=wn,X.sampleBrightness=Xn,X.serializeFragmentSelector=Xt,X.serializeSVGSelector=Ft,X.serializeW3CImageAnnotation=Zt,X.setTheme=_t,Object.defineProperty(X,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=annotorious.js.map
